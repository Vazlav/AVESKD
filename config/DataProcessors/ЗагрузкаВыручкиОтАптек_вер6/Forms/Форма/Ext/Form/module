


Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	ПараметрыСеанса.Беспредел = Беспредел;
	
	Попытка
		ОтключитьОбработчикОжидания("РоботПоЗагрузкеВыручки");
		ЭлементыФормы.СостояниеРобота.Заголовок="Робот остановлен";
	ИСключение
	КонецПопытки;
	
	СтруктИндФайл=новый Структура("Значение,МаксимальноеЗначение",0,0);
	
	Если ОбрабатыватьПоаптечно = Истина Тогда
		
		ТХТ = "ВЫБРАТЬ
		|	МестаХранения.Ссылка
		|ИЗ
		|	Справочник.МестаХранения КАК МестаХранения
		|ГДЕ
		|	МестаХранения.ЭтоГруппа = ЛОЖЬ
		|	И МестаХранения.ПометкаУдаления = ЛОЖЬ";
		Запрос = Новый Запрос;
		Запрос.Текст = ТХТ;
		ТЗАптек = Запрос.Выполнить().Выгрузить();
		
		Для каждого стр из ТЗАптек Цикл
			ЗагружатьПоВыбранномуСкладу = стр.Ссылка;
			ЭтаФорма.Обновить();
			мЗапускЗагрузкиВыручки(ЭлементыФормы.ИндФайлы,СтруктИндФайл,ЭлементыФормы.Лог);
		КонецЦикла;
	Иначе
		ЗагружатьПоВыбранномуСкладу = Справочники.МестаХранения.ПустаяСсылка();
		мЗапускЗагрузкиВыручки(ЭлементыФормы.ИндФайлы,СтруктИндФайл,ЭлементыФормы.Лог);
	КонецЕсли;
	
	ПараметрыСеанса.Беспредел = ЛОЖЬ;
	
КонецПроцедуры



Процедура ПолеКартинки1Нажатие(Элемент)
	Предупреждение("Это Робот",5);
КонецПроцедуры

Процедура ОсновныеДействияФормыОчиститьЛог(Кнопка)
	ЭлементыФормы.Лог.Очистить();
КонецПроцедуры

Процедура ПриЗакрытии()
	УстановитьЗаголовокСистемы(""+ глФирма);
КонецПроцедуры


Процедура РоботПоЗагрузкеВыручки()
	ЭлементыФормы.Лог.Очистить();
	Попытка
		ОтключитьОбработчикОжидания("РоботПоЗагрузкеВыручки");
		ЭлементыФормы.СостояниеРобота.Заголовок="Робот остановлен";
	ИСключение
	КонецПопытки;
	ЭлементыФормы.СостояниеРобота.Заголовок="Робот обрабатывает файлы...";
	
	СтруктИндФайл=новый Структура("Значение,МаксимальноеЗначение",0,0);
	
	 РоботЗаголовокСистемы();

	
	мЗапускЗагрузкиВыручки(ЭлементыФормы.ИндФайлы,СтруктИндФайл,ЭлементыФормы.Лог);
	
	ПериодРобота= 5*Константы.ЗадержкаТаймераРобота.Получить();
	ДатаЗапуска=ТекущаяДата()+ПериодРобота;
	ПодключитьОбработчикОжидания("РоботПоЗагрузкеВыручки",5*Константы.ЗадержкаТаймераРобота.Получить());
	ЭлементыФормы.СостояниеРобота.Заголовок="Робот запущен. Старт:"+ДатаЗапуска;
КонецПроцедуры	


Процедура ОсновныеДействияФормыЗапуститьРобота(Кнопка)
	РоботПоЗагрузкеВыручки();
КонецПроцедуры

Процедура РоботЗаголовокСистемы()
	Попытка
		УстановитьЗаголовокСистемы(""+ПолучитьИмяБазыДанных()+" Выручка ver.5");
	Исключение
	КонецПопытки;
КонецПроцедуры	

Процедура ПриОткрытии()
	ЭлементыФормы.СостояниеРобота.Заголовок="Робот остановлен";
	РоботЗаголовокСистемы();
КонецПроцедуры




