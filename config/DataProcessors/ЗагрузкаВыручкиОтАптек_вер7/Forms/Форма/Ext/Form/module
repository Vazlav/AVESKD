


Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	ПараметрыСеанса.Беспредел = Беспредел;
	
	Попытка
		ОтключитьОбработчикОжидания("РоботПоЗагрузкеВыручки");
		ЭлементыФормы.СостояниеРобота.Заголовок="Робот остановлен";
	ИСключение
	КонецПопытки;
	
	СтруктИндФайл=новый Структура("Значение,МаксимальноеЗначение",0,0);
	
	Если ОбрабатыватьПоаптечно = Истина Тогда
		
		ТХТ = "ВЫБРАТЬ
		|	МестаХранения.Ссылка
		|ИЗ
		|	Справочник.МестаХранения КАК МестаХранения
		|ГДЕ
		|	МестаХранения.ЭтоГруппа = ЛОЖЬ
		|	И МестаХранения.ПометкаУдаления = ЛОЖЬ";
		Запрос = Новый Запрос;
		Запрос.Текст = ТХТ;
		ТЗАптек = Запрос.Выполнить().Выгрузить();
		
		Для каждого стр из ТЗАптек Цикл
			ЗагружатьПоВыбранномуСкладу = стр.Ссылка;
			ЭтаФорма.Обновить();
			мЗапускЗагрузкиВыручки(ЭлементыФормы.ИндФайлы,СтруктИндФайл,ЭлементыФормы.Лог);
		КонецЦикла;
	Иначе
		ЗагружатьПоВыбранномуСкладу = Справочники.МестаХранения.ПустаяСсылка();
		мЗапускЗагрузкиВыручки(ЭлементыФормы.ИндФайлы,СтруктИндФайл,ЭлементыФормы.Лог);
	КонецЕсли;
	
	ПараметрыСеанса.Беспредел = ЛОЖЬ;
	
КонецПроцедуры



Процедура ПолеКартинки1Нажатие(Элемент)
	Предупреждение("Это Робот",5);
КонецПроцедуры

Процедура ОсновныеДействияФормыОчиститьЛог(Кнопка)
	ЭлементыФормы.Лог.Очистить();
КонецПроцедуры

Процедура ПриЗакрытии()
	УстановитьЗаголовокСистемы(""+ глФирма);
КонецПроцедуры


Процедура РоботПоЗагрузкеВыручки()
	ЭлементыФормы.Лог.Очистить();
	Попытка
		ОтключитьОбработчикОжидания("РоботПоЗагрузкеВыручки");
		ЭлементыФормы.СостояниеРобота.Заголовок="Робот остановлен";
	ИСключение
	КонецПопытки;
	ЭлементыФормы.СостояниеРобота.Заголовок="Робот обрабатывает файлы...";
	
	СтруктИндФайл=новый Структура("Значение,МаксимальноеЗначение",0,0);
	
	 РоботЗаголовокСистемы();

	
	мЗапускЗагрузкиВыручки(ЭлементыФормы.ИндФайлы,СтруктИндФайл,ЭлементыФормы.Лог);
	
	ПериодРобота= 5*Константы.ЗадержкаТаймераРобота.Получить();
	ДатаЗапуска=ТекущаяДата()+ПериодРобота;
	ПодключитьОбработчикОжидания("РоботПоЗагрузкеВыручки",5*Константы.ЗадержкаТаймераРобота.Получить());
	ЭлементыФормы.СостояниеРобота.Заголовок="Робот запущен. Старт:"+ДатаЗапуска;
КонецПроцедуры	


Процедура ОсновныеДействияФормыЗапуститьРобота(Кнопка)
	РоботПоЗагрузкеВыручки();
КонецПроцедуры

Процедура РоботЗаголовокСистемы()
	Попытка
		УстановитьЗаголовокСистемы(""+ПолучитьИмяБазыДанных()+" Выручка ver.5");
	Исключение
	КонецПопытки;
КонецПроцедуры	

Процедура ПриОткрытии()
	ОбновитьИнформациюОбОбработке();
	ЭлементыФормы.СостояниеРобота.Заголовок="Робот остановлен";
	РоботЗаголовокСистемы();
КонецПроцедуры


Процедура ОбновитьИнформациюОбОбработке()
	
	Запрос=Новый Запрос("ВЫБРАТЬ
	|	ВнешниеОтчетыИОбработки.Ссылка
	|ИЗ
	|	Справочник.ВнешниеОтчетыИОбработки КАК ВнешниеОтчетыИОбработки
	|ГДЕ
	|	ПОДСТРОКА(ВнешниеОтчетыИОбработки.ПутьКФайлу, 1, 999) = ПОДСТРОКА(&ПутьКФайлу, 1, 999)
	|	И ВнешниеОтчетыИОбработки.Наименование <> &Наименование");
	
	Попытка
		ЭОИФ=СокрЛП(ЭтотОбъект.ИспользуемоеИмяФайла);
	исключение
		ЭОИФ="";
	КонецПопытки;
	
	Если ПустаяСтрока(ЭОИФ) тогда
		возврат;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ПутьКФайлу",СокрЛП(ЭтотОбъект.ИспользуемоеИмяФайла));
	Запрос.УстановитьПараметр("Наименование",СокрЛП(ЭтаФорма.Заголовок));
	
	Ссылки=Запрос.Выполнить().Выгрузить();
	Для Каждого Стр Из ссылки Цикл
		Объект=Стр.ссылка.ПолучитьОбъект();
		Объект.Наименование=ЭтаФорма.Заголовок;
		Объект.Записать();
	КонецЦикла;
	
   


КонецПроцедуры

Процедура ЗаполнитьПоФирмеНажатие(Элемент)
	Запрос=Новый Запрос("ВЫБРАТЬ
	                    |	МестаХранения.Ссылка КАК Аптека
	                    |ИЗ
	                    |	Справочник.МестаХранения КАК МестаХранения
	                    |ГДЕ
	                    |	МестаХранения.Фирма = &Фирма");
						
	Запрос.УстановитьПараметр("Фирма",Фирма);
	
	ЭлементыФормы.СписокАптек.Значение=Запрос.Выполнить().Выгрузить();
	
						
КонецПроцедуры

Процедура ОсновныеДействияФормыЗагрузитьПоСпискуАптек(Кнопка)
	ДЛя Каждого Стр Из СписокАптек Цикл
		ЗагружатьПоВыбранномуСкладу=Стр.Аптека;
		РоботПоЗагрузкеВыручки();
	КонецЦикла;	
КонецПроцедуры

Процедура ПодобратьАптеки()
	
	Обработка = Обработки.ОтборПоФильтру.Создать();
	Обработка.ТекстЗапроса = "ВЫБРАТЬ
	                         |	МестаХранения.Ссылка
	                         |ИЗ
	                         |	Справочник.МестаХранения КАК МестаХранения
	                         |
							 |{ГДЕ
	                         |	МестаХранения.Ссылка.* КАК Аптека}";
	
	ФормаПодбора=Обработка.ПолучитьФорму("Форма");
	
	РезультатСписок = ФормаПодбора.ОткрытьМодально();
	Если РезультатСписок= Неопределено Тогда
		ПРедупреждение("Ничего не выбрано!");
		Возврат;
	КонецЕсли;	
	МассивАптек = РезультатСписок.ВыгрузитьЗначения();
	Для каждого стр из МассивАптек Цикл
		нов = СписокАптек.Добавить();
		нов.Аптека = стр;
		КонецЦикла;
	//СписокАптек.ЗагрузитьКолонку(РезультатСписок.ВыгрузитьЗначения(),"Аптека");
	
	
КонецПроцедуры


Процедура СписокВыбораАптекПриИзменении(Элемент)
	
	ПодобратьАптеки();	
	
КонецПроцедуры

ЭлементыФормы.СписокВыбораАптек.СписокВыбора.Добавить(1,"Аптеки (подбор)");
