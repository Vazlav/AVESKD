Перем ДокИзФормы Экспорт;
Перем АвтозапускРасценкиИзФормы Экспорт;

Перем ТЗКосяков;
Перем ИспользоватьЦеныКонкурентов;
Перем ДокОбъект Экспорт;
Перем ТЗМатрицаОгруглений Экспорт;

//==================<КУЧЕРЯВОЕ ЦЕНООБРАЗОВАНИЕ>===================GtG====22.11.2007
//расчет цен ведется на самую мелкую единицу измерения
//чтобы процент наценки не превышал максимальный лимит:
//	округление по верхнему пределу в меньшюу сторону
//	округление по нижнему лимиту в большую сторону
//тогда цена всегда будет в допустимо мдиапазоне
//и для укрупненных единиц измерени явсегда будет делиться нацело, без длинны ххвостов
//	Для товаров цена которых меньше константы минимальная цена округления округляе мцену до 1-й копейки
//		если цена больше константы - округляем до 5 или 10 копеек ,
//			что указано в константе метод округления розн. цены
// после асрчета цены (на 1) она умножается на коэффициент единицы из документа
//
// алгоритмы , условия их применения и необходимые для расечта параметры описываются в справочнике АлгоритмыЦенообразованияРегионов
// подчиненном справочнику Регионы
//
// Цена рассчитывается на единицу измерения с коэффициентом =1, при этом цена более крупной еит должна без дробей делиться на коэффициент.
// Если в документе использовалась ЕИТ с К<>1 цо единичную цену умножаем на К

Перем КоличествоОшибокРАсценки;

Перем ДанныеТекПартии; // для поиска спецЦены по строке документа. 


//==========================================================GtG====
Процедура АвтозапускРасценкиТовара ()  
	//----------------------------------
	//Назначение:
	//  
	//  
	//  
	//  
	//----------------------------------
	ЭтаФорма.ОтключитьОбработчикОжидания("АвтозапускРасценкиТовара");
	ОсновныеДействияФормыРасценить("");
	КоманднаяПанель1СохранитьЦены("");
	
	КоманднаяПанель1Закрыть("");

КонецПроцедуры	//АвтозапускРасценкиТовара
//==========================================================GtG====


Процедура ПриОткрытии()
	// Подставляем регион из склада или из константы
	// регион используется для расчета предельной наценки по ЖНВЛС / СВЛС
	// Запуск расценки Только из формы прихода товара(пока что)
	//------------------------------------------------------------------------
	
 	
	
	
	Попытка
		Документ=ЭтаФорма.ВладелецФормы.Ссылка;
		Если Документ.Склад.ТипСклада=Перечисления.ТипыМХ.Розн Тогда
			УстановитьрозничныеЦеныВДокументе=Истина;
		Иначе
			УстановитьрозничныеЦеныВДокументе=Ложь;
		КонецЕсли;	
		//ФинСкидка=ЭтаФорма.ВладелецФормы.ФинСкидка;
		ЭлементыФормы.ТП.ФиксацияСлева=2;
		ЭлементыФормы.Индикатор.Видимость=Ложь;
		//ЭлементыФормы.ТОварИндюк.Видимость=Ложь;
	Исключение
	КонецПопытки;
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПерерасценкаТоваровНаСкладе") ТОгда
		УстановитьрозничныеЦеныВДокументе=Ложь;
	КонецЕсли;
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.Перерасценка366") ТОгда
		УстановитьрозничныеЦеныВДокументе=Истина;
		РасцениватьВсеСтрокиДокумента=Истина;
		ЗаписыватьЦеныВРегистрЦен=Ложь;
		ПроверятьЗакупкуИРозницу = Ложь;
	КонецЕсли;
	
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПеремещениеТовара") ТОгда
		Если Документ.СкладПолучатель.ТипСклада=Перечисления.ТипыМХ.Опт ТОгда
			
			ПРедупреждение("Расценку товара на оптовом складе делают документом ПЕРЕРАСЦЕНКА ТОВАРА НА СКЛАДЕ!");
			ЭтаФорма.Закрыть();
			Возврат;
			
		Иначе
			
			ЭлементыФормы.ЗаписыватьЦеныВРегистрЦен.Доступность=Ложь;
			ЭлементыФормы.УстановитьрозничныеЦеныВДокументе.Доступность=Ложь;
			
			ЗаписыватьЦеныВРегистрЦен=Ложь;
			УстановитьрозничныеЦеныВДокументе=Истина;
			
			РегионСклада=Документ.СкладПолучатель.Регион;
			Склад=Документ.СкладПолучатель;
			
			КоманднаяПанель2неВыбратьВсеРег("");
			Для каждого Стр из ВыбРег Цикл
				Если Стр.Значение=РегионСклада ТОгда
					Стр.Пометка=Истина;
				КонецЕсли;	
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если  ИспользоватьЦеныКонкурентов = Истина Тогда
		ЭлементыФормы.ТП.Колонки.МинимальнаяЦена.Видимость=Истина;
		ЭлементыФормы.ТП.Колонки.СредневзвешеннаяЦена.Видимость=Истина;
		ЭлементыФормы.ТП.Колонки.Конкурент.Видимость=Истина;
	Иначе
		ЭлементыФормы.ТП.Колонки.МинимальнаяЦена.Видимость=Ложь;
		ЭлементыФормы.ТП.Колонки.СредневзвешеннаяЦена.Видимость=Ложь;
		ЭлементыФормы.ТП.Колонки.Конкурент.Видимость=Ложь;
	КонецЕсли;	
	
	
	//==================<Регионы по авторасценке>===================GtG====21.11.2008

		// только для поступления товара
		Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПеремещениеТовара") ТОгда
			РегионСклада=Документ.СкладПолучатель.Регион;
			Склад=Документ.СкладПолучатель;
		ИНаче
			РегионСклада=Документ.Склад.Регион;
			Склад=Документ.Склад;
		КОнецЕсли;
		
		
		Если ТипЗнч(Документ)=Тип("ДокументСсылка.РаспоряжениеНаПереоценку") ТОгда
              РасцениватьВсеСтрокиДокумента=Истина;
		КонецЕсли;	
		
		
		Если Склад.ТипСклада=Перечисления.ТипыМХ.Розн ТОгда  // только по региону аптеки
			
			Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПоступлениеТовара") ТОгда
				ЗаписыватьЦеныВРегистрЦен=Истина; // по приходам пишем в регистр цен
			КонецЕсли;	
			
			УстановитьрозничныеЦеныВДокументе=Истина;// по розничным складам цену пицем в документ
			
			КоманднаяПанель2неВыбратьВсеРег("");
			Для каждого Стр из ВыбРег Цикл
				Если Стр.Значение=РегионСклада ТОгда
					Стр.Пометка=Истина;
				КонецЕсли;	
			КонецЦикла;	
		Иначе
			КоманднаяПанель2ВыбратьВсеРЕг(""); // по всем регионам
		КонецЕсли;
		
		
		ВыводитьНеРасцененные=Истина; // что расценится то и выведем
		

	//================================================GtG====КОНЕЦ==21.11.2008
	
	
	
КонецПроцедуры

 
Функция ПолучитьТаблицуЦенКонкурентов()
	
	ЭлементыФормы.ХодРасценкиТОвар.Заголовок="Получаем таблицу цен конкурентов...";

	
	ТХТ = "ВЫБРАТЬ
	      |	Конкуренты.Наименование КАК ИмяКонкурента,
	      |	Конкуренты.Вес,
	      |	ЦеныКонкурентов.Цена,
	      |	ВыборкаТовары.Товар,
	      |	ВыборкаТовары.КодТовара,
	      |	Конкуренты.Код КАК КодКонкурента
	      |ПОМЕСТИТЬ ВремВыборка
	      |ИЗ
	      |	РегистрСведений.ЦеныКонкурентов КАК ЦеныКонкурентов
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      |			товары.Товар КАК Товар,
	      |			товары.Товар.Код КАК КодТовара
	      |		ИЗ
	      |			Документ.ПоступлениеТовара.Товар КАК товары
	      |		ГДЕ
	      |			товары.Ссылка = &Документ) КАК ВыборкаТовары
	      |		ПО (ВыборкаТовары.КодТовара = ЦеныКонкурентов.КодТовараСправочной)
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонкурентыЕГК КАК Конкуренты
	      |		ПО ЦеныКонкурентов.КодКонкурента = Конкуренты.Код
	      |			И (Конкуренты.Вес > 0)
	      |			И (Конкуренты.ЗагружатьДанные = ИСТИНА)
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |ВЫБРАТЬ
	      |	МАКСИМУМ(ВремВыборка.ИмяКонкурента) КАК ИмяКонкурента,
	      |	ВремВыборка.КодТовара,
	      |	выборка2.МинЦена
	      |ПОМЕСТИТЬ ВыборкаМинЦен
	      |ИЗ
	      |	ВремВыборка КАК ВремВыборка
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      |			МИНИМУМ(ВремВыборка.Цена) КАК МинЦена,
	      |			ВремВыборка.КодТовара КАК КодТовара
	      |		ИЗ
	      |			ВремВыборка КАК ВремВыборка
	      |		ГДЕ
	      |			ВремВыборка.Вес > 0
	      |		
	      |		СГРУППИРОВАТЬ ПО
	      |			ВремВыборка.КодТовара) КАК выборка2
	      |		ПО ВремВыборка.КодТовара = выборка2.КодТовара
	      |			И ВремВыборка.Цена = выборка2.МинЦена
	      |ГДЕ
	      |	ВремВыборка.Вес > 0
	      |
	      |СГРУППИРОВАТЬ ПО
	      |	ВремВыборка.КодТовара,
	      |	выборка2.МинЦена
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |ВЫБРАТЬ
	      |	ЕСТЬNULL(СУММА(ВремВыборка.Цена * ВремВыборка.Вес) / СУММА(ВремВыборка.Вес), 0) КАК СВЦена,
	      |	ВремВыборка.Товар,
	      |	ВремВыборка.КодТовара,
	      |	ВыборкаМинЦен.ИмяКонкурента,
	      |	ВыборкаМинЦен.МинЦена
	      |ИЗ
	      |	ВремВыборка КАК ВремВыборка
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыборкаМинЦен КАК ВыборкаМинЦен
	      |		ПО (ВыборкаМинЦен.КодТовара = ВремВыборка.КодТовара)
	      |ГДЕ
	      |	ВремВыборка.Вес > 0
	      |
	      |СГРУППИРОВАТЬ ПО
	      |	ВремВыборка.Товар,
	      |	ВремВыборка.КодТовара,
	      |	ВыборкаМинЦен.ИмяКонкурента,
	      |	ВыборкаМинЦен.МинЦена
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |УНИЧТОЖИТЬ ВремВыборка
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |УНИЧТОЖИТЬ ВыборкаМинЦен";
		  
	Запрос  = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Документ",Документ);
	ТЗЦенКонкурентов = Запрос.Выполнить().Выгрузить();
	Для каждого стр из ТЗЦенКонкурентов Цикл
		Если стр.СВЦена > 0 Тогда
			Если стр.СВЦена > 0 и стр.СВЦена <= 10	Тогда
				стр.СВЦена = Округлить(стр.СВЦена, Перечисления.СпособыОкруглений.До10коп, Перечисления.МетодыОкругления.Математически);
			ИначеЕсли стр.СВЦена > 10 и стр.СВЦена <= 50 Тогда
				стр.СВЦена = Округлить(стр.СВЦена, Перечисления.СпособыОкруглений.До50коп, Перечисления.МетодыОкругления.Математически);
			ИначеЕсли стр.СВЦена > 50 Тогда
				стр.СВЦена = Округлить(стр.СВЦена, Перечисления.СпособыОкруглений.ДоРуб, Перечисления.МетодыОкругления.Математически);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;	
	Возврат ТЗЦенКонкурентов;
	
КонецФункции
 

Процедура ОсновныеДействияФормыРасценить(Кнопка) Экспорт
	
	Перем СокрСтр;
	
	НачалоРасценки=ТекущаяДата();
	
	
	ЭтаФорма.Панель.ТекущаяСтраница= ЭтаФорма.Панель.Страницы.Найти("Страница1");
	ЭтаФорма.Обновить();
	
	ЭлементыФормы.ХодРасценкиРегион.Видимость=Истина;
	ЭлементыФормы.ХодРасценкиТОвар.Видимость=Истина;
	ЭлементыФормы.Индикатор.Видимость=Истина;
	
	КоличествоОшибокРАсценки=0;
	
	
	Если ЭтаФорма.ВладелецФормы= Неопределено Тогда
		ЭВФ=Документ;
	Иначе
		ЭВФ=ЭтаФорма.ВладелецФормы;
	КонецЕсли;
	
	ДатаДок=ЭВФ.Дата;
	
	СКЛАД=ЭВФ.Склад;

	//------------------<Сколько регионов?>-------------------GtG----09.01.2008
	ТЗРег= Новый ТаблицаЗначений;
	ТЗРег.Колонки.Добавить("Рег");
	Для каждого Стр из ВыбРег Цикл
		Если Стр.Пометка=Истина Тогда
			СтрРег=ТЗРег.Добавить();
			СтрРег.Рег=Стр.Значение;
		КонецЕсли;	
	КонецЦикла;	
	//--------------------------------------------------------GtG----КОНЕЦ--09.01.2008
	Если ТЗРег.Количество() = 0 Тогда
		Предупреждение("Для аптеки не задан регион ценообразования");
		Возврат;
	КонецЕсли;
	
	ПараметрыРасценки = Новый Структура;
	
	ПараметрыРасценки.Вставить("Авторасценка",Ложь) ;
	ПараметрыРасценки.Вставить("Склад",СКЛАД);
	ПараметрыРасценки.Вставить("Документ",Документ) ;
	ПараметрыРасценки.Вставить("ТипДокумента",ТипЗнч(Документ)) ;
	ПараметрыРасценки.Вставить("ВидДокумента",Документ.Метаданные().Имя) ;
	ПараметрыРасценки.Вставить("Комментировать",Истина);
	ПараметрыРасценки.Вставить("ВыводитьНеРасцененные",Истина);
	ПараметрыРасценки.Вставить("Регион",ТЗРег.Получить(0).Рег);//;Склад.Регион);	
	ПараметрыРасценки.Вставить("ДопРегион",ТЗРег.Получить(0).Рег.ДопРегион);//;Склад.Регион);	
	ПараметрыРасценки.Вставить("МинимальныйПроцентНаценкиКромеТопов",0);
	ПараметрыРасценки.Вставить("ЗаписыватьЦеныВРегистрЦен",Истина);
	ПараметрыРасценки.Вставить("УстановитьрозничныеЦеныВДокументе",Истина);
	ПараметрыРасценки.Вставить("ИспользоватьЦеныКонкурентов",Ложь);
	ПараметрыРасценки.Вставить("ПроверятьЗакупкуИРозницу",Истина);

	
	СтруктураРезультата = Расценка.Расценить366(ПараметрыРасценки);
	ЭлементыФормы.ТП.Значение = СтруктураРезультата.ТП;
	ЭлементыФормы.ДеревоОшибок.Значение = СтруктураРезультата.ДеревоОшибок;
	ЭлементыФормы.Таб.Очистить();
	ЭлементыФормы.Таб.Вывести(СтруктураРезультата.ТаблицаКомментариев);
	//СтруктураРезультата.ТаблицаКомментариев.Вывести(ЭлементыФормы.Таб);
	ЭлементыФормы.Таб.Показать();
	КоличествоОшибокРАсценки = СтруктураРезультата.КоличествоОшибокРасценки;
	ТЗКосяков = СтруктураРезультата.ТЗКосяков;
	КонецРасценки=ТекущаяДата();
	
	ВремяВыполнения=КонецРасценки-НачалоРасценки;
	
	ВВМин=Цел(ВремяВыполнения/60);
	ВВСек=ВремяВыполнения%60;
	
	ЭлементыФормы.ХодРасценкиТОвар.Заголовок="Готово! "+Формат(ВВМин,"ЧЦ=2; ЧН=00; ЧВН=")+":"+Формат(ВВсек,"ЧЦ=2; ЧН=00; ЧВН=");
	
КонецПроцедуры

Процедура ТПГТТОткрытие(Элемент, СтандартнаяОбработка)
КонецПроцедуры

Процедура КоманднаяПанель1СохранитьЦены(Кнопка)
	
	
	Если ЭтаФорма.ВладелецФормы= Неопределено Тогда
		ЭФВО=ДокОбъект;	
	Иначе
		ЭФВО=ЭтаФорма.ВладелецФормы;
	КонецЕсли;
	
	Если ЭФВО=Неопределено Тогда
		ЭФВО=Документ.ПолучитьОбъект();
	КонецЕсли;	
	
	ЕСли УстановитьрозничныеЦеныВДокументе=Истина Тогда //пихаем их в документ
		
		
		если АвтоРасценка=Ложь 
				и ТипЗнч(Документ)<>Тип("ДокументСсылка.ПеремещениеТовара") 
				и ТипЗнч(Документ)<>Тип("ДокументСсылка.ПереРасценкаТоваров") 
				
			Тогда
			Если  ЭФВО.Проведен=Истина Тогда
				ПРедупреждение("В проведенный документ розничные цены записать не могу!");
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		
		ТОвар=ЭФВО.Товар;
		
		Для каждого СтрТП из ТП Цикл
			
			
			Если СтрТП.ЦенаРозн=0 Тогда
				Если Авторасценка=Ложь ТОгда  // при ручной расценке долбим пока все цены не рассчитаются
					Сообщить("У товара "+СтрТП.ТОвар+" для региона "+СтрТП.регион+" не рассчиталась розничная цена!
					|Чтобы цены сохранились - они все должны быть рассчитаны!");
					продолжить;
				Иначе
					Продолжить; // при авторасценке пропускаем строчку нерасцененного товара
				КонецЕсли;	
			КонецЕсли;	
			
			СтрП=ТОВар.Найти(СтрТП.Партия,"Партия");
			Если СтрП= Неопределено Тогда
				//Сообщить("Не найдена строка с партией "+СтрТП.Партия+" пропускаем...");
				Продолжить;
			КонецЕсли; 
			
			Цена1миншт=СтрТП.ЦенаРозн/СтрТП.КоэффЕит;
			
			СтрП.ЦенаРознНовая=Цена1миншт*СтрП.Коэфф;	
			СтрП.СуммаРознНовая=СтрП.ЦенаРознНовая*СтрП.Количество;
			
			Если  СтрП.СуммаЗакуп<>0 и СтрП.СуммаРознНовая<>0 Тогда
				СтрП.ПроцентРознНац=(СтрП.СуммаРознНовая/СтрП.СуммаЗакуп-1)*100;
			ИначеЕсли СтрП.ЦенаРознНовая<>0 и СтрП.ЦенаЗакуп<>0 ТОГДА
				СтрП.ПроцентРознНац=(СтрП.ЦенаРознНовая/СтрП.ЦенаЗакуп-1)*100;
			КонецЕсли;	
			
			//------------------<Не пропускаем товар с отрицательной наценкой ( косяк разбивки?)>-------------------GtG----01.12.2008
			Если СтрП.ПроцентРознНац<0 Тогда
				Косяк=ТЗКосяков.Добавить();
				Косяк.Партия=СтрП.Партия;
				Косяк.ТОвар=СтрП.Товар;
				Косяк.Косяк="Отрицательная наценка! (Разбивочный товар?) "+СтрП.ПроцентРознНац;
				Косяк.ЦенаПоРасценке=СтрП.ЦенаРозн;
			КонецЕсли;
			
			
			//СтрП.НДСРозн=ОМ3_НДСИзСуммыПоСтавке(СтрП.СуммаРозн,СтрП.СтавкаНДС);
		КонецЦикла;	
		
		Если ТЗКосяков.Количество()>0 ТОгда
			Результат = Ложь;
			//ЛогОшибок = Новый ТекстовыйДокумент;
			//Попытка
			//	ЛогОшибок.Прочитать("\\id-app-01\common\Санакоев\LogErrPrices.csv");
			//Исключение
			//	ЛогОшибок.Записать("\\id-app-01\common\Санакоев\LogErrPrices.csv",КодировкаТекста.ANSI);
			//КонецПопытки;
			
			Для каждого Стр из ТЗКосяков Цикл
				СтрОп=ЭФВО.ОшибкиРасценки.Добавить();
				СтрОП.Товар 	= Стр.Товар;
				СтрОП.Партия 	= Стр.Партия;
				СтрОП.ОписаниеОшибки= Стр.Косяк;
				СтрОП.ЦенаПоРасценке= Стр.ЦенаПоРасценке;
				
				//ЛогОшибок.ДобавитьСтроку(""+Формат(документ.Дата,"ДФ=dd.MM.yyyy") + "|"
				//+ Формат(документ.Номер,"ЧГ=0") + "|"
				//+ ПараметрыРасценки.Склад + "|"
				//+ Стр.Товар + "|"
				//+ Стр.Косяк + "|"
				//+ Стр.ЦенаПоРасценке + "|"
				//+ ПараметрыРасценки.Регион );
				
				
			КонецЦикла;
			//ЛогОшибок.Записать("\\id-app-01\common\Санакоев\LogErrPrices.csv",КодировкаТекста.ANSI);
		КонецЕсли;			
		
	КонецЕсли;
	
	Для н = 0 По 5 Цикл
		Попытка
			ЭФВО.Записать(РежимЗаписиДокумента.Запись);
			Прервать;
		Исключение
			ОбщегоНазначения.Задержка(1);
		КонецПопытки;
	КонецЦикла;
	
	
    	
КонецПроцедуры

Процедура ДеревоОшибокВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	Если ТипЗнч(ВыбраннаяСтрока.Ошибки)<>Тип("Строка") ТОгда
		ВыбраннаяСтрока.Ошибки.ПолучитьФорму().Открыть();
	КонецЕсли;
КонецПроцедуры

Процедура ПоТОваруНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	
	МассивТоваров=ЭтаФорма.ВладелецФормы.Товар.ВыгрузитьКолонку("Товар");
	Элемент.СписокВыбора.ЗагрузитьЗначения(МАссивТоваров);
КонецПроцедуры

Процедура ТПЦенаРознПриИзменении(Элемент)
	
	//Пересчет процентов наценки при изменении розничной цены вручную
	
	ТСР= ЭлементыФормы.ТП.ТекущаяСтрока;
	
	СтрТП=ЭлементыФормы.ТП.ТекущаяСтрока;
	Если СтрТП.ЖНВЛС = Истина Тогда
		//СтрТП.ЦенаОптовая=СтрТП.ЦенаРозн;// затычка
		ЦенаЗакупБезНДС = Окр(СтрТП.ЦенаЗакуп/(1+СтрТП.СтавкаНДС.Ставка/100),2);
		СтрТП.НаценкаОтЗакупки = Окр((СтрТП.ЦенаРозн/(1+СтрТП.СтавкаНДС.Ставка/100) - ЦенаЗакупБезНДС)*100/СтрТП.ЦенаПрБезНДС,2);
	Иначе
		СтрТП.НаценкаОтЗакупки = ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаЗакуп,СтрТП.ЦенаРозн);
	КонецЕсли;
	СтрТП.НаценкаОтЦГР =ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаГосРег,СтрТП.ЦенаРозн);
	СтрТП.НаценкаОтЗакупБезНДС= ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаЗакуп-ОМ3_НДСИзСуммыПоСтавке(СтрТП.ЦенаЗакуп,СтрТП.СтавкаНДС,2),СтрТП.ЦенаРозн);
	СтрТП.НаценкаОтЦПРБНДС=ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаПрБезНДС,СтрТП.ЦенаРозн);
	
КонецПроцедуры

Процедура КоманднаяПанель1Закрыть(Кнопка)
	ЭтаФорма.Закрыть();
КонецПроцедуры

Процедура КоманднаяПанель2ВыбратьВсеРЕг(Кнопка)
	ВыбРег.ЗаполнитьПометки(Истина);
КонецПроцедуры

Процедура КоманднаяПанель2неВыбратьВсеРег(Кнопка)
	ВыбРег.ЗаполнитьПометки(Ложь);

КонецПроцедуры

Процедура КоманднаяПанель2ОбратитьРЕГ(Кнопка)
	Для каждого Стр из ВыбРег Цикл
		Стр.Пометка=Не Стр.Пометка;
	КонецЦикла;	 
КонецПроцедуры

Процедура ТППриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Остаток > 0 Тогда
		ОформлениеСтроки.Ячейки.Товар.ЦветФона = Новый Цвет(104, 240, 90);	
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1кнПоказатьЦеныКонкурентов(Кнопка)
	
	Если Константы.ИспользоватьЦеныКонкурентовПриРасценке.Получить() = Истина Тогда
		ТекСтрока = ЭлементыФормы.ТП.ТекущаяСтрока;
		Если ТекСтрока = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ  ПустаяСтрока(ТекСтрока.Конкурент) Тогда
			Форма = ПолучитьФорму("Обработка.Расценка_v2.Форма.ВсеЦеныКонкурентов");
			Форма.Код = ТекСтрока.Товар.Код;
			Форма.Открыть();
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры


ЭлементыФормы.ХодРасценкиРегион.Видимость=Ложь;
ЭлементыФормы.ХодРасценкиТОвар.Видимость=Ложь;
	
Комментировать=Истина;
ВыводитьНеРасцененные=Истина;

ТХТ="ВЫБРАТЬ
	    |	Регионы.Ссылка как Рег
	    |ИЗ
	    |	Справочник.Регионы КАК Регионы
	    |ГДЕ
	    |	Регионы.ПометкаУдаления = Ложь";
		
Запрос = Новый Запрос;
Запрос.Текст=ТХТ;
	
ВыбРег.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Рег"));

Попытка
	Если ЭтаФорма.ВладелецФормы.Склад.ТипСклада = Перечисления.ТипыМХ.Розн Тогда
		Для каждого Стр из ВыбРег Цикл
			Если Стр.Значение= ЭтаФорма.ВладелецФормы.Склад.Регион ТОгда
				Стр.Пометка=Истина;
			КонецЕсли;
		КонецЦикла;	
	Иначе
		ВыбРег.ЗаполнитьПометки(Истина);
	КонецЕсли;
Исключение
КонецПопытки; 


МинимальныйПроцентНаценкиКромеТопов=0;

ЗаписыватьЦеныВРегистрЦен=Истина;
УстановитьрозничныеЦеныВДокументе=Ложь;
ИспользоватьЦеныКонкурентов = Константы.ИспользоватьЦеныКонкурентовПриРасценке.Получить();
ПроверятьЗакупкуИРозницу = Истина;

