
Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Функция ЗаполнитьТПГТТ(Товар)
	ТХТ = "ВЫБРАТЬ
	      |	Категории.Ссылка КАК Категория,
	      |	ЕСТЬNULL(Выборка.ЕстьТовар, 0) КАК Присутствует
	      |ИЗ
	      |	Справочник.КатегорииUMG КАК Категории
	      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	      |			Матрица.Аптека.КатегорияUMG КАК Категория,
	      |			1 КАК ЕстьТовар
	      |		ИЗ
	      |			РегистрСведений.Матрица КАК Матрица
	      |		ГДЕ
	      |			Матрица.Товар = &ТекТовар) КАК Выборка
	      |		ПО (Выборка.Категория = Категории.Ссылка)
	      |
	      |УПОРЯДОЧИТЬ ПО
	      |	Категории.Наименование";
	
	Запрос=Новый Запрос;
	Запрос.Текст=ТХТ;
	Запрос.УстановитьПараметр("ТекТОвар",Товар);
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	
	Возврат ТЗ;		
КонецФункции

Функция ЗаполнитьАпт (Товар,Категория="")  
	//----------------------------------
	//Назначение:
	//  Заполняет тч аптек по выбранному товару ебзу чета / с учетом ГТТ
	//  
	//  
	//  тормозящий ертминал ето ппиец
	//----------------------------------
	
	Если Категория=""  Тогда
		ЭлементыФормы.Надпись_Апт.Заголовок="Аптеки (по всем категориям)";
	иначе
		ЭлементыФормы.Надпись_Апт.Заголовок="Аптеки ("+Категория.наименование+")";
		ТХТГТТ1="	И МХ.КатегорияUMG = &выбКатегория ";
	КонецЕсли;
	
	
	
		
	ТХТ=	"ВЫБРАТЬ
		|	МХ.Ссылка КАК Аптека,
		|	ЕСТЬNULL(Выборка.Присутствует, 0) КАК Присутствует,
		|	ЕСТЬNULL(ВыборкаНЗ.Реклама, 0) КАК Реклама,
		|	МХ.КатегорияUMG КАК Категория
		|ИЗ
		|	Справочник.МестаХранения КАК МХ
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			Матрица.Аптека КАК Аптека,
		|			1 КАК Присутствует
		|		ИЗ
		|			РегистрСведений.Матрица КАК Матрица
		|		ГДЕ
		|			Матрица.Товар = &ВыбТовар) КАК Выборка
		|		ПО (Выборка.Аптека = МХ.Ссылка)
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			МатрицаНЗ_1.Аптека КАК Аптека,
		|			1 КАК Реклама
		|		ИЗ
		|			РегистрСведений.МатрицаНЗ КАК МатрицаНЗ_1
		|		ГДЕ
		|			МатрицаНЗ_1.Товар = &ВыбТовар
		|			И МатрицаНЗ_1.ВидНЗ = ЗНАЧЕНИЕ(Перечисление.ВидыНЗ.НЗ_1)) КАК ВыборкаНЗ
		|		ПО (ВыборкаНЗ.Аптека = МХ.Ссылка)
		|ГДЕ
		|	МХ.ПометкаУдаления = ЛОЖЬ
		|	"+ТХТГТТ1+" 
		|
		|УПОРЯДОЧИТЬ ПО
		|	МХ.КатегорияUMG"  ;
	
	
	Если ТипЗнч(Товар)=Тип("ЭлементСпискаЗначений") ТОгда
		Товарец=Товар.Значение;
	Иначе
		Товарец=Товар;
	КонецЕсли; 	
	
	
	
	Запрос=Новый Запрос;
	Запрос.Текст=ТХТ;
	Запрос.УстановитьПараметр("ВыбТовар",Товарец);
	Запрос.УстановитьПараметр("выбКатегория",Категория);
	Запрос.УстановитьПараметр("ТолькоАптеки",Перечисления.ТипыМХ.Розн);

	
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	Возврат ТЗ;
	
КонецФункции	//ЗаполнитьАпт


Процедура СпрТовараПриАктивизацииСтроки(Элемент)
	
	ТекСтрока = Элемент.ТекущаяСтрока;
	
	ЭлементыФормы.ТП_ГТТ.Значение=ЗаполнитьТПГТТ(ТекСтрока) ;
	Если АптекиБезГТТ = Истина Тогда
		ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт(ТекСтрока) ;
	Иначе
		ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт(ТекСтрока,ТП_ГТТ.Получить(0).Категория) ;
	КонецЕсли;
	
КонецПроцедуры

Процедура ТП_ГТТПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Категория.ПометкаУдаления=Истина ТОгда
		ОформлениеСтроки.ЦветФона=Новый Цвет(255,209,200);
	КонецЕсли;

КонецПроцедуры

Процедура ТП_ГТТПриАктивизацииСтроки(Элемент)
	
	Если АптекиБезГТТ=Истина Тогда
		ЭлементыФормы.Надпись_Апт.Заголовок="Аптеки (по всем ГТТ)";
	Иначе
		ЭлементыФормы.Надпись_Апт.Заголовок="Аптеки ("+Элемент.ТекущиеДанные.Категория+")";
		
		
		Если ЭлементыФормы.АП.ТекущаяСтраница.Имя="ГрупповаяОбработка" тогда
			ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт ( ЭлементыФормы.СписокОтобранныхПозиций.ТекущаяСтрока, Элемент.ТекущаяСтрока.Категория);
		ИначеЕсли ЭлементыФормы.АП.ТекущаяСтраница.Имя="АП" тогда
			ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт ( ЭлементыФормы.СпрТовара.ТекущаяСтрока, Элемент.ТекущаяСтрока.Категория);
		КонецЕсли; 
	КонецЕсли; 
КонецПроцедуры



Процедура СОХРАНЯЛКА_АПТЕК (Товар, Категория)  
	//----------------------------------
	//Назначение:
	//  Сохраняет товар по матрице аптек
	//  Добавляет в ГТТ если в гтт аптеки такого товара еще нет
	//  или удаляет товар из матрицы если галка снята
	//----------------------------------
	
	// пишет в матри цу записи по овтару по каждой аптеке 9если не было рнееа записи)
	// при этом попутндооб влаяет в апгтт тех гтт е гдтовара еще нет
	
	
	// придал унеии товара удаляет его из матрицыап теки
	ТекЭлемАП=Товар;// 
	ТекКатегория   = Категория; // 
	ТекСостАпт=Новый ТаблицаЗначений ;
	
	Если АптекиБезГТТ=Истина Тогда
		ТекСостАпт=ЗаполнитьАпт ( ТекЭлемАП); // только по товару
	Иначе
		ТекСостАпт=ЗаполнитьАпт ( ТекЭлемАП, ТекКатегория); // по товару и ГТТ
	КонецЕсли;
	
	// ТекСостАпт - состояние галочек до изменения
	
	//==================<Найдем то что нужно изменить>===================GtG====27.11.2007
	
	НовоеСостАпт=ТП_Матр.Скопировать();
	
	//------------------<Заменим булево на цифирки>-------------------GtG----27.11.2007
	ТекСостАпт.Колонки.Добавить("Действие");
	Для каждого Стр из ТекСостАпт Цикл
		Если Стр.Присутствует=Истина ТОгда
			Стр.Действие=1; // был товар
		Иначе
			Стр.Действие=0; // не было товара
		КонецЕсли; 	
	КонецЦикла;	
	
	НовоеСостАпт.Колонки.Добавить("Действие");
	Для каждого Стр из НовоеСостАпт Цикл
		Если Стр.Присутствует=Истина ТОгда
			Стр.Действие=1; // есть товар
		Иначе
			Стр.Действие=-1; // нет  товара
		КонецЕсли; 	
	КонецЦикла;	
	
	//------------------<Соберем в одну таблицу старое и новое состояние>-------------------GtG----27.11.2007
	Для каждого Стр из НовоеСостАпт Цикл
		СтрД= ТекСостАпт.Добавить();
		СтрД.Аптека=Стр.Аптека;
		СтрД.Действие=Стр.Действие;
	КонецЦикла;	
	
	ТекСостАпт.Свернуть("Аптека","Действие");
	
	//------------------<Получим на выходе 4 варианта>-------------------GtG----27.11.2007
	//Было   Стало  Действие
	// 0       1      1        -- ДОБАВЛЯЕМ
	// 0      -1     -1        -- не было и не появилось - не трогаем   
	// 1       1      2        -- было и осталось - не трогаем  
	// 1      -1      0        -- УДАЛЯЕМ
	
	ЭлементыФормы.Индюк.Видимость=Истина;	
	ЭлементыФормы.Индюк.Значение=0;
	ЭлементыФормы.Индюк.МаксимальноеЗначение=ТекСостАпт.Количество();
	
	МассивИзмерений = Новый Структура;
	МассивИзмерений.Вставить("Товар",ТекЭлемАП);
	
	МассивИзменений = Новый Структура;
	МассивИзменений.Вставить("ГруппаАПИтог",СокрЛП(ТекЭлемАП.Наименование));
	МассивИзменений.Вставить("КтоВнесВМатрицу",ПараметрыСеанса.ТекущийСотр);
	МассивИзменений.Вставить("ДатаВнесенияВМатрицу",ТекущаяДата());
	
	//Блокировка = Новый БлокировкаДанных;
	//БлокировкаМатрицы = Блокировка.Добавить("РегистрСведений.Матрица");
	//БлокировкаМатрицы.УстановитьЗначение("Товар",ТекЭлемАП);
	//Блокировка.Заблокировать();	
	
	
	н=0;
	Для каждого Стр из ТекСостАпт Цикл
		//ЭлементыФормы.Индюк.Значение=ЭлементыФормы.Индюк.Значение+1;
		н=н+1;
		Состояние("Обработано: " + н);
		Если Стр.Действие=-1 или Стр.Действие=2 Тогда
			Продолжить;
		КонецЕсли; 	
		
		Если Стр.Действие=1 Тогда
			//------------------< Добавляем товар в ап гтт аптеки, если там нет >-------------------GtG----27.11.2007
			//Добавляем в матрицу аптеки
			МассивИзмерений.Вставить("Аптека",стр.Аптека);
			ОМ16_ДобавитьТоварВМатрицу("Матрица",МассивИзмерений,МассивИзменений);
		КонецЕсли; 
		
		Если Стр.Действие=0 ТОгда
			//------------------<Удаляем из матрицы аптеки, АП ГТТ не трогаем>-------------------GtG----27.11.2007
			МассивИзмерений.Вставить("Аптека",стр.Аптека);
			ОМ16_УдалитьТоварИзМатрицы("Матрица",МассивИзмерений);
			ОМ16_УдалитьТоварИзМатрицы("МатрицаНЗ",МассивИзмерений);
		КонецЕсли;
	КонецЦикла;	
	
	ЭлементыФормы.Индюк.Видимость=Ложь;
	 
	
	
	
	
КонецПроцедуры	//СОХРАНЯЛКА_АПТЕК


Процедура КоманднаяПанель5ОтобратьТОварДляГрупповухи(Кнопка)
	
	СписокОтобранныхПозиций.Очистить();
	
    Рез=Обработки.ОтборПоФильтру.ПолучитьФорму("Форма").ОткрытьМодально();
	Если Рез= Неопределено Тогда
		ПРедупреждение("Ничего не выбрано!");
		Возврат;
	КонецЕсли; 	
	
	СписокОтобранныхПозиций=Рез.Скопировать();
	
КонецПроцедуры

Процедура КоманднаяПанель5НайтиВАП(Кнопка)
	
	Товар=ЭлементыФормы.СписокОтобранныхПозиций.ТекущаяСтрока.Значение;
	ЭлементыФормы.АП.ТекущаяСтраница= ЭлементыФормы.АП.Страницы.АП;
	ЭлементыФормы.СпрТовара.ТекущаяСтрока=Товар;
	
КонецПроцедуры

Процедура КоманднаяПанель4ОтметитьВсеАптеки(Кнопка)
	Для каждого Стр из ТП_Матр Цикл
		Стр.Присутствует= Истина;
	КонецЦикла;
КонецПроцедуры

Процедура КоманднаяПанель4СнятьОтметкуСАптек(Кнопка)
	Для каждого Стр из ТП_Матр Цикл
		Стр.Присутствует= Ложь;
	КонецЦикла;
КонецПроцедуры

Процедура КоманднаяПанель4ОбратитьОтметкуАптек(Кнопка)
	Для каждого Стр из ТП_Матр Цикл
		Стр.Присутствует= НЕ Стр.Присутствует;
	КонецЦикла;
КонецПроцедуры

Процедура КоманднаяПанель4Сохранить_аПТ(Кнопка)
	
	ТекКатегория=ЭлементыФормы.ТП_ГТТ.ТекущаяСтрока.Категория;
	
	Если ЭлементыФормы.АП.ТекущаяСтраница.Имя="АП"  Тогда    
		
		СОХРАНЯЛКА_АПТЕК (ЭлементыФормы.СпрТовара.ТекущаяСтрока, ТекКатегория) ;
	ИНаче
		
		
		//ЭлементыФормы.Индюк2.МаксимальноеЗначение=СписокОтобранныхПозиций.Количество();
		//ЭлементыФормы.Индюк2.Значение=0;
		//ЭлементыФормы.Индюк2.Видимость=Истина;
		
		Для каждого Стр из СписокОтобранныхПозиций Цикл
			СОХРАНЯЛКА_АПТЕК (Стр.Значение, ТекКатегория) ;
			//ЭлементыФормы.Индюк2.Значение=ЭлементыФормы.Индюк2.Значение+1;
		КонецЦикла;	 
		//ЭлементыФормы.Индюк2.Видимость=Ложь;
	КонецЕсли;    
	
	 //------------------<Обновим таблицы ГТТ и АПтек>-------------------
	ЭлементыФормы.ТП_ГТТ.Значение=ЗаполнитьТПгтт ( ЭлементыФормы.СпрТовара.ТекущаяСтрока) ;
	//==================<Выбрать все аптеки  и поставить галки где  есть>==================
	// учет галочки по всем аптекам
	Если АптекиБезГТТ = Истина Тогда
		ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт ( ЭлементыФормы.СпрТовара.ТекущаяСтрока) ;
	Иначе
		ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт ( ЭлементыФормы.СпрТовара.ТекущаяСтрока,ТП_ГТТ.Получить(0).Категория) ;
	КонецЕсли;


КонецПроцедуры

Процедура КоманднаяПанель3Сохранить_ГТТ(Кнопка)
	
	//Если ЭлементыФормы.АП.ТекущаяСтраница.Имя="АП" ТОгда
	//	
	//	
	//	СОХРАНЯЛКА_ГТТ (ЭлементыФормы.СпрТовара.ТекущаяСтрока);
	//	
	//	
	//ИначеЕсли ЭлементыФормы.АП.ТекущаяСтраница.Имя="ГрупповаяОбработка" ТОгда
	//	
	//	
	//	//ЭлементыФормы.Индюк2.МаксимальноеЗначение=СписокОтобранныхПозиций.Количество();
	//	//ЭлементыФормы.Индюк2.Значение=0;
	//	//ЭлементыФормы.Индюк2.Видимость=Истина;
	//	
	//	Для каждого Стр из СписокОтобранныхПозиций Цикл
	//		 СОХРАНЯЛКА_ГТТ (Стр.Значение);
	//		 //ЭлементыФормы.Индюк2.Значение=ЭлементыФормы.Индюк2.Значение+1;
	//	 КонецЦикла;	
	//	 
	//	// ЭлементыФормы.Индюк2.Видимость=Ложь;
	//	
	//	
	//КонецЕсли;
КонецПроцедуры

Процедура АптекиБезГТТПриИзменении(Элемент)
	
	Если Элемент.Значение=Истина  Тогда
		
		//==================<Выбрать все аптеки  и поставить галки где  есть>===================GtG====26.11.2007
		// БЕЗ учета ГТТ(!) ибо при тычке на товар в справочнике АП неизвестна текущая строка таблицы ГТТ
		ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт ( ЭлементыФормы.СпрТовара.ТекущаяСтрока) ;
		ЭлементыФормы.Надпись_Апт.Заголовок="Аптеки (по всем ГТТ)";
	Иначе
		ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт ( ЭлементыФормы.СпрТовара.ТекущаяСтрока, ЭлементыФормы.ТП_ГТТ.ТекущаяСтрока.Категория) ;
		ЭлементыФормы.Надпись_Апт.Заголовок="Аптеки ("+ЭлементыФормы.ТП_ГТТ.ТекущаяСтрока.Категория.Наименование+")";
	КонецЕсли;
	
КонецПроцедуры

Процедура СписокОтобранныхПозицийПриАктивизацииСтроки(Элемент)
	
	
	Если СписокОтобранныхПозиций.Количество()=0  Тогда  
		Возврат;
	КонецЕсли; 	
	
	ЭлементыФормы.ТП_ГТТ.Значение=ЗаполнитьТПгтт (Элемент.ТекущаяСтрока.Значение) ;
	
	//==================<Выбрать все аптеки  и поставить галки где  есть>===================GtG====26.11.2007
	// БЕЗ учета ГТТ(!) ибо при тычке на товар в справочнике АП неизвестна текущая строка таблицы ГТТ
	ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт (Элемент.ТекущаяСтрока.Значение) ;
	
	
КонецПроцедуры

Процедура ОбновитьРекламу(ПризнакУстановки)
	
	Если ПризнакУстановки = Истина Тогда
		ВремСрокДействия = СрокДействияРекламы;
		ВремУсловиеРекламнойАкции = УсловиеРекламнойАкции;
		ВремНЗ = НЗ;
	Иначе
		//ВремСрокДействия = ОМ3_ПустаяДата();
		//ВремУсловиеРекламнойАкции = Справочники.УсловияПроведенияАкции.ПустаяСсылка();
		//ВремНЗ =0;
	КонецЕсли;	
	МассивИзменений = Новый Структура;
	МассивИзменений.Вставить("РекламнаяАкция",ПризнакУстановки);
	МассивИзменений.Вставить("ДатаНачалаАкции",ДатаНачалаАкции);
	МассивИзменений.Вставить("СрокДействияРекламы",ВремСрокДействия);
	МассивИзменений.Вставить("НЗ",ВремНЗ);
	МассивИзменений.Вставить("УсловиеРекламнойАкции",ВремУсловиеРекламнойАкции);
	МассивИзменений.Вставить("КтоВнесВМатрицу",ПараметрыСеанса.ТекущийСотр);
	МассивИзменений.Вставить("ДатаВнесенияВМатрицу",ТекущаяДата());
	
	
	Если ЭлементыФормы.АП.ТекущаяСтраница.Имя="АП"  Тогда  
		ТекТовар = ЭлементыФормы.СпрТовара.ТекущаяСтрока;
		МассивИзмерений = Новый Структура;
		МассивИзмерений.Вставить("Товар",ТекТовар);
		МассивИзмерений.Вставить("ВидНЗ",ВидНЗ);
		Для каждого стр из ТП_Матр Цикл
			Если стр.Присутствует = Истина Тогда
				МассивИзмерений.Вставить("Аптека",стр.Аптека);
				Если ПризнакУстановки = Истина Тогда
					ОМ16_ДобавитьТоварВМатрицу("МатрицаНЗ",МассивИзмерений,МассивИзменений,Истина);
				Иначе
					ОМ16_УдалитьТоварИзМатрицы("МатрицаНЗ",МассивИзмерений);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	Иначе
		Для каждого СтрСпискаОтобранныхПозиций из СписокОтобранныхПозиций Цикл
			ТекТовар = СтрСпискаОтобранныхПозиций.Значение;
			ЭлементыФормы.СписокОтобранныхПозиций.ТекущаяСтрока = СтрСпискаОтобранныхПозиций;
			//ЭлементыФормы.ТП_Матр.Значение=ЗаполнитьАпт(ТекТовар);
			МассивИзмерений = Новый Структура;
			МассивИзмерений.Вставить("Товар",ТекТовар);
			МассивИзмерений.Вставить("ВидНЗ",ВидНЗ);
			Для каждого стр из ТП_Матр Цикл
				Если стр.Присутствует = Истина Тогда
					МассивИзмерений.Вставить("Аптека",стр.Аптека);
					
					Если ПризнакУстановки = Истина Тогда
						ОМ16_ДобавитьТоварВМатрицу("МатрицаНЗ",МассивИзмерений,МассивИзменений,Истина);
					Иначе
						ОМ16_УдалитьТоварИзМатрицы("МатрицаНЗ",МассивИзмерений);
					КонецЕсли;
					
				КонецЕсли;
			КонецЦикла;		
		КонецЦикла;				
	КонецЕсли;

КонецПроцедуры


Процедура кнУстановитьРекламуНажатие(Элемент)
	
	ОбновитьРекламу(Истина);
	
	
КонецПроцедуры

Процедура кнУдалитьРекламуНажатие(Элемент)
	
	ОбновитьРекламу(Ложь);

КонецПроцедуры

ВидНЗ = Перечисления.ВидыНЗ.НЗ_1;
ДатаНачалаАкции = ТекущаяДата();