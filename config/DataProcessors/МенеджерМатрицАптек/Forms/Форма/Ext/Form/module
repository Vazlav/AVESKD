
Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ВыборВариантИмпортаПриИзменении(Элемент)
	
	Если Элемент.Значение = 1 Тогда
		ИсточникИмпорта = "";
	Иначе
		ИсточникИмпорта = Справочники.МестаХранения.ПустаяСсылка();
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ИсточникИмпортаНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	
	Если ВыборВариантИмпорта = 1 Тогда //из файла
		СтандартнаяОбработка = Ложь;
		Режим = РежимДиалогаВыбораФайла.Открытие;
		ДОФ = Новый ДиалогВыбораФайла(Режим);
		ДОФ.Расширение="*.xls";
		Доф.Фильтр="Файл заказа *.xls|*.xls";
		
		
		Если ДОФ.Выбрать() Тогда
			ИсточникИмпорта=ДОФ.ПолноеИмяФайла;
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ИмпортМатрицы()
	
		
			Если ОчиститьМатрицуПередИмпортом = Истина Тогда
				ТХТ = "ВЫБРАТЬ
				|	&АптекаПриемник как Аптека,
				|	Матрица.Товар КАК Товар,
				|	Матрица.КуМин,
				|	Матрица.КуМакс,
				|	Матрица.КтоВнесВМатрицу,
				|	Матрица.ДатаВнесенияВМатрицу,
				|	Матрица.ГруппаXYZ,
				|	Матрица.ГруппаАПИтог
				|ИЗ
				|	РегистрСведений.Матрица КАК Матрица
				|ГДЕ
				|	Матрица.Аптека = &Аптека";
				Запрос = Новый Запрос;
				Запрос.Текст = ТХТ;		  
				Запрос.УстановитьПараметр("Аптека",ИсточникИмпорта);
				Запрос.УстановитьПараметр("АптекаПриемник",АптекаПриемник);
				
				
				ТЗМатрица = Запрос.Выполнить().Выгрузить();
				Если ТЗМатрица.Количество() = 0 Тогда
					Предупреждение("В матрице источника данных для импорта нет.");
					Возврат;
				КонецЕсли;
				
				Блокировка = Новый БлокировкаДанных;
				БлокировкаМатрицы = Блокировка.Добавить("РегистрСведений.Матрица");
				БлокировкаМатрицы.УстановитьЗначение("Аптека",АптекаПриемник);
				Блокировка.Заблокировать();
				
				Набор = РегистрыСведений.Матрица.СоздатьНаборЗаписей();
				Набор.Отбор.Аптека.Установить(АптекаПриемник);	
				Набор.Загрузить(ТЗМатрица);
				Набор.Записать();
			Иначе
				ТХТ = "ВЫБРАТЬ
				|	&АптекаПриемник как Аптека,
				|	Матрица.Товар,
				|	Матрица.ГруппаXYZ,
				|	Матрица.ГруппаАПИтог,
				|	Матрица.КуМин,
				|	Матрица.КуМакс,
				|	Матрица.КтоВнесВМатрицу,
				|	Матрица.ДатаВнесенияВМатрицу
				|ИЗ
				|	РегистрСведений.Матрица КАК Матрица
				|ГДЕ
				|	Матрица.Аптека = &АптекаИсточник
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ
				|	&АптекаПриемник как Аптека,
				|	МатрицаПриемник.Товар,
				|	МатрицаПриемник.ГруппаXYZ,
				|	МатрицаПриемник.ГруппаАПИтог,
				|	МатрицаПриемник.КуМин,
				|	МатрицаПриемник.КуМакс,
				|	МатрицаПриемник.КтоВнесВМатрицу,
				|	МатрицаПриемник.ДатаВнесенияВМатрицу
				|ИЗ
				|	РегистрСведений.Матрица КАК МатрицаПриемник
				|ГДЕ
				|	МатрицаПриемник.Аптека = &АптекаПриемник
				|	И (НЕ МатрицаПриемник.Товар В
				|				(ВЫБРАТЬ
				|					Выборка.Товар
				|				ИЗ
				|					РегистрСведений.Матрица КАК Выборка
				|				ГДЕ
				|					Выборка.Аптека = &АптекаИсточник))";
				Запрос = Новый Запрос;
				Запрос.Текст = ТХТ;		  
				Запрос.УстановитьПараметр("АптекаИсточник",ИсточникИмпорта);
				Запрос.УстановитьПараметр("АптекаПриемник",АптекаПриемник);
				
				ТЗМатрица = Запрос.Выполнить().Выгрузить();
				Если ТЗМатрица.Количество() = 0 Тогда
					Предупреждение("В матрице источника данных для импорта нет.");
					Возврат;
				КонецЕсли;
				
				Блокировка = Новый БлокировкаДанных;
				БлокировкаМатрицы = Блокировка.Добавить("РегистрСведений.Матрица");
				БлокировкаМатрицы.УстановитьЗначение("Аптека",АптекаПриемник);
				Блокировка.Заблокировать();				
				
				Набор = РегистрыСведений.Матрица.СоздатьНаборЗаписей();
				Набор.Отбор.Аптека.Установить(АптекаПриемник);	
				Набор.Загрузить(ТЗМатрица);
				Набор.Записать();
			
			КонецЕсли;
			Предупреждение("Импорт завершен",10);
			
КонецПроцедуры
	
Процедура ИмпортМатрицыНЗ()
	
		
			Если ОчиститьМатрицуПередИмпортом = Истина Тогда
				ТХТ = "ВЫБРАТЬ
				      |	&АптекаПриемник КАК Аптека,
				      |	Матрица.Товар КАК Товар,
				      |	Матрица.ВидНЗ,
				      |	Матрица.НЗ,
				      |	Матрица.КтоВнесВМатрицу,
				      |	Матрица.ДатаВнесенияВМатрицу,
				      |	Матрица.СрокДействияРекламы,
				      |	Матрица.УсловиеРекламнойАкции,
				      |	Матрица.ДатаНачалаАкции,
				      |	Матрица.РекламнаяАкция
				      |ИЗ
				      |	РегистрСведений.МатрицаНЗ КАК Матрица
				      |ГДЕ
				      |	Матрица.Аптека = &Аптека
				      |	И Матрица.СрокДействияРекламы > &текДата
				      |	И Матрица.РекламнаяАкция = ИСТИНА";
				Запрос = Новый Запрос;
				Запрос.Текст = ТХТ;		  
				Запрос.УстановитьПараметр("ТекДата",ТекущаяДата());
				Запрос.УстановитьПараметр("Аптека",ИсточникИмпорта);
				Запрос.УстановитьПараметр("АптекаПриемник",АптекаПриемник);
				
				
				ТЗМатрица = Запрос.Выполнить().Выгрузить();
				Если ТЗМатрица.Количество() = 0 Тогда
					Предупреждение("В матрице источника данных для импорта нет.");
					Возврат;
				КонецЕсли;
				Набор = РегистрыСведений.МатрицаНЗ.СоздатьНаборЗаписей();
				Набор.Отбор.Аптека.Установить(АптекаПриемник);	
				Набор.Загрузить(ТЗМатрица);
				Набор.Записать();
			Иначе
				ТХТ = "ВЫБРАТЬ
				      |	&АптекаПриемник КАК Аптека,
				      |	Матрица.Товар КАК Товар,
				      |	Матрица.ВидНЗ,
				      |	Матрица.НЗ,
				      |	Матрица.КтоВнесВМатрицу,
				      |	Матрица.ДатаВнесенияВМатрицу,
				      |	Матрица.СрокДействияРекламы,
				      |	Матрица.УсловиеРекламнойАкции,
				      |	Матрица.ДатаНачалаАкции,
				      |	Матрица.РекламнаяАкция
				      |ИЗ
				      |	РегистрСведений.МатрицаНЗ КАК Матрица
				      |ГДЕ
				      |	Матрица.Аптека = &АптекаИсточник
				      |	И Матрица.СрокДействияРекламы > &текДата
				      |	И Матрица.РекламнаяАкция = ИСТИНА
				      |
				      |ОБЪЕДИНИТЬ ВСЕ
				      |
				      |ВЫБРАТЬ
				      |	&АптекаПриемник,
				      |	МатрицаПриемник.Товар,
				      |	МатрицаПриемник.ВидНЗ,
				      |	МатрицаПриемник.НЗ,
				      |	МатрицаПриемник.КтоВнесВМатрицу,
				      |	МатрицаПриемник.ДатаВнесенияВМатрицу,
				      |	МатрицаПриемник.СрокДействияРекламы,
				      |	МатрицаПриемник.УсловиеРекламнойАкции,
				      |	МатрицаПриемник.ДатаНачалаАкции,
				      |	МатрицаПриемник.РекламнаяАкция
				      |ИЗ
				      |	РегистрСведений.МатрицаНЗ КАК МатрицаПриемник
				      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МатрицаНЗ КАК Выборка
				      |		ПО (Выборка.Аптека = &АптекаИсточник)
				      |			И (Выборка.Товар = МатрицаПриемник.Товар)
				      |			И (Выборка.ВидНЗ = МатрицаПриемник.ВидНЗ)
				      |ГДЕ
				      |	МатрицаПриемник.Аптека = &АптекаПриемник
				      |	И Выборка.Товар ЕСТЬ NULL ";
				Запрос = Новый Запрос;
				Запрос.Текст = ТХТ;		  
				Запрос.УстановитьПараметр("ТекДата",ТекущаяДата());
				Запрос.УстановитьПараметр("АптекаИсточник",ИсточникИмпорта);
				Запрос.УстановитьПараметр("АптекаПриемник",АптекаПриемник);
				
				ТЗМатрица = Запрос.Выполнить().Выгрузить();
				Если ТЗМатрица.Количество() = 0 Тогда
					Предупреждение("В матрице источника данных для импорта нет.");
					Возврат;
				КонецЕсли;
				Набор = РегистрыСведений.МатрицаНЗ.СоздатьНаборЗаписей();
				Набор.Отбор.Аптека.Установить(АптекаПриемник);	
				Набор.Загрузить(ТЗМатрица);
				Набор.Записать();
			
			КонецЕсли;
	
	
КонецПроцедуры

Процедура кн_ИмпортироватьМатрицуНажатие(Элемент)
	
	Если АптекаПриемник.Пустая() Тогда
		Предупреждение("Не выбрана аптека-приемник.");
		Возврат;
	КонецЕсли;
	
	
	Если ВыборВариантИмпорта = 2 Тогда
		Если ВидМатрицы = "Матрица" Тогда
			ИмпортМатрицы();
		ИначеЕсли ВидМатрицы = "МатрицаНЗ" Тогда
			ИмпортМатрицыНЗ();
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры

Процедура СформироватьНажатие(Элемент)
	
	ТХТ = "ВЫБРАТЬ
	      |	Матрица.Товар.Код КАК Код,
	      |	Матрица.Товар.Наименование КАК Товар,
	      |	Матрица.ГруппаАПИтог КАК ГруппаАП,
	      |	МатрицаНЗ_1.НЗ КАК НЗ_1,
	      |	МатрицаНЗ_2.НЗ КАК НЗ_2,
		  | ВЫБОР КОГДА МатрицаНЗ_2.НЗ IS NULL ТОГДА МатрицаНЗ_1.РекламнаяАкция ИНАЧЕ МатрицаНЗ_2.РекламнаяАкция КОНЕЦ КАК Акция,
		  | ВЫБОР КОГДА МатрицаНЗ_2.НЗ IS NULL ТОГДА МатрицаНЗ_1.СрокДействияРекламы ИНАЧЕ МатрицаНЗ_2.СрокДействияРекламы КОНЕЦ КАК СрокАкции,
		  | ВЫБОР КОГДА МатрицаНЗ_2.НЗ IS NULL ТОГДА МатрицаНЗ_1.УсловиеРекламнойАкции.Условие ИНАЧЕ МатрицаНЗ_2.УсловиеРекламнойАкции.Условие КОНЕЦ КАК УсловиеАкции,
		  | ВЫБОР КОГДА МатрицаНЗ_2.НЗ IS NULL ТОГДА МатрицаНЗ_1.ДатаНачалаАкции ИНАЧЕ МатрицаНЗ_2.ДатаНачалаАкции КОНЕЦ КАК ДатаНачалаАкции,
		  | ВЫБОР КОГДА МатрицаНЗ_2.НЗ IS NULL ТОГДА МатрицаНЗ_1.СрокДействияРекламы ИНАЧЕ МатрицаНЗ_2.СрокДействияРекламы КОНЕЦ КАК СрокДействияРекламы,
	      |	Матрица.КуМин,
	      |	Матрица.КуМакс,
	      |	Матрица.ДатаВнесенияВМатрицу КАК ДатаВнесения,
		  |	Матрица.ДатаИзменения КАК ДатаИзм,
	      |	Матрица.КтоВнесВМатрицу.Наименование КАК Сотрудник
	      |ИЗ
	      |	РегистрСведений.Матрица КАК Матрица
	      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МатрицаНЗ КАК МатрицаНЗ_1
	      |		ПО (МатрицаНЗ_1.Аптека = &Аптека)
	      |			И Матрица.Товар = МатрицаНЗ_1.Товар
	      |			И (МатрицаНЗ_1.ВидНЗ = ЗНАЧЕНИЕ(Перечисление.ВидыНЗ.НЗ_1))
	      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МатрицаНЗ КАК МатрицаНЗ_2
	      |		ПО (МатрицаНЗ_2.Аптека = &Аптека)
	      |			И Матрица.Товар = МатрицаНЗ_2.Товар
	      |			И (МатрицаНЗ_2.ВидНЗ = ЗНАЧЕНИЕ(Перечисление.ВидыНЗ.НЗ_2))
	      |ГДЕ
	      |	Матрица.Аптека = &Аптека
	      |
	      |УПОРЯДОЧИТЬ ПО
	      |	Товар";	
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Аптека",АптекаПросмотра);
	ТЗ = Запрос.Выполнить().Выгрузить();
	ЭлементыФормы.ТЗПросмотра.Значение = ТЗ;
	
	
КонецПроцедуры

ЭлементыФормы.ВидМатрицы.СписокВыбора.Добавить("Матрица","Матрица");
ЭлементыФормы.ВидМатрицы.СписокВыбора.Добавить("МатрицаНЗ","Матрица НЗ");
ВидМатрицы = "Матрица";

ЭлементыФормы.ВыборВариантИмпорта.СписокВыбора.Добавить(1,"Файл (Excel)");
ЭлементыФормы.ВыборВариантИмпорта.СписокВыбора.Добавить(2,"Матрица аптеки");
ВыборВариантИмпорта = 1;


ОчиститьМатрицуПередИмпортом = Истина;
ЭлементыФормы.ТребованияКФайлу.Заголовок = "Первая строка - шапка, со второй строки - данные
|Список колонок: 
|1. Код товара - целое число
|2. Наименование
|3. Qmin - целое число
|4. Qmax - целое число
|5. Группа АП - в ячейке должна быть одна латинская буква из A,B,C,D,I,S,G";