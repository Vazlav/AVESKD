Перем ДатаСтарта;

Процедура НадписьСостоянияРобота()
	ЭлементыФормы.СостояниеКонстантыОтключенияробота.Заголовок="Загрузка файлов с FTP: "+Формат(Константы.ОстановитьЗагрузкуЧеков.Получить(),"БЛ=Работает; БИ=Остановлен");
КонецПроцедуры	


Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	ПеречитатьСписокАптек();
	
	НадписьСостоянияРобота();
	Загрузить();
КонецПроцедуры

Процедура КоманднаяПанель1ПокоситьКХерамЗагруженныеДанные(Кнопка)
	Запрос=Новый Запрос("ВЫБРАТЬ
	|	СменаККМ.Ссылка
	|ИЗ
	|	Документ.СменаККМ КАК СменаККМ");
	
	
	Для Каждого Стр Из Запрос.Выполнить().Выгрузить() Цикл
		Стр.ссылка.получитьОбъект().Удалить();
	КонецЦикла;
	
КонецПроцедуры

Процедура ПриОткрытии()
    
    ДатаСтарта=ТекущаяДата();
    
    МаксЗначение=1000;// по умолчанию
	НадписьСостоянияРобота();
	ОчиститьСообщения();
КонецПроцедуры


Процедура ПеречитатьСписокАптек()
	
	ПутьКФайлуСписка=Константы.КаталогФТП.Получить()+"KKM_CHECKS_CSV\APT_LOAD_LIST.LST";
	Если НайтиФайлы(ПутьКФайлуСписка).Количество()<>0 Тогда
		МассивКодов=ЗначениеИзФайла(ПутьКФайлуСписка);
		СписокКодовАптек.ЗагрузитьЗначения(МассивКодов);
	КонецЕсли;
	
	
КонецПроцедуры	

Функция ПолучитьИмяБазы()
	ссиб=СтрокаСоединенияИнформационнойБазы();
	ПозРеф=Найти(ССИБ,"Ref=");
	ИМяБазы=Сред(ССИБ,ПозРеф+5);
	ИМяБазы=Лев(ИМяБазы,Найти(ИМяБазы,"""")-1);
	Возврат ИмяБазы;
КонецФункции


Функция ВычислитьВремяАптайма()
    
    Запрос=Новый Запрос(  "	ВЫБРАТЬ
    |		РАЗНОСТЬДАТ(&Дата1, &Дата2, МИНУТА) КАК Аптайм
    |"); // Сгенерировано в GtG's Консоль запросов. 14.05.2014 15:50:11
    
    Запрос.УстановитьПараметр("Дата1",ДатаСтарта);
    Запрос.УстановитьПараметр("Дата2",ТекущаяДата());
    
    АптаймМин=Запрос.Выполнить().Выгрузить().Получить(0).Аптайм;
    
    Часы=цел(АптаймМин / 60);
    Минуты= АптаймМин-Часы*60;
    
    Возврат ""+Часы+":"+Минуты; 
КонецФункции






Процедура ЗагрузитьРобот()
	
	Если Константы.ОстановитьЗагрузкуЧеков.Получить()=Истина Тогда
		ОтключитьОбработчикОжидания("ЗагрузитьРобот");
		// виснет почему-то ?? Предупреждение("Константа Остановить загрузку чеков - истина. Закрываем робота!",10);
		Сообщить("Константа Остановить загрузку чеков - истина. Закрываем робота!");
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли;

	
	МодульРегламентныхЗаданий.Регламент_ВыручкаCSV_ЗаписьВЛог(""+Формат(кодначало,"ЧГ=0")+"--"+Формат(кодконец,"ЧГ=0")+ " на "+ИмяКомпьютера() ,"ПИНГ");
	
	УстановитьЗаголовокСистемы(" "+ПолучитьИмяБазы()+" Чеки (вер.7.5) с "+КодНачало+" по "+КодКонец);

	
	
	ПеречитатьСписокАптек();
	
	НадписьСостоянияРобота();
    
    
    ЭлементыФормы.НАптайм.Заголовок="Работает "+ВычислитьВремяАптайма();
    
    
    
    
	
	ОчиститьСообщения();
	Сообщить("Робот начал "+ТекущаяДата());
	ОтключитьОбработчикОжидания("ЗагрузитьРобот");
	
	Загрузить();

	Сообщить("Робот кончил "+ТекущаяДата());
    
    
    Если Константы.ОстановитьЗагрузкуЧеков.Получить()=Истина Тогда
		// виснет почему-то ?? Предупреждение("Константа Остановить загрузку чеков - истина. Закрываем робота!",10);
		Сообщить("Константа Остановить загрузку чеков - истина. Закрываем робота!");
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли;

    
    
    
    
	ПодключитьОбработчикОжидания("ЗагрузитьРобот",60);
	
	ЭлементыФормы.Надпись2.Заголовок="Следующий запуск:"+(ТекущаяДата()+60);
	
	
	
КонецПроцедуры	

Процедура ОсновныеДействияФормыЗапускРобота(Кнопка)
	НадписьСостоянияРобота();
	ПодключитьОбработчикОжидания("ЗагрузитьРобот",1);
КонецПроцедуры

Процедура КоманднаяПанель1Регламент_Создать_РеализацииККМ(Кнопка)
	НадписьСостоянияРобота();
	Регламент_Создать_РеализацииККМ_По_Закрытым_Сменам();
КонецПроцедуры

Процедура КоманднаяПанель1СпрятатьВсеФайлыЧековОтЗагрузчика(Кнопка)
	
	КудаПрятатьНаФТП="";
	ВвестиСтроку(КудаПрятатьНаФТП,"Куда прятать на FTP");
	
	КудаПрятатьНаФТП=КудаПрятатьНаФТП+"/";
	КудаПрятатьНаФТП=СтрЗаменить(КудаПрятатьНаФТП,"//","/");
	
	
	
	ПодключитьсяКФТП();
	

	Пока Истина Цикл
		МассивФайловФТП=FTPСоединение.НайтиФайлы("/","*.csv",ложь);
		Если МассивФайловФТП.Количество()=0 Тогда
			Прервать;
		КонецЕсли;
		
		Для Каждого Ф Из МассивФайловФТП Цикл
			Состояние(Ф.Имя);
			FTPСоединение.Переместить(Ф.ПолноеИмя,КудаПрятатьНаФТП+Ф.Имя);
		КонецЦикла;	
		
	КонецЦикла;
	
КонецПроцедуры




Процедура КоманднаяПанель2ДобавитьКЗА(Кнопка)
	НадписьСостоянияРобота();
	КодАптеки=0;
	ВвестиЧисло(КодАптеки,"Код аптеки",10,0);
	Если СписокКодовАптек.НайтиПоЗначению(КодАптеки)=Неопределено Тогда
		СписокКодовАптек.Добавить(КодАптеки);
	КонецЕсли;
	
	
	
КонецПроцедуры


Процедура КоманднаяПанель2Действие(Кнопка)
	НадписьСостоянияРобота();
	Если Вопрос("Очистить список кодов?",РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да Тогда
		СписокКодовАптек.Очистить();
	КонецЕсли;
КонецПроцедуры


Процедура НадписьВключитьНажатие(Элемент)
	Константы.ОстановитьЗагрузкуЧеков.Установить(Ложь);
	НадписьСостоянияРобота();
КонецПроцедуры


Процедура ОтключитьНажатие(Элемент)
	Константы.ОстановитьЗагрузкуЧеков.Установить(Истина);
	НадписьСостоянияРобота();

КонецПроцедуры

Процедура КоманднаяПанель1Регламент_Создать_РеализацииККМ_дефективные(Кнопка)
	НадписьСостоянияРобота();
	Регламент_Создать_РеализацииККМ_По_Закрытым_Сменам(Истина);
КонецПроцедуры

Процедура КоманднаяПанель2СохранитьСписок(Кнопка)
	ПутьКФайлуСписка=Константы.КаталогФТП.Получить()+"KKM_CHECKS_CSV\APT_LOAD_LIST.LST";
	
	МассивКодов=СписокКодовАптек.ВыгрузитьЗначения();
	
	//---------------<Свертка и сортировка>---------------------------// GtG // 07.01.2014 16:59:51
	ТЗСортировки=Новый ТаблицаЗначений();
	ТЗСортировки.Колонки.Добавить("Код");
	Для Каждого Стр Из МассивКодов Цикл
		ТЗСортировки.Добавить().Код=Стр;
	КонецЦикла;
	
	ТЗСортировки.Свернуть("Код","");
	ТЗСортировки.Сортировать("Код");
	
	МассивКодов=ТЗСортировки.ВыгрузитьКолонку("Код");
	
	ЗначениеВФайл(ПутьКФайлуСписка,МассивКодов);
	
	//---------------<Перезагрузка причесаннного списка>---------------------------// GtG // 07.01.2014 17:00:13
	СписокКодовАптек.ЗагрузитьЗначения(МассивКодов);
КонецПроцедуры

Процедура КоманднаяПанель2УдалитьТекСтрокуСпискаАптек(Кнопка)
	СписокКодовАптек.Удалить(ЭлементыФормы.СписокКодовЗагрАптек.ТекущаяСтрока);
КонецПроцедуры

Процедура КоманднаяПанель1ВосстановлениеИПеревыгрузкаЧековИзБэкапа(Кнопка)
	
	ФормаЗакрытия = ПолучитьФорму("ПерезагрузкаВыручкиПоФайламИзБэкапа");
	ФормаЗакрытия.ВладелецФормы = ЭтаФорма;
	ФормаЗакрытия.Открыть();
	
	//Обр=Обработки.ЗагрузкаЧеков_CSV_ПеревыгрузкаФайловИзБэкапа.Создать();
	//Обр.ПолучитьФорму("ПерезагрузкаВыручкиПоФайламИзБэкапа",ЭтаФорма).Открыть();
	
КонецПроцедуры


Процедура КоманднаяПанель2ДобавитьНовыеАптеки(Кнопка)
	// Ищем в каталоге бэкапа аптеки, у которых есть данные по чекам начиная со вчерашнего дня
 Сервер="192.168.10.1";
	Порт=2121;
	ИмяПользователя ="check";
	ПарольПользователя="Check_Upload";
	Прокси ="";
	ПассивноеСоединение=Истина;
	Таймаут=30;
	
	FTPСоед=Новый  FTPСоединение(Сервер, Порт, ИмяПользователя, ПарольПользователя, Прокси, ПассивноеСоединение, Таймаут) ;
	
	ГодФайлов=Формат(Год(ТекущаяДата()),"ЧГ=");
	
	МассивФайловКодовАптек=FTPСоед.НайтиФайлы("/backup/"+ГодФайлов,"*");
	
	
	ТЗКодовАптек=Новый ТаблицаЗначений;
	ТЗКодовАптек.Колонки.Добавить("Код");
	
	
	
	
	Для Каждого ПапкаАпт Из МассивФайловКодовАптек Цикл
		
		Добавлен=Ложь;
		
		ТекКодАптеки= Число(ПапкаАПТ.ИмяБезРасширения);
		
		МассивПапокКасс=FTPСоед.НайтиФайлы(ПапкаАПТ.ПолноеИмя,"*");
		
		
		
		Для Каждого ПапкаКассы Из МассивПапокКасс Цикл
			
			Если Добавлен=Истина ТОгда
				Прервать;
			КонецЕсли;	
			
			МассивПапокДат=FTPСоед.НайтиФайлы(ПапкаКассы.ПолноеИмя,Формат(НачалоДня(НачалоДня(ТекущаяДата())-100) ,"ДФ=yyyy-MM-dd" ));
			
			Для Каждого ПапкаДаты Из МассивПапокДат Цикл
				
				Если Добавлен=Истина ТОгда
					Прервать;
				КонецЕсли;	
				
				ДатаВыручки=Дата(СтрЗаменить(ПапкаДаты.ИмяБезРасширения,"-",""));
				
				Если НачалоДня(ДатаВыручки)<НачалоДня(ТекущаяДата()) ТОгда
					ТЗКодовАптек.Добавить().Код=ТекКодАптеки;
					Добавлен=Истина;
				КонецЕсли;	
				
				
								
			КонецЦикла;	
		КонецЦикла;
		
	КонецЦикла;
	
	
	ТЗКодовАптек.Свернуть("Код","");
	
	
	Для Каждого Стр Из ТЗКодовАптек Цикл
		Если СписокКодовАптек.НайтиПоЗначению(Стр.Код)= Неопределено ТОгда
			СписокКодовАптек.Добавить(Стр.Код);
			Сообщить("Добавлена аптека с кодом "+Стр.Код);
		КонецЕсли;
	КонецЦикла;
			
	
	Если Вопрос("Сохранить список аптек?",РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да ТОгда
		КоманднаяПанель2СохранитьСписок("");
	КонецЕсли;	
КонецПроцедуры

Процедура КоманднаяПанель1ЗакрытьСменыЗаУказаннуюДату(Кнопка)
    
    ДатаЗакрытия=ТекущаяДата();
    ВвестиДату(ДатаЗакрытия,"Дата закрытия",ЧастиДаты.Дата);
    
    Регламент_Создать_РеализацииККМ_По_Закрытым_Сменам(ложь,Истина, ДатаЗакрытия,Ложь,Неопределено);

    
    
КонецПроцедуры

Процедура КоманднаяПанель1ОстановитьВсеЗагрузчики(Кнопка)
    Константы.ОстановитьЗагрузкуЧеков.Установить(Истина);
КонецПроцедуры

Процедура КоманднаяПанель1РазрешитьЗапускЗагрузчиков(Кнопка)
    // Вставить содержимое обработчика.
    Константы.ОстановитьЗагрузкуЧеков.Установить(Ложь);
КонецПроцедуры


//---------------<На время тестирования на рабочей базе>---------------------------// GtG // 11.12.2013 21:36:04
//СписокКодовАптек.Очистить();
//СписокКодовАптек.Добавить(30);// МО, Балашиха, Советская, 11а Аптека №33
//СписокКодовАптек.Добавить(427);//  Москва, ул. Краснопролетарская, д. 16, стр. 2 Аптека №276
//СписокКодовАптек.Добавить(179);//  Москва, Сиреневый бульвар, 69 Аптека №118
//СписокКодовАптек.Добавить(250);//  Москва, Рязанский проспект, 66 Аптека №191
//СписокКодовАптек.Добавить(338);//  Москва, Отрадный проезд, 3А Аптека №244
//СписокКодовАптек.Добавить(36);//  Москва, Фрунзенская набережная, д. 30, стр. 2 Аптека №24
//СписокКодовАптек.Добавить(249);//  Москва, Рогожский вал , 2/50. Аптека №190
//СписокКодовАптек.Добавить(11);//  Черняховского
//СписокКодовАптек.Добавить(122);//  Черняховского
//СписокКодовАптек.Добавить(6);//  Черняховского
//СписокКодовАптек.Добавить(269); // ЗДОРОВЬЕ Москва, Адмирала Лазарева, д.47, корп. 1 (КОМИССИОНЕР)

ПеречитатьСписокАптек();







ГрузитьЗакрытиеСмен=Истина;
ГрузитьСлужебныеЧеки=Истина;
ГрузитьЧеки=Истина;
СоздаватьРеализацииККМ=Истина;
ГрузитьИсправленныеЧеки=Истина;
ЧасЗакрытияКривыхСмен=1;