
Процедура КоманднаяПанель1Заполнить(Кнопка)
	
	Запрос=Новый Запрос();
	Запрос.Текст= "ВЫБРАТЬ РАЗЛИЧНЫЕ
	              |	СменаККМ.КодСклада КАК Код,
	              |	СменаККМ.Склад КАК аптека,
	              |	СУММА(СменаККМ.КоличествоЧеков - СменаККМ.ЗагруженоЧеков) КАК dКЧ,
	              |	НАЧАЛОПЕРИОДА(СменаККМ.Дата, ДЕНЬ) КАК Дата
	              |ИЗ
	              |	Документ.СменаККМ КАК СменаККМ
	              |ГДЕ
	              |	СменаККМ.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата1, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата2, ДЕНЬ)
	              |
	              |СГРУППИРОВАТЬ ПО
	              |	СменаККМ.КодСклада,
	              |	СменаККМ.Склад,
	              |	НАЧАЛОПЕРИОДА(СменаККМ.Дата, ДЕНЬ)
	              |
	              |ИМЕЮЩИЕ
	              |	СУММА(СменаККМ.КоличествоЧеков) <> СУММА(СменаККМ.ЗагруженоЧеков)
	              |
	              |УПОРЯДОЧИТЬ ПО
	              |	СменаККМ.КодСклада,
	              |	Дата"; // Сгенерировано в GtG's Консоль запросов. 03.01.2014 14:02:44
	
	Запрос.УстановитьПараметр("Дата1",НачалоДня(НачПериода));
	Запрос.УстановитьПараметр("Дата2",КонецДня(КонПериода));
	
	ЭлементыФормы.АптекиНаПеревыгрузку.Значение=Запрос.Выполнить().Выгрузить();
	
	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыУдалитьРеализацииККМ_и_СменыККМ(Кнопка)
	Запрос=Новый Запрос();
	Запрос.Текст= "	ВЫБРАТЬ
|		РеализацияККМ.Ссылка
|	ИЗ
|		Документ.РеализацияККМ КАК РеализацияККМ
|	ГДЕ
|		РеализацияККМ.Склад В(&Склады)
|		И РеализацияККМ.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)
|	
|	ОБЪЕДИНИТЬ ВСЕ
|	
|	ВЫБРАТЬ
|		СменаККМ.Ссылка
|	ИЗ
|		Документ.СменаККМ КАК СменаККМ
|	ГДЕ
|		СменаККМ.Склад В(&Склады)
|		И СменаККМ.ДатаОткрытияСмены МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)
|
 |"; // Сгенерировано в GtG's Консоль запросов. 03.01.2014 14:16:01

 
 Для Каждого Стр Из АптекиНаПеревыгрузку Цикл
	 
	 Запрос.УстановитьПараметр("Дата",Стр.Дата);
	 Запрос.УстановитьПараметр("Склады",Стр.Аптека);
	 
	 ЕстьНеудалившиеся=Истина;
	 
	 
	 Пока ЕстьНеудалившиеся=Истина Цикл
		 
		 ЕстьНеудалившиеся=Ложь;
		 
		 Рез=Запрос.Выполнить();
		 
		 Выб=Рез.Выбрать();
		 
		 Пока Выб.Следующий() Цикл
			 
			 Объект=Выб.Ссылка.ПолучитьОбъект();
			 
			 Попытка
				 Объект.Удалить();
			 Исключение
				 ЕстьНеудалившиеся=Истина;
			 Конецпопытки;	
			 
		 КонецЦикла;
		 
	 КонецЦикла;	
	 
	 Сообщить("Удалены Реализации ККМ и Смены ККМ по "+Стр.Аптека);
	 
 КонецЦикла;
 
	
КонецПроцедуры

Процедура ОсновныеДействияФормыВосстановитьФайлыИзБэкапа(Кнопка)
	// Восстанавливаем файлы из бэкапа сразу в виндовскую шару, минуя процесс перетаскивания
	// с линуксового фтп на винду через регламендт.
	
	//---------------<Отдельное подключение к фтп>---------------------------// GtG // 03.01.2014 14:37:39
	Сервер="192.168.10.1";
	Порт=2121;
	ИмяПользователя ="check";
	ПарольПользователя="Check_Upload";
	Прокси ="";
	ПассивноеСоединение=Истина;
	Таймаут=30;
	
	Попытка
		FTP=Новый  FTPСоединение(Сервер, Порт, ИмяПользователя, ПарольПользователя, Прокси, ПассивноеСоединение, Таймаут) ;
	Исключение
		Предупреждение("Какая-то проблема с интернетом. Нет доступа к FTP серверу "+символы.пс+ОписаниеОшибки(),15);
		Возврат;
	КонецПопытки;
	//---------------<>---------------------------// GtG // 03.01.2014 14:37:53
	
	ПутьВиндовскойШары=Константы.КаталогФТП.Получить()+"KKM_CHECKS_CSV";
	
	ВсегоВосстановлено=0;
	
	Для Каждого Стр Из АптекиНаПеревыгрузку Цикл
		
		Сообщить("Восстанавливаем чеки за "+Стр.Дата+" по аптеке "+Стр.Аптека);
		
		ПутьКФайламБэкапа="/backup/"+Формат(Стр.Дата,"ДФ=yyyy")+"/"+Формат(Стр.Код,"ЧЦ=5; ЧВН=; ЧГ=");//  /backup/2014/00064/0000200303/2014-01-01
		
		//попытка
			СписокПутейККассам=FTP.НайтиФайлы(ПутьКФайламБэкапа,"*",ложь);
		//Исключение
        если СписокПутейККассам.Количество()=0  тогда
            Сообщить("Нет ничего по коду "+Формат(Стр.Код,"ЧЦ=5; ЧВН=; ЧГ="));
            продолжить;
        конецесли;    
		//Конецпопытки;
		
		Для Каждого ПапкаКассы Из СписокПутейККассам Цикл
			
			Сообщить(ПапкаКассы.ПолноеИмя);
			// это типа  /backup/2014/00064/0000200303
			
			ПапкаДатыВыручки=ПапкаКассы.ПолноеИмя+"/"+Формат(Стр.Дата,"ДФ=yyyy-MM-dd");
			//Попытка
            
				СписокФайловДляВосстановления=FTP.НайтиФайлы(ПапкаДатыВыручки,"*.csv",ложь);
                если СписокФайловДляВосстановления.Количество()=0 тогда
                    //Исключение
                    Сообщить("Нет файлов по дате по коду "+Формат(Стр.Код,"ЧЦ=5; ЧВН=; ЧГ="));
                    Продолжить;
                КонецЕсли;
			//КонецПопытки;
			
			КолвоХХХ=СписокФайловДляВосстановления.Количество();
			
		    Сообщить("Найдено для восстановления по аптеке "+Стр.Код+" по кассе "+ПапкаКассы.ИмяБезРасширения+" файлов для перевыгрузки "+КолвоХХХ+" штук");
			
			//---------------<Определяем версию формата в который восстанавливать>---------------------------// GtG // 09.01.2014 12:56:29
			// Если есть хотя бы один чек с именем типа ???_ то эту смену нужно грузить в первом формате.
			// второй от первого отличается наличием доп колонки с ид смены
			
			ПервыйФормат=Ложь;
			Для Каждого Файл Из СписокФайловДляВосстановления Цикл
				
				Если Найти(Файл.Имя,"hdr_")<>0 или
					Найти(Файл.Имя,"str_")<>0 или
					Найти(Файл.Имя,"adv_")<>0 или
					Найти(Файл.Имя,"sys_")<>0 тогда
					ПервыйФормат=Истина;
					Прервать;
				КонецЕсли;	
				
			КонецЦикла;
			
			ХХХ=0;
			ПодменаФормата=0;
			Для Каждого Файл Из СписокФайловДляВосстановления Цикл
				ХХХ=ХХХ+1;
				
				Если ПервыйФормат=Истина Тогда
					ФайлИмя=Файл.Имя;
					ФайлИмя=СтрЗаменить(ФайлИмя,"str2_","str_");
					ФайлИмя=СтрЗаменить(ФайлИмя,"hdr2_","hdr_");
					ФайлИмя=СтрЗаменить(ФайлИмя,"sys2_","sys_");
					ФайлИмя=СтрЗаменить(ФайлИмя,"adv2_","adv_");
					ПодменаФормата=ПодменаФормата+1;
				Иначе
					ФайлИмя=Файл.Имя;
				Конецесли;	
				
				
				
				FTP.Получить(Файл.ПолноеИмя,ПутьВиндовскойШары+"\"+ФайлИмя);
				Состояние("Скопировано "+ХХХ+" из "+КолвоХХХ+" по апт."+Стр.Код+" Подмена формата у "+ПодменаФормата+" файлов");
			КонецЦикла;	
			
			ВсегоВосстановлено=ВсегоВосстановлено+ХХХ;
			
	    КонецЦикла;		
	КонецЦикла;
	
	Предупреждение("Восстановлено "+ВсегоВосстановлено+" файлов",10);
	
	
КонецПроцедуры

Функция КолвоДней()
	Запрос=Новый Запрос("ВЫБРАТЬ
	                    |	РАЗНОСТЬДАТ(&НачПериода, &КонПериода, ДЕНЬ) КАК Дельта");
	Запрос.УстановитьПараметр("НачПериода",НачПериода);
	Запрос.УстановитьПараметр("КонПериода",КонПериода);
	
	Рез=Запрос.Выполнить();
	
	Выб=Рез.Выбрать();
	Выб.Следующий();
	
	Возврат Выб.ДЕЛЬТА;
	
	
КонецФункции	

Процедура АптекиНаПеревыгрузкуПередНачаломДобавления(Элемент, Отказ, Копирование)
	Отказ=Истина;
	
	ФВ=Справочники.МестаХранения.ПолучитьФормуВыбора("ФормаСписка");
	ФВ.МножественныйВыбор=Истина;
	ФВ.ОткрытьМодально();
	
	КД=КолвоДней();
	
	для Каждого Стр из ФВ.ЭлементыФормы.СправочникСписок.ВыделенныеСтроки Цикл
		
		Для Ы=0 По КД Цикл
			
			Апт=АптекиНаПеревыгрузку.Добавить();
			Апт.Код=Стр.Код;
			Апт.Аптека=Стр;
			Апт.Дата=НачПериода+Ы*60*60*24;
		КонецЦикла;
	КонецЦикла;	
		
	
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель1Очистить(Кнопка)
	
	АптекиНаПеревыгрузку.Очистить();
КонецПроцедуры

Процедура ОсновныеДействияФормыПринудительноЗакрытьСмены(Кнопка)
	
    Для Каждого Стр Из АптекиНаПеревыгрузку Цикл
        Сообщить(Стр.Аптека);
        
        Запрос=Новый Запрос();
        Запрос.Текст="ВЫБРАТЬ
                     |  СменаККМ.Ссылка
                     |ИЗ
                     |  Документ.СменаККМ КАК СменаККМ
                     |ГДЕ
                     |  СменаККМ.Проведен = Истина
                     |  И СменаККМ.Склад = &Склад
                     |  И СменаККМ.ДатаОткрытияСмены между началопериода(&ДатаОткрытияСмены,день)  и конецпериода(&ДатаОткрытияСмены,день)";
        
        Запрос.УстановитьПараметр("Склад",Стр.Аптека);
        Запрос.УстановитьПараметр("ДатаОткрытияСмены",Стр.Дата);
        
        Выб=Запрос.Выполнить().Выбрать();
        Пока Выб.Следующий() Цикл
            Сообщить("  Закрываем смену "+Выб.ссылка);
            
            НеПроверятьВремяЗакрытия=Истина;// позволит принудительно закрыть даже кривоватую смену и создаст РККМ
            ВладелецФормы.ЭтотОбъект.СТАНДАРТНОЕ_ЗАКРЫТИЕ_ОДНОЙ_СМЕНЫ(Выб.ссылка,НеПроверятьВремяЗакрытия);
        КонецЦикла;
	КонецЦикла;
	
	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыГенератор_скрипта_выгрузкиИзАптеки(Кнопка)
	
БазовыйТекст=	
"SELECT
| 'sales', 
| aid,
| cash.save_str_to_csv(aid), 
| ndoc::varchar(20), 
| ddoc  
| FROM cash.cash_str 
|	WHERE id_type in (1, 2) 
|	and 
|	id_hdr in (Select aid from cash.cash_hdr where ddoc::date = '####')

|union all

|SELECT
| 'system', 
| aid,
| cash.save_sys_to_csv(aid), 
| ndoc::varchar(20), 
| ddoc  
| FROM cash.cash_str 
|	WHERE id_type not in (1, 2, 9, 10) 
|	and 
|	id_hdr in (Select aid from cash.cash_hdr where ddoc::date = '####')

|  union all
|  
|  SELECT
| 'avans', 
| aid,
| cash.save_adv_to_csv(aid), 
| ndoc::varchar(20), 
| ddoc  
| FROM cash.cash_str 
|	WHERE id_type in (9, 10) 
|	and 
|	id_hdr in (Select aid from cash.cash_hdr where ddoc::date = '####')

|  union all
|  
|  SELECT
| 'np sales', 
| aid,
| cash.save_np_str_to_csv(aid), 
| ndoc::varchar(20), 
| ddoc  
| FROM cash.cash_str 
|	WHERE id_type in (5, 7) 
|	and 
|	id_hdr in (Select aid from cash.cash_hdr where ddoc::date = '####')

| union all      

| Select 'hdr',
|	aid,
|	cash.save_hdr_to_csv(aid),
|	ndoc::varchar(20),
|	ddoc
| from cash.cash_hdr where ddoc::date = '####' ";

ТХТ=Новый ТекстовыйДокумент;

Для Каждого Стр ИЗ АптекиНаПеревыгрузку Цикл
	 ТХТ.ДобавитьСтроку("-------- "+Стр.Аптека+" /// "+Стр.Код+" /// "+ Формат(Стр.Дата,"ДЛФ=D")+"   ------------------");
	 ТХТ.ДобавитьСтроку("");
	 ТХТ.ДобавитьСтроку(СтрЗаменить(БазовыйТекст,"####",Формат(Стр.Дата,"ДФ=yyyy-MM-dd")  ));
	 ТХТ.ДобавитьСтроку(";");
	 ТХТ.ДобавитьСтроку("");
	
 КонецЦикла;	
 
 ТХТ.Показать();

КонецПроцедуры






