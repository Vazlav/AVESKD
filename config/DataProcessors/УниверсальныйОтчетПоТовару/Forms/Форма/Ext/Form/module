Перем ПоЗапр;
Перем ИсходныйТекстЗапроса;
Перем КаталогХраненияНастроек;
Перем СтрокаУсловийПоТипамДокументов;
Перем РеальныйТекстЗапроса;


Процедура ЛОГ_ВРЕМЕНИ_ВЫПОЛНЕНИЯ(ИД,ИДЗапроса,Начало,Окончание)
	
	ВремяВыполнения=Окончание-Начало ;
	
	Если ВремяВыполнения<60 тогда
		Возврат; // не логгируем запросы выполняющиеся менее 30 секунд
	КонецЕсли; 	
	
	ИФЛОга="\\id-app-01\1C_exchange\EPF_TUNES\LOGS_EPF\"+ИД+"."+Формат(ТекущаяДата(),"ДФ=dd.MM.yyyy")+".ExTimeLOG";
	
	Ф=Новый Файл(ИФЛОга);
	
	Лог=Новый ТекстовыйДокумент;
	
	Если Ф.Существует()=Истина ТОгда
		Лог.Прочитать(ИФЛОга);
	КонецЕсли;
	
	Лог.ДобавитьСтроку(""+ПараметрыСеанса.ТекущийСотр+" | "+ИДЗапроса+" | "+ВремяВыполнения+" | "+Начало+" | "+Окончание);
	
	Лог.Записать(ИФЛОга);
	
	//---------------------- сохраним текущие настройки давщие такой косяяяяк -----------------------
	ПарамСохр=Новый СписокЗначений;
	
	
	
	ВидыДвиженийСтр=ЗначениеВСтрокуВнутр(ВидыДвижений);
	ВидыДокументовСтр=ЗначениеВСтрокуВнутр(ВидыДокументов);
	НастройкиПостроителяСтр= ЗначениеВСтрокуВнутр(Построитель.ПолучитьНастройки());
	
	ПарамСохр.Добавить(ВидыДвиженийСтр);
	ПарамСохр.Добавить(ВидыДокументовСтр);
	ПарамСохр.Добавить(НастройкиПостроителяСтр);
	
	
	СодержимоеФайлаНстроек= ЗначениеВСтрокуВнутр(ПарамСохр);
	
	ТХТ=Новый ТекстовыйДокумент;
	
	ТХТ.ДобавитьСтроку( СодержимоеФайлаНстроек);
	
	
	
	ИмяНастройки="";
	ТХТ.Записать("\\id-app-01\1C_exchange\EPF_TUNES\LOGS_EPF"+"\УОПТ_v2-"+ИДЗапроса+"-ВВ "+ВремяВыполнения+"-("+формат(НачПериода,"ДФ=HH_mm_ss")+"_"+формат(КонПериода,"ДФ=HH_mm_ss")+")-"+ПараметрыСеанса.ТекущийСотр+".var");
	КоманднаяПанель4ОбновитьСписокНастроек("");
	
	ЭлементыФормы.НадписьТекНастр.Заголовок=ИмяНастройки;
	
	
	
	
КонецПроцедуры

ФУНКЦИЯ НачалоЗапроса()
	возврат "ВЫБРАТЬ
	|	BASE.Товар,
	|	BASE.Товар.ПРедставление,
	|	BASE.Склад,
	|	BASE.Склад.Представление,
	|	BASE.Партия,
	|	BASE.Партия.Представление,
	|	BASE.СтавкаНДС,
	|	BASE.СтавкаНДС.Представление,
	|	BASE.Регистратор,
//	|	BASE.Регистратор.Представление,
	|	СУММА(BASE.НачОст_Количество) КАК НачОст_Количество,
	|	СУММА(BASE.НачОст_СуммаЗакуп) КАК НачОст_СуммаЗакуп,
	|	СУММА(BASE.НачОст_НДСЗакуп) КАК НачОст_НДСЗакуп,
	|	СУММА(BASE.НачОст_СуммаРозн) КАК НачОст_СуммаРозн,
	|	СУММА(BASE.НачОст_НДСРозн) КАК НачОст_НДСРозн,
	|	СУММА(BASE.НачОст_ЦенаЗакуп) КАК НачОст_ЦенаЗакуп,
	|	СУММА(BASE.НачОст_ЦенаРозн) КАК НачОст_ЦенаРозн,
	|	СУММА(BASE.НачОст_Наценка) КАК НачОст_Наценка,
	|	СУММА(BASE.Прих_Количество) КАК Прих_Количество,
	|	СУММА(BASE.Прих_СуммаЗакуп) КАК Прих_СуммаЗакуп,
	|	СУММА(BASE.Прих_НДСЗакуп) КАК Прих_НДСЗакуп,
	|	СУММА(BASE.Прих_СуммаРозн) КАК Прих_СуммаРозн,
	|	СУММА(BASE.Прих_НДСРозн) КАК Прих_НДСРозн,
	|	СУММА(BASE.Прих_ЦенаЗакуп) КАК Прих_ЦенаЗакуп,
	|	СУММА(BASE.Прих_ЦенаРозн) КАК Прих_ЦенаРозн,
	|	СУММА(BASE.Прих_Наценка) КАК Прих_Наценка,
	|	СУММА(BASE.Расх_Количество) КАК Расх_Количество,
	|	СУММА(BASE.Расх_СуммаЗакуп) КАК Расх_СуммаЗакуп,
	|	СУММА(BASE.Расх_НДСЗакуп) КАК Расх_НДСЗакуп,
	|	СУММА(BASE.Расх_СуммаРозн) КАК Расх_СуммаРозн,
	|	СУММА(BASE.Расх_НДСРозн) КАК Расх_НДСРозн,
	|	СУММА(BASE.Расх_ЦенаЗакуп) КАК Расх_ЦенаЗакуп,
	|	СУММА(BASE.Расх_ЦенаРозн) КАК Расх_ЦенаРозн,
	|	СУММА(BASE.Расх_Наценка) КАК Расх_Наценка,
	|	СУММА(BASE.КонОст_Количество) КАК КонОст_Количество,
	|	СУММА(BASE.КонОст_СуммаЗакуп) КАК КонОст_СуммаЗакуп,
	|	СУММА(BASE.КонОст_НДСЗакуп) КАК КонОст_НДСЗакуп,
	|	СУММА(BASE.КонОст_СуммаРозн) КАК КонОст_СуммаРозн,
	|	СУММА(BASE.КонОст_НДСРозн) КАК КонОст_НДСРозн,
	|	СУММА(BASE.КонОст_ЦенаЗакуп) КАК КонОст_ЦенаЗакуп,
	|	СУММА(BASE.КонОст_ЦенаРозн) КАК КонОст_ЦенаРозн,
	|	СУММА(BASE.КонОст_Наценка) КАК КонОст_Наценка
	|{ВЫБРАТЬ
	|	Товар.*,
	|	Склад.*,
	|	Партия.*,
	|	СтавкаНДС.*,
	|	Регистратор.*,
	|	НачОст_Количество,
	|	НачОст_СуммаЗакуп,
	|	НачОст_НДСЗакуп,
	|	НачОст_СуммаРозн,
	|	НачОст_НДСРозн,
	|	НачОст_ЦенаЗакуп,
	|	НачОст_ЦенаРозн,
	|	НачОст_Наценка,
	|	Прих_Количество,
	|	Прих_СуммаЗакуп,
	|	Прих_НДСЗакуп,
	|	Прих_СуммаРозн,
	|	Прих_НДСРозн,
	|	Прих_ЦенаЗакуп,
	|	Прих_ЦенаРозн,
	|	Прих_Наценка,
	|	Расх_Количество,
	|	Расх_СуммаЗакуп,
	|	Расх_НДСЗакуп,
	|	Расх_СуммаРозн,
	|	Расх_НДСРозн,
	|	Расх_ЦенаЗакуп,
	|	Расх_ЦенаРозн,
	|	Расх_Наценка,
	|	КонОст_Количество,
	|	КонОст_СуммаЗакуп,
	|	КонОст_НДСЗакуп,
	|	КонОст_СуммаРозн,
	|	КонОст_НДСРозн,
	|	КонОст_ЦенаЗакуп,
	|	КонОст_ЦенаРозн,
	|	КонОст_Наценка}
	|ИЗ
	|	(
	|";
конецФункции	

Функция КонецЗапроса()
	Возврат ") КАК BASE
	|{ГДЕ
	|	BASE.Товар.*,
	|	BASE.Склад.*,
	|	BASE.Партия.*,
	|	BASE.СтавкаНДС.*,
	|	BASE.Регистратор.*,
	|	BASE.НачОст_Количество,
	|	BASE.НачОст_СуммаЗакуп,
	|	BASE.НачОст_НДСЗакуп,
	|	BASE.НачОст_СуммаРозн,
	|	BASE.НачОст_НДСРозн,
	|	BASE.НачОст_ЦенаЗакуп,
	|	BASE.НачОст_ЦенаРозн,
	|	BASE.НачОст_Наценка,
	|	BASE.Прих_Количество,
	|	BASE.Прих_СуммаЗакуп,
	|	BASE.Прих_НДСЗакуп,
	|	BASE.Прих_СуммаРозн,
	|	BASE.Прих_НДСРозн,
	|	BASE.Прих_ЦенаЗакуп,
	|	BASE.Прих_ЦенаРозн,
	|	BASE.Прих_Наценка,
	|	BASE.Расх_Количество,
	|	BASE.Расх_СуммаЗакуп,
	|	BASE.Расх_НДСЗакуп,
	|	BASE.Расх_СуммаРозн,
	|	BASE.Расх_НДСРозн,
	|	BASE.Расх_ЦенаЗакуп,
	|	BASE.Расх_ЦенаРозн,
	|	BASE.Расх_Наценка,
	|	BASE.КонОст_Количество,
	|	BASE.КонОст_СуммаЗакуп,
	|	BASE.КонОст_НДСЗакуп,
	|	BASE.КонОст_СуммаРозн,
	|	BASE.КонОст_НДСРозн,
	|	BASE.КонОст_ЦенаЗакуп,
	|	BASE.КонОст_ЦенаРозн,
	|	BASE.КонОст_Наценка}
	|СГРУППИРОВАТЬ ПО
	|	BASE.Товар,
	|	BASE.Склад,
	|	BASE.Партия,
	|	BASE.СтавкаНДС,
	|	BASE.Регистратор
	|{УПОРЯДОЧИТЬ ПО
	|	Товар.*,
	|	Склад.*,
	|	Партия.*,
	|	СтавкаНДС.*,
	|	Регистратор.*,
	|	НачОст_Количество,
	|	НачОст_СуммаЗакуп,
	|	НачОст_НДСЗакуп,
	|	НачОст_СуммаРозн,
	|	НачОст_НДСРозн,
	|	НачОст_ЦенаЗакуп,
	|	НачОст_ЦенаРозн,
	|	НачОст_Наценка,
	|	Прих_Количество,
	|	Прих_СуммаЗакуп,
	|	Прих_НДСЗакуп,
	|	Прих_СуммаРозн,
	|	Прих_НДСРозн,
	|	Прих_ЦенаЗакуп,
	|	Прих_ЦенаРозн,
	|	Прих_Наценка,
	|	Расх_Количество,
	|	Расх_СуммаЗакуп,
	|	Расх_НДСЗакуп,
	|	Расх_СуммаРозн,
	|	Расх_НДСРозн,
	|	Расх_ЦенаЗакуп,
	|	Расх_ЦенаРозн,
	|	Расх_Наценка,
	|	КонОст_Количество,
	|	КонОст_СуммаЗакуп,
	|	КонОст_НДСЗакуп,
	|	КонОст_СуммаРозн,
	|	КонОст_НДСРозн,
	|	КонОст_ЦенаЗакуп,
	|	КонОст_ЦенаРозн,
	|	КонОст_Наценка}
	|{ИТОГИ ПО
	|	Товар.*,
	|	Склад.*,
	|	Партия.*,
	|	СтавкаНДС.*,
	|	Регистратор.*}
	|";
КонецФункции	


Функция ПолучитьТекстНачОст()
	Возврат "ВЫБРАТЬ
	        |	НачОст.Товар,
	        |	НачОст.Склад,
	        |	НачОст.Партия,
	        |	НачОст.СтавкаНДС,
	        |	NULL КАК Регистратор,
	        |	СУММА(НачОст.КолвоОстаток) КАК НачОст_Количество,
	        |	СУММА(НачОст.СуммаЗакупСНДСОстаток) КАК НачОст_СуммаЗакуп,
	        |	СУММА(НачОст.СуммаНДСЗакупОстаток) КАК НачОст_НДСЗакуп,
	        |	СУММА(НачОст.СуммаРознСНДСОстаток) КАК НачОст_СуммаРозн,
	        |	СУММА(НачОст.СуммаРознНДСОстаток) КАК НачОст_НДСРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(НачОст.КолвоОстаток) <> 0
	        |			ТОГДА СУММА(НачОст.СуммаЗакупСНДСОстаток) / СУММА(НачОст.КолвоОстаток)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК НачОст_ЦенаЗакуп,
	        |	ВЫБОР
	        |		КОГДА СУММА(НачОст.КолвоОстаток) <> 0
	        |			ТОГДА СУММА(НачОст.СуммаРознСНДСОстаток) / СУММА(НачОст.КолвоОстаток)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК НачОст_ЦенаРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(НачОст.СуммаЗакупСНДСОстаток) <> 0
	        |			ТОГДА (СУММА(НачОст.СуммаРознСНДСОстаток) / СУММА(НачОст.СуммаЗакупСНДСОстаток) - 1) * 100
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК НачОст_Наценка,
	        |	СУММА(0) КАК Прих_Количество,
	        |	СУММА(0) КАК Прих_СуммаЗакуп,
	        |	СУММА(0) КАК Прих_НДСЗакуп,
	        |	СУММА(0) КАК Прих_СуммаРозн,
	        |	СУММА(0) КАК Прих_НДСРозн,
	        |	СУММА(0) КАК Прих_ЦенаЗакуп,
	        |	СУММА(0) КАК Прих_ЦенаРозн,
	        |	СУММА(0) КАК Прих_Наценка,
	        |	СУММА(0) КАК Расх_Количество,
	        |	СУММА(0) КАК Расх_СуммаЗакуп,
	        |	СУММА(0) КАК Расх_НДСЗакуп,
	        |	СУММА(0) КАК Расх_СуммаРозн,
	        |	СУММА(0) КАК Расх_НДСРозн,
	        |	СУММА(0) КАК Расх_ЦенаЗакуп,
	        |	СУММА(0) КАК Расх_ЦенаРозн,
	        |	СУММА(0) КАК Расх_Наценка,
	        |	СУММА(0) КАК КонОст_Количество,
	        |	СУММА(0) КАК КонОст_СуммаЗакуп,
	        |	СУММА(0) КАК КонОст_НДСЗакуп,
	        |	СУММА(0) КАК КонОст_СуммаРозн,
	        |	СУММА(0) КАК КонОст_НДСРозн,
	        |	СУММА(0) КАК КонОст_ЦенаЗакуп,
	        |	СУММА(0) КАК КонОст_ЦенаРозн,
	        |	СУММА(0) КАК КонОст_Наценка
	        |{ВЫБРАТЬ
	        |	НачОст.Товар.*,
	        |	НачОст.Склад.*,
	        |	НачОст.Партия.*,
	        |	НачОст.СтавкаНДС.*}
	        |ИЗ
	        |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата1НачОст, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК НачОст
	        |{ГДЕ
	        |	НачОст.Товар.*,
	        |	НачОст.Склад.*,
	        |	НачОст.Партия.*,
	        |	НачОст.СтавкаНДС.*,
	        |	НачОст.КолвоОстаток КАК НачОст_Количество,
	        |	НачОст.СуммаЗакупСНДСОстаток КАК НачОст_СуммаЗакуп,
	        |	НачОст.СуммаРознСНДСОстаток КАК НачОст_СуммаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(НачОст.КолвоОстаток) <> 0
	        |				ТОГДА СУММА(НачОст.СуммаЗакупСНДСОстаток) / СУММА(НачОст.КолвоОстаток)
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК НачОст_ЦенаЗакуп,
	        |	(ВЫБОР
	        |			КОГДА СУММА(НачОст.КолвоОстаток) <> 0
	        |				ТОГДА СУММА(НачОст.СуммаРознСНДСОстаток) / СУММА(НачОст.КолвоОстаток)
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК НачОст_ЦенаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(НачОст.СуммаЗакупСНДСОстаток) <> 0
	        |				ТОГДА (СУММА(НачОст.СуммаРознСНДСОстаток) / СУММА(НачОст.СуммаЗакупСНДСОстаток) - 1) * 100
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК НачОст_Наценка}
	        |
	        |СГРУППИРОВАТЬ ПО
	        |	НачОст.Партия,
	        |	НачОст.Склад,
	        |	НачОст.СтавкаНДС,
	        |	НачОст.Товар
	        |{УПОРЯДОЧИТЬ ПО
	        |	НачОст.Товар.*,
	        |	НачОст.Склад.*,
	        |	НачОст.Партия.*,
	        |	НачОст.СтавкаНДС.*,
	        |	НачОст.КолвоОстаток КАК НачОст_Количество,
	        |	НачОст.СуммаЗакупСНДСОстаток КАК НачОст_СуммаЗакуп,
	        |	НачОст.СуммаРознСНДСОстаток КАК НачОст_СуммаРозн,
	        |	НачОст_ЦенаЗакуп,
	        |	НачОст_ЦенаРозн,
	        |	НачОст_Наценка}
	        |{ИТОГИ ПО
	        |	НачОст.Товар.*,
	        |	НачОст.Склад.*,
	        |	НачОст.Партия.*,
	        |	НачОст.СтавкаНДС.*}";
КонецФункции

Функция ПолучитьТекстПриход()
	Возврат "ВЫБРАТЬ
	        |	Прих.Товар,
	        |	Прих.Склад,
	        |	Прих.Партия,
	        |	Прих.СтавкаНДС,
	        |	Прих.Регистратор,
	        |	СУММА(0) КАК НачОст_Количество,
	        |	СУММА(0) КАК НачОст_СуммаЗакуп,
	        |	СУММА(0) КАК НачОст_НДСЗакуп,
	        |	СУММА(0) КАК НачОст_СуммаРозн,
	        |	СУММА(0) КАК НачОст_НДСРозн,
	        |	СУММА(0) КАК НачОст_ЦенаЗакуп,
	        |	СУММА(0) КАК НачОст_ЦенаРозн,
	        |	СУММА(0) КАК НачОст_Наценка,
	        |	СУММА(Прих.КолвоПриход) КАК Прих_Количество,
	        |	СУММА(Прих.СуммаЗакупСНДСПриход) КАК Прих_СуммаЗакуп,
	        |	СУММА(Прих.СуммаНДСЗакупПриход) КАК Прих_НДСЗакуп,
	        |	СУММА(Прих.СуммаРознСНДСПриход) КАК Прих_СуммаРозн,
	        |	СУММА(Прих.СуммаРознНДСПриход) КАК Прих_НДСРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(Прих.КолвоПриход) <> 0
	        |			ТОГДА СУММА(Прих.СуммаЗакупСНДСПриход) / СУММА(Прих.КолвоПриход)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК Прих_ЦенаЗакуп,
	        |	ВЫБОР
	        |		КОГДА СУММА(Прих.КолвоПриход) <> 0
	        |			ТОГДА СУММА(Прих.СуммаРознСНДСПриход) / СУММА(Прих.КолвоПриход)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК Прих_ЦенаРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(Прих.СуммаЗакупСНДСПриход) <> 0
	        |			ТОГДА (СУММА(Прих.СуммаРознСНДСПриход) / СУММА(Прих.СуммаЗакупСНДСПриход) - 1) * 100
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК Прих_Наценка,
	        |	СУММА(0) КАК Расх_Количество,
	        |	СУММА(0) КАК Расх_СуммаЗакуп,
	        |	СУММА(0) КАК Расх_НДСЗакуп,
	        |	СУММА(0) КАК Расх_СуммаРозн,
	        |	СУММА(0) КАК Расх_НДСРозн,
	        |	СУММА(0) КАК Расх_ЦенаЗакуп,
	        |	СУММА(0) КАК Расх_ЦенаРозн,
	        |	СУММА(0) КАК Расх_Наценка,
	        |	СУММА(0) КАК КонОст_Количество,
	        |	СУММА(0) КАК КонОст_СуммаЗакуп,
	        |	СУММА(0) КАК КонОст_НДСЗакуп,
	        |	СУММА(0) КАК КонОст_СуммаРозн,
	        |	СУММА(0) КАК КонОст_НДСРозн,
	        |	СУММА(0) КАК КонОст_ЦенаЗакуп,
	        |	СУММА(0) КАК КонОст_ЦенаРозн,
	        |	СУММА(0) КАК КонОст_Наценка
	        |{ВЫБРАТЬ
	        |	Прих.Товар.*,
	        |	Прих.Склад.*,
	        |	Прих.Партия.*,
	        |	Прих.СтавкаНДС.*,
	        |	Регистратор.*}
	        |ИЗ
	        |	РегистрНакопления.ПартииЖНВЛС.Обороты(&Дата1Приход, &Дата2Приход, Регистратор, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК Прих
	        |ГДЕ
	        |	999 = 999
	        |{ГДЕ
	        |	Прих.Товар.*,
	        |	Прих.Склад.*,
	        |	Прих.Партия.*,
	        |	Прих.СтавкаНДС.*,
	        |	Прих.КолвоПриход КАК Прих_Количество,
	        |	Прих.СуммаЗакупСНДСПриход КАК Прих_СуммаЗакуп,
	        |	Прих.СуммаРознСНДСПриход КАК Прих_СуммаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(Прих.КолвоПриход) <> 0
	        |				ТОГДА СУММА(Прих.СуммаЗакупСНДСПриход) / СУММА(Прих.КолвоПриход)
	        |			ИНАЧЕ 0
	        |		КОНЕЦ) КАК Прих_ЦенаЗакуп,
	        |	(ВЫБОР
	        |			КОГДА СУММА(Прих.КолвоПриход) <> 0
	        |				ТОГДА СУММА(Прих.СуммаРознСНДСПриход) / СУММА(Прих.КолвоПриход)
	        |			ИНАЧЕ 0
	        |		КОНЕЦ) КАК Прих_ЦенаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(Прих.СуммаЗакупСНДСПриход) <> 0
	        |				ТОГДА (СУММА(Прих.СуммаРознСНДСПриход) / СУММА(Прих.СуммаЗакупСНДСПриход) - 1) * 100
	        |			ИНАЧЕ 0
	        |		КОНЕЦ) КАК Прих_Наценка}
	        |
	        |СГРУППИРОВАТЬ ПО
	        |	Прих.СтавкаНДС,
	        |	Прих.Фирма,
	        |	Прих.Склад,
	        |	Прих.Партия,
	        |	Прих.Товар,
	        |	Прих.Регистратор
	        |{УПОРЯДОЧИТЬ ПО
	        |	Прих.Товар.*,
	        |	Прих.Склад.*,
	        |	Прих.Партия.*,
	        |	Прих.СтавкаНДС.*,
	        |	Прих.СуммаЗакупСНДСПриход КАК Прих_СуммаЗакуп,
	        |	Прих.СуммаРознСНДСПриход КАК Прих_СуммаРозн,
	        |	Прих_ЦенаЗакуп,
	        |	Прих_ЦенаРозн,
	        |	Прих_Наценка}
	        |{ИТОГИ ПО
	        |	Прих.Товар.*,
	        |	Прих.Склад.*,
	        |	Прих.Партия.*,
	        |	Прих.СтавкаНДС.*}";
	
КонецФункции

Функция ПолучитьТекстРасход()
	Возврат "ВЫБРАТЬ
	        |	Расх.Товар,
	        |	Расх.Склад,
	        |	Расх.Партия,
	        |	Расх.СтавкаНДС,
	        |	Расх.Регистратор,
	        |	СУММА(0) КАК НачОст_Количество,
	        |	СУММА(0) КАК НачОст_СуммаЗакуп,
	        |	СУММА(0) КАК НачОст_НДСЗакуп,
	        |	СУММА(0) КАК НачОст_СуммаРозн,
	        |	СУММА(0) КАК НачОст_НДСРозн,
	        |	СУММА(0) КАК НачОст_ЦенаЗакуп,
	        |	СУММА(0) КАК НачОст_ЦенаРозн,
	        |	СУММА(0) КАК НачОст_Наценка,
	        |	СУММА(0) КАК Прих_Количество,
	        |	СУММА(0) КАК Прих_СуммаЗакуп,
	        |	СУММА(0) КАК Прих_НДСЗакуп,
	        |	СУММА(0) КАК Прих_СуммаРозн,
	        |	СУММА(0) КАК Прих_НДСРозн,
	        |	СУММА(0) КАК Прих_ЦенаЗакуп,
	        |	СУММА(0) КАК Прих_ЦенаРозн,
	        |	СУММА(0) КАК Прих_Наценка,
	        |	СУММА(Расх.КолвоРасход) КАК Расх_Количество,
	        |	СУММА(Расх.СуммаЗакупСНДСРасход) КАК Расх_СуммаЗакуп,
	        |	СУММА(Расх.СуммаНДСЗакупРасход) КАК Расх_НДСЗакуп,
	        |	СУММА(Расх.СуммаРознСНДСРасход) КАК Расх_СуммаРозн,
	        |	СУММА(Расх.СуммаРознНДСРасход) КАК Расх_НДСРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(Расх.КолвоРасход) <> 0
	        |			ТОГДА СУММА(Расх.СуммаЗакупСНДСРасход) / СУММА(Расх.КолвоРасход)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК Расх_ЦенаЗакуп,
	        |	ВЫБОР
	        |		КОГДА СУММА(Расх.КолвоРасход) <> 0
	        |			ТОГДА СУММА(Расх.СуммаРознСНДСРасход) / СУММА(Расх.КолвоРасход)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК Расх_ЦенаРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(Расх.СуммаЗакупСНДСРасход) <> 0
	        |			ТОГДА (СУММА(Расх.СуммаРознСНДСРасход) / СУММА(Расх.СуммаЗакупСНДСРасход) - 1) * 100
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК Расх_Наценка,
	        |	СУММА(0) КАК КонОст_Количество,
	        |	СУММА(0) КАК КонОст_СуммаЗакуп,
	        |	СУММА(0) КАК КонОст_НДСЗакуп,
	        |	СУММА(0) КАК КонОст_СуммаРозн,
	        |	СУММА(0) КАК КонОст_НДСРозн,
	        |	СУММА(0) КАК КонОст_ЦенаЗакуп,
	        |	СУММА(0) КАК КонОст_ЦенаРозн,
	        |	СУММА(0) КАК КонОст_Наценка
	        |{ВЫБРАТЬ
	        |	Расх.Товар.*,
	        |	Расх.Склад.*,
	        |	Расх.Партия.*,
	        |	Расх.СтавкаНДС.*,
	        |	Регистратор.*}
	        |ИЗ
	        |	РегистрНакопления.ПартииЖНВЛС.Обороты(&Дата1Расход, &Дата2Расход, Регистратор, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК Расх
	        |ГДЕ
	        |	999 = 999
	        |{ГДЕ
	        |	Расх.Товар.*,
	        |	Расх.Склад.*,
	        |	Расх.Партия.*,
	        |	Расх.СтавкаНДС.*,
	        |	Расх.КолвоПриход КАК Расх_Количество,
	        |	Расх.СуммаЗакупСНДСПриход КАК Расх_СуммаЗакуп,
	        |	Расх.СуммаРознСНДСПриход КАК Расх_СуммаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(Расх.КолвоРасход) <> 0
	        |				ТОГДА СУММА(Расх.СуммаЗакупСНДСРасход) / СУММА(Расх.КолвоРасход)
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК Расх_ЦенаЗакуп,
	        |	(ВЫБОР
	        |			КОГДА СУММА(Расх.КолвоРасход) <> 0
	        |				ТОГДА СУММА(Расх.СуммаРознСНДСРасход) / СУММА(Расх.КолвоРасход)
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК Расх_ЦенаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(Расх.СуммаЗакупСНДСРасход) <> 0
	        |				ТОГДА (СУММА(Расх.СуммаРознСНДСРасход) / СУММА(Расх.СуммаЗакупСНДСРасход) - 1) * 100
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК Расх_Наценка}
	        |
	        |СГРУППИРОВАТЬ ПО
	        |	Расх.Склад,
	        |	Расх.Регистратор,
	        |	Расх.Партия,
	        |	Расх.Товар,
	        |	Расх.СтавкаНДС
	        |{УПОРЯДОЧИТЬ ПО
	        |	Расх.Товар.*,
	        |	Расх.Склад.*,
	        |	Расх.Партия.*,
	        |	Расх.СтавкаНДС.*,
	        |	Расх.СуммаЗакупСНДСРасход КАК Расх_СуммаЗакуп,
	        |	Расх.СуммаРознСНДСРасход КАК Расх_СуммаРозн,
	        |	Расх_Количество КАК Расх_Количество,
	        |	Расх_ЦенаЗакуп,
	        |	Расх_ЦенаРозн,
	        |	Расх_Наценка}
	        |{ИТОГИ ПО
	        |	Расх.Товар.*,
	        |	Расх.Склад.*,
	        |	Расх.Партия.*,
	        |	Расх.СтавкаНДС.*}";
КонецФункции

Функция ПолучитьТекстКонОст()
	Возврат "ВЫБРАТЬ
	        |	КонОст.Товар,
	        |	КонОст.Склад,
	        |	КонОст.Партия,
	        |	КонОст.СтавкаНДС,
	        |	NULL КАК Регистратор,
	        |	СУММА(0) КАК НачОст_Количество,
	        |	СУММА(0) КАК НачОст_СуммаЗакуп,
	        |	СУММА(0) КАК НачОст_НДСЗакуп,
	        |	СУММА(0) КАК НачОст_СуммаРозн,
	        |	СУММА(0) КАК НачОст_НДСРозн,
	        |	СУММА(0) КАК НачОст_ЦенаЗакуп,
	        |	СУММА(0) КАК НачОст_ЦенаРозн,
	        |	СУММА(0) КАК НачОст_Наценка,
	        |	СУММА(0) КАК Прих_Количество,
	        |	СУММА(0) КАК Прих_СуммаЗакуп,
	        |	СУММА(0) КАК Прих_НДСЗакуп,
	        |	СУММА(0) КАК Прих_СуммаРозн,
	        |	СУММА(0) КАК Прих_НДСРозн,
	        |	СУММА(0) КАК Прих_ЦенаЗакуп,
	        |	СУММА(0) КАК Прих_ЦенаРозн,
	        |	СУММА(0) КАК Прих_Наценка,
	        |	СУММА(0) КАК Расх_Количество,
	        |	СУММА(0) КАК Расх_СуммаЗакуп,
	        |	СУММА(0) КАК Расх_НДСЗакуп,
	        |	СУММА(0) КАК Расх_СуммаРозн,
	        |	СУММА(0) КАК Расх_НДСРозн,
	        |	СУММА(0) КАК Расх_ЦенаЗакуп,
	        |	СУММА(0) КАК Расх_ЦенаРозн,
	        |	СУММА(0) КАК Расх_Наценка,
	        |	СУММА(КонОст.КолвоОстаток) КАК КонОст_Количество,
	        |	СУММА(КонОст.СуммаЗакупСНДСОстаток) КАК КонОст_СуммаЗакуп,
	        |	СУММА(КонОст.СуммаНДСЗакупОстаток) КАК КонОст_НДСЗакуп,
	        |	СУММА(КонОст.СуммаРознСНДСОстаток) КАК КонОст_СуммаРозн,
	        |	СУММА(КонОст.СуммаРознНДСОстаток) КАК КонОст_НДСРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(КонОст.КолвоОстаток) <> 0
	        |			ТОГДА СУММА(КонОст.СуммаЗакупСНДСОстаток) / СУММА(КонОст.КолвоОстаток)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК КонОст_ЦенаЗакуп,
	        |	ВЫБОР
	        |		КОГДА СУММА(КонОст.КолвоОстаток) <> 0
	        |			ТОГДА СУММА(КонОст.СуммаРознСНДСОстаток) / СУММА(КонОст.КолвоОстаток)
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК КонОст_ЦенаРозн,
	        |	ВЫБОР
	        |		КОГДА СУММА(КонОст.СуммаЗакупСНДСОстаток) <> 0
	        |			ТОГДА (СУММА(КонОст.СуммаРознСНДСОстаток) / СУММА(КонОст.СуммаЗакупСНДСОстаток) - 1) * 100
	        |		ИНАЧЕ СУММА(0)
	        |	КОНЕЦ КАК КонОст_Наценка
	        |{ВЫБРАТЬ
	        |	КонОст.Товар.*,
	        |	КонОст.Склад.*,
	        |	КонОст.Партия.*,
	        |	КонОст.СтавкаНДС.*,
	        |	Регистратор}
	        |ИЗ
	        |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата2КонОст, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК КонОст
	        |{ГДЕ
	        |	КонОст.Товар.*,
	        |	КонОст.Склад.*,
	        |	КонОст.Партия.*,
	        |	КонОст.СтавкаНДС.*,
	        |	КонОст.КолвоОстаток КАК КонОст_Количество,
	        |	КонОст.СуммаЗакупСНДСОстаток КАК КонОст_СуммаЗакуп,
	        |	КонОст.СуммаРознСНДСОстаток КАК КонОст_СуммаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(КонОст.КолвоОстаток) <> 0
	        |				ТОГДА СУММА(КонОст.СуммаЗакупСНДСОстаток) / СУММА(КонОст.КолвоОстаток)
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК КонОст_ЦенаЗакуп,
	        |	(ВЫБОР
	        |			КОГДА СУММА(КонОст.КолвоОстаток) <> 0
	        |				ТОГДА СУММА(КонОст.СуммаРознСНДСОстаток) / СУММА(КонОст.КолвоОстаток)
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК КонОст_ЦенаРозн,
	        |	(ВЫБОР
	        |			КОГДА СУММА(КонОст.СуммаЗакупСНДСОстаток) <> 0
	        |				ТОГДА (СУММА(КонОст.СуммаРознСНДСОстаток) / СУММА(КонОст.СуммаЗакупСНДСОстаток) - 1) * 100
	        |			ИНАЧЕ СУММА(0)
	        |		КОНЕЦ) КАК КонОст_Наценка}
	        |
	        |СГРУППИРОВАТЬ ПО
	        |	КонОст.Партия,
	        |	КонОст.СтавкаНДС,
	        |	КонОст.Фирма,
	        |	КонОст.Склад,
	        |	КонОст.Товар
	        |{УПОРЯДОЧИТЬ ПО
	        |	КонОст.Товар.*,
	        |	КонОст.Склад.*,
	        |	КонОст.Партия.*,
	        |	КонОст.СтавкаНДС.*,
	        |	КонОст.КолвоОстаток КАК КонОст_Количество,
	        |	КонОст.СуммаЗакупСНДСОстаток КАК КонОст_СуммаЗакуп,
	        |	КонОст.СуммаРознСНДСОстаток КАК КонОст_СуммаРозн,
	        |	КонОст_ЦенаЗакуп,
	        |	КонОст_ЦенаРозн,
	        |	КонОст_Наценка}
	        |{ИТОГИ ПО
	        |	КонОст.Товар.*,
	        |	КонОст.Склад.*,
	        |	КонОст.Партия.*,
	        |	КонОст.СтавкаНДС.*}";
КонецФункции



Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если Построитель.ВыбранныеПоля.Количество()=0 Тогда
		Предупреждение("Не указаны поля выводимые в отчет на закладке ""Поля, сортировка, шахматка"" !");
		
		ЭлементыФормы.Панель1.ТекущаяСтраница=ЭлементыФормы.Панель1.Страницы.Получить(1);
		
		
		Возврат;
	КонецЕсли;
	
	ЕстьЧисловыеПоля=Ложь;
	Для каждого Поле из Построитель.ВыбранныеПоля Цикл
		Если Найти(Поле.Имя,"КонОст")<>0 Тогда
			ЕстьЧисловыеПоля=Истина;
		ИначеЕсли	 Найти(Поле.Имя,"НачОст")<>0 Тогда
			ЕстьЧисловыеПоля=Истина;
		ИначеЕсли	 Найти(Поле.Имя,"Прих")<>0 Тогда
			ЕстьЧисловыеПоля=Истина;
		ИначеЕсли	 Найти(Поле.Имя,"Расх")<>0 Тогда
			ЕстьЧисловыеПоля=Истина;
		КонецЕсли; 
	КонецЦикла;
	
	Если ЕстьЧисловыеПоля=Ложь Тогда
		Предупреждение("Не выбрано ни одного числового поля! Отчет без цифр - это не отчет!");
		ЭлементыФормы.Панель1.ТекущаяСтраница=ЭлементыФормы.Панель1.Страницы.Получить(1);
		Возврат;
	КонецЕсли;	
	
	
	
	РеальныйПостроитель=Новый ПостроительОтчета;
	
	ИсполняемыйТекстЗапроса= НачалоЗапроса(); // начинаем собирать огромный запрос
	
	
	// Собираем Строку условий по типам документов
	УсловиеПоТипамДокументов="";
	Первая=Истина;
	Для каждого  Стр Из ВидыДокументов  Цикл
		Если Стр.Пометка=Ложь Тогда
			Продолжить;
		КонецЕсли; 
		
		Если Первая=Ложь Тогда
			УсловиеПоТипамДокументов=УсловиеПоТипамДокументов+"
			| ИЛИ";
		КонецЕсли; 
		УсловиеПоТипамДокументов=УсловиеПоТипамДокументов+"
		|Регистратор ССЫЛКА Документ."+Стр.Значение;
		
		Первая=Ложь;
	КонецЦикла; 
	
	
	Х=0;
	
	
	ПерваяЧастьЗапроса=Истина;
	РеальныйПостроитель.Параметры.Очистить();
	
	
	МожноВыполнять=Ложь;
	Для каждого  Стр Из ВидыДвижений  Цикл
		Х=Х+1;
		Если Стр.Пометка=Истина Тогда
			МожноВыполнять=Истина;
			Если ПерваяЧастьЗапроса=Ложь Тогда
				
				ИсполняемыйТекстЗапроса=ИсполняемыйТекстЗапроса+"
				|
				|UNION ALL
				|";
			КонецЕсли;	
			
			
			ИсполняемыйТекстЗапроса=ИсполняемыйТекстЗапроса+Вычислить("ПолучитьТекст"+Стр.Значение+"()");
			
			ПерваяЧастьЗапроса=Ложь;
		Иначе
			Продолжить;
		КонецЕсли;	
		
		РеальныйПостроитель.Параметры.Вставить("Дата1"+Стр.Значение,НачалоДня(НачПериода));
		РеальныйПостроитель.Параметры.Вставить("Дата2"+Стр.Значение,КонецДня(КонПериода));
		
	КонецЦикла; 
	
	Если МожноВыполнять=Ложь Тогда
		Предупреждение("Не выбрано ни одного вида движений! Отчет сформировать невозможно!");
		Возврат;
	КонецЕсли; 	
	
	
	//---------- Копируем параметры построителя в реальный построитель -----------------------------
	
	//Сообщить(ИсполняемыйТекстЗапроса);
	
	ИсполняемыйТекстЗапроса=ИсполняемыйТекстЗапроса+КонецЗапроса();
	
	
	Если ПустаяСтрока(УсловиеПоТипамДокументов)=Ложь ТОгда
		УсловиеПоТипамДокументов="("+УсловиеПоТипамДокументов+")";
		ИсполняемыйТекстЗапроса=СтрЗаменить(ИсполняемыйТекстЗапроса,"999 = 999",УсловиеПоТипамДокументов);
		СтрокаУсловийПоТипамДокументов=УсловиеПоТипамДокументов;
	КонецЕсли; 
	
	РеальныйПостроитель.Текст=ИсполняемыйТекстЗапроса;
	
	РеальныйПостроитель.ВыбранныеПоля.Очистить();
	
	Для каждого  ВП Из Построитель.ВыбранныеПоля  Цикл
		Попытка
			РеальныйПостроитель.ВыбранныеПоля.Добавить(ВП.ПутьКДанным,ВП.Имя);
		Исключение
			// это не от этого варианта поле
		КонецПопытки;
	КонецЦикла;
	
	РеальныйПостроитель.Порядок.Очистить();
	Для каждого  ПС Из  Построитель.Порядок Цикл
		Попытка
			РеальныйПостроитель.Порядок.Добавить(пс.ПутьКДанным,пс.Имя,пс.Представление,пс.Направление);
		Исключение
			// это не отсюда
		КонецПопытки; 
	КонецЦикла; 
	
	Для каждого  СтрО Из РеальныйПостроитель.Отбор  Цикл
		Попытка
			РеальныйПостроитель.Отбор.Удалить(СтрО);
		ИСключение
		КонецПопытки; 
	КонецЦикла; 
	
	Для каждого  СтрО Из Построитель.Отбор Цикл
		Попытка
			ЭлРО=РеальныйПостроитель.Отбор.Добавить(СтрО.ПутьКДанным,СтрО.Имя,СтрО.Представление);
			ЭлРО.ВидСравнения=СтрО.ВидСравнения;
			ЭлРО.Значение=СтрО.Значение;
			ЭлРО.ЗначениеПо=СтрО.ЗначениеПо;
			ЭлРО.ЗначениеС=СтрО.ЗначениеС;
			ЭлРО.Использование=СтрО.Использование;
		Исключение
			// неотсюда
		КонецПопытки; 
	КонецЦикла; 
	
	// шахматка (2 цикла заполнения) !!!!!!!!!!!11
	
	РеальныйПостроитель.ИзмеренияКолонки.Очистить();
	Для каждого  ПИ Из  Построитель.ИзмеренияКолонки Цикл
		Попытка
			РеальныйПостроитель.ИзмеренияКолонки.Добавить(ПИ.ПутьКДанным,Пи.Имя,ПИ.ТипИзмерения);
		Исключение
			// это не отсюда
		КонецПопытки; 
	КонецЦикла; 
	
	РеальныйПостроитель.ИзмеренияСтроки.Очистить();
	Для каждого  ПИС Из  Построитель.ИзмеренияСтроки Цикл
		Попытка
			РеальныйПостроитель.ИзмеренияСтроки.Добавить(ПИС.ПутьКДанным,ПиС.Имя,ПИС.ТипИзмерения);
		Исключение
			// это не отсюда
		КонецПопытки; 
	КонецЦикла; 
	
	
	
	
	
	
	
	
	
	РеальныйПостроитель.ОтображатьСостояние=Истина;
	РеальныйПостроитель.ВыводитьЗаголовокОтчета=Истина;
	Оформление = ПолучитьМакетОформления(СтандартноеОформление.Классика);
	РеальныйПостроитель.МакетОформления = Оформление;
	
	РеальныйПостроитель.ОформитьМакет();
	ПредставлениеПериода=" с "+НачалоДня(НачПериода)+" по "+КонецДня(КонПериода);
	РеальныйПостроитель.ТекстЗаголовка="Движение товара за период "+ПредставлениеПериода ;//"Движение товара за период с "+Формат(НачПериода,"ДФ=dd.MM.yyyy")+" по "+Формат(КонПериода,"ДФ=dd.MM.yyyy");
	
	НачалоВыпЗап=ТекущаяДата();
	
	РеальныйПостроитель.ОбрабатыватьПрерываниеПользователя=Истина;
	РеальныйПостроитель.ВыводитьОбщиеИтоги=Истина;
	
	РеальныйПостроитель.Выполнить();
	РеальныйПостроитель.Вывести();
	ЛОГ_ВРЕМЕНИ_ВЫПОЛНЕНИЯ("УОПТ_v2",Х,НачалоВыпЗап,ТекущаяДата());
	
	КоманднаяПанель4ОбновитьСписокНастроек("");
	
	ОтметкаАудита(ЭтотОбъект,ЭтаФорма,"Выполнить");
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура СохранитьНастройку(КаталогСохранения,ДляТерминала=ложь)
	
	Если ДляТерминала=Истина Тогда
		РДП="(RDP) ";
	Иначе
		РДП="";
	КонецЕсли;
	
	ПарамСохр=Новый СписокЗначений;
	
	
	
	ВидыДвиженийСтр=ЗначениеВСтрокуВнутр(ВидыДвижений);
	ВидыДокументовСтр=ЗначениеВСтрокуВнутр(ВидыДокументов);
	НастройкиПостроителяСтр= ЗначениеВСтрокуВнутр(Построитель.ПолучитьНастройки());
	
	
	
	
	
	
	
	ПарамСохр.Добавить(ВидыДвиженийСтр);
	ПарамСохр.Добавить(ВидыДокументовСтр);
	ПарамСохр.Добавить(НастройкиПостроителяСтр);
	
	
	СодержимоеФайлаНстроек= ЗначениеВСтрокуВнутр(ПарамСохр);
	
	ТХТ=Новый ТекстовыйДокумент;
	
	ТХТ.ДобавитьСтроку( СодержимоеФайлаНстроек);
	
		
	
	
	ИмяНастройки="";
	Пока ПустаяСтрока(ИмяНастройки)=Истина Цикл
		ВвестиСтроку(ИмяНастройки,"Имя настройки",100,Ложь);
		
		Ф=Новый Файл(КаталогСохранения+"\"+РДП+ИмяНастройки+".var");
		Если Ф.Существует()=Истина Тогда
			Предупреждение("Настройка с таким именем уже существует!");
			ИмяНастройки="";
		КонецЕсли; 	
		
	КонецЦикла; 	
	
	ТХТ.Записать(КаталогСохранения+"\"+РДП+ИмяНастройки+".var");
	КоманднаяПанель4ОбновитьСписокНастроек("");
	
	ЭлементыФормы.НадписьТекНастр.Заголовок=ИмяНастройки;
Конецпроцедуры

	


Процедура СохранитьТекНастрНажатие(Элемент)
	 СохранитьНастройку(КаталогХраненияНастроек);
КонецПроцедуры

Процедура Загрузить_настройкуНажатие(Элемент)
	
	ИмяНастройки=(ЭлементыФормы.СохраненныеНастройки.ТекущаяСтрока.Настройка);
	
	Если Найти(ИмяНастройки,"(RDP) ")<>0 Тогда
		КХН=ПолучитьПутьНастроекТерминала();
	Иначе
		КХН=КаталогХраненияНастроек;
	КонецЕсли;	

	
	ТХТ=Новый ТекстовыйДокумент;
	ТХТ.прочитать(КХН+"\"+ИмяНастройки+".var");
	
	
	СписокЗначенийНастроек=ЗначениеИзСтрокиВнутр(ТХТ.ПолучитьТекст());
	
	
	ВидыДвижений=ЗначениеИзСтрокиВнутр(СписокЗначенийНастроек.Получить(0).Значение);//
	ВидыДокументов=ЗначениеИзСтрокиВнутр(СписокЗначенийНастроек.Получить(1).Значение);//ЗначениеВСтрокуВнутр(ВидыДокументов);
	
	Построитель.УстановитьНастройки(ЗначениеИзСтрокиВнутр(СписокЗначенийНастроек.Получить(2).Значение));
	
	ЭлементыФормы.НадписьТекНастр.Заголовок=ИмяНастройки;
	
КонецПроцедуры

Функция ПолучитьПутьНастроекТерминала()
	СС=СтрокаСоединенияИнформационнойБазы(); //Srvr="id-app-01";Ref="alfega_skd";
	ИБ=Сред(СС,Найти(СС,"Ref=")+5,СтрДлина(СС));
	ИБ=СтрЗаменить(ИБ,""";","");
	ИмяИБ=ИБ;
	
	ПутьДляСохраненияНастроек="C:\1S_TerminalUserData"+"\"+ИмяИБ;
	
	Возврат ПутьДляСохраненияНастроек;
КонецФункции	


Процедура КоманднаяПанель4ОбновитьСписокНастроек(Кнопка)
	
	МассивФайлов=НайтиФайлы(КаталогХраненияНастроек,"*.var");
	
	СохраненныеНастройки.Очистить();
	
	Для каждого  Ф Из МассивФайлов Цикл
		Стр=СохраненныеНастройки.Добавить();
		Стр.Настройка=Ф.ИмяБезРасширения;
	КонецЦикла; 
	
	
	
	МассивФайлов=НайтиФайлы(ПолучитьПутьНастроекТерминала(),"*.var");
	Для каждого  Ф Из МассивФайлов Цикл
		Стр=СохраненныеНастройки.Добавить();
		Стр.Настройка=Ф.ИмяБезРасширения;
	КонецЦикла; 
	
	
КонецПроцедуры

Процедура КоманднаяПанель2Действие2(Кнопка)
    Если Построитель.ВыбранныеПоля.Найти("НачОст_Количество")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("НачОст_Количество");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("НачОст_СуммаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("НачОст_СуммаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("НачОст_СуммаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("НачОст_СуммаРозн");
	КонецЕсли; 	
КонецПроцедуры

Процедура КоманднаяПанель2ПоставщикПартииТовара(Кнопка)
	Если Построитель.ВыбранныеПоля.Найти("Партия.Поставщик")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Партия.Поставщик");
	КонецЕсли; 	
КонецПроцедуры

Процедура КоманднаяПанель2Действие(Кнопка)
	Если Построитель.ВыбранныеПоля.Найти("Прих_Количество")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Прих_Количество");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Прих_СуммаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Прих_СуммаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Прих_СуммаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Прих_СуммаРозн");
	КонецЕсли; 	
КонецПроцедуры

Процедура КоманднаяПанель2ДействиеРасход(Кнопка)
	Если Построитель.ВыбранныеПоля.Найти("Расх_Количество")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Расх_Количество");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Расх_СуммаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Расх_СуммаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Расх_СуммаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Расх_СуммаРозн");
	КонецЕсли; 	
КонецПроцедуры

Процедура КоманднаяПанель2ДействиеКонОст(Кнопка)
	Если Построитель.ВыбранныеПоля.Найти("КонОст_Количество")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("КонОст_Количество");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("КонОст_СуммаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("КонОст_СуммаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("КонОст_СуммаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("КонОст_СуммаРозн");
	КонецЕсли; 	

КонецПроцедуры

Процедура КоманднаяПанель2Цены(Кнопка)
	Если Построитель.ВыбранныеПоля.Найти("НачОст_ЦенаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("НачОст_ЦенаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("НачОст_ЦенаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("НачОст_ЦенаРозн");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Прих_ЦенаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Прих_ЦенаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Прих_ЦенаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Прих_ЦенаРозн");
	КонецЕсли; 
	Если Построитель.ВыбранныеПоля.Найти("Расх_ЦенаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Расх_ЦенаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("Расх_ЦенаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Расх_ЦенаРозн");
	КонецЕсли; 
	Если Построитель.ВыбранныеПоля.Найти("КонОст_ЦенаЗакуп")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("КонОст_ЦенаЗакуп");
	КонецЕсли; 	
	Если Построитель.ВыбранныеПоля.Найти("КонОст_ЦенаРозн")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("КонОст_ЦенаРозн");
	КонецЕсли; 
КонецПроцедуры

Процедура КоманднаяПанель4УдалитьНастройку(Кнопка)
	ИмяНастройки=(ЭлементыФормы.СохраненныеНастройки.ТекущаяСтрока.Настройка);
	
	Если Найти(ИмяНастройки,"(RDP) ")<>0 Тогда
		КХН=ПолучитьПутьНастроекТерминала();
	Иначе
		КХН=КаталогХраненияНастроек;
	КонецЕсли;	


	
	
	Если Вопрос("Удалить выбранную настройку?",РежимДиалогаВопрос.ДаНет,0,КодВозвратаДиалога.Нет,"Удалить настройку?")=КодВозвратаДиалога.Да ТОгда
		УдалитьФайлы(КХН+"\"+ИмяНастройки+".var");
	КонецЕсли; 
	
	КоманднаяПанель4ОбновитьСписокНастроек("");

	
КонецПроцедуры

Процедура КоманднаяПанель2Наценки(Кнопка)
	Если Построитель.ВыбранныеПоля.Найти("НачОст_Наценка")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("НачОст_Наценка");
	КонецЕсли; 
	Если Построитель.ВыбранныеПоля.Найти("Прих_Наценка")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Прих_Наценка");
	КонецЕсли; 
	Если Построитель.ВыбранныеПоля.Найти("Расх_Наценка")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("Расх_Наценка");
	КонецЕсли; 
	Если Построитель.ВыбранныеПоля.Найти("КонОст_Наценка")=Неопределено ТОгда
		Построитель.ВыбранныеПоля.Добавить("КонОст_Наценка");
	КонецЕсли; 
КонецПроцедуры

Процедура КоманднаяПанель4ХранилищеНастроек(Кнопка)
	
	Ф=ЭтотОбъект.ПолучитьФорму("НазначениеХранилищаНастроек");
	Ф.ОткрытьМодально();
КонецПроцедуры

Процедура Сохранить_для_терминала(Кнопка)
	СохранитьНастройку(ПолучитьПутьНастроекТерминала(),истина);
КонецПроцедуры


      


ВидыДвижений.Добавить("НачОст","Начальный остаток");
ВидыДвижений.Добавить("Приход","Приход");
ВидыДвижений.Добавить("Расход","Расход");
ВидыДвижений.Добавить("КонОст","Конечный остаток");
ВидыДвижений.ЗаполнитьПометки(Ложь);


Для каждого Стр из Документы Цикл
	
	//Док=Документы.ПоступлениеТовара.СоздатьДокумент();
	Док=Документы[СтрЗаменить(Стр,"ДокументМенеджер.","")].СоздатьДокумент();
	
	Если Док.Движения.Найти("ПартииЖНВЛС")<> Неопределено  ТОгда
		
		
		ИмяТипаДока=СтрЗаменить(Стр,"ДокументМенеджер.",   "");
		
		ВидыДокументов.Добавить(ИмяТипаДока,Метаданные.Документы[ИмяТипаДока].Синоним).Пометка=Ложь;
	КонецЕсли;
КонецЦикла;	


//-------------------- Запрос by GtG -----------------------
// Назначение: ВыгребаемДанные
//----------------------------------------------------------
ИсходныйТекстЗапроса="ВЫБРАТЬ
                     |	НачОст.Товар КАК Товар,
                     |	НачОст.Склад,
                     |	НачОст.Партия,
                     |	НачОст.СтавкаНДС,
                     |	НачОст.КолвоОстаток КАК НачОст_Количество,
                     |	НачОст.СуммаЗакупСНДСОстаток КАК НачОст_СуммаЗакуп,
                     |	НачОст.СуммаНДСЗакупОстаток КАК НачОст_НДСЗакуп,
                     |	НачОст.СуммаРознСНДСОстаток КАК НачОст_СуммаРозн,
                     |	НачОст.СуммаРознНДСОстаток КАК НачОст_НДСРозн,
                     |	1 КАК НачОст_ЦенаЗакуп,
                     |	2 КАК НачОст_ЦенаРозн,
                     |	3 КАК НачОст_Наценка
                     |ПОМЕСТИТЬ НачальныйОстаток
                     |{ВЫБРАТЬ
                     |	НачОст.Товар.*,
                     |	НачОст.Склад.*,
                     |	НачОст.Партия.*,
                     |	НачОст.СтавкаНДС.*,
                     |	НачОст.КолвоОстаток КАК НачОст_Количество,
                     |	НачОст.СуммаЗакупСНДСОстаток КАК НачОст_СуммаЗакуп,
                     |	НачОст.СуммаНДСЗакупОстаток КАК НачОст_НДСЗакуп,
                     |	НачОст.СуммаРознСНДСОстаток КАК НачОст_СуммаРозн,
                     |	НачОст.СуммаРознНДСОстаток КАК НачОст_НДСРозн,
                     |	НачОст_ЦенаЗакуп,
                     |	НачОст_ЦенаРозн,
                     |	НачОст_Наценка}
                     |ИЗ
                     |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата1НачОст, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК НачОст
                     |{ГДЕ
                     |	НачОст.Товар.*,
                     |	НачОст.Склад.*,
                     |	НачОст.Партия.*,
                     |	НачОст.СтавкаНДС.*,
                     |	НачОст.КолвоОстаток КАК НачОст_Количество,
                     |	НачОст.СуммаЗакупСНДСОстаток КАК НачОст_СуммаЗакуп,
                     |	НачОст.СуммаРознСНДСОстаток КАК НачОст_СуммаРозн,
                     |	(1) КАК НачОст_ЦенаЗакуп,
                     |	(2) КАК НачОст_ЦенаРозн,
                     |	(3) КАК НачОст_Наценка}
                     |{УПОРЯДОЧИТЬ ПО
                     |	НачОст.Товар.*,
                     |	НачОст.Склад.*,
                     |	НачОст.Партия.*,
                     |	НачОст.СтавкаНДС.*,
                     |	НачОст.КолвоОстаток КАК НачОст_Количество,
                     |	НачОст.СуммаЗакупСНДСОстаток КАК НачОст_СуммаЗакуп,
                     |	НачОст.СуммаРознСНДСОстаток КАК НачОст_СуммаРозн,
                     |	НачОст_ЦенаЗакуп,
                     |	НачОст_ЦенаРозн,
                     |	НачОст_Наценка}
                     |{ИТОГИ ПО
                     |	НачОст.Товар.*,
                     |	НачОст.Склад.*,
                     |	НачОст.Партия.*,
                     |	НачОст.СтавкаНДС.*}
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |ВЫБРАТЬ
                     |	КонОст.Товар КАК Товар,
                     |	КонОст.Склад,
                     |	КонОст.Партия,
                     |	КонОст.СтавкаНДС,
                     |	КонОст.КолвоОстаток КАК КолвоОстаток,
                     |	КонОст.СуммаЗакупСНДСОстаток,
                     |	КонОст.СуммаНДСЗакупОстаток,
                     |	КонОст.СуммаРознСНДСОстаток,
                     |	КонОст.СуммаРознНДСОстаток,
                     |	1 КАК КонОст_ЦенаЗакуп,
                     |	2 КАК КонОст_ЦенаРозн,
                     |	3 КАК КонОст_Наценка
                     |ПОМЕСТИТЬ КонечныйОстаток
                     |{ВЫБРАТЬ
                     |	КонОст.Товар.*,
                     |	КонОст.Склад.*,
                     |	КонОст.Партия.*,
                     |	КонОст.СтавкаНДС.*,
                     |	КонОст.КолвоОстаток КАК КонОст_Количество,
                     |	КонОст.СуммаЗакупСНДСОстаток КАК КонОст_СуммаЗакуп,
                     |	КонОст.СуммаНДСЗакупОстаток КАК КонОст_НДСЗакуп,
                     |	КонОст.СуммаРознСНДСОстаток КАК КонОст_СуммаРозн,
                     |	КонОст.СуммаРознНДСОстаток КАК КонОст_НДСРозн,
                     |	КонОст_ЦенаЗакуп,
                     |	КонОст_ЦенаРозн,
                     |	КонОст_Наценка}
                     |ИЗ
                     |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата2КонОст, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК КонОст
                     |{ГДЕ
                     |	КонОст.Товар.*,
                     |	КонОст.Склад.*,
                     |	КонОст.Партия.*,
                     |	КонОст.СтавкаНДС.*,
                     |	КонОст.КолвоОстаток КАК КонОст_Количество,
                     |	КонОст.СуммаЗакупСНДСОстаток КАК КонОст_СуммаЗакуп,
                     |	КонОст.СуммаРознСНДСОстаток КАК КонОст_СуммаРозн,
                     |	(1) КАК КонОст_ЦенаЗакуп,
                     |	(2) КАК КонОст_ЦенаРозн,
                     |	(3) КАК КонОст_Наценка}
                     |{УПОРЯДОЧИТЬ ПО
                     |	КонОст.Товар.*,
                     |	КонОст.Склад.*,
                     |	КонОст.Партия.*,
                     |	КонОст.СтавкаНДС.*,
                     |	КонОст.КолвоОстаток КАК КонОст_Количество,
                     |	КонОст.СуммаЗакупСНДСОстаток КАК КонОст_СуммаЗакуп,
                     |	КонОст.СуммаРознСНДСОстаток КАК КонОст_СуммаРозн,
                     |	КонОст_ЦенаЗакуп,
                     |	КонОст_ЦенаРозн,
                     |	КонОст_Наценка}
                     |{ИТОГИ ПО
                     |	КонОст.Товар.*,
                     |	КонОст.Склад.*,
                     |	КонОст.Партия.*,
                     |	КонОст.СтавкаНДС.*}
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |ВЫБРАТЬ
                     |	Прих.Товар,
                     |	Прих.Склад,
                     |	Прих.Партия,
                     |	Прих.СтавкаНДС,
                     |	Прих.КолвоПриход,
                     |	Прих.СуммаЗакупСНДСПриход,
                     |	Прих.СуммаНДСЗакупПриход,
                     |	Прих.СуммаРознСНДСПриход,
                     |	Прих.СуммаРознНДСПриход,
                     |	1 КАК Прих_ЦенаЗакуп,
                     |	2 КАК Прих_ЦенаРозн,
                     |	3 КАК прих_Наценка
                     |ПОМЕСТИТЬ Приход
                     |{ВЫБРАТЬ
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	КолвоПриход КАК Прих_Количество,
                     |	СуммаЗакупСНДСПриход КАК Прих_СуммаЗакуп,
                     |	СуммаНДСЗакупПриход КАК Прих_НДСЗакуп,
                     |	СуммаРознСНДСПриход КАК Прих_СуммаРозн,
                     |	СуммаРознНДСПриход КАК Прих_НДСРозн,
                     |	Прих_ЦенаЗакуп,
                     |	Прих_ЦенаРозн,
                     |	прих_Наценка}
                     |ИЗ
                     |	РегистрНакопления.ПартииЖНВЛС.Обороты(&Дата1Приход, &Дата2Приход, Регистратор, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК Прих
                     |ГДЕ
                     |	999 = 999
                     |{ГДЕ
                     |	Прих.Товар.*,
                     |	Прих.Склад.*,
                     |	Прих.Партия.*,
                     |	Прих.СтавкаНДС.*,
                     |	Прих.КолвоПриход КАК Прих_Количество,
                     |	Прих.СуммаЗакупСНДСПриход КАК Прих_СуммаЗакуп,
                     |	Прих.СуммаРознСНДСПриход КАК Прих_СуммаРозн,
                     |	(1) КАК Прих_ЦенаЗакуп,
                     |	(2) КАК Прих_ЦенаРозн,
                     |	(3) КАК Прих_Наценка}
                     |{УПОРЯДОЧИТЬ ПО
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	КолвоПриход КАК Прих_Количество,
                     |	СуммаЗакупСНДСПриход КАК Прих_СуммаЗакуп,
                     |	СуммаРознСНДСПриход КАК Прих_СуммаРозн,
                     |	Прих_ЦенаЗакуп,
                     |	Прих_ЦенаРозн,
                     |	прих_Наценка}
                     |{ИТОГИ ПО
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*}
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |ВЫБРАТЬ
                     |	Расх.Товар,
                     |	Расх.Склад,
                     |	Расх.Партия,
                     |	Расх.СтавкаНДС,
                     |	Расх.КолвоРасход,
                     |	Расх.СуммаЗакупСНДСРасход,
                     |	Расх.СуммаНДСЗакупРасход,
                     |	Расх.СуммаРознСНДСРасход,
                     |	Расх.СуммаРознНДСРасход,
                     |	1 КАК Расх_ЦенаЗакуп,
                     |	2 КАК Расх_ЦенаРозн,
                     |	3 КАК Расх_Наценка
                     |ПОМЕСТИТЬ Расход
                     |{ВЫБРАТЬ
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	КолвоРасход КАК Расх_Количество,
                     |	СуммаЗакупСНДСРасход КАК Расх_СуммаЗакуп,
                     |	СуммаНДСЗакупРасход КАК Расх_НДСЗакуп,
                     |	СуммаРознСНДСРасход КАК Расх_СуммаРозн,
                     |	СуммаРознНДСРасход КАК Расх_НДСРозн,
                     |	Расх_ЦенаЗакуп,
                     |	Расх_ЦенаРозн,
                     |	Расх_Наценка}
                     |ИЗ
                     |	РегистрНакопления.ПартииЖНВЛС.Обороты(&Дата1Расход, &Дата2Расход, Регистратор, {(Партия).*, (Склад).*, (СтавкаНДС), (Товар).*}) КАК Расх
                     |ГДЕ
                     |	999 = 999
                     |{ГДЕ
                     |	Расх.Товар.*,
                     |	Расх.Склад.*,
                     |	Расх.Партия.*,
                     |	Расх.СтавкаНДС.*,
                     |	Расх.КолвоПриход КАК Расх_Количество,
                     |	Расх.СуммаЗакупСНДСПриход КАК Расх_СуммаЗакуп,
                     |	Расх.СуммаРознСНДСПриход КАК Расх_СуммаРозн,
                     |	(1) КАК Расх_ЦенаЗакуп,
                     |	(2) КАК Расх_ЦенаЗакуп,
                     |	(3) КАК Расх_ЦенаЗакуп}
                     |{УПОРЯДОЧИТЬ ПО
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	КолвоРасход КАК Расх_Количество,
                     |	СуммаЗакупСНДСРасход КАК Расх_СуммаЗакуп,
                     |	СуммаРознСНДСРасход КАК Расх_СуммаРозн,
                     |	Расх_ЦенаЗакуп,
                     |	Расх_ЦенаРозн,
                     |	Расх_Наценка}
                     |{ИТОГИ ПО
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*}
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |ВЫБРАТЬ
                     |	НачОст.Товар,
                     |	НачОст.Склад,
                     |	НачОст.Партия,
                     |	НачОст.СтавкаНДС,
                     |	НачОст.НачОст_Количество,
                     |	НачОст.НачОст_СуммаЗакуп,
                     |	НачОст.НачОст_НДСЗакуп,
                     |	НачОст.НачОст_СуммаРозн,
                     |	НачОст.НачОст_НДСРозн,
                     |	NULL КАК Прих_Количество,
                     |	NULL КАК Прих_СуммаЗакуп,
                     |	NULL КАК Прих_НДСЗакуп,
                     |	NULL КАК Прих_СуммаРозн,
                     |	NULL КАК Прих_НДСРозн,
                     |	NULL КАК Расх_Количество,
                     |	NULL КАК Расх_СуммаЗакуп,
                     |	NULL КАК Расх_НДСЗакуп,
                     |	NULL КАК Расх_СуммаРозн,
                     |	NULL КАК Расх_НДСРозн,
                     |	NULL КАК КонОст_Количество,
                     |	NULL КАК КонОст_СуммаЗакуп,
                     |	NULL КАК КонОст_НДСЗакуп,
                     |	NULL КАК КонОст_СуммаРознСуммаРознСНДСОстаток1,
                     |	NULL КАК КонОст_НДСРозн,
                     |	НачОст.НачОст_ЦенаЗакуп,
                     |	НачОст.НачОст_ЦенаРозн,
                     |	НачОст.НачОст_Наценка,
                     |	NULL КАК Прих_ЦенаЗакуп,
                     |	NULL КАК Прих_ЦенаРозн,
                     |	NULL КАК прих_Наценка,
                     |	NULL КАК Расх_ЦенаЗакуп,
                     |	NULL КАК Расх_ЦенаРозн,
                     |	NULL КАК Расх_Наценка,
                     |	NULL КАК КонОст_ЦенаЗакуп,
                     |	NULL КАК КонОст_ЦенаРозн,
                     |	NULL КАК КонОст_Наценка
                     |{ВЫБРАТЬ
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	НачОст_Количество,
                     |	НачОст_СуммаЗакуп,
                     |	НачОст_НДСЗакуп,
                     |	НачОст_СуммаРозн,
                     |	НачОст_НДСРозн,
                     |	Прих_Количество,
                     |	Прих_СуммаЗакуп,
                     |	Прих_НДСЗакуп,
                     |	Прих_СуммаРозн,
                     |	Прих_НДСРозн,
                     |	Расх_Количество,
                     |	Расх_СуммаЗакуп,
                     |	Расх_НДСЗакуп,
                     |	Расх_СуммаРозн,
                     |	Расх_НДСРозн,
                     |	КонОст_Количество,
                     |	КонОст_СуммаЗакуп,
                     |	КонОст_НДСЗакуп,
                     |	КонОст_СуммаРознСуммаРознСНДСОстаток1 КАК КонОст_СуммаРозн,
                     |	КонОст_НДСРозн,
                     |	НачОст_ЦенаЗакуп,
                     |	НачОст_ЦенаРозн,
                     |	НачОст_Наценка,
                     |	Прих_ЦенаЗакуп,
                     |	Прих_ЦенаРозн,
                     |	прих_Наценка,
                     |	Расх_ЦенаЗакуп,
                     |	Расх_ЦенаРозн,
                     |	Расх_Наценка,
                     |	КонОст_ЦенаЗакуп,
                     |	КонОст_ЦенаРозн,
                     |	КонОст_Наценка}
                     |ИЗ
                     |	НачальныйОстаток КАК НачОст
                     |{ГДЕ
                     |	НачОст.Товар.*,
                     |	НачОст.Склад.*,
                     |	НачОст.Партия.*,
                     |	НачОст.СтавкаНДС.*,
                     |	НачОст.НачОст_Количество,
                     |	НачОст.НачОст_СуммаЗакуп,
                     |	НачОст.НачОст_НДСЗакуп,
                     |	НачОст.НачОст_СуммаРозн,
                     |	НачОст.НачОст_НДСРозн,
                     |	НачОст.НачОст_ЦенаЗакуп,
                     |	НачОст.НачОст_ЦенаРозн,
                     |	НачОст.НачОст_Наценка}
                     |
                     |ОБЪЕДИНИТЬ ВСЕ
                     |
                     |ВЫБРАТЬ
                     |	Приход.Товар,
                     |	Приход.Склад,
                     |	Приход.Партия,
                     |	Приход.СтавкаНДС,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	Приход.КолвоПриход,
                     |	Приход.СуммаЗакупСНДСПриход,
                     |	Приход.СуммаНДСЗакупПриход,
                     |	Приход.СуммаРознСНДСПриход,
                     |	Приход.СуммаРознНДСПриход,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	Приход.Прих_ЦенаЗакуп,
                     |	Приход.Прих_ЦенаРозн,
                     |	Приход.прих_Наценка,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL
                     |{ВЫБРАТЬ
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	НачОст_Количество,
                     |	НачОст_СуммаЗакуп,
                     |	НачОст_НДСЗакуп,
                     |	НачОст_СуммаРозн,
                     |	НачОст_НДСРозн,
                     |	Прих_Количество,
                     |	Прих_СуммаЗакуп,
                     |	Прих_НДСЗакуп,
                     |	Прих_СуммаРозн,
                     |	Прих_НДСРозн,
                     |	Расх_Количество,
                     |	Расх_СуммаЗакуп,
                     |	Расх_НДСЗакуп,
                     |	Расх_СуммаРозн,
                     |	Расх_НДСРозн,
                     |	КонОст_Количество,
                     |	КонОст_СуммаЗакуп,
                     |	КонОст_НДСЗакуп,
                     |	КонОст_СуммаРознСуммаРознСНДСОстаток1 КАК КонОст_СуммаРозн,
                     |	КонОст_НДСРозн,
                     |	КонОст_Наценка,
                     |	КонОст_ЦенаРозн,
                     |	КонОст_ЦенаЗакуп,
                     |	Расх_Наценка,
                     |	Расх_ЦенаРозн,
                     |	Расх_ЦенаЗакуп,
                     |	прих_Наценка,
                     |	Прих_ЦенаРозн,
                     |	Прих_ЦенаЗакуп,
                     |	НачОст_Наценка,
                     |	НачОст_ЦенаРозн,
                     |	НачОст_ЦенаЗакуп}
                     |ИЗ
                     |	Приход КАК Приход
                     |{ГДЕ
                     |	Приход.Товар.*,
                     |	Приход.Склад.*,
                     |	Приход.Партия.*,
                     |	Приход.СтавкаНДС.*,
                     |	Приход.КолвоПриход,
                     |	Приход.СуммаЗакупСНДСПриход,
                     |	Приход.СуммаНДСЗакупПриход,
                     |	Приход.СуммаРознСНДСПриход,
                     |	Приход.СуммаРознНДСПриход,
                     |	Приход.Прих_ЦенаЗакуп,
                     |	Приход.Прих_ЦенаРозн,
                     |	Приход.прих_Наценка}
                     |
                     |ОБЪЕДИНИТЬ ВСЕ
                     |
                     |ВЫБРАТЬ
                     |	Расход.Товар,
                     |	Расход.Склад,
                     |	Расход.Партия,
                     |	Расход.СтавкаНДС,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	Расход.КолвоРасход,
                     |	Расход.СуммаЗакупСНДСРасход,
                     |	Расход.СуммаНДСЗакупРасход,
                     |	Расход.СуммаРознСНДСРасход,
                     |	Расход.СуммаРознНДСРасход,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	Расход.Расх_ЦенаЗакуп,
                     |	Расход.Расх_ЦенаРозн,
                     |	Расход.Расх_Наценка,
                     |	NULL,
                     |	NULL,
                     |	NULL
                     |{ВЫБРАТЬ
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	НачОст_Количество,
                     |	НачОст_СуммаЗакуп,
                     |	НачОст_НДСЗакуп,
                     |	НачОст_СуммаРозн,
                     |	НачОст_НДСРозн,
                     |	Прих_Количество,
                     |	Прих_СуммаЗакуп,
                     |	Прих_НДСЗакуп,
                     |	Прих_СуммаРозн,
                     |	Прих_НДСРозн,
                     |	Расх_Количество,
                     |	Расх_СуммаЗакуп,
                     |	Расх_НДСЗакуп,
                     |	Расх_СуммаРозн,
                     |	Расх_НДСРозн,
                     |	КонОст_Количество,
                     |	КонОст_СуммаЗакуп,
                     |	КонОст_НДСЗакуп,
                     |	КонОст_СуммаРознСуммаРознСНДСОстаток1 КАК КонОст_СуммаРозн,
                     |	КонОст_НДСРозн,
                     |	КонОст_Наценка,
                     |	КонОст_ЦенаРозн,
                     |	КонОст_ЦенаЗакуп,
                     |	Расх_Наценка,
                     |	Расх_ЦенаРозн,
                     |	Расх_ЦенаЗакуп,
                     |	прих_Наценка,
                     |	Прих_ЦенаРозн,
                     |	Прих_ЦенаЗакуп,
                     |	НачОст_Наценка,
                     |	НачОст_ЦенаРозн,
                     |	НачОст_ЦенаЗакуп}
                     |ИЗ
                     |	Расход КАК Расход
                     |{ГДЕ
                     |	Расход.Товар.*,
                     |	Расход.Склад.*,
                     |	Расход.Партия.*,
                     |	Расход.СтавкаНДС.*,
                     |	Расход.КолвоРасход,
                     |	Расход.СуммаЗакупСНДСРасход,
                     |	Расход.СуммаНДСЗакупРасход,
                     |	Расход.СуммаРознСНДСРасход,
                     |	Расход.СуммаРознНДСРасход,
                     |	Расход.Расх_ЦенаЗакуп,
                     |	Расход.Расх_ЦенаРозн,
                     |	Расход.Расх_Наценка}
                     |
                     |ОБЪЕДИНИТЬ ВСЕ
                     |
                     |ВЫБРАТЬ
                     |	КонОст.Товар,
                     |	КонОст.Склад,
                     |	КонОст.Партия,
                     |	КонОст.СтавкаНДС,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	СУММА(КонОст.КолвоОстаток),
                     |	СУММА(КонОст.СуммаЗакупСНДСОстаток),
                     |	СУММА(КонОст.СуммаНДСЗакупОстаток),
                     |	СУММА(КонОст.СуммаРознСНДСОстаток),
                     |	СУММА(КонОст.СуммаРознНДСОстаток),
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	NULL,
                     |	КонОст.КонОст_ЦенаЗакуп,
                     |	КонОст.КонОст_ЦенаРозн,
                     |	КонОст.КонОст_Наценка
                     |{ВЫБРАТЬ
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	НачОст_Количество,
                     |	НачОст_СуммаЗакуп,
                     |	НачОст_НДСЗакуп,
                     |	НачОст_СуммаРозн,
                     |	НачОст_НДСРозн,
                     |	Прих_Количество,
                     |	Прих_СуммаЗакуп,
                     |	Прих_НДСЗакуп,
                     |	Прих_СуммаРозн,
                     |	Прих_НДСРозн,
                     |	Расх_Количество,
                     |	Расх_СуммаЗакуп,
                     |	Расх_НДСЗакуп,
                     |	Расх_СуммаРозн,
                     |	Расх_НДСРозн,
                     |	КонОст_Количество,
                     |	КонОст_СуммаЗакуп,
                     |	КонОст_НДСЗакуп,
                     |	КонОст_СуммаРознСуммаРознСНДСОстаток1 КАК КонОст_СуммаРозн,
                     |	КонОст_НДСРозн,
                     |	КонОст_ЦенаЗакуп,
                     |	КонОст_ЦенаРозн,
                     |	КонОст_Наценка,
                     |	Расх_Наценка,
                     |	Расх_ЦенаРозн,
                     |	Расх_ЦенаЗакуп,
                     |	прих_Наценка,
                     |	Прих_ЦенаРозн,
                     |	Прих_ЦенаЗакуп,
                     |	НачОст_Наценка,
                     |	НачОст_ЦенаРозн,
                     |	НачОст_ЦенаЗакуп}
                     |ИЗ
                     |	КонечныйОстаток КАК КонОст
                     |{ГДЕ
                     |	КонОст.Товар.*,
                     |	КонОст.Склад.*,
                     |	КонОст.Партия.*,
                     |	КонОст.СтавкаНДС.*,
                     |	КонОст.КолвоОстаток,
                     |	КонОст.СуммаЗакупСНДСОстаток,
                     |	КонОст.СуммаНДСЗакупОстаток,
                     |	КонОст.СуммаРознСНДСОстаток,
                     |	КонОст.СуммаРознНДСОстаток,
                     |	КонОст.КонОст_ЦенаЗакуп,
                     |	КонОст.КонОст_ЦенаРозн,
                     |	КонОст.КонОст_Наценка}
                     |
                     |СГРУППИРОВАТЬ ПО
                     |	КонОст.Товар,
                     |	КонОст.Склад,
                     |	КонОст.Партия,
                     |	КонОст.СтавкаНДС,
                     |	КонОст.КонОст_ЦенаЗакуп,
                     |	КонОст.КонОст_ЦенаРозн,
                     |	КонОст.КонОст_Наценка
                     |{УПОРЯДОЧИТЬ ПО
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*,
                     |	НачОст_Количество,
                     |	НачОст_СуммаЗакуп,
                     |	НачОст_НДСЗакуп,
                     |	НачОст_СуммаРозн,
                     |	НачОст_НДСРозн,
                     |	Прих_Количество,
                     |	Прих_СуммаЗакуп,
                     |	Прих_НДСЗакуп,
                     |	Прих_СуммаРозн,
                     |	Прих_НДСРозн,
                     |	Расх_Количество,
                     |	Расх_СуммаЗакуп,
                     |	Расх_НДСЗакуп,
                     |	Расх_СуммаРозн,
                     |	Расх_НДСРозн,
                     |	КонОст_Количество,
                     |	КонОст_СуммаЗакуп,
                     |	КонОст_НДСЗакуп,
                     |	КонОст_СуммаРознСуммаРознСНДСОстаток1,
                     |	КонОст_НДСРозн}
                     |{ИТОГИ ПО
                     |	Товар.*,
                     |	Склад.*,
                     |	Партия.*,
                     |	СтавкаНДС.*}
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |УНИЧТОЖИТЬ НачальныйОстаток
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |УНИЧТОЖИТЬ КонечныйОстаток
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |УНИЧТОЖИТЬ Приход
                     |;
                     |
                     |////////////////////////////////////////////////////////////////////////////////
                     |УНИЧТОЖИТЬ Расход";



Построитель.Текст=ИсходныйТекстЗапроса; // на самом деле все будет не так. это чтобы только построитель работал

Построитель.ВыбранныеПоля.Очистить();

//----------------------------------------------------------

КаталогХраненияНастроек="\\id-app-01\1C_exchange\EPF_TUNES\УОПТ_v2";

КоманднаяПанель4ОбновитьСписокНастроек("");

СтрокаУсловийПоТипамДокументов="-=НетТакойСтроки=-";

