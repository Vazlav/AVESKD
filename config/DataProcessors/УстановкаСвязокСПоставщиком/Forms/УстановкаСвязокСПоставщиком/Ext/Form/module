Перем АДО;
Перем ТЗГлавная ЭКСПОРТ;

Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура КоманднаяПанель2Загрузить(Кнопка)
	//------------------<Загружаем в ТЗ номенклатуру аптеки 2005>-------------------GtG----07.12.2007
	
	//------------------<сколько строк в ном а2005>-------------------GtG----07.12.2007
	ТХТ="Select count(*) from Prices where PostID = " + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "";
	РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
	
	Попытка 
		РС. MoveFirst();
	Исключение
		ПРедупреждение("Не удалось получить номенклатуру из аптеки 2005");
		Возврат;
	КонецПопытки; 
	
	КолвоСтрокНомА2005=Рс.Fields(0).Value;
	
	//------------------<грузим номенклатуру>-------------------GtG----07.12.2007 
	
	
	НомА5.Очистить();
	
	ТХТ="Select distinct Prices.GoodCode, Prices.GoodName,SheafWhithPost.GoodID8,Prices.Producer from Prices 
	|left join SheafWhithPost on SheafWhithPost.PostID = Prices.PostID 
	|							and SheafWhithPost.PostGood = Prices.GoodCode
	|Where Prices.PostID = '" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "'
	|Order by GoodName";
	
	
	РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
	
	
	
	ТЗ= Новый ТАблицаЗначений ;
	
	ТЗ.Колонки.Добавить("Код");
	ТЗ.Колонки.Добавить("Наименование");
	ТЗ.Колонки.Добавить("Связан");
	ТЗ.Колонки.Добавить("Производитель");
	
	
	ЭлементыФормы.Индикатор1.Видимость=Истина;
	ЭлементыФормы.Индикатор1.Значение=0;
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение=КолвоСтрокНомА2005;
	
	//------------------<заполняем  временную тз данными из 2005-й>-------------------GtG----07.12.2007
	Пока РС.EOF()=0 Цикл
		
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;
		Стр=ТЗ.Добавить();
		
		Стр.Код=РС.Fields(0).VAlue;
		Стр.Наименование=РС.Fields(1).VAlue;
		Стр.Связан=РС.Fields(2).VAlue;
		Стр.Производитель=РС.Fields(3).VAlue;
		
		Если ЭлементыФормы.Индикатор1.Значение%1000=0 ТОгда
			Состояние("Считано "+ЭлементыФормы.Индикатор1.Значение+" строк номенклатуры 2005");
		КонецЕсли; 	
		
		
		
		РС. MoveNext(); 
	КонецЦикла;
	
	
	
	ТЗ.Сортировать("Наименование");
	ТЗГлавная = ТЗ.Скопировать();
	
	ЭлементыФормы.Индикатор1.Видимость=Ложь;
	
	ЭлементыФормы.НомА5.Значение=ТЗ;
	ЭлементыФормы.НомА5.СоздатьКолонки();
	ЭлементыФормы.НомА5.Колонки.Код.Ширина = 6;
	ЭлементыФормы.НомА5.Колонки.Наименование.Ширина = 50;
	ЭлементыФормы.НомА5.Колонки.Связан.Ширина = 6;
	ЭлементыФормы.НомА5.Колонки.Производитель.Ширина = 50;

	
	
	
	
	
КонецПроцедуры

Процедура АППриАктивизацииСтроки(Элемент)
	
	//ОтборКодА5=ЕИТ.Отбор.Найти( "КодА2005");
	//
	//ТС=ЭлементыФормы.НомА5.ТекущаяСтрока;
	//
	//ЭлементыФормы.Надпись2.Заголовок=Элемент.ТекущаяСтрока.Наименование;
	//
	//Если ТС<> Неопределено ТОгда
	//	Если ТС.Связан = null Тогда
	//		Возврат;
	//	КонецЕсли;
	//	ОтборКодА5.Значение=ТС.Связан;
	//	ОтборКодА5.Использование=Истина;
	//КонецЕсли; 
	//
	//ПоказатьДляСвязи = Ложь;
	//
	НашКод = Формат(Элемент.ТекущаяСтрока.Код,"ЧГ=0");
	
	ТХТ="select distinct PostGood from SheafWhithPost where PostID = '" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "'
		| and GoodID8 = '" + НашКод + "'" ;
		//| Values ('" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "','" + Формат(ТекАП.Ссылка.Код,"ЧГ=0") + "'," + Формат(текКодПост.Код,"ЧГ=0") + ")";
	РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);	
	Попытка 
		РС. MoveFirst();
	Исключение
		ВсеСвязи.Очистить();
		//ПРедупреждение("Не удалось получить номенклатуру из аптеки 2005");
		Возврат;
	КонецПопытки; 
	
	КодТовПост=Рс.Fields(0).Value;	
	ТекСтрока = НомА5.Найти(КодТовПост,"Код");
	Если ТекСтрока <> Неопределено Тогда
		ЭлементыФормы.НомА5.ТекущаяСтрока = ТекСтрока;	
	КонецЕсли;
	
	// Найдем все связки со всеми поставщиками по этому товару 
	ТХТ="select distinct S.PostID, PostGood, P.GoodName from SheafWhithPost S
	|left join prices P on P.PostID = S.PostID and P.GoodCode = S.PostGood
	|where GoodID8 = '" + НашКод + "'" ;
	РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);	
	Попытка 
		РС. MoveFirst();
	Исключение
		//ПРедупреждение("Не удалось получить номенклатуру из аптеки 2005");
		ВсеСвязи.Очистить();
		Возврат;
	КонецПопытки; 	
	
	ТЗВрем= Новый ТАблицаЗначений ;
	
	ТЗВрем.Колонки.Добавить("Поставщик",,,30);
	ТЗВрем.Колонки.Добавить("Наименование",,,50);
	ТЗВрем.Колонки.Добавить("Код",,,10);
	
	//------------------<заполняем  временную тз данными из 2005-й>-------------------GtG----07.12.2007
	Пока РС.EOF()=0 Цикл
		
		
		Стр=ТЗВрем.Добавить();
		
		Стр.Поставщик=Справочники.Поставщики.НайтиПоКоду(РС.Fields(0).VAlue);
		Если РС.Fields(2).VAlue = NULL Тогда
			Стр.Наименование="---------------нет в прайсе----------------";
		Иначе
			Стр.Наименование=РС.Fields(2).VAlue;
		КонецЕсли;
		
		Стр.Код=РС.Fields(1).VAlue;
		
		РС. MoveNext(); 
	КонецЦикла;
	
	ЭлементыФормы.ВсеСвязи.Значение = ТЗВрем;
	ЭлементыФормы.ВсеСвязи.СоздатьКолонки();
	
	
КонецПроцедуры

Процедура НомА5ПриАктивизацииСтроки(Элемент)
	Попытка
		ЭлементыФормы.Надпись1.Заголовок=Элемент.ТекущаяСтрока.Наименование;
	Исключение
		Возврат;
	КонецПопытки;
	
	//------------------<Переместим выделение в таблице ап на связанную позицию>-------------------GtG----07.12.2007
	Если ЭлементыФормы.НомА5.Колонки.Найти("Связан")<> Неопределено  Тогда   
		
		//ТХТ="ВЫБРАТЬ
		//	|	ЕИТ.Владелец.Ссылка как Ссылка
		//	|ИЗ
		//	|	Справочник.ЕИТ КАК ЕИТ
		//	|ГДЕ
		//	|	ЕИТ.КодА2005 = &КодА2005";
		ТХТ="ВЫБРАТЬ
		    |	АП.Ссылка как Ссылка
		    |ИЗ
		    |	Справочник.Ассортиментный_План как АП
		    |ГДЕ
		    |	АП.Код = &Код";
		
			
			Запрос=Новый Запрос;
			Запрос.Текст=ТХТ;
			Запрос.УстановитьПараметр("Код",Элемент.ТекущаяСтрока.Связан);
			
			//------------------<Ищем через ЕИТы>-------------------GtG----07.12.2007
			ТЗ=Запрос.Выполнить().Выгрузить();
			
			ЕСли ТЗ.Количество()>0  Тогда  
				СвязанныйАП=ТЗ.Получить(0).Ссылка;
				ЭлементыФормы.АП.ТекущаяСтрока=СвязанныйАП; // переместим выделение на связанный элем АП
				АППриАктивизацииСтроки(ЭлементыФормы.АП);
    		Иначе
				//ЭлементыФормы.АП.ТекущаяСтрока= Неопределено; // сбросим выделение ваще
			КонецЕсли;	
		ЭлементыФормы.УдалитьСвязь.Доступность = Истина;
	Иначе
		ЭлементыФормы.УдалитьСвязь.Доступность = Ложь;
	КонецЕсли; 
	
КонецПроцедуры

Процедура ПодключитьЦентральнуюБазу(АдоЦБ) Экспорт// ---- by  GtG ---- 
	//---------------------- ПОДКЛЮЧАЕМСЯ К БАЗЕ ЧЕРЕЗ ADO -------------------GTG->-
	АдоЦБ=Новый COMОбъект ("AdoDB.Connection");
	АдоЦБ_КоннСтр="DSN=A5_Sklad; Password=;User ID=sa";
	АдоЦБ.Open(АдоЦБ_КоннСтр);
	//------------------------------------------------------------------------GTG-<-  
	//глПРоверкаСостоянияАДО(АдоЦБ,"Подключение к А2005 через ADODB");   
КонецПроцедуры // ----< ПодключитьЦентральнуюБазу_АДО >---- by  GtG ----

Процедура СвязатьНажатие(Элемент)
	
	//Если ЕдИзм.Пустая()=Истина ТОгда
	//	ПРедупреждение("Не выбрана единица измерения!");
	//	Возврат;
	//КонецЕсли; 
	//
	//Если К=0 ТОгда
	//	К=1;
	//	ПРедупреждение("Коэффициент установлен равным 1 !");
	//КонецЕсли; 	
	//
	//
	//	ТОВар=ЭлементыФормы.АП.ТекущаяСтрока;
	//
	//НоваяЕит=Справочники.ЕИТ.СоздатьЭлемент();
	//НоваяЕИТ.Владелец=ТОвар;
	//НоваяЕИТ.К=К;
	//НоваяЕИТ.ЕдИзм=ЕдИзм;
	//НоваяЕИТ.КодА2005= ЭлементыФормы.НомА5.ТекущаяСтрока.Код;
	//НоваяЕИТ.Наименование=ЕдИзм.Наименование;
	//НоваяЕИТ.НаименованиеТовара=ТОвар.Наименование;
	//НоваяЕИТ.Записать();
	//
	//Префикс=Константы.Первые2СимволаВШКНеЖНВЛС.Получить();
	//ШтрихкодВн=ОМ1_ШК_СПрефиксом(Префикс,НоваяЕИТ.Код);
	//НоваяЕИТ.ШтрихкодВн=ШтрихкодВн;
	//НоваяЕИТ.Записать();
	//
	//АППриАктивизацииСтроки(ЭлементыФормы.АП);
	//
	//ЭлементыФормы.НомА5.ТекущаяСтрока.Связан=НоваяЕИТ.Код;
	
	ТекАП = ЭлементыФормы.АП.ТекущаяСтрока;
	Если (НовыйКод = "") или (НовыйКод = Неопределено) или (НовыйКод = "0") Тогда
		ТекКодПост = ЭлементыФормы.НомА5.ТекущаяСтрока;
		ТХТ="Insert into SheafWhithPost (PostID,GoodID8,PostGood) 
		| Values ('" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "','" + Формат(ТекАП.Ссылка.Код,"ЧГ=0") + "', '" + СокрЛП(текКодПост.Код) + "')";
	
	Иначе

		ТХТ="Insert into SheafWhithPost (PostID,GoodID8,PostGood) 
		| Values ('" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "','" + Формат(ТекАП.Ссылка.Код,"ЧГ=0") + "','" + СокрЛП(НовыйКод) + "')";
		
	КонецЕсли;
	
	
	РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
	
	Если (НовыйКод = "0") или (НовыйКод = Неопределено) или (НовыйКод = "") Тогда
		ЭлементыФормы.НомА5.ТекущаяСтрока.Связан=ТекАП.Ссылка.Код;
	Иначе
		НовыйКод = 0;
	КонецЕсли;
	

КонецПроцедуры

Процедура ПоказатьДляСвязиПриИзменении(Элемент)
	
	//Если ПоказатьДляСвязи = Истина Тогда
	//	ОтборКодА5=ЕИТ.Отбор.Найти( "КодА2005");
	//	ОтборКодА5.Использование = Ложь;
	//Иначе
	//	АППриАктивизацииСтроки(ЭлементыФормы.АП);
	//КонецЕсли;


КонецПроцедуры

Процедура УдалитьСвязьНажатие(Элемент)
	
	
	Если (НовыйКод = "0") или (НовыйКод = Неопределено) или (НовыйКод = "") Тогда
		
		ТекАП = ЭлементыФормы.АП.ТекущаяСтрока;
		ТекКодПост = ЭлементыФормы.НомА5.ТекущаяСтрока;
		
		ТХТ="delete from SheafWhithPost where PostID = '" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "' and GoodID8 = '" + Формат(ТекАП.Ссылка.Код,"ЧГ=0") + "' and PostGood = '" + СокрЛП(текКодПост.Код) + "'";
		
		РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
		
		ЭлементыФормы.НомА5.ТекущаяСтрока.Связан=0;	
	Иначе
		ТекАП = ЭлементыФормы.АП.ТекущаяСтрока;
		ТХТ="delete from SheafWhithPost where PostID = '" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "' and GoodID8 = '" + Формат(ТекАП.Ссылка.Код,"ЧГ=0") + "' and PostGood = '" + СокрЛП(НовыйКод) + "'";
		РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
	КонецЕсли;
	
	
КонецПроцедуры

Процедура КоманднаяПанель2Фильтр(Кнопка)
	
	Если ПустаяСтрока(ВыбПоставщик) = Истина Тогда
		Возврат;
	КонецЕсли;
	
	Текст = "";
	Подсказка = "Введите текст поиска";
	
	Если ВвестиСтроку(Текст, Подсказка, 20, Истина) Тогда
		Если ПустаяСтрока(Текст) = Ложь Тогда
			
			ТХТ="Select distinct Prices.GoodCode, Prices.GoodName,SheafWhithPost.GoodID8,Prices.Producer from Prices 
			|left join SheafWhithPost on SheafWhithPost.PostID = Prices.PostID 
			|							and SheafWhithPost.PostGood = Prices.GoodCode
			|Where Prices.PostID = '" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "' and  Prices.GoodName like '%" + СокрЛП(Текст) + "%'
			|Order by GoodName";
			
			
			РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
			
			
			
			ТЗ= Новый ТАблицаЗначений;
			
			ТЗ.Колонки.Добавить("Код");
			ТЗ.Колонки.Добавить("Наименование");
			ТЗ.Колонки.Добавить("Связан");
			ТЗ.Колонки.Добавить("Производитель");
			
			
			//------------------<заполняем  временную тз данными из 2005-й>-------------------GtG----07.12.2007
			Пока РС.EOF()=0 Цикл
				
				Стр=ТЗ.Добавить();
				
				Стр.Код=РС.Fields(0).VAlue;
				Стр.Наименование=РС.Fields(1).VAlue;
				Стр.Связан=РС.Fields(2).VAlue;
				Стр.Производитель=РС.Fields(3).VAlue;
				
				
				РС. MoveNext(); 
			КонецЦикла;
			ТЗ.Сортировать("Наименование");
			
			ЭлементыФормы.НомА5.Значение=ТЗ;
			ЭлементыФормы.НомА5.СоздатьКолонки();
			ЭлементыФормы.НомА5.Колонки.Код.Ширина = 6;
			ЭлементыФормы.НомА5.Колонки.Наименование.Ширина = 50;
			ЭлементыФормы.НомА5.Колонки.Связан.Ширина = 6;
			ЭлементыФормы.НомА5.Колонки.Производитель.Ширина = 50;
		Иначе
			
			ЭлементыФормы.НомА5.Значение=ТЗГлавная;
			ЭлементыФормы.НомА5.СоздатьКолонки();
			ЭлементыФормы.НомА5.Колонки.Код.Ширина = 6;
			ЭлементыФормы.НомА5.Колонки.Наименование.Ширина = 50;
			ЭлементыФормы.НомА5.Колонки.Связан.Ширина = 6;
			ЭлементыФормы.НомА5.Колонки.Производитель.Ширина = 50;
	КонецЕсли;

	
КонецЕсли;		
	
КонецПроцедуры

Процедура ПриОткрытии()
	Если Поставщик <> Справочники.Поставщики.ПустаяСсылка() Тогда
		ВыбПоставщик = Поставщик;
			ТХТ="Select distinct Prices.GoodCode, Prices.GoodName,SheafWhithPost.GoodID8,Prices.Producer from Prices 
			|left join SheafWhithPost on SheafWhithPost.PostID = Prices.PostID 
			|							and SheafWhithPost.PostGood = Prices.GoodCode
			|Where Prices.PostID = '" + Формат(ВыбПоставщик.Ссылка.Код,"ЧГ=0") + "' and  Prices.GoodCode in (" + СокрЛП(УсловиеФильтра) + ")
			|Order by GoodName";
			
			
			РС=ОМ8_ВыполнитьSQLЗапросКВнешнейБД(АДО,ТХТ,0,1,0);
			
			
			
			ТЗ= Новый ТАблицаЗначений;
			
			ТЗ.Колонки.Добавить("Код");
			ТЗ.Колонки.Добавить("Наименование");
			ТЗ.Колонки.Добавить("Связан");
			ТЗ.Колонки.Добавить("Производитель");
			
			Если РС <> "" Тогда
				
				//------------------<заполняем  временную тз данными из 2005-й>-------------------GtG----07.12.2007
				Пока РС.EOF()=0 Цикл
					
					Стр=ТЗ.Добавить();
					
					Стр.Код=РС.Fields(0).VAlue;
					Стр.Наименование=РС.Fields(1).VAlue;
					Стр.Связан=РС.Fields(2).VAlue;
					Стр.Производитель=РС.Fields(3).VAlue;
					
					
					РС. MoveNext(); 
				КонецЦикла;
				ТЗ.Сортировать("Наименование");
				
				ЭлементыФормы.НомА5.Значение=ТЗ;
				
				ЭлементыФормы.НомА5.СоздатьКолонки();
				ЭлементыФормы.НомА5.Колонки.Код.Ширина = 6;
				ЭлементыФормы.НомА5.Колонки.Наименование.Ширина = 50;
				ЭлементыФормы.НомА5.Колонки.Связан.Ширина = 6;
				ЭлементыФормы.НомА5.Колонки.Производитель.Ширина = 50;
				
			КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры
//===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***===***//
Попытка
	ПодключитьЦентральнуюБазу(Адо);

Исключение
	Сообщить("Не удалось подключиться к базе. Проверьте настройки AdoDB.Connection. DSN=A5_Sklad");
КонецПопытки;

ЭлементыФормы.Индикатор1.Видимость=Ложь;