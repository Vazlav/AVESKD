Функция  ПроверкаВозможностиЗакрытьСмену() 
	
	Если Фирма.Пустая()=Истина Тогда
		Предупреждение("Не выбрана фирма!");
		Возврат Ложь;
	КонецЕсли;	
	
	Если Аптека.Пустая()=Истина Тогда
		Предупреждение("Не выбрана аптека!");
		Возврат Ложь;
	КонецЕсли;	
	
	Если ДатаСмены = Дата("00010101000000") Тогда
		Предупреждение("Не указана дата смены!");
		Возврат Ложь;
	КонецЕсли;	

	//---------------<Все указано, надо проверить не закрыта ли уже смена ранее?>---------------------------// GtG // 01.08.2012 20:39:31
	// Критерии:
	//        1)Должны быть проведенные чеки по аптеке с указанной датой смены
	//        2)Должен быть Z-отчет по этой смене и номеру ккм, пробитый на ккм (что значит что смена закрыта)
	
	
	
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ЧекПродажи.ДатаСмены,
	                      |	ЧекПродажи.НомерСмены,
	                      |	ЧекПродажи.СерийныйНомер,
	                      |	ЧекСлужебный.Ссылка,
	                      |	ЧекСлужебный.Представление,
	                      |	ЧекПродажи.СменаЗакрыта
	                      |ИЗ
	                      |	Документ.ЧекПродажи КАК ЧекПродажи
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЧекСлужебный КАК ЧекСлужебный
	                      |		ПО конецпериода(ЧекПродажи.ДатаСмены,день) = конецпериода(ЧекСлужебный.ДатаСмены,день)
	                      |			И ЧекПродажи.НомерСмены = ЧекСлужебный.НомерСмены
	                      |			И ЧекПродажи.СерийныйНомер = ЧекСлужебный.СерийныйНомер
	                      |			И (ЧекСлужебный.ТипСлужебногоЧека = &ТипЗетОтчет)
	                      |ГДЕ
	                      |	ЧекПродажи.Проведен  <>&ПерезакрытиеСтаройСмены
	                      |	И ЧекПродажи.Фирма = &Фирма
	                      |	И ЧекПродажи.Аптека = &Аптека
	                      |	И конецпериода(ЧекПродажи.ДатаСмены,день) = конецпериода(&ДатаСмены,День)
	                      |	И ЧекСлужебный.Ссылка ЕСТЬ НЕ NULL ");

	
	
	  Запрос.УстановитьПараметр("Фирма",Фирма);
	  Запрос.УстановитьПараметр("Аптека",Аптека);
	  Запрос.УстановитьПараметр("ДатаСмены",ДатаСмены);
	  Запрос.УстановитьПараметр("ТипЗетОтчет",Перечисления.ККМ_ТипыСлужебныхЧеков.Z_Отчет);
	  Запрос.УстановитьПараметр("ПерезакрытиеСтаройСмены",ПерезакрытиеСтаройСмены);

	  Рез=Запрос.Выполнить().Выгрузить();
	  
	  // Наличие проведенных чеков, закрытых зет-отчетом говорит о том что выручка ккм по ним еще не формировалась
	
	  Если Рез.Количество()<>0 Тогда
		  Возврат Истина;
	  Иначе
		  Возврат Ложь;
	  КонецЕсли;
КонецФункции

ПРоцедура ДвижениеКасс()
	
	Запрос=Новый Запрос( "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЧекПродажиТовар.Ссылка.СерийныйНомер,
	|	ЧекПродажиТовар.Ссылка.Фирма,
	|	ЧекПродажиТовар.Ссылка.Аптека
	|ПОМЕСТИТЬ ИсхДанные
	|ИЗ
	|	Документ.ЧекПродажи.Товар КАК ЧекПродажиТовар
	|ГДЕ
	|	ЧекПродажиТовар.Ссылка.ДатаСмены = &ДатаСмены
	|	И ЧекПродажиТовар.Ссылка.Проведен = ИСТИНА
	|	И ЧекПродажиТовар.Ссылка.Фирма = &Фирма
	|	И ЧекПродажиТовар.Ссылка.Аптека = &Аптека
	|	И ЧекПродажиТовар.Ссылка.СменаЗакрыта = ИСТИНА
	|	И ЧекПродажиТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ИсхДанные.СерийныйНомер,
	|	ИсхДанные.Аптека КАК ТекАптека,
	|	Кассы.Ссылка КАК Касса,
	|	Кассы.Владелец,
	|	ВЫБОР
	|		КОГДА Кассы.Владелец ЕСТЬ NULL 
	|			ТОГДА 0
	|		КОГДА Кассы.Владелец ЕСТЬ НЕ NULL 
	|				И Кассы.Владелец <> ИсхДанные.Аптека
	|			ТОГДА 1
	|		КОГДА Кассы.Владелец = ИсхДанные.Аптека
	|			ТОГДА 2
	|	КОНЕЦ КАК Действие,
	|	Кассы.ПометкаУдаления
	|ИЗ
	|	ИсхДанные КАК ИсхДанные
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Кассы КАК Кассы
	|		ПО ИсхДанные.СерийныйНомер = Кассы.ЗаводскойНомер
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИсхДанные");
	
	Запрос.УстановитьПараметр("ДатаСмены",ДатаСмены);
	Запрос.УстановитьПараметр("Фирма",Фирма);
	Запрос.УстановитьПараметр("Аптека",Аптека);
	
	ТаблицаНомеровККМ=Запрос.Выполнить().Выгрузить();
	
	Для Каждого Стр Из  ТаблицаНомеровККМ Цикл
		Если Стр.Действие=0 ТОгда
			НоваяКасса=Справочники.Кассы.СоздатьЭлемент();
			НоваяКасса.ЗаводскойНомер=Стр.СерийныйНомер;
			НоваяКасса.Владелец=Стр.ТекАптека ;
			НоваяКасса.Наименование= Стр.СерийныйНомер;
			НоваяКасса.Записать();
			Сообщить("Создана новая касса "+НоваяКасса);
		ИначеЕсли Стр.Действие=1 и стр.ПометкаУдаления=ложь ТОгда	 // касса переехала
			ОбКасса=Стр.Касса.ПолучитьОбъект();
			ОбКасса.УстановитьПометкуУдаления(Истина);
			Сообщить("Касса "+ОбКасса+" уехала из аптеки "+ОбКасса.Владелец);
		ИначеЕсли Стр.Действие=2 и стр.ПометкаУдаления=истина ТОгда	 // касса вернулась
			ОбКасса=Стр.Касса.ПолучитьОбъект();
			ОбКасса.УстановитьПометкуУдаления(Ложь);
			Сообщить("Касса "+ОбКасса+" вернулась в аптеку "+ОбКасса.Владелец);
			
		КонецЕсли;	 
		
	КонецЦикла;	 
	
КонецПроцедуры	


Процедура КнопкаВыполнитьНажатие(Кнопка)
	Если ПроверкаВозможностиЗакрытьСмену()=ЛОжь Тогда
		Возврат;
	КонецЕсли;
	
	
	
	
	
	
	
	//-----------------------------
	//	1) уаляем непроведенные непробитые мусорные чеки
	
	Запрос=Новый Запрос("ВЫБРАТЬ
	                    |	ЧекПродажи.Ссылка
	                    |ИЗ
	                    |	Документ.ЧекПродажи КАК ЧекПродажи
	                    |ГДЕ
	                    |	ЧекПродажи.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)
	                    |	И ЧекПродажи.Проведен = ЛОЖЬ
	                    |	И ЧекПродажи.Фирма = &Фирма
	                    |	И ЧекПродажи.Аптека = &Аптека
	                    |	И ЧекПродажи.ЧекПробитНаККМ = ЛОЖЬ
	                    |	И ЧекПродажи.СменаЗакрыта = ЛОЖЬ
	                    |
	                    |ОБЪЕДИНИТЬ ВСЕ
	                    |
	                    |ВЫБРАТЬ
	                    |	ЧекВозврата.Ссылка
	                    |ИЗ
	                    |	Документ.ЧекВозврата КАК ЧекВозврата
	                    |ГДЕ
	                    |	ЧекВозврата.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ) И КОНЕЦПЕРИОДА(&Дата, ДЕНЬ)
	                    |	И ЧекВозврата.Проведен = ЛОЖЬ
	                    |	И ЧекВозврата.Фирма = &Фирма
	                    |	И ЧекВозврата.Аптека = &Аптека
	                    |	И ЧекВозврата.ЧекПробитНаККМ = ЛОЖЬ
	                    |	И ЧекВозврата.СменаЗакрыта = ЛОЖЬ");
	
	Запрос.УстановитьПараметр("Фирма",Фирма);
	Запрос.УстановитьПараметр("Аптека",Аптека);
	Запрос.УстановитьПараметр("Дата",ДатаСмены);
	
	Рез=Запрос.Выполнить().Выгрузить();
	
	ДЛя Каждого Стр Из Рез Цикл
		ОбЧек=Стр.Ссылка.ПолучитьОбъект();
		Если ОбЧек.Товар.Количество()=0 и ОбЧек.АвансыПоУслугам.Количество()=0 Тогда
			ОбЧек.Удалить();// с концаминах  , это мусорный чек
		КонецЕсли;	
	КонецЦикла;
	// Если после этого что-то останется - это какие-то странные глючные чеки, возможно там есть что-то полезное.
	
	
	//---------------<Выковыриваем из чеков данные по номерам ККМ и привязываем изх к аптеке>---------------------------// GtG // 02.08.2012 17:01:24
	ДвижениеКасс();
	 

	
	
	
	
	
	
	
	
	//2) распроводим оставшиеся пробитые чеки и на основании данных из них формируем реализацию ккм
	РеализацияККМ=Документы.РеализацияККМ.СоздатьДокумент();
	РеализацияККМ.Фирма=Фирма;
	РеализацияККМ.Склад=Аптека;
	
	СтрИзм=РеализацияККМ.Изменения.Добавить();
	СтрИзм.Дата=ТекущаяДата();
	СтрИзм.КомментарийИзменения="Создан обработкой по закрытию смены по чекам";
	СтрИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр;
	СтрИзм.ТипИзм=Перечисления.ДействияНадДокументами.Загрузка;
	
	//---------------<Данные для заполнения таблицы Товар>---------------------------// GtG // 01.08.2012 21:56:59
	Запрос=Новый Запрос( "ВЫБРАТЬ
	                     |	ЧекПродажиТовар.Товар,
	                     |	ЧекПродажиТовар.ЕИТ,
	                     |	ЧекПродажиТовар.К,
	                     |	ЧекПродажиТовар.Количество КАК Количество,
	                     |	ЧекПродажиТовар.Партия,
	                     |	ЧекПродажиТовар.Сумма КАК Сумма,
	                     |	ЧекПродажиТовар.СтавкаНДС,
	                     |	ЧекПродажиТовар.СуммаНДС КАК СуммаНДС,
	                     |	ЧекПродажиТовар.СуммаЗакуп КАК СуммаЗакуп,
	                     |	ЧекПродажиТовар.НДСЗакуп КАК НДСЗакуп,
	                     |	ЧекПродажиТовар.Ссылка КАК Чек,
	                     |	ЧекПродажиТовар.Ссылка.НомерСмены,
	                     |	ЧекПродажиТовар.Ссылка.ДатаСмены
	                     |ПОМЕСТИТЬ ИсхДанные
	                     |ИЗ
	                     |	Документ.ЧекПродажи.Товар КАК ЧекПродажиТовар
	                     |ГДЕ
	                     |	КОНЕЦПЕРИОДА(ЧекПродажиТовар.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
	                     |	И ЧекПродажиТовар.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
	                     |	И ЧекПродажиТовар.Ссылка.Фирма = &Фирма
	                     |	И ЧекПродажиТовар.Ссылка.Аптека = &Аптека
	                     |	И ЧекПродажиТовар.Ссылка.СменаЗакрыта = ИСТИНА
	                     |	И ЧекПродажиТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА
	                     |
	                     |ОБЪЕДИНИТЬ ВСЕ
	                     |
	                     |ВЫБРАТЬ
	                     |	ЧекВозвратаТовар.Товар,
	                     |	ЧекВозвратаТовар.ЕИТ,
	                     |	ЧекВозвратаТовар.К,
	                     |	ЧекВозвратаТовар.Количество,
	                     |	ЧекВозвратаТовар.Партия,
	                     |	ЧекВозвратаТовар.Сумма,
	                     |	ЧекВозвратаТовар.СтавкаНДС,
	                     |	ЧекВозвратаТовар.СуммаНДС,
	                     |	ЧекВозвратаТовар.СуммаЗакуп,
	                     |	ЧекВозвратаТовар.НДСЗакуп,
	                     |	ЧекВозвратаТовар.Ссылка.ВозвращаемыйЧек,
	                     |	ЧекВозвратаТовар.Ссылка.НомерСмены,
	                     |	ЧекВозвратаТовар.Ссылка.ДатаСмены
	                     |ИЗ
	                     |	Документ.ЧекВозврата.Товар КАК ЧекВозвратаТовар
	                     |ГДЕ
	                     |	КОНЕЦПЕРИОДА(ЧекВозвратаТовар.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
	                     |	И ЧекВозвратаТовар.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
	                     |	И ЧекВозвратаТовар.Ссылка.Фирма = &Фирма
	                     |	И ЧекВозвратаТовар.Ссылка.Аптека = &Аптека
	                     |	И ЧекВозвратаТовар.Ссылка.СменаЗакрыта = ИСТИНА
	                     |	И ЧекВозвратаТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА
	                     |;
	                     |
	                     |////////////////////////////////////////////////////////////////////////////////
	                     |ВЫБРАТЬ
	                     |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ИсхДанные.Чек) КАК КолвоЧековПродажи
	                     |ПОМЕСТИТЬ КолвоЧеков
	                     |ИЗ
	                     |	ИсхДанные КАК ИсхДанные
	                     |;
	                     |
	                     |////////////////////////////////////////////////////////////////////////////////
	                     |ВЫБРАТЬ
	                     |	ИсхДанные.Товар,
	                     |	ИсхДанные.ЕИТ,
	                     |	ИсхДанные.К,
	                     |	СУММА(ИсхДанные.Количество) КАК Количество,
	                     |	ИсхДанные.Партия,
	                     |	СУММА(ИсхДанные.Сумма) КАК Сумма,
	                     |	ИсхДанные.СтавкаНДС,
	                     |	СУММА(ИсхДанные.СуммаНДС) КАК СуммаНДС,
	                     |	СУММА(ИсхДанные.СуммаЗакуп) КАК СуммаЗакуп,
	                     |	СУММА(ИсхДанные.НДСЗакуп) КАК НДСЗакуп,
	                     |	КолвоЧеков.КолвоЧековПродажи
	                     |ИЗ
	                     |	ИсхДанные КАК ИсхДанные,
	                     |	КолвоЧеков КАК КолвоЧеков
	                     |
	                     |СГРУППИРОВАТЬ ПО
	                     |	ИсхДанные.Товар,
	                     |	ИсхДанные.ЕИТ,
	                     |	ИсхДанные.К,
	                     |	ИсхДанные.Партия,
	                     |	ИсхДанные.СтавкаНДС,
	                     |	КолвоЧеков.КолвоЧековПродажи
	                     |;
	                     |
	                     |////////////////////////////////////////////////////////////////////////////////
	                     |УНИЧТОЖИТЬ ИсхДанные
	                     |;
	                     |
	                     |////////////////////////////////////////////////////////////////////////////////
	                     |УНИЧТОЖИТЬ КолвоЧеков"); // Сгенерировано в GtG's Консоль запросов. 01.08.2012 22:06:56
	
						 Запрос.УстановитьПараметр("ДатаСмены",ДатаСмены);
						 Запрос.УстановитьПараметр("Фирма",Фирма);
						 Запрос.УстановитьПараметр("Аптека",Аптека);
						 Запрос.УстановитьПараметр("ПерезакрытиеСтаройСмены",ПерезакрытиеСтаройСмены);
						 Рез=Запрос.Выполнить().Выгрузить();
						 
						 РеализацияККМ.Товар.Загрузить(Рез);
						 
						 Если  Рез.Количество()<>0 Тогда
							 РеализацияККМ.КоличествоЧеков=Рез.Получить(0).КолвоЧековПродажи;
						 КонецЕсли;
	
	//---------------<Данные для заполнения таблицы Дисконт>---------------------------// GtG // 01.08.2012 22:25:22 
		Запрос=Новый Запрос( "ВЫБРАТЬ
		                     |	база.Товар,
		                     |	база.Еит,
		                     |	база.К,
		                     |	СУММА(база.Количество) КАК Количество,
		                     |	база.Партия,
		                     |	база.НомерСмены,
		                     |	база.ДатаСмены,
		                     |	база.Карта,
		                     |	СУММА(база.СуммаСоСкидкой) КАК СуммаСоСкидкой,
		                     |	СУММА(база.СуммаСкидки) КАК СуммаСкидки,
		                     |	база.ШКЛПВ,
		                     |	база.НомерЧека
		                     |ИЗ
		                     |	(ВЫБРАТЬ
		                     |		ЧекПродажиДисконт.Товар КАК Товар,
		                     |		ЧекПродажиДисконт.Еит КАК Еит,
		                     |		ЧекПродажиДисконт.К КАК К,
		                     |		СУММА(ЧекПродажиДисконт.Количество) КАК Количество,
		                     |		ЧекПродажиДисконт.Партия КАК Партия,
		                     |		ЧекПродажиДисконт.Ссылка.НомерСмены КАК НомерСмены,
		                     |		ЧекПродажиДисконт.Ссылка.ДатаСмены КАК ДатаСмены,
		                     |		ЧекПродажиДисконт.Карта КАК Карта,
		                     |		СУММА(ЧекПродажиДисконт.СуммаСоСкидкой) КАК СуммаСоСкидкой,
		                     |		СУММА(ЧекПродажиДисконт.СуммаСкидки) КАК СуммаСкидки,
		                     |		ЧекПродажиДисконт.Ссылка.ШКЛПВ КАК ШКЛПВ,
		                     |		ЧекПродажиДисконт.Ссылка.НомерЧека КАК НомерЧека
		                     |	ИЗ
		                     |		Документ.ЧекПродажи.Дисконт КАК ЧекПродажиДисконт
		                     |	ГДЕ
		                     |		КОНЕЦПЕРИОДА(ЧекПродажиДисконт.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
		                     |		И ЧекПродажиДисконт.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
		                     |		И ЧекПродажиДисконт.Ссылка.Фирма = &Фирма
		                     |		И ЧекПродажиДисконт.Ссылка.Аптека = &Аптека
		                     |		И ЧекПродажиДисконт.Ссылка.СменаЗакрыта = ИСТИНА
		                     |		И ЧекПродажиДисконт.Ссылка.ЧекПробитНаККМ = ИСТИНА
		                     |	
		                     |	СГРУППИРОВАТЬ ПО
		                     |		ЧекПродажиДисконт.Товар,
		                     |		ЧекПродажиДисконт.Еит,
		                     |		ЧекПродажиДисконт.К,
		                     |		ЧекПродажиДисконт.Партия,
		                     |		ЧекПродажиДисконт.Ссылка.НомерСмены,
		                     |		ЧекПродажиДисконт.Ссылка.ДатаСмены,
		                     |		ЧекПродажиДисконт.Карта,
		                     |		ЧекПродажиДисконт.Ссылка.ШКЛПВ,
		                     |		ЧекПродажиДисконт.Ссылка.НомерЧека
		                     |	
		                     |	ОБЪЕДИНИТЬ ВСЕ
		                     |	
		                     |	ВЫБРАТЬ
		                     |		ЧекВозвратаДисконт.Товар,
		                     |		ЧекВозвратаДисконт.Еит,
		                     |		ЧекВозвратаДисконт.К,
		                     |		СУММА(ЧекВозвратаДисконт.Количество),
		                     |		ЧекВозвратаДисконт.Партия,
		                     |		ЧекВозвратаДисконт.Ссылка.НомерСмены,
		                     |		ЧекВозвратаДисконт.Ссылка.ДатаСмены,
		                     |		ЧекВозвратаДисконт.Карта,
		                     |		СУММА(ЧекВозвратаДисконт.СуммаСоСкидкой),
		                     |		СУММА(ЧекВозвратаДисконт.СуммаСкидки),
		                     |		NULL,
		                     |		ЧекВозвратаДисконт.Ссылка.ДокументОснование.НомерЧека
		                     |	ИЗ
		                     |		Документ.ЧекВозврата.Дисконт КАК ЧекВозвратаДисконт
		                     |	ГДЕ
		                     |		КОНЕЦПЕРИОДА(ЧекВозвратаДисконт.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
		                     |		И ЧекВозвратаДисконт.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
		                     |		И ЧекВозвратаДисконт.Ссылка.Фирма = &Фирма
		                     |		И ЧекВозвратаДисконт.Ссылка.Аптека = &Аптека
		                     |		И ЧекВозвратаДисконт.Ссылка.СменаЗакрыта = ИСТИНА
		                     |		И ЧекВозвратаДисконт.Ссылка.ЧекПробитНаККМ = ИСТИНА
		                     |	
		                     |	СГРУППИРОВАТЬ ПО
		                     |		ЧекВозвратаДисконт.Товар,
		                     |		ЧекВозвратаДисконт.Еит,
		                     |		ЧекВозвратаДисконт.К,
		                     |		ЧекВозвратаДисконт.Партия,
		                     |		ЧекВозвратаДисконт.Ссылка.НомерСмены,
		                     |		ЧекВозвратаДисконт.Ссылка.ДатаСмены,
		                     |		ЧекВозвратаДисконт.Карта,
		                     |		ЧекВозвратаДисконт.Ссылка.ДокументОснование.НомерЧека) КАК база
		                     |
		                     |СГРУППИРОВАТЬ ПО
		                     |	база.Товар,
		                     |	база.Еит,
		                     |	база.К,
		                     |	база.Партия,
		                     |	база.НомерСмены,
		                     |	база.ДатаСмены,
		                     |	база.Карта,
		                     |	база.ШКЛПВ,
		                     |	база.НомерЧека"); // Сгенерировано в GtG's Консоль запросов. 01.08.2012 22:06:56
	
						 Запрос.УстановитьПараметр("ДатаСмены",ДатаСмены);
						 Запрос.УстановитьПараметр("Фирма",Фирма);
						 Запрос.УстановитьПараметр("Аптека",Аптека);
						 Запрос.УстановитьПараметр("ПерезакрытиеСтаройСмены",ПерезакрытиеСтаройСмены);
						 РеализацияККМ.Дисконт.Загрузить(Запрос.Выполнить().Выгрузить());

	
	//---------------<Данные для заполненрия таблицы авансыпоуслугам>---------------------------// GtG // 01.08.2012 22:25:52
	Запрос=Новый Запрос( "ВЫБРАТЬ
	                     |	база.ВидОперации,
	                     |	база.ТипОплаты,
	                     |	база.НомерЗаказа,
	                     |	база.ДатаЗаказа,
	                     |	СУММА(база.Сумма) КАК Сумма,
	                     |	база.Касса,
	                     |	база.ЗетОчет,
	                     |	база.СтавкаНДС,
	                     |	СУММА(база.СуммаНДС) КАК СуммаНДС,
	                     |	база.Услуга,
	                     |	база.НомерСмены,
	                     |	база.ДатаСмены,
	                     |	база.СерийныйНомер
	                     |ИЗ
	                     |	(ВЫБРАТЬ
	                     |		ЧекПродажиАвансыПоУслугам.ВидОперации КАК ВидОперации,
	                     |		ЧекПродажиАвансыПоУслугам.ТипОплаты КАК ТипОплаты,
	                     |		ЧекПродажиАвансыПоУслугам.НомерЗаказа КАК НомерЗаказа,
	                     |		ЧекПродажиАвансыПоУслугам.ДатаЗаказа КАК ДатаЗаказа,
	                     |		СУММА(ЧекПродажиАвансыПоУслугам.Сумма) КАК Сумма,
	                     |		ЧекПродажиАвансыПоУслугам.Касса КАК Касса,
	                     |		ЧекПродажиАвансыПоУслугам.ЗетОчет КАК ЗетОчет,
	                     |		ЧекПродажиАвансыПоУслугам.СтавкаНДС КАК СтавкаНДС,
	                     |		СУММА(ЧекПродажиАвансыПоУслугам.СуммаНДС) КАК СуммаНДС,
	                     |		ЧекПродажиАвансыПоУслугам.Услуга КАК Услуга,
	                     |		ЧекПродажиАвансыПоУслугам.Ссылка.НомерСмены КАК НомерСмены,
	                     |		ЧекПродажиАвансыПоУслугам.Ссылка.ДатаСмены КАК ДатаСмены,
	                     |		ЧекПродажиАвансыПоУслугам.Ссылка.СерийныйНомер КАК СерийныйНомер
	                     |	ИЗ
	                     |		Документ.ЧекПродажи.АвансыПоУслугам КАК ЧекПродажиАвансыПоУслугам
	                     |	ГДЕ
	                     |		КОНЕЦПЕРИОДА(ЧекПродажиАвансыПоУслугам.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
	                     |		И ЧекПродажиАвансыПоУслугам.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
	                     |		И ЧекПродажиАвансыПоУслугам.Ссылка.Фирма = &Фирма
	                     |		И ЧекПродажиАвансыПоУслугам.Ссылка.Аптека = &Аптека
	                     |		И ЧекПродажиАвансыПоУслугам.Ссылка.СменаЗакрыта = ИСТИНА
	                     |		И ЧекПродажиАвансыПоУслугам.Ссылка.ЧекПробитНаККМ = ИСТИНА
	                     |	
	                     |	СГРУППИРОВАТЬ ПО
	                     |		ЧекПродажиАвансыПоУслугам.ВидОперации,
	                     |		ЧекПродажиАвансыПоУслугам.ТипОплаты,
	                     |		ЧекПродажиАвансыПоУслугам.НомерЗаказа,
	                     |		ЧекПродажиАвансыПоУслугам.ДатаЗаказа,
	                     |		ЧекПродажиАвансыПоУслугам.ЗетОчет,
	                     |		ЧекПродажиАвансыПоУслугам.СтавкаНДС,
	                     |		ЧекПродажиАвансыПоУслугам.Услуга,
	                     |		ЧекПродажиАвансыПоУслугам.Ссылка.НомерСмены,
	                     |		ЧекПродажиАвансыПоУслугам.Ссылка.ДатаСмены,
	                     |		ЧекПродажиАвансыПоУслугам.Ссылка.СерийныйНомер,
	                     |		ЧекПродажиАвансыПоУслугам.Касса
	                     |	
	                     |	ОБЪЕДИНИТЬ ВСЕ
	                     |	
	                     |	ВЫБРАТЬ
	                     |		ЧекВозвратаАвансыПоУслугам.ВидОперации,
	                     |		ЧекВозвратаАвансыПоУслугам.ТипОплаты,
	                     |		ЧекВозвратаАвансыПоУслугам.НомерЗаказа,
	                     |		ЧекВозвратаАвансыПоУслугам.ДатаЗаказа,
	                     |		СУММА(ЧекВозвратаАвансыПоУслугам.Сумма),
	                     |		ЧекВозвратаАвансыПоУслугам.Касса,
	                     |		ЧекВозвратаАвансыПоУслугам.ЗетОчет,
	                     |		ЧекВозвратаАвансыПоУслугам.СтавкаНДС,
	                     |		СУММА(ЧекВозвратаАвансыПоУслугам.СуммаНДС),
	                     |		ЧекВозвратаАвансыПоУслугам.Услуга,
	                     |		ЧекВозвратаАвансыПоУслугам.Ссылка.НомерСмены,
	                     |		ЧекВозвратаАвансыПоУслугам.Ссылка.ДатаСмены,
	                     |		ЧекВозвратаАвансыПоУслугам.Ссылка.СерийныйНомер
	                     |	ИЗ
	                     |		Документ.ЧекВозврата.АвансыПоУслугам КАК ЧекВозвратаАвансыПоУслугам
	                     |	ГДЕ
	                     |		КОНЕЦПЕРИОДА(ЧекВозвратаАвансыПоУслугам.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
	                     |		И ЧекВозвратаАвансыПоУслугам.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
	                     |		И ЧекВозвратаАвансыПоУслугам.Ссылка.Фирма = &Фирма
	                     |		И ЧекВозвратаАвансыПоУслугам.Ссылка.Аптека = &Аптека
	                     |		И ЧекВозвратаАвансыПоУслугам.Ссылка.СменаЗакрыта = ИСТИНА
	                     |		И ЧекВозвратаАвансыПоУслугам.Ссылка.ЧекПробитНаККМ = ИСТИНА
	                     |	
	                     |	СГРУППИРОВАТЬ ПО
	                     |		ЧекВозвратаАвансыПоУслугам.ВидОперации,
	                     |		ЧекВозвратаАвансыПоУслугам.ТипОплаты,
	                     |		ЧекВозвратаАвансыПоУслугам.НомерЗаказа,
	                     |		ЧекВозвратаАвансыПоУслугам.ДатаЗаказа,
	                     |		ЧекВозвратаАвансыПоУслугам.ЗетОчет,
	                     |		ЧекВозвратаАвансыПоУслугам.СтавкаНДС,
	                     |		ЧекВозвратаАвансыПоУслугам.Услуга,
	                     |		ЧекВозвратаАвансыПоУслугам.Ссылка.НомерСмены,
	                     |		ЧекВозвратаАвансыПоУслугам.Ссылка.ДатаСмены,
	                     |		ЧекВозвратаАвансыПоУслугам.Ссылка.СерийныйНомер,
	                     |		ЧекВозвратаАвансыПоУслугам.Касса) КАК база
	                     |
	                     |СГРУППИРОВАТЬ ПО
	                     |	база.ВидОперации,
	                     |	база.ТипОплаты,
	                     |	база.НомерЗаказа,
	                     |	база.ДатаЗаказа,
	                     |	база.Касса,
	                     |	база.ЗетОчет,
	                     |	база.СтавкаНДС,
	                     |	база.Услуга,
	                     |	база.НомерСмены,
	                     |	база.ДатаСмены,
	                     |	база.СерийныйНомер"); // Сгенерировано в GtG's Консоль запросов. 01.08.2012 22:06:56
	
						 Запрос.УстановитьПараметр("ДатаСмены",ДатаСмены);
						 Запрос.УстановитьПараметр("Фирма",Фирма);
						 Запрос.УстановитьПараметр("Аптека",Аптека);
						  Запрос.УстановитьПараметр("ПерезакрытиеСтаройСмены",ПерезакрытиеСтаройСмены);
						 
						 РеализацияККМ.АвансыПоУслугам.Загрузить(Запрос.Выполнить().Выгрузить());

						 //---------------<Расчет таблицы для бухгалтерии>---------------------------// GtG // 02.08.2012 18:16:00
						 Запрос.УстановитьПараметр("Комиссия",Перечисления.ВидыПоступленияТоваров.Комиссия);
						 Запрос.Текст= "ВЫБРАТЬ
						               |	база.СерийныйНомер,
						               |	база.НомерСмены,
						               |	база.СтавкаНДС,
						               |	база.ТипОплаты,
						               |	СУММА(база.СуммаБезСкидки) КАК СуммаБезСкидки,
						               |	СУММА(база.СуммаСоСкидкой) КАК СуммаСоСкидкой,
						               |	СУММА(база.СуммаСкидки) КАК СуммаСкидки,
						               |	СУММА(база.СуммаНДСБезСкидки) КАК СуммаНДСБезСкидки,
						               |	СУММА(база.СуммаНДДСоСкидкой) КАК СуммаНДДСоСкидкой,
						               |	СУММА(база.ЗакупочнаяСНДС) КАК ЗакупочнаяСНДС,
						               |	СУММА(база.НДСЗакуп) КАК НДСЗакуп,
						               |	база.ТипНалогообложенияПТ,
						               |	база.ВидПоступленияТовара,
						               |	база.ВхНомерНакл,
						               |	база.ВхДатаНакл,
						               |	база.Поставщик,
						               |	база.Партия,
						               |	база.Ссылка
						               |ПОМЕСТИТЬ ИсхДанные
						               |ИЗ
						               |	(ВЫБРАТЬ
						               |		ЧекПродажиТовар.Ссылка.СерийныйНомер КАК СерийныйНомер,
						               |		ЧекПродажиТовар.Ссылка.НомерСмены КАК НомерСмены,
						               |		ЧекПродажиТовар.СтавкаНДС КАК СтавкаНДС,
						               |		ЗНАЧЕНИЕ(перечисление.типыоплаты.наличными) КАК ТипОплаты,
						               |		ЧекПродажиТовар.Сумма КАК СуммаБезСкидки,
						               |		ЧекПродажиТовар.Сумма КАК СуммаСоСкидкой,
						               |		0 КАК СуммаСкидки,
						               |		ЧекПродажиТовар.СуммаНДС КАК СуммаНДСБезСкидки,
						               |		ЧекПродажиТовар.СуммаНДС КАК СуммаНДДСоСкидкой,
						               |		ЧекПродажиТовар.СуммаЗакуп КАК ЗакупочнаяСНДС,
						               |		ЧекПродажиТовар.НДСЗакуп КАК НДСЗакуп,
						               |		ЧекПродажиТовар.Партия.ДокументПоступления.Склад.ТипНалогообложения КАК ТипНалогообложенияПТ,
						               |		ЧекПродажиТовар.Партия.ВидПоступленияТовара КАК ВидПоступленияТовара,
						               |		ВЫБОР
						               |			КОГДА ЧекПродажиТовар.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекПродажиТовар.Партия.ДокументПоступления.ВхНомерНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ КАК ВхНомерНакл,
						               |		ВЫБОР
						               |			КОГДА ЧекПродажиТовар.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекПродажиТовар.Партия.ДокументПоступления.ВхДатаНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ КАК ВхДатаНакл,
						               |		ВЫБОР
						               |			КОГДА ЧекПродажиТовар.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекПродажиТовар.Партия.Поставщик
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ КАК Поставщик,
						               |		ЧекПродажиТовар.Партия КАК Партия,
						               |		ЧекПродажиТовар.Ссылка КАК Ссылка
						               |	ИЗ
						               |		Документ.ЧекПродажи.Товар КАК ЧекПродажиТовар
						               |	ГДЕ
						               |		КОНЕЦПЕРИОДА(ЧекПродажиТовар.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
						               |		И ЧекПродажиТовар.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
						               |		И ЧекПродажиТовар.Ссылка.Фирма = &Фирма
						               |		И ЧекПродажиТовар.Ссылка.Аптека = &Аптека
						               |		И ЧекПродажиТовар.Ссылка.СменаЗакрыта = ИСТИНА
						               |		И ЧекПродажиТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА
						               |	
						               |	ОБЪЕДИНИТЬ ВСЕ
						               |	
						               |	ВЫБРАТЬ
						               |		ЧекВозвратаТовар.Ссылка.СерийныйНомер,
						               |		ЧекВозвратаТовар.Ссылка.НомерСмены,
						               |		ЧекВозвратаТовар.СтавкаНДС,
						               |		ЗНАЧЕНИЕ(перечисление.типыоплаты.наличными),
						               |		ЧекВозвратаТовар.Сумма,
						               |		ЧекВозвратаТовар.Сумма,
						               |		0,
						               |		ЧекВозвратаТовар.СуммаНДС,
						               |		ЧекВозвратаТовар.СуммаНДС,
						               |		ЧекВозвратаТовар.СуммаЗакуп,
						               |		ЧекВозвратаТовар.НДСЗакуп,
						               |		ЧекВозвратаТовар.Партия.ДокументПоступления.Склад.ТипНалогообложения,
						               |		ЧекВозвратаТовар.Партия.ВидПоступленияТовара,
						               |		ВЫБОР
						               |			КОГДА ЧекВозвратаТовар.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекВозвратаТовар.Партия.ДокументПоступления.ВхНомерНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ,
						               |		ВЫБОР
						               |			КОГДА ЧекВозвратаТовар.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекВозвратаТовар.Партия.ДокументПоступления.ВхДатаНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ,
						               |		ВЫБОР
						               |			КОГДА ЧекВозвратаТовар.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекВозвратаТовар.Партия.Поставщик
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ,
						               |		ЧекВозвратаТовар.Партия,
						               |		ЧекВозвратаТовар.Ссылка.ВозвращаемыйЧек
						               |	ИЗ
						               |		Документ.ЧекВозврата.Товар КАК ЧекВозвратаТовар
						               |	ГДЕ
						               |		КОНЕЦПЕРИОДА(ЧекВозвратаТовар.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
						               |		И ЧекВозвратаТовар.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
						               |		И ЧекВозвратаТовар.Ссылка.Фирма = &Фирма
						               |		И ЧекВозвратаТовар.Ссылка.Аптека = &Аптека
						               |		И ЧекВозвратаТовар.Ссылка.СменаЗакрыта = ИСТИНА
						               |		И ЧекВозвратаТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА) КАК база
						               |
						               |СГРУППИРОВАТЬ ПО
						               |	база.СерийныйНомер,
						               |	база.НомерСмены,
						               |	база.СтавкаНДС,
						               |	база.ТипОплаты,
						               |	база.ТипНалогообложенияПТ,
						               |	база.ВидПоступленияТовара,
						               |	база.ВхНомерНакл,
						               |	база.ВхДатаНакл,
						               |	база.Поставщик,
						               |	база.Партия,
						               |	база.Ссылка
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |ВЫБРАТЬ
						               |	база.СерийныйНомер,
						               |	база.НомерСмены,
						               |	база.ТипОплаты,
						               |	база.ТипНалогообложенияПТ,
						               |	база.ВидПоступленияТовара,
						               |	база.ВхНомерНакл,
						               |	база.ВхДатаНакл,
						               |	база.Поставщик,
						               |	база.Партия,
						               |	база.Ссылка,
						               |	СУММА(база.СуммаСкидки) КАК СуммаСкидки,
						               |	СУММА(база.СуммаСоСкидкой) КАК СуммаСоСкидкой
						               |ПОМЕСТИТЬ ИсхДанныедисконт
						               |ИЗ
						               |	(ВЫБРАТЬ
						               |		ЧекПродажиДисконт.Ссылка.СерийныйНомер КАК СерийныйНомер,
						               |		ЧекПродажиДисконт.Ссылка.НомерСмены КАК НомерСмены,
						               |		ЗНАЧЕНИЕ(перечисление.типыоплаты.наличными) КАК ТипОплаты,
						               |		ЧекПродажиДисконт.Партия.ДокументПоступления.Склад.ТипНалогообложения КАК ТипНалогообложенияПТ,
						               |		ЧекПродажиДисконт.Партия.ВидПоступленияТовара КАК ВидПоступленияТовара,
						               |		ВЫБОР
						               |			КОГДА ЧекПродажиДисконт.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекПродажиДисконт.Партия.ДокументПоступления.ВхНомерНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ КАК ВхНомерНакл,
						               |		ВЫБОР
						               |			КОГДА ЧекПродажиДисконт.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекПродажиДисконт.Партия.ДокументПоступления.ВхДатаНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ КАК ВхДатаНакл,
						               |		ВЫБОР
						               |			КОГДА ЧекПродажиДисконт.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекПродажиДисконт.Партия.Поставщик
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ КАК Поставщик,
						               |		ЧекПродажиДисконт.Партия КАК Партия,
						               |		ЧекПродажиДисконт.Ссылка КАК Ссылка,
						               |		ЧекПродажиДисконт.СуммаСкидки КАК СуммаСкидки,
						               |		ЧекПродажиДисконт.СуммаСоСкидкой КАК СуммаСоСкидкой
						               |	ИЗ
						               |		Документ.ЧекПродажи.Дисконт КАК ЧекПродажиДисконт
						               |	ГДЕ
						               |		КОНЕЦПЕРИОДА(ЧекПродажиДисконт.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
						               |		И ЧекПродажиДисконт.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
						               |		И ЧекПродажиДисконт.Ссылка.Фирма = &Фирма
						               |		И ЧекПродажиДисконт.Ссылка.Аптека = &Аптека
						               |		И ЧекПродажиДисконт.Ссылка.СменаЗакрыта = ИСТИНА
						               |		И ЧекПродажиДисконт.Ссылка.ЧекПробитНаККМ = ИСТИНА
						               |	
						               |	ОБЪЕДИНИТЬ ВСЕ
						               |	
						               |	ВЫБРАТЬ
						               |		ЧекВозвратаДисконт.Ссылка.СерийныйНомер,
						               |		ЧекВозвратаДисконт.Ссылка.НомерСмены,
						               |		ЗНАЧЕНИЕ(перечисление.типыоплаты.наличными),
						               |		ЧекВозвратаДисконт.Партия.ДокументПоступления.Склад.ТипНалогообложения,
						               |		ЧекВозвратаДисконт.Партия.ВидПоступленияТовара,
						               |		ВЫБОР
						               |			КОГДА ЧекВозвратаДисконт.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекВозвратаДисконт.Партия.ДокументПоступления.ВхНомерНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ,
						               |		ВЫБОР
						               |			КОГДА ЧекВозвратаДисконт.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекВозвратаДисконт.Партия.ДокументПоступления.ВхДатаНакл
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ,
						               |		ВЫБОР
						               |			КОГДА ЧекВозвратаДисконт.Партия.ВидПоступленияТовара = &Комиссия
						               |				ТОГДА ЧекВозвратаДисконт.Партия.Поставщик
						               |			ИНАЧЕ NULL
						               |		КОНЕЦ,
						               |		ЧекВозвратаДисконт.Партия,
						               |		ЧекВозвратаДисконт.Ссылка,
						               |		ЧекВозвратаДисконт.СуммаСкидки,
						               |		ЧекВозвратаДисконт.СуммаСоСкидкой
						               |	ИЗ
						               |		Документ.ЧекВозврата.Дисконт КАК ЧекВозвратаДисконт
						               |	ГДЕ
						               |		КОНЕЦПЕРИОДА(ЧекВозвратаДисконт.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
						               |		И ЧекВозвратаДисконт.Ссылка.Проведен <> &ПерезакрытиеСтаройСмены
						               |		И ЧекВозвратаДисконт.Ссылка.Фирма = &Фирма
						               |		И ЧекВозвратаДисконт.Ссылка.Аптека = &Аптека
						               |		И ЧекВозвратаДисконт.Ссылка.СменаЗакрыта = ИСТИНА
						               |		И ЧекВозвратаДисконт.Ссылка.ЧекПробитНаККМ = ИСТИНА) КАК база
						               |
						               |СГРУППИРОВАТЬ ПО
						               |	база.СерийныйНомер,
						               |	база.ТипОплаты,
						               |	база.ТипНалогообложенияПТ,
						               |	база.ВидПоступленияТовара,
						               |	база.ВхНомерНакл,
						               |	база.ВхДатаНакл,
						               |	база.Поставщик,
						               |	база.Партия,
						               |	база.Ссылка,
						               |	база.НомерСмены
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |ВЫБРАТЬ
						               |	ИсхДанные.СерийныйНомер,
						               |	ИсхДанные.НомерСмены,
						               |	ИсхДанные.СтавкаНДС,
						               |	ИсхДанные.ТипОплаты,
						               |	ИсхДанные.СуммаБезСкидки,
						               |	ИсхДанные.СуммаСоСкидкой - ЕСТЬNULL(ИсхДанныедисконт.СуммаСкидки, 0) КАК СуммаСоСкидкой,
						               |	ЕСТЬNULL(ИсхДанныедисконт.СуммаСкидки, 0) КАК СуммаСкидки,
						               |	ИсхДанные.СуммаНДСБезСкидки,
						               |	(ИсхДанные.СуммаСоСкидкой - ЕСТЬNULL(ИсхДанныедисконт.СуммаСкидки, 0)) / (100 + ИсхДанные.СтавкаНДС.Ставка) * ИсхДанные.СтавкаНДС.Ставка КАК СуммаНДДСоСкидкой,
						               |	ИсхДанные.ЗакупочнаяСНДС,
						               |	ИсхДанные.НДСЗакуп,
						               |	ИсхДанные.ТипНалогообложенияПТ,
						               |	ИсхДанные.ВидПоступленияТовара,
						               |	ИсхДанные.ВхНомерНакл,
						               |	ИсхДанные.ВхДатаНакл,
						               |	ИсхДанные.Поставщик,
						               |	ИсхДанные.Партия,
						               |	ИсхДанные.Ссылка
						               |ПОМЕСТИТЬ БУх1
						               |ИЗ
						               |	ИсхДанные КАК ИсхДанные
						               |		ПОЛНОЕ СОЕДИНЕНИЕ ИсхДанныедисконт КАК ИсхДанныедисконт
						               |		ПО ИсхДанные.Ссылка = ИсхДанныедисконт.Ссылка
						               |			И ИсхДанные.СерийныйНомер = ИсхДанныедисконт.СерийныйНомер
						               |			И ИсхДанные.НомерСмены = ИсхДанныедисконт.НомерСмены
						               |			И ИсхДанные.ТипОплаты = ИсхДанныедисконт.ТипОплаты
						               |			И ИсхДанные.ТипНалогообложенияПТ = ИсхДанныедисконт.ТипНалогообложенияПТ
						               |			И ИсхДанные.ВидПоступленияТовара = ИсхДанныедисконт.ВидПоступленияТовара
						               |			И ИсхДанные.Партия = ИсхДанныедисконт.Партия
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |ВЫБРАТЬ
						               |	БУх1.СерийныйНомер,
						               |	БУх1.НомерСмены,
						               |	БУх1.СтавкаНДС,
						               |	БУх1.ТипОплаты,
						               |	СУММА(БУх1.СуммаБезСкидки) КАК СуммаБезСкидки,
						               |	СУММА(БУх1.СуммаСоСкидкой) КАК СуммаСоСкидкой,
						               |	СУММА(БУх1.СуммаСкидки) КАК СуммаСкидки,
						               |	СУММА(БУх1.СуммаНДСБезСкидки) КАК СуммаНДСБезСкидки,
						               |	СУММА(БУх1.СуммаНДДСоСкидкой) КАК СуммаНДДСоСкидкой,
						               |	СУММА(БУх1.ЗакупочнаяСНДС) КАК ЗакупочнаяСНДС,
						               |	СУММА(БУх1.НДСЗакуп) КАК НДСЗакуп,
						               |	БУх1.ТипНалогообложенияПТ,
						               |	БУх1.ВидПоступленияТовара,
						               |	БУх1.ВхНомерНакл,
						               |	БУх1.ВхДатаНакл,
						               |	БУх1.Поставщик
						               |ПОМЕСТИТЬ Бух2
						               |ИЗ
						               |	БУх1 КАК БУх1
						               |
						               |СГРУППИРОВАТЬ ПО
						               |	БУх1.СерийныйНомер,
						               |	БУх1.НомерСмены,
						               |	БУх1.СтавкаНДС,
						               |	БУх1.ТипОплаты,
						               |	БУх1.ТипНалогообложенияПТ,
						               |	БУх1.ВидПоступленияТовара,
						               |	БУх1.ВхНомерНакл,
						               |	БУх1.ВхДатаНакл,
						               |	БУх1.Поставщик
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |ВЫБРАТЬ
						               |	Бух2.СерийныйНомер,
						               |	Бух2.НомерСмены,
						               |	Бух2.СтавкаНДС,
						               |	Бух2.ТипОплаты,
						               |	Бух2.СуммаБезСкидки,
						               |	Бух2.СуммаСоСкидкой,
						               |	Бух2.СуммаСкидки,
						               |	Бух2.СуммаНДСБезСкидки,
						               |	Бух2.СуммаНДДСоСкидкой,
						               |	Бух2.ЗакупочнаяСНДС,
						               |	Бух2.НДСЗакуп,
						               |	Бух2.ТипНалогообложенияПТ,
						               |	Бух2.ВидПоступленияТовара,
						               |	Бух2.ВхНомерНакл,
						               |	Бух2.ВхДатаНакл,
						               |	Бух2.Поставщик,
						               |	Кассы.Ссылка КАК Касса
						               |ИЗ
						               |	Бух2 КАК Бух2
						               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Кассы КАК Кассы
						               |		ПО Бух2.СерийныйНомер = Кассы.ЗаводскойНомер
						               |			И (Кассы.ПометкаУдаления = ЛОЖЬ)
						               |			И (Кассы.Владелец = &Аптека)
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |УНИЧТОЖИТЬ ИсхДанные
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |УНИЧТОЖИТЬ ИсхДанныедисконт
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |УНИЧТОЖИТЬ БУх1
						               |;
						               |
						               |////////////////////////////////////////////////////////////////////////////////
						               |УНИЧТОЖИТЬ Бух2"; // Сгенерировано в GtG's Консоль запросов. 02.08.2012 19:47:17
						 
    РеализацияККМ.Бухгалтерия.Загрузить(Запрос.Выполнить().Выгрузить());
	
	
	
	
	
	
	РеализацияККМ.СуммаСоСкидкой =РеализацияККМ.Бухгалтерия.Итог("СуммаСоСкидкой");
	РеализацияККМ.ССП = ?(РеализацияККМ.КоличествоЧеков<>0,РеализацияККМ.СуммаСоСкидкой /РеализацияККМ.КоличествоЧеков,0);
	
	РеализацияККМ.Сумма=РеализацияККМ.СуммаСоСкидкой+РеализацияККМ.Бухгалтерия.Итог("СуммаСкидки");
	
	
	РеализацияККМ.Дата=конецДня(ДатаСмены);
	
	
	Успешно=Ложь;
	Х=0;
	
	Пока Успешно=Ложь И Х<=10 Цикл
		Х=Х+1;
		Попытка
			РеализацияККМ.Записать(РежимЗаписиДокумента.Проведение);
			Успешно=Истина;
			Прервать;
		Исключение
			Сообщить("Блокировка. Ждем 3 секунды и пробуем еще раз",3);
		КонецПопытки;
		
	КонецЦикла;
	
	
	
	
	
	//---------------<Распроведение чеков>---------------------------// GtG // 01.08.2012 22:26:26
	Запрос.Текст="ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |	ЧекПродажиТовар.Ссылка,
	             |	NULL КАК ЗаказСВозвратом,
	             |	NULL КАК ДокументОснование
	             |ИЗ
	             |	Документ.ЧекПродажи.Товар КАК ЧекПродажиТовар
	             |ГДЕ
	             |	КОНЕЦПЕРИОДА(ЧекПродажиТовар.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
	             |	И ЧекПродажиТовар.Ссылка.Проведен = ИСТИНА
	             |	И ЧекПродажиТовар.Ссылка.Фирма = &Фирма
	             |	И ЧекПродажиТовар.Ссылка.Аптека = &Аптека
	             |	И ЧекПродажиТовар.Ссылка.СменаЗакрыта = ИСТИНА
	             |	И ЧекПродажиТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА
	             |
	             |ОБЪЕДИНИТЬ ВСЕ
	             |
	             |ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |	ЧекВозвратаТовар.Ссылка,
	             |	NULL,
	             |	ЧекВозвратаТовар.Ссылка.ДокументОснование
	             |ИЗ
	             |	Документ.ЧекВозврата.Товар КАК ЧекВозвратаТовар
	             |ГДЕ
	             |	КОНЕЦПЕРИОДА(ЧекВозвратаТовар.Ссылка.ДатаСмены, ДЕНЬ) = КОНЕЦПЕРИОДА(&ДатаСмены, ДЕНЬ)
	             |	И ЧекВозвратаТовар.Ссылка.Проведен = ИСТИНА
	             |	И ЧекВозвратаТовар.Ссылка.Фирма = &Фирма
	             |	И ЧекВозвратаТовар.Ссылка.Аптека = &Аптека
	             |	И ЧекВозвратаТовар.Ссылка.СменаЗакрыта = ИСТИНА
	             |	И ЧекВозвратаТовар.Ссылка.ЧекПробитНаККМ = ИСТИНА";
	Рез=Запрос.Выполнить().Выгрузить();
	
	ЭлементыФормы.Индикатор1.Значение=0;
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение=Рез.Количество();
	Для Каждого Стр Из Рез Цикл
		Успешно=Ложь;
		Х=0;
		
		Пока Успешно=Ложь И Х<=10 Цикл
			Х=Х+1;
			Попытка
				Док=Стр.Ссылка.ПолучитьОбъект();
				Док.Записать(РежимЗаписиДокумента.ОтменаПроведения);
				Успешно=Истина;
				Прервать;
			Исключение
				Сообщить("Блокировка. Ждем 3 секунды и пробуем еще раз",3);
			КонецПопытки;
			
		КонецЦикла;
		
		Если ПустаяСтрока(Стр.ЗаказСВозвратом)=Ложь Тогда
			
			Успешно=Ложь;
			Х=0;
			
			Пока Успешно=Ложь И Х<=10 Цикл
				Х=Х+1;
				Попытка
					Док=Стр.ЗаказСВозвратом.ПолучитьОбъект();  // пересчитается долг курьера с учетом пробитого возврата
					Док.Записать(РежимЗаписиДокумента.Проведение);
					Успешно=Истина;
					Прервать;
				Исключение
					Сообщить("Блокировка. Ждем 3 секунды и пробуем еще раз",3);
				КонецПопытки;
				
			КонецЦикла;
			
			
		КонецЕсли;
		
		
		
		
		
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;
		
	КонецЦикла;	
				 
	
	
	
	
	
КонецПроцедуры

Процедура ДатаСменыПриИзменении(Элемент)
	Если ПроверкаВозможностиЗакрытьСмену() =Ложь Тогда
		ПРедупреждение("Нельзя закрывать смену за эту дату!");
	КонецЕсли;	
		
		
КонецПроцедуры

Процедура АптекаПриИзменении(Элемент)
	Фирма=Аптека.Фирма;
КонецПроцедуры
