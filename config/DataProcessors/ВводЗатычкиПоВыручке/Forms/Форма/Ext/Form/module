Функция СредняяНаценкаПоОстатку(Аптека,Дата)
	
	
	//-------------------- Запрос by GtG -----------------------
	// Назначение: Средняя наценка по остатку
	//----------------------------------------------------------
	ТХТ="ВЫБРАТЬ
	    |	ЕСТЬNULL((СУММА(ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток) / СУММА(ПартииЖНВЛСОстатки.СуммаЗакупСНДСОстаток) - 1) * 100, 0) КАК СреднийПроцНацПоОстатку
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата, Склад = &Аптека) КАК ПартииЖНВЛСОстатки";
	
	Запрос=Новый Запрос;
	Запрос.УстановитьПараметр( "Дата",КонецДня(Дата));
	Запрос.УстановитьПараметр("Аптека",Аптека);
	Запрос.Текст=ТХТ;
	
	Попытка
		СреднийПроцНацПоОстатку=Запрос.Выполнить().Выгрузить().Получить(0).СреднийПроцНацПоОстатку;
	Исключение
		ТХТ="ВЫБРАТЬ
		    |	ЕСТЬNULL((СУММА(ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток) / СУММА(ПартииЖНВЛСОстатки.СуммаЗакупСНДСОстаток) - 1) * 100, 0) КАК СреднийПроцНацПоОстатку
		    |ИЗ
		    |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата, Склад.ТипСклада = &Аптека) КАК ПартииЖНВЛСОстатки";
		
		Запрос.УстановитьПараметр("Аптека",Аптека.ТипСклада);
		Запрос.Текст=ТХТ;
		СреднийПроцНацПоОстатку=Запрос.Выполнить().Выгрузить().Получить(0).СреднийПроцНацПоОстатку;
	КонецПопытки;
	//----------------------------------------------------------
	Возврат СреднийПроцНацПоОстатку;
КонецФункции // СредняяНаценкаПоОстатку()
 








Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	ТХТ="ВЫБРАТЬ
	    |	РеализацияККМ.Ссылка
	    |ИЗ
	    |	Документ.РеализацияККМ КАК РеализацияККМ
	    |ГДЕ
	    |	РеализацияККМ.Проведен = ИСТИНА
	    |	И РеализацияККМ.Склад = &Склад
	    |	И РеализацияККМ.Дата МЕЖДУ &Дата1 И &Дата2";
		
	Запрос=Новый Запрос;
	Запрос.Текст=ТХТ;
	Запрос.УстановитьПараметр("Склад",Аптека);	
	Запрос.УстановитьПараметр("Дата1",НачалоДня(Дата));	
	Запрос.УстановитьПараметр("Дата2",КонецДня(Дата));	
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	
	Если ТЗ.Количество()<>0 Тогда
		ПРедупреждение("Уже есть данные по выручке за этот день!");
		Возврат;
	КонецЕсли;	
	
	
		
	
	
	
	Док=Документы.РеализацияККМ.СоздатьДокумент();
	
	Док.Фирма=Константы.ОсновнаяФирма.Получить();
	
	Док.Затычка=Не ЭтоФитобар;//Истина; // Важно! затычка - у аптек, у фитобара затычки нет
	Док.Склад=Аптека;
	Док.Фирма=Аптека.Фирма;
	Док.Дата=Дата;
	Док.КоличествоЧеков=КоличествоЧеков;
	Док.ССП=ссп;
	Док.СуммаСоСкидкой=Выручка;
	
	Стр=Док.Бухгалтерия.Добавить();
	Стр.СтавкаНДС= ОМ3_СтавкаНДС_ПоЧислу(18);
	Стр.СуммаСоСкидкой=Выручка;
	Стр.СуммаНДДСоСкидкой=ОМ3_НДСИзСуммыПоСтавке(Выручка,ОМ3_СтавкаНДС_ПоЧислу(18));
		
	
	Док.Товар.Очистить();
	СтрТ=Док.Товар.Добавить();
	
	ТоварЗатычка=Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.НайтиПоНаименованию("--- НЕИЗВЕСТНЫЙ ТОВАР. ПЕРЕОЦЕНКА ---");
	
	Если  ТоварЗатычка.Пустая()=Истина Тогда
		ОбТоварЗатычка=Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.СоздатьЭлемент();
		ОбТоварЗатычка.Наименование="--- НЕИЗВЕСТНЫЙ ТОВАР. ПЕРЕОЦЕНКА ---";
		ОбТоварЗатычка.СтавкаНДС=Справочники.СтавкиНДС.НайтиПоРеквизиту("Ставка",18);
		ОбТоварЗатычка.Записать();
		ТоварЗатычка=ОбТоварЗатычка.Ссылка;
	КонецЕсли;	
	
	

	
	
	
	СтрТ.Товар=ТоварЗатычка;
	СтрТ.Сумма=Выручка;
	СтрТ.СуммаНДС=ОМ3_НДСИзСуммыПоСтавке(Выручка,ОМ3_СтавкаНДС_ПоЧислу(18));
    СтрТ.СтавкаНДС=ОМ3_СтавкаНДС_ПоЧислу(18);	
	
	
	СредняяНацПоОст=СредняяНаценкаПоОстатку(Аптека,Дата);
	
	Если СредняяНацПоОст<>0 и СредняяНацПоОст<>-100 Тогда
		
		ЗакупСуммаВоображаемая=100*Выручка/(100+СредняяНацПоОст);
	Иначе
		Если Выручка<>0 Тогда
			Предупреждение("По аптеке "+Аптека+" НЕТ ОСТАТКА! 
			|Возможно Вы промахнулись с аптекой и она 
			|либо еще не открылась, либо уже закрылась
			|
			| Затычка по выручке НЕ СОЗДАНА!");
			Возврат;
		Иначе
			ЗакупСуммаВоображаемая=0;
		КонецЕсли;
	КонецЕсли;
				   
	
	СтрТ.СуммаЗакуп=ЗакупСуммаВоображаемая;
	СтрТ.НДСЗакуп=ОМ3_НДСИзСуммыПоСтавке(ЗакупСуммаВоображаемая,ОМ3_СтавкаНДС_ПоЧислу(18));
	
	
	
	Док.Записать(РежимЗаписиДокумента.Проведение);

	ПРедупреждение("Создан документ "+Док,1);
	
	ЭтаФорма.Закрыть();
	
КонецПроцедуры

Процедура КоличествоЧековПриИзменении(Элемент)
	ССП=Выручка/КоличествоЧеков;

КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	ТХТ="ВЫБРАТЬ
	    |	РеализацияККМ.Ссылка
	    |ИЗ
	    |	Документ.РеализацияККМ КАК РеализацияККМ
	    |ГДЕ
	    |	РеализацияККМ.Проведен = ИСТИНА
	    |	И РеализацияККМ.Склад = &Склад
	    |	И РеализацияККМ.Дата МЕЖДУ &Дата1 И &Дата2";
		
	Запрос=Новый Запрос;
	Запрос.Текст=ТХТ;
	Запрос.УстановитьПараметр("Склад",Аптека);	
	Запрос.УстановитьПараметр("Дата1",НачалоДня(Дата));	
	Запрос.УстановитьПараметр("Дата2",КонецДня(Дата));	
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	
	Если ТЗ.Количество()<>0 Тогда
		ПРедупреждение("Уже есть данные по выручке за этот день!");
		Отказ=истина;
	КонецЕсли;	
	

КонецПроцедуры


СписатьТоварПоРознице=Истина;