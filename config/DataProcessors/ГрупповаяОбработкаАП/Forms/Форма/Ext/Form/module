Процедура УстановитьВсеРеквизитыВПостроитель()
	
	ТХТ="ВЫБРАТЬ ";
	ТХТРеквизиты = " " ;
	
	
	Для каждого стр из Метаданные.Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.Реквизиты Цикл
		ТХТРеквизиты = ТХТРеквизиты + " " + стр.Имя + ",";
		ЕстьРеквизиты = Истина;
	КонецЦикла;
	
	
	ТХТРеквизиты = ЛЕВ(ТХТРеквизиты,СтрДлина(ТХТРеквизиты)-1);
	
	ТХТ = ТХТ + " " + ТХТРеквизиты + "  
	|ИЗ
	|	Справочник.Ассортиментный_План КАК АП
	|{ГДЕ
	|	 " + ТХТРеквизиты + " }";
	
	Построитель.Текст=ТХТ;
	
	
КонецПроцедуры

Процедура УстановитьРеквизитыПоОтборуВПостроитель()
	
	НаборЗаписей = РегистрыСведений.ПраваНаОбъекты.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Объект.Установить(Метаданные.Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.Имя);
	НаборЗаписей.Отбор.Пользователь.Установить(ПараметрыСеанса.ТекущийСотр);
	
	НаборЗаписей.Прочитать();
	КоличествоЗаписей = НаборЗаписей.Количество();
	
	Если КоличествоЗаписей = 0 Тогда
		Предупреждение("Недостаточно прав для редактирования реквизитов справочника");
		ЭтаФорма.Закрыть();
		Возврат;			
	КонецЕсли;	
	
	Если НаборЗаписей.Получить(0).ПолныеПрава Тогда
		УстановитьВсеРеквизитыВПостроитель();
		Возврат;
	КонецЕсли;
	
	ТХТ="ВЫБРАТЬ ";
	ТХТРеквизиты = " " ;
	ЕстьРеквизиты = Ложь;
	Для каждого стр из НаборЗаписей Цикл
		Если НЕ Метаданные.Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.Реквизиты.найти(стр.Реквизит) = Неопределено Тогда
			ТХТРеквизиты = ТХТРеквизиты + " " + стр.Реквизит + ",";
			ЕстьРеквизиты = Истина;
		КонецЕсли;
	КонецЦикла;
	
	
	Если ЕстьРеквизиты = Ложь Тогда
		Предупреждение("Недостаточно прав для редактирования реквизитов справочника");
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли;
	
	ТХТРеквизиты = ЛЕВ(ТХТРеквизиты,СтрДлина(ТХТРеквизиты)-1);
	
	ТХТ = ТХТ + " " + ТХТРеквизиты + "  
	|ИЗ
	|	Справочник.Ассортиментный_План КАК АП
	|{ГДЕ
	|	 " + ТХТРеквизиты + " }";
	
	Построитель.Текст=ТХТ;
	
	
КонецПроцедуры

Процедура ОбработатьОсновныеРеквизиты()
	
	ЭлементыФормы.Индикатор1.Значение=0;
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение= СписокОтобранныхПозиций.Количество();
	
	
	Пользователь = ПараметрыСеанса.ТекущийСотр;
	
	Для каждого Стр из СписокОтобранныхПозиций Цикл
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;
		
		АП=Стр.Значение.ПолучитьОбъект();
		
		Изменения = АП.Изменения;
		Для каждого Рекв из  Построитель.Отбор Цикл
			ЗначениеДо = АП[Рекв.ПутьКДанным];
			АП[Рекв.ПутьКДанным]=Рекв.Значение;
			НС = Изменения.Добавить();
			НС.Дата = ТекущаяДата();
			НС.Реквизит =  Рекв.ПутьКДанным;
			НС.Пользователь  = Пользователь;
			НС.ЗначениеДо = ЗначениеДо;
			НС.ЗначениеПосле = Рекв.Значение;
		КонецЦикла;	
		
		Попытка
		
			АП.Записать();	
		
		Исключение
			Сообщить("Не удалось записать элемент справочника: "+Стр.Значение+". Проверьте заполнение обязательных полей!");
		КонецПопытки;
		
	КонецЦикла;	
	
	
КонецПроцедуры

Процедура ОбработатьТипСТМ()
	
	Если НЕ ЗначениеЗаполнено(ДатаДействияСТМ) Тогда 
		Предупреждение("Не заполнена дата действия. Выполнение не может быть продолжено!");	
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТипСТМ) Тогда 
		Предупреждение("Не заполнен Тип СТМ. Выполнение не может быть продолжено!");	
		Возврат;
	КонецЕсли;	
	
	ЭлементыФормы.Индикатор1.Значение=0;
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение= СписокОтобранныхПозиций.Количество();
	
	
	Пользователь = ПараметрыСеанса.ТекущийСотр;
	
	Для каждого Стр из СписокОтобранныхПозиций Цикл
		ОбработкаПрерыванияПользователя();
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;
		
		МЗ = РегистрыСведений.ТоварыСТМ.СоздатьМенеджерЗаписи();
		МЗ.Период = ДатаДействияСТМ;
		МЗ.ТипСТМ = ТипСТМ;
		МЗ.Товар = стр.Значение;
		МЗ.Записать();
		
		
		//АП=Стр.Значение.ПолучитьОбъект();
		//
		//Изменения = АП.Изменения;
		//Для каждого Рекв из  Построитель.Отбор Цикл
		//	ЗначениеДо = АП[Рекв.ПутьКДанным];
		//	АП[Рекв.ПутьКДанным]=Рекв.Значение;
		//	НС = Изменения.Добавить();
		//	НС.Дата = ТекущаяДата();
		//	НС.Реквизит =  Рекв.ПутьКДанным;
		//	НС.Пользователь  = Пользователь;
		//	НС.ЗначениеДо = ЗначениеДо;
		//	НС.ЗначениеПосле = Рекв.Значение;
		//КонецЦикла;	
		//
		//АП.Записать();
	КонецЦикла;	
	
	
КонецПроцедуры


Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если ЭлементыФормы.ПанельРеквизитов.ТекущаяСтраница = ЭлементыФормы.ПанельРеквизитов.Страницы.СтраницаОсновныеРеквизиты Тогда
		ОбработатьОсновныеРеквизиты();
	ИначеЕсли ЭлементыФормы.ПанельРеквизитов.ТекущаяСтраница = ЭлементыФормы.ПанельРеквизитов.Страницы.СтраницаТипСТМ Тогда
		ОбработатьТипСТМ();
	КонецЕсли;
	
	
КонецПроцедуры

Процедура КоманднаяПанель3ПодобратьТовар(Кнопка)
	СписокОтобранныхПозиций.Очистить();
	
    Рез=Обработки.ОтборПоФильтру.ПолучитьФорму("Форма").ОткрытьМодально();
	Если Рез= Неопределено Тогда
		ПРедупреждение("Ничего не выбрано!");
	КонецЕсли; 	
	
	СписокОтобранныхПозиций=Рез.Скопировать();
КонецПроцедуры

Процедура КоманднаяПанель3кнЗагрузитьИзФайла(Кнопка)
	
	XLS=Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	XLS.ПолноеИмяФайла = "";
	XLS.МножественныйВыбор = Ложь;
	XLS.Заголовок = "Выберите файл формата Excel";
	XLS.Фильтр="*.xls|*.xls";
	Если XLS.Выбрать() Тогда
		ФайлЭксель=XLS.ПолноеИмяФайла;
	Иначе
		Возврат;
	КонецЕсли;	
	
	Если ПустаяСтрока(СокрЛП(ФайлЭксель)) = Истина Тогда
		Предупреждение("Не выбран файл для загрузки");
		Возврат;
	КонецЕсли;
	
	Excel = Новый COMОбъект("Excel.Application");
	Попытка
		Excel.WorkBooks.Open(СокрЛП(ФайлЭксель), 0);
	Исключение
		Сообщить("Файл: " + ФайлЭксель + " либо уже открыт, либо поврежден! Пропускаем его... ");	
		Возврат;
	КонецПопытки;
	
	
	ТХТ = "ВЫБРАТЬ
	      |	АССОРТИМЕНТНЫЙ_ПЛАН.Код,
	      |	АССОРТИМЕНТНЫЙ_ПЛАН.Ссылка
	      |ИЗ
	      |	Справочник.АССОРТИМЕНТНЫЙ_ПЛАН КАК АССОРТИМЕНТНЫЙ_ПЛАН";
		Запрос = Новый Запрос;
		Запрос.Текст = ТХТ;
		ТЗТоваров = Запрос.Выполнить().Выгрузить();
		ТЗтоваров.Индексы.Добавить("Код");
	
	
	
	Sell_itr = 2;
	КолСтрок = 0;	
	
	Пока Строка(Excel.ActiveSheet.Cells(Sell_itr,1).Value) <> "" Цикл
		Sell_itr = Sell_itr + 1;
		КолСтрок = КолСтрок + 1;
	КонецЦикла;	
	
	Sell_itr = 2;
	
	АППустаяСсылка = Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.ПустаяСсылка();
	
	Пока Строка(Excel.ActiveSheet.Cells(Sell_itr,1).Value) <> "" Цикл

		ОбработкаПрерыванияПользователя();
		Попытка
			КодТовара		= Число(Excel.ActiveSheet.Cells(Sell_itr,1).Value);
		Исключение
			КодТовара = 0;
		КонецПопытки;
	
		НайденнаяСтрока = ТЗТоваров.Найти(КодТовара,"Код");
		Если НЕ НайденнаяСтрока = Неопределено  Тогда
			СписокОтобранныхПозиций.Добавить(НайденнаяСтрока.Ссылка);
		КонецЕсли;
		
		Sell_itr = Sell_itr + 1;
					
	КонецЦикла;
	
	Excel.Quit();

	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	
	Если  РольДоступна("супер_Администратор") или  Константы.ИспользоватьОграничениеПравНаСправочники.Получить() = Ложь  Тогда	
		УстановитьВсеРеквизитыВПостроитель();	
	Иначе
		УстановитьРеквизитыПоОтборуВПостроитель();
	КонецЕсли;	
	
КонецПроцедуры


