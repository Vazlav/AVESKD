Перем СписокКомПодключений;

Функция ПодключитьсяКДочернейБазе(Сервер,База,Пользователь,Пароль)
	
	//Параметры:
	//<Строка соединения> (обязательный)
	//Тип: Строка. Строка параметров, используемая 1С:Предприятием 
	//для соединения с информационной базой.
	//Строка соединения представляет собой набор параметров, каждый из которых является фрагментом вида: 
	//<Имя параметра=><Значение>, 
	//где Имя параметра — имя параметра, а Значение — его значение. 
	//Фрагменты отделяются друг от друга символами ';'. 
	//Если значение содержит пробельные символы, то оно должно быть заключено в двойные кавычки (").
	//Для файлового варианта определен параметр: 
	//File — каталог информационной базы (файловый режим);
	//Для клиент-серверного варианта определены параметры: 
	//Srvr — имя сервера 1С:Предприятия; 
	//Ref — имя информационной базы на сервере;
	//Для всех вариантов определены параметры: 
	//Usr — имя пользователя; 
	//Pwd — пароль и UC<Код доступа> позволяет выполнить установку соединения с информационной базой, 
	//на которую установлена блокировка установки соединений. 
	//Если при установке блокировки задан непустой код доступа, то для установки соединения 
	//необходимо в параметре /UC указать этот код доступа. 
	
	СтрокаСоединения="Srvr="""+Сервер+"""; Ref="""+База+"""; ";

	СтрокаСоединения=СтрокаСоединения+" Usr="""+Пользователь+"""; Pwd="""+Пароль+""""; 		
	
	
	
	Попытка
		
		Комец=Новый COMObject("V81.COMConnector");
		
		Ком=Комец.Connect(СтрокаСоединения);
		Возврат Ком;
	Исключение
		
		предупреждение("Не удалось подключиться к базе! Причина 
		|"+ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	
КонецФункции


Процедура СоздатьСвязкиВДочернихБазах(ПоставщикКод,ТекАПКод,ТекКодПост)
	
	////СпрДочернихБаз = Справочники.ДочерниеБазыДанных.Выбрать();
	//Для каждого ЭлементСписка из СписокКомПодключений Цикл
	//	Ком = ЭлементСписка.Значение;
	////Пока СпрДочернихБаз.Следующий() Цикл
	//	
	//	//Ком = ПодключитьсяКДочернейБазе(СпрДочернихБаз.Сервер,СпрДочернихБаз.ИмяБазы,СпрДочернихБаз.Пользователь,СпрДочернихБаз.Пароль);
	//	//Если Ком = Неопределено Тогда
	//	//	Возврат;
	//	//КонецЕсли;
	//	
	//	СпрСвязокКомБазы = Ком.Справочники.СвязкиТовараСПоставщиком;
	//	СпрПоставщикиКомБазы = Ком.Справочники.Поставщики;
	//	СпрАПКомБазы = Ком.Справочники.АССОРТИМЕНТНЫЙ_ПЛАН;
	//	//Проверим, если ли такой поставщик в дочерней базе
	//	ПоставщикСсылка = СпрПоставщикиКомБазы.НайтиПоКоду(ПоставщикКод);
	//	Если ПоставщикСсылка.Пустая() Тогда
	//		Сообщить("Не удалось создать связку в базе: " + ЭлементСписка.Представление + ". Отсутствует поставщик" );
	//		//Ком = Неопределено;
	//		Продолжить;
	//	КонецЕсли;
	//	
	//	ТоварСсылка = СпрАПКомБазы.НайтиПоКоду(ТекАПКод);
	//	Если ТоварСсылка.Пустая() Тогда
	//		Сообщить("Не удалось создать связку в базе: " + ЭлементСписка.Представление + ". Отсутствует данный товар" );
	//		//Ком = Неопределено;
	//		Продолжить;
	//	КонецЕсли;
	//	// Проверим, есть существует ли уже такая связка в справочнике
	//	Запрос=Ком.NewObject("Запрос");
	//	Запрос.Текст = "ВЫБРАТЬ
	//				   |	СвязкиТовараСПоставщиком.КодТовараПоставщика
	//				   |ИЗ
	//				   |	Справочник.СвязкиТовараСПоставщиком КАК СвязкиТовараСПоставщиком
	//				   |ГДЕ
	//				   |	СвязкиТовараСПоставщиком.Поставщик.Код = &ПоставщикКод
	//				   |	И СвязкиТовараСПоставщиком.КодТовараПоставщика = &КодТовараПоставщика
	//				   |	И СвязкиТовараСПоставщиком.ТоварФирмы.Код = &КодТовара";
	//	Запрос.УстановитьПараметр("ПоставщикКод",ПоставщикКод);
	//	Запрос.УстановитьПараметр("КодТовараПоставщика",ТекКодПост);
	//	Запрос.УстановитьПараметр("КодТовара",ТекАПКод);
	//	РезТЗ = Запрос.Выполнить().Выгрузить();
	//	Если РезТЗ.Количество() > 0 Тогда
	//		Сообщить("В базе: " + ЭлементСписка.Представление + " есть уже такая связка" );
	//		//Ком = Неопределено;
	//		Продолжить;			
	//	КонецЕсли;
	//	

	//	//СВязку не нашли, значит создаем ее:
	//	НовыйЭлемент = СпрСвязокКомБазы.СоздатьЭлемент();
	//	НовыйЭлемент.Поставщик = ПоставщикСсылка;
	//	НовыйЭлемент.КодТовараПоставщика = ТекКодПост;
	//	НовыйЭлемент.ТоварФирмы = ТоварСсылка;
	//	Попытка
	//		НовыйЭлемент.Записать();
	//	Исключение
	//		Сообщить(ОписаниеОшибки());
	//		//Ком = Неопределено;
	//	КонецПопытки;
	//	
	//КонецЦикла;
	
	
КонецПроцедуры

Процедура УдалитьСвязкиВДочернихБазах(ПоставщикКод,ТекАПКод,ТекКодПост)
	
	//Для каждого ЭлементСписка из СписокКомПодключений Цикл
	//	Ком = ЭлементСписка.Значение;
	//	СпрСвязокКомБазы = Ком.Справочники.СвязкиТовараСПоставщиком;
	//	СпрПоставщикиКомБазы = Ком.Справочники.Поставщики;
	//	СпрАПКомБазы = Ком.Справочники.АССОРТИМЕНТНЫЙ_ПЛАН;
	//	//Проверим, если ли такой поставщик в дочерней базе
	//	ПоставщикСсылка = СпрПоставщикиКомБазы.НайтиПоКоду(ПоставщикКод);
	//	Если ПоставщикСсылка.Пустая() Тогда
	//		Сообщить("Не удалось удалить связку в базе: " + ЭлементСписка.Представление + ". Отсутствует поставщик" );
	//		//Ком = Неопределено;
	//		Продолжить;
	//	КонецЕсли;
	//	
	//	ТоварСсылка = СпрАПКомБазы.НайтиПоКоду(ТекАПКод);
	//	Если ТоварСсылка.Пустая() Тогда
	//		Сообщить("Не удалось удалить связку в базе: " + ЭлементСписка.Представление + ". Отсутствует данный товар" );
	//		//Ком = Неопределено;
	//		Продолжить;
	//	КонецЕсли;
	//	// Проверим, есть существует ли уже такая связка в справочнике
	//	Запрос=Ком.NewObject("Запрос");
	//	Запрос.Текст = "ВЫБРАТЬ
	//				   |	СвязкиТовараСПоставщиком.Ссылка как Ссылка
	//				   |ИЗ
	//				   |	Справочник.СвязкиТовараСПоставщиком КАК СвязкиТовараСПоставщиком
	//				   |ГДЕ
	//				   |	СвязкиТовараСПоставщиком.Поставщик.Код = &ПоставщикКод
	//				   |	И СвязкиТовараСПоставщиком.КодТовараПоставщика = &КодТовараПоставщика
	//				   |	И СвязкиТовараСПоставщиком.ТоварФирмы.Код = &КодТовара";
	//	Запрос.УстановитьПараметр("ПоставщикКод",ПоставщикКод);
	//	Запрос.УстановитьПараметр("КодТовараПоставщика",ТекКодПост);
	//	Запрос.УстановитьПараметр("КодТовара",ТекАПКод);
	//	РезТЗ = Запрос.Выполнить().Выгрузить();
	//
	//	Для каждого стр из РезТЗ Цикл
	//		СвязкаОбъект = стр.Ссылка.ПолучитьОбъект();
	//		Попытка
	//			СвязкаОбъект.Удалить();
	//		Исключение
	//			Сообщить(ОписаниеОшибки());
	//		КонецПопытки;
	//	КонецЦикла;
	//	
	//КонецЦикла;
КонецПроцедуры

Процедура ПривестиШиринуКолонокТЗ()
	ЭлементыФормы.Прайс.Колонки.Код.Ширина = 6;
	ЭлементыФормы.Прайс.Колонки.Товар.Ширина = 50;
	ЭлементыФормы.Прайс.Колонки.Связан.Ширина = 6;
	ЭлементыФормы.Прайс.Колонки.Производитель.Ширина = 50;	
	ЭлементыФормы.Прайс.Колонки.Блокировка.Ширина = 6;
КонецПроцедуры

Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ПоставщикПриИзменении(Элемент)
	
	
	//ЭтаФорма.ПрайсПоставщика.Отбор.Поставщик.Использование = Истина;
	//ЭтаФорма.ПрайсПоставщика.Отбор.Поставщик.Значение = Поставщик;
	ТХТ = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	      |	Прайсы.Код,
	      |	Прайсы.Товар КАК Товар,
	      |	Связки.ТоварФирмы.Код КАК Связан,
	      |	Прайсы.Производитель,
	      |	ЕСТЬNULL(Связки.Блокировка, ЛОЖЬ) КАК Блокировка
	      |ИЗ
	      |	РегистрСведений.Прайсы КАК Прайсы
	      |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СвязкиТовараСПоставщиком КАК Связки
	      |		ПО Прайсы.Поставщик = Связки.Поставщик
	      |			И Прайсы.Код = Связки.КодТовараПоставщика
	      |ГДЕ
	      |	Прайсы.Поставщик = &Поставщик" ;
	Если УсловиеФильтра.Количество() > 0 Тогда
		ТХТ = ТХТ + "
		|	И Прайсы.Код В(&УсловиеФильтра) ";
	КонецЕсли;
	ТХТ = ТХТ +  "
	|
	|УПОРЯДОЧИТЬ ПО
	|	Товар";
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Поставщик",Поставщик);
	Запрос.УстановитьПараметр("УсловиеФильтра",УсловиеФильтра);
	Прайс = Запрос.Выполнить().Выгрузить();
	ЭлементыФормы.Прайс.СоздатьКолонки();
	ПривестиШиринуКолонокТЗ();
КонецПроцедуры

Процедура ФильтрПоСловуПриИзменении(Элемент)
	
	Если ПустаяСтрока(СокрЛП(ФильтрПоСлову)) = Истина Тогда
		ПоставщикПриИзменении("");
	Иначе
			ТХТ = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			      |	Прайсы.Код,
			      |	Прайсы.Товар КАК Товар,
			      |	Связки.ТоварФирмы.Код КАК Связан,
			      |	Прайсы.Производитель,
			      |	ЕСТЬNULL(Связки.Блокировка, ЛОЖЬ) КАК Блокировка
			      |ИЗ
			      |	РегистрСведений.Прайсы КАК Прайсы
			      |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СвязкиТовараСПоставщиком КАК Связки
			      |		ПО Прайсы.Поставщик = Связки.Поставщик
			      |			И Прайсы.Код = Связки.КодТовараПоставщика
			      |ГДЕ
			      |	Прайсы.Поставщик = &Поставщик
			      |	И Прайсы.Товар ПОДОБНО &Товар
			      |
			      |УПОРЯДОЧИТЬ ПО
			      |	Товар";
			Запрос = Новый Запрос;
			Запрос.Текст = ТХТ;
			Запрос.УстановитьПараметр("Поставщик",Поставщик);
			Запрос.УстановитьПараметр("Товар","%" + СокрЛП(ФильтрПоСлову) + "%");
			Прайс = Запрос.Выполнить().Выгрузить();
			ЭлементыФормы.Прайс.СоздатьКолонки();
			ПривестиШиринуКолонокТЗ();
	КонецЕсли;
	
	
КонецПроцедуры

Процедура КнОчиститьФильтрНажатие(Элемент)
	
	ФильтрПоСлову = "";
	ФильтрПоСловуПриИзменении("");	
	
КонецПроцедуры

Процедура СправочникАППриАктивизацииСтроки(Элемент)
	
	ТХТ = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	      |	СвязкиТовараСПоставщиком.Поставщик.Наименование КАК Поставщик,
	      |	СвязкиТовараСПоставщиком.КодТовараПоставщика КАК Код,
	      |	ЕСТЬNULL(Прайсы.Товар, ""------"") КАК Товар
	      |ИЗ
	      |	Справочник.СвязкиТовараСПоставщиком КАК СвязкиТовараСПоставщиком
	      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Прайсы КАК Прайсы
	      |		ПО СвязкиТовараСПоставщиком.Поставщик = Прайсы.Поставщик
	      |			И СвязкиТовараСПоставщиком.КодТовараПоставщика = Прайсы.Код
	      |ГДЕ
	      |	СвязкиТовараСПоставщиком.ТоварФирмы = &ТоварФирмы
	      |
	      |УПОРЯДОЧИТЬ ПО
	      |	Поставщик";
		  
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("ТоварФирмы",Элемент.ТекущаяСтрока.Ссылка);
	ВсеСвязкиПоТовару = Запрос.Выполнить().Выгрузить();
	ЭлементыФормы.ВсеСвязкиПоТовару.СоздатьКолонки();
	
	ЭлементыФормы.ВсеСвязкиПоТовару.Колонки.Код.Ширина = 6;
	ЭлементыФормы.ВсеСвязкиПоТовару.Колонки.Товар.Ширина = 50;
	ЭлементыФормы.ВсеСвязкиПоТовару.Колонки.Поставщик.Ширина = 20;
	
	Если Поставщик.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Если Прайс.Колонки.Найти("Связан") <> Неопределено Тогда
		НайденнаяСтрока = Прайс.Найти(Элемент.ТекущаяСтрока.Код,"Связан");
		Если НЕ НайденнаяСтрока = Неопределено Тогда
			ЭлементыФормы.Прайс.ТекущаяСтрока = НайденнаяСтрока;	
		КонецЕсли;
	КонецЕсли;

	
	
КонецПроцедуры

Процедура кнСвязатьНажатие(Элемент)
	
	Если Поставщик.Пустая() Тогда
		Предупреждение("Не выбран поставщик!");
		Возврат;
	КонецЕсли;
	
	Если ЭлементыФормы.Прайс.ТекущаяСтрока.Связан <> null Тогда
		Предупреждение("Данный товар поставщка уже имеет связку!");
		Возврат;
	КонецЕсли;
	
	ТекАп = ЭлементыФормы.СправочникАП.ТекущаяСтрока;
	ТекАПКод = ТекАП.Код;
	ТекКодПост = ЭлементыФормы.Прайс.ТекущаяСтрока.Код;

	НовыйЭлемент = Справочники.СвязкиТовараСПоставщиком.СоздатьЭлемент();
	НовыйЭлемент.КодТовараПоставщика = ТекКодПост;
	НовыйЭлемент.Поставщик = Поставщик;
	НовыйЭлемент.ТоварФирмы = ТекАП;
	Попытка
		НовыйЭлемент.Записать();
		ЭлементыФормы.Прайс.ТекущаяСтрока.Связан = ТекАПКод;
		СоздатьСвязкиВДочернихБазах(Поставщик.Код,ТекАПКод,ТекКодПост);
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	
	
	
	
КонецПроцедуры

Процедура кнУдалитьСвязьНажатие(Элемент)
	
	Если Поставщик.Пустая() Тогда
		Предупреждение("Не выбран поставщик!");
		Возврат;
	КонецЕсли;
	
	Если ЭлементыФормы.Прайс.ТекущаяСтрока.Связан = null Тогда
		Предупреждение("Данная позиция не имеет связки.!");
		Возврат;
	КонецЕсли;
	ТекАПКод = ЭлементыФормы.Прайс.ТекущаяСтрока.Связан;
	ТекАп = Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.НайтиПоКоду(ТекАПКод);
	Если ТекАП.Пустая() Тогда
		Сообщить("Не могу удалить связь. Нет в АП элемента с кодом : " +  ТекАПКод, СтатусСообщения.Важное ); 
		Возврат;
	КонецЕсли;
	ТекКодПост = ЭлементыФормы.Прайс.ТекущаяСтрока.Код;
	
	ТХТ = "ВЫБРАТЬ
	      |	СвязкиТовараСПоставщиком.Ссылка как СвязкаСсылка
	      |ИЗ
	      |	Справочник.СвязкиТовараСПоставщиком КАК СвязкиТовараСПоставщиком
	      |ГДЕ
	      |	СвязкиТовараСПоставщиком.Поставщик = &Поставщик
	      |	И СвязкиТовараСПоставщиком.ТоварФирмы = &ТоварФирмы
	      |	И СвязкиТовараСПоставщиком.КодТовараПоставщика = &КодТовараПоставщика";
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Поставщик",Поставщик);
	Запрос.УстановитьПараметр("ТоварФирмы",ТекАП);
	Запрос.УстановитьПараметр("КодТовараПоставщика",СокрЛП(ТекКодПост));
	
	ВремТЗ = Запрос.Выполнить().Выгрузить();
	Если ВремТЗ.Количество() = 0 Тогда
		Предупреждение("Данная позиция не имеет связки.!");
		Возврат;
	Иначе 
		Успешно = Ложь;
		Для каждого стр из ВремТЗ Цикл
			Объект = стр.СвязкаСсылка.ПолучитьОбъект();
			Попытка
				Объект.Удалить();
				Успешно = Истина;
				
				УдалитьСвязкиВДочернихБазах(Поставщик.Код,ТекАПКод,ТекКодПост);
				
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЦикла;
		Если Успешно = Истина Тогда
			ЭлементыФормы.Прайс.ТекущаяСтрока.Связан = NULL;
		КонецЕсли;
	КонецЕсли;
	

КонецПроцедуры

Процедура ОбработкаТаймера()
	
	//СпрДочернихБаз = Справочники.ДочерниеБазыДанных.Выбрать();

	//Пока СпрДочернихБаз.Следующий() Цикл
	//	
	//	Ком = ПодключитьсяКДочернейБазе(СпрДочернихБаз.Сервер,СпрДочернихБаз.ИмяБазы,СпрДочернихБаз.Пользователь,СпрДочернихБаз.Пароль);
	//	Если Ком = Неопределено Тогда
	//		Продолжить;
	//	КонецЕсли;
	//	
	//	СписокКомПодключений.Добавить(Ком,СпрДочернихБаз.ИмяБазы);
	//	
	//КонецЦикла;	
	//
	//КоличествоПодключений = СписокКомПодключений.Количество();
	//ЭлементыФормы.ТекстПодключения.Заголовок = "Количество COM-подключений: " + КоличествоПодключений ;
	//ЭтаФорма.Обновить();
	
	Если Поставщик.Пустая() = Ложь Тогда
		ПоставщикПриИзменении("");
	КонецЕсли;

КонецПроцедуры


Процедура ПриОткрытии()
	
	ПодключитьОбработчикОжидания("ОбработкаТаймера",1,Истина);
	
	
КонецПроцедуры

Процедура ПрайсВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	КодАП = ВыбраннаяСтрока.Связан;
	Если КодАП > 0 Тогда
		НайденнаяСсылка = Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.НайтиПоКоду(КодАП);
		Если НайденнаяСсылка.Пустая() = Истина Тогда
			Предупреждение("По данному коду: " + КодАП + " не найден товар в справочнике");
			Возврат;
		Иначе
			ЭлементыФормы.СправочникАП.ТекущаяСтрока = НайденнаяСсылка;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура Кнопка2Нажатие(Элемент)
	
	УчВАП=СправочникАП.Отбор.Найти("УчаствуетВАП");	
	Если УчВАП<>Неопределено ТОгда
		УчВап.Использование=Ложь;
	КонецЕсли;
	
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
	
	УчВАП=СправочникАП.Отбор.Найти("УчаствуетВАП");	
	Если УчВАП<>Неопределено ТОгда
		УчВАП.ВидСравнения=ВидСравнения.Равно;
		УчВАП.Значение=ИСтина;
		УчВап.Использование=Истина;
	КонецЕсли;		
	
КонецПроцедуры

Процедура ФильтрПоАППриИзменении(Элемент)
	
	СправочникАП.Отбор.Наименование.ВидСравнения = ВидСравнения.Содержит; 
	СправочникАП.Отбор.Наименование.Значение = ФильтрПоАП; 
	СправочникАП.Отбор.Наименование.Использование = Истина; 
	ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.СправочникАП;	
	
КонецПроцедуры

Процедура ОтменитьОтборНажатие(Элемент)
	
	СправочникАП.Отбор.Сбросить();
	
КонецПроцедуры


Процедура кнЗаблокироватьСвязкуНажатие(Элемент)
	
	Если Поставщик.Пустая() Тогда
		Предупреждение("Не выбран поставщик!");
		Возврат;
	КонецЕсли;

	Если ЭлементыФормы.Прайс.ТекущаяСтрока.Связан <> null Тогда
		
		ПричинаБлокировки = "";
		Если ВвестиСтроку(ПричинаБлокировки,"Укажите причину блокировки",139) Тогда
			Если ПустаяСтрока(ПричинаБлокировки) Тогда
				Предупреждение("Причина блокировки не указана. Операция отменена");
				Возврат;
			КонецЕсли;
			
			ПричинаБлокировки = "Блокировка " + ПричинаБлокировки;
			
			
		Иначе
			Предупреждение("Причина блокировки не указана. Операция отменена");
			Возврат;
		КонецЕсли;
		
		
		ТекАп = ЭлементыФормы.СправочникАП.ТекущаяСтрока;
		//ТекАПКод = ТекАП.Код;		
		ТекКодПост = ЭлементыФормы.Прайс.ТекущаяСтрока.Код;
		Запрос = Новый Запрос;
		Запрос.Текст= "ВЫБРАТЬ
		              |	СвязкиТовараСПоставщиком.Ссылка
		              |ИЗ
		              |	Справочник.СвязкиТовараСПоставщиком КАК СвязкиТовараСПоставщиком
		              |ГДЕ
		              |	СвязкиТовараСПоставщиком.КодТовараПоставщика = &КодТовараПоставщика
		              |	И СвязкиТовараСПоставщиком.ТоварФирмы = &ТоварФирмы
		              |	И СвязкиТовараСПоставщиком.Поставщик = &Поставщик";
					  
		Запрос.УстановитьПараметр("КодТовараПоставщика", ТекКодПост);
		Запрос.УстановитьПараметр("ТоварФирмы", ТекАп);
		Запрос.УстановитьПараметр("Поставщик", Поставщик);
		Рез = Запрос.Выполнить();
		Если НЕ Рез.Пустой() Тогда
			Выборка = Рез.Выбрать();
			Выборка.Следующий();
			Об = Выборка.Ссылка.ПолучитьОбъект();
			Об.Блокировка = Истина;
			Об.Записать();
			ЭлементыФормы.Прайс.ТекущаяСтрока.Блокировка = Истина;
			
			МенЗап=РегистрыСведений.АудитСвязок.СоздатьМенеджерЗаписи();
			МенЗап.Дата=ТекущаяДата();
			МенЗап.Пользователь = ПараметрыСеанса.ТекущийСотр;
			МенЗап.Товар = ТекАп;
			МенЗап.Поставщик = Поставщик;
			МенЗап.КодТовараПоставщика = ТекКодПост;
			Если НЕ ЭлементыФормы.Прайс.Колонки.Найти("Товар") = Неопределено Тогда
				МенЗап.НаименованиеТовараПоставщика = ЭлементыФормы.Прайс.ТекущаяСтрока.Товар;
			КонецЕсли;
			МенЗап.Комментарий = ПричинаБлокировки;
			МенЗап.Записать();
			
		КонецЕсли;	
		
	КонецЕсли;

	

 
		
	
КонецПроцедуры

Процедура ПрайсПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Блокировка = Истина Тогда
		ОформлениеСтроки.ЦветФона=Новый Цвет(255,155,240);	
	КонецЕсли;
	
КонецПроцедуры

Процедура кнРазблокироватьНажатие(Элемент)

	
	Если Поставщик.Пустая() Тогда
		Предупреждение("Не выбран поставщик!");
		Возврат;
	КонецЕсли;

	Если ЭлементыФормы.Прайс.ТекущаяСтрока.Связан <> null Тогда
		
		ПричинаСнятияБлокировки = "";
		Если ВвестиСтроку(ПричинаСнятияБлокировки,"Укажите причину снятия блокировки",139) Тогда
			Если ПустаяСтрока(ПричинаСнятияБлокировки) Тогда
				Предупреждение("Причина снятия блокировки не указана. Операция отменена");
				Возврат;
			КонецЕсли;
			
			ПричинаСнятияБлокировки = "Снятие блокировки " + ПричинаСнятияБлокировки;
			
			
		Иначе
			Предупреждение("Причина снятия блокировки не указана. Операция отменена");
			Возврат;
		КонецЕсли;
		
		
		ТекАп = ЭлементыФормы.СправочникАП.ТекущаяСтрока;
		//ТекАПКод = ТекАП.Код;		
		ТекКодПост = ЭлементыФормы.Прайс.ТекущаяСтрока.Код;
		Запрос = Новый Запрос;
		Запрос.Текст= "ВЫБРАТЬ
		              |	СвязкиТовараСПоставщиком.Ссылка
		              |ИЗ
		              |	Справочник.СвязкиТовараСПоставщиком КАК СвязкиТовараСПоставщиком
		              |ГДЕ
		              |	СвязкиТовараСПоставщиком.КодТовараПоставщика = &КодТовараПоставщика
		              |	И СвязкиТовараСПоставщиком.ТоварФирмы = &ТоварФирмы
		              |	И СвязкиТовараСПоставщиком.Поставщик = &Поставщик";
					  
		Запрос.УстановитьПараметр("КодТовараПоставщика", ТекКодПост);
		Запрос.УстановитьПараметр("ТоварФирмы", ТекАп);
		Запрос.УстановитьПараметр("Поставщик", Поставщик);
		Рез = Запрос.Выполнить();
		Если НЕ Рез.Пустой() Тогда
			Выборка = Рез.Выбрать();
			Выборка.Следующий();
			Об = Выборка.Ссылка.ПолучитьОбъект();
			Об.Блокировка = Ложь;
			Об.Записать();
			ЭлементыФормы.Прайс.ТекущаяСтрока.Блокировка = Ложь;
			
			МенЗап=РегистрыСведений.АудитСвязок.СоздатьМенеджерЗаписи();
			МенЗап.Дата=ТекущаяДата();
			МенЗап.Пользователь = ПараметрыСеанса.ТекущийСотр;
			МенЗап.Товар = ТекАп;
			МенЗап.Поставщик = Поставщик;
			МенЗап.КодТовараПоставщика = ТекКодПост;
			Если НЕ ЭлементыФормы.Прайс.Колонки.Найти("Товар") = Неопределено Тогда
				МенЗап.НаименованиеТовараПоставщика = ЭлементыФормы.Прайс.ТекущаяСтрока.Товар;
			КонецЕсли;
			МенЗап.Комментарий = ПричинаСнятияБлокировки;
			МенЗап.Записать();				
			
		КонецЕсли;	
		
	КонецЕсли;
	
	
КонецПроцедуры



СписокКомПодключений = Новый СписокЗначений;
