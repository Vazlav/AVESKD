Перем ДокИзФормы Экспорт;
Перем АвтозапускРасценкиИзФормы Экспорт;

Перем ТЗКосяков;
Перем ИспользоватьЦеныКонкурентов;
Перем ДокОбъект Экспорт;
Перем ТЗМатрицаОгруглений Экспорт;

//==================<КУЧЕРЯВОЕ ЦЕНООБРАЗОВАНИЕ>===================GtG====22.11.2007
//расчет цен ведется на самую мелкую единицу измерения
//чтобы процент наценки не превышал максимальный лимит:
//	округление по верхнему пределу в меньшюу сторону
//	округление по нижнему лимиту в большую сторону
//тогда цена всегда будет в допустимо мдиапазоне
//и для укрупненных единиц измерени явсегда будет делиться нацело, без длинны ххвостов
//	Для товаров цена которых меньше константы минимальная цена округления округляе мцену до 1-й копейки
//		если цена больше константы - округляем до 5 или 10 копеек ,
//			что указано в константе метод округления розн. цены
// после асрчета цены (на 1) она умножается на коэффициент единицы из документа
//
// алгоритмы , условия их применения и необходимые для расечта параметры описываются в справочнике АлгоритмыЦенообразованияРегионов
// подчиненном справочнику Регионы
//
// Цена рассчитывается на единицу измерения с коэффициентом =1, при этом цена более крупной еит должна без дробей делиться на коэффициент.
// Если в документе использовалась ЕИТ с К<>1 цо единичную цену умножаем на К

Перем КоличествоОшибокРАсценки;

Перем ДанныеТекПартии; // для поиска спецЦены по строке документа. 


//==========================================================GtG====
Процедура АвтозапускРасценкиТовара ()  
	//----------------------------------
	//Назначение:
	//  
	//  
	//  
	//  
	//----------------------------------
	ЭтаФорма.ОтключитьОбработчикОжидания("АвтозапускРасценкиТовара");
	ОсновныеДействияФормыРасценить("");
	КоманднаяПанель1СохранитьЦены("");
	
	КоманднаяПанель1Закрыть("");

КонецПроцедуры	//АвтозапускРасценкиТовара
//==========================================================GtG====


Процедура ПриОткрытии()
	// Подставляем регион из склада или из константы
	// регион используется для расчета предельной наценки по ЖНВЛС / СВЛС
	// Запуск расценки Только из формы прихода товара(пока что)
	//------------------------------------------------------------------------
	
 	
	
	
	Попытка
		Документ=ЭтаФорма.ВладелецФормы.Ссылка;
		Если Документ.Склад.ТипСклада=Перечисления.ТипыМХ.Розн Тогда
			УстановитьрозничныеЦеныВДокументе=Истина;
		Иначе
			УстановитьрозничныеЦеныВДокументе=Ложь;
		КонецЕсли;	
		//ФинСкидка=ЭтаФорма.ВладелецФормы.ФинСкидка;
		ЭлементыФормы.ТП.ФиксацияСлева=2;
		ЭлементыФормы.Индикатор.Видимость=Ложь;
		//ЭлементыФормы.ТОварИндюк.Видимость=Ложь;
	Исключение
	КонецПопытки;
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПерерасценкаТоваровНаСкладе") ТОгда
		УстановитьрозничныеЦеныВДокументе=Ложь;
	КонецЕсли;
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПерерасценкаТоваров") ТОгда
		УстановитьрозничныеЦеныВДокументе=Истина;
		РасцениватьВсеСтрокиДокумента=Истина;
		ЗаписыватьЦеныВРегистрЦен=Ложь;
		ПроверятьЗакупкуИРозницу = Ложь;
	КонецЕсли;
	
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПередачаНаКомиссиюСтороннемуКомиссионеру") ТОгда    // GtG  //  22.10.2014 15:18:07
		УстановитьрозничныеЦеныВДокументе=Истина;
	КонецЕсли;       // GtG  //  22.10.2014 15:18:11 

	
	
	Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПеремещениеТовара") ТОгда
		Если Документ.СкладПолучатель.ТипСклада=Перечисления.ТипыМХ.Опт ТОгда
			
			ПРедупреждение("Расценку товара на оптовом складе делают документом ПЕРЕРАСЦЕНКА ТОВАРА НА СКЛАДЕ!");
			ЭтаФорма.Закрыть();
			Возврат;
			
		Иначе
			
			ЭлементыФормы.ЗаписыватьЦеныВРегистрЦен.Доступность=Ложь;
			ЭлементыФормы.УстановитьрозничныеЦеныВДокументе.Доступность=Ложь;
			
			ЗаписыватьЦеныВРегистрЦен=Ложь;
			УстановитьрозничныеЦеныВДокументе=Истина;
			
			РегионСклада=Документ.СкладПолучатель.Регион;
			Склад=Документ.СкладПолучатель;
			
			КоманднаяПанель2неВыбратьВсеРег("");
			Для каждого Стр из ВыбРег Цикл
				Если Стр.Значение=РегионСклада ТОгда
					Стр.Пометка=Истина;
				КонецЕсли;	
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если  ИспользоватьЦеныКонкурентов = Истина Тогда
		ЭлементыФормы.ТП.Колонки.МинимальнаяЦена.Видимость=Истина;
		//ЭлементыФормы.ТП.Колонки.СредневзвешеннаяЦена.Видимость=Истина;
		ЭлементыФормы.ТП.Колонки.Конкурент.Видимость=Истина;
	Иначе
		ЭлементыФормы.ТП.Колонки.МинимальнаяЦена.Видимость=Ложь;
		//ЭлементыФормы.ТП.Колонки.СредневзвешеннаяЦена.Видимость=Ложь;
		ЭлементыФормы.ТП.Колонки.Конкурент.Видимость=Ложь;
	КонецЕсли;	
	
	
	//==================<Регионы по авторасценке>===================GtG====21.11.2008

		// только для поступления товара
		Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПеремещениеТовара") ТОгда
			РегионСклада=Документ.СкладПолучатель.Регион;
			Склад=Документ.СкладПолучатель;
		ИНаче
			РегионСклада=Документ.Склад.Регион;
			Склад=Документ.Склад;
		КОнецЕсли;
		
		
		Если ТипЗнч(Документ)=Тип("ДокументСсылка.РаспоряжениеНаПереоценку") ТОгда
              РасцениватьВсеСтрокиДокумента=Истина;
		КонецЕсли;	
		
		
		Если Склад.ТипСклада=Перечисления.ТипыМХ.Розн 
			 или 
			 ТипЗнч(Документ)=Тип("ДокументСсылка.ПередачаНаКомиссиюСтороннемуКомиссионеру")  ТОгда  // только по региону аптеки
			
			Если ТипЗнч(Документ)=Тип("ДокументСсылка.ПоступлениеТовара") ТОгда
				ЗаписыватьЦеныВРегистрЦен=Истина; // по приходам пишем в регистр цен
			КонецЕсли;	
			
			УстановитьрозничныеЦеныВДокументе=Истина;// по розничным складам цену пицем в документ
			
			КоманднаяПанель2неВыбратьВсеРег("");
			Для каждого Стр из ВыбРег Цикл
				Если Стр.Значение=РегионСклада ТОгда
					Стр.Пометка=Истина;
				КонецЕсли;	
			КонецЦикла;	
		Иначе
			КоманднаяПанель2ВыбратьВсеРЕг(""); // по всем регионам
		КонецЕсли;
		
		
		ВыводитьНеРасцененные=Истина; // что расценится то и выведем
		

	//================================================GtG====КОНЕЦ==21.11.2008
	
	
	
КонецПроцедуры

 
Функция ПолучитьТаблицуЦенКонкурентов()
	
	ЭлементыФормы.ХодРасценкиТОвар.Заголовок="Получаем таблицу цен конкурентов...";

	
	ТХТ = "ВЫБРАТЬ
	      |	Конкуренты.Наименование КАК ИмяКонкурента,
	      |	Конкуренты.Вес,
	      |	ЦеныКонкурентов.Цена,
	      |	ВыборкаТовары.Товар,
	      |	ВыборкаТовары.КодТовара,
	      |	Конкуренты.Код КАК КодКонкурента
	      |ПОМЕСТИТЬ ВремВыборка
	      |ИЗ
	      |	РегистрСведений.ЦеныКонкурентов КАК ЦеныКонкурентов
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      |			товары.Товар КАК Товар,
	      |			товары.Товар.Код КАК КодТовара
	      |		ИЗ
	      |			Документ.ПоступлениеТовара.Товар КАК товары
	      |		ГДЕ
	      |			товары.Ссылка = &Документ) КАК ВыборкаТовары
	      |		ПО (ВыборкаТовары.КодТовара = ЦеныКонкурентов.КодТовараСправочной)
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонкурентыЕГК КАК Конкуренты
	      |		ПО ЦеныКонкурентов.КодКонкурента = Конкуренты.Код
	      |			И (Конкуренты.Вес > 0)
	      |			И (Конкуренты.ЗагружатьДанные = ИСТИНА)
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |ВЫБРАТЬ
	      |	МАКСИМУМ(ВремВыборка.ИмяКонкурента) КАК ИмяКонкурента,
	      |	ВремВыборка.КодТовара,
	      |	выборка2.МинЦена
	      |ПОМЕСТИТЬ ВыборкаМинЦен
	      |ИЗ
	      |	ВремВыборка КАК ВремВыборка
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      |			МИНИМУМ(ВремВыборка.Цена) КАК МинЦена,
	      |			ВремВыборка.КодТовара КАК КодТовара
	      |		ИЗ
	      |			ВремВыборка КАК ВремВыборка
	      |		ГДЕ
	      |			ВремВыборка.Вес > 0
	      |		
	      |		СГРУППИРОВАТЬ ПО
	      |			ВремВыборка.КодТовара) КАК выборка2
	      |		ПО ВремВыборка.КодТовара = выборка2.КодТовара
	      |			И ВремВыборка.Цена = выборка2.МинЦена
	      |ГДЕ
	      |	ВремВыборка.Вес > 0
	      |
	      |СГРУППИРОВАТЬ ПО
	      |	ВремВыборка.КодТовара,
	      |	выборка2.МинЦена
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |ВЫБРАТЬ
	      |	ЕСТЬNULL(СУММА(ВремВыборка.Цена * ВремВыборка.Вес) / СУММА(ВремВыборка.Вес), 0) КАК СВЦена,
	      |	ВремВыборка.Товар,
	      |	ВремВыборка.КодТовара,
	      |	ВыборкаМинЦен.ИмяКонкурента,
	      |	ВыборкаМинЦен.МинЦена
	      |ИЗ
	      |	ВремВыборка КАК ВремВыборка
	      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыборкаМинЦен КАК ВыборкаМинЦен
	      |		ПО (ВыборкаМинЦен.КодТовара = ВремВыборка.КодТовара)
	      |ГДЕ
	      |	ВремВыборка.Вес > 0
	      |
	      |СГРУППИРОВАТЬ ПО
	      |	ВремВыборка.Товар,
	      |	ВремВыборка.КодТовара,
	      |	ВыборкаМинЦен.ИмяКонкурента,
	      |	ВыборкаМинЦен.МинЦена
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |УНИЧТОЖИТЬ ВремВыборка
	      |;
	      |
	      |////////////////////////////////////////////////////////////////////////////////
	      |УНИЧТОЖИТЬ ВыборкаМинЦен";
		  
	Запрос  = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Документ",Документ);
	ТЗЦенКонкурентов = Запрос.Выполнить().Выгрузить();
	Для каждого стр из ТЗЦенКонкурентов Цикл
		Если стр.СВЦена > 0 Тогда
			Если стр.СВЦена > 0 и стр.СВЦена <= 10	Тогда
				стр.СВЦена = Округлить(стр.СВЦена, Перечисления.СпособыОкруглений.До10коп, Перечисления.МетодыОкругления.Математически);
			ИначеЕсли стр.СВЦена > 10 и стр.СВЦена <= 50 Тогда
				стр.СВЦена = Округлить(стр.СВЦена, Перечисления.СпособыОкруглений.До50коп, Перечисления.МетодыОкругления.Математически);
			ИначеЕсли стр.СВЦена > 50 Тогда
				стр.СВЦена = Округлить(стр.СВЦена, Перечисления.СпособыОкруглений.ДоРуб, Перечисления.МетодыОкругления.Математически);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;	
	Возврат ТЗЦенКонкурентов;
	
КонецФункции
 

Процедура ОсновныеДействияФормыРасценить(Кнопка) Экспорт
	Перем СокрСтр;
	
	 НачалоРасценки=ТекущаяДата();
	//Сообщить(ТекущаяДата());
	//МодОсновныеДействияФормыРасценить(Кнопка);
	
	
	
	
	//возврат;
	
	Если Типзнч(Документ)=Тип("ДокументСсылка.ПеремещениеТовара") ТОгда
		Если Документ.Статус= Перечисления.СтатусПеремещения.ВыгруженНаАптеку Тогда
			Предупреждение("Документ выгружен на аптеку, возможен расход ! Расценить невозможно!",10);
			ЭтаФорма.Закрыть();
			Возврат;
		КонецЕсли;
		
		//---------------------- Перед расценкой в партии должен торчать поставщик ----------GtG--24.04.2009
		// при автоматической расценке записи реквизитов в партии нет пока не проведется документ.
	Иначе
			ЭлементыФормы.ХодРасценкиТОвар.Заголовок="Обновляем данные по партиям документа...";

			Если ТипЗнч(Документ)<>Тип("ДокументСсылка.ПерерасценкаТоваров") Тогда
				Отказ = Ложь;
				ПроверитьИОбновитьДанныеПартии(Документ.ПолучитьОбъект(),Отказ);
				Если Отказ = Истина Тогда
					Сообщить("Не удалось обновить данные по партиям. Попробуйте запустить расценку через несколько секунд еще раз");	
					Возврат;
				КонецЕсли;
			КонецЕсли;
		    ЭлементыФормы.ХодРасценкиТОвар.Заголовок="";

		//Для каждого СтрДок Из Документ.Товар Цикл // на всякий случай запишем данные в партию до проведения документа
		//	ЭлементыФормы.ХодРасценкиТОвар.Заголовок="Обновляем данные по партиям документа...";

		//	Если ТипЗнч(Документ)<>Тип("ДокументСсылка.ПерерасценкаТоваров") Тогда
		//	   ОМ1_ОбновитьДанныеПартии  (СтрДок, Документ.ПолучитьОбъект());
		//	КонецЕсли;
		//	
		//КонецЦикла;
	КонецЕсли;	
	
	
	
	
		
	
	ЭтаФорма.Панель.ТекущаяСтраница= ЭтаФорма.Панель.Страницы.Найти("Страница1");
	ЭтаФорма.Обновить();
	
	ЭлементыФормы.ХодРасценкиРегион.Видимость=Истина;
	ЭлементыФормы.ХодРасценкиТОвар.Видимость=Истина;
	ЭлементыФормы.Индикатор.Видимость=Истина;
	//ЭлементыФормы.ТОварИндюк.Видимость=Истина;
	
	КоличествоОшибокРАсценки=0;
	
	
	Если  ЭтаФорма.ВладелецФормы= Неопределено Тогда
		 ЭВФ=Документ;
	 Иначе
		ЭВФ=ЭтаФорма.ВладелецФормы;//Документ.ПолучитьОбъект(); 
	КонецЕсли;
	
	ДатаДок=ЭВФ.Дата;
	
	//------------------<СКЛАД для использования в алгоритмах завязанных на складе>-------------------GtG----21.11.2008
	Если ТипЗнч(ЭВФ)=Тип("ДокументОбъект.ПеремещениеТовара") 
		или ТипЗнч(ЭВФ)=Тип("ДокументСсылка.ПеремещениеТовара")
		или ТипЗнч(ЭВФ.Ссылка)=Тип("ДокументСсылка.ПеремещениеТовара")
		
		тогда
		СКЛАД=ЭВФ.СкладПолучатель;
	Иначе
		СКЛАД=ЭВФ.Склад;
	КонецЕсли; 
	//------------------------------------------------------------------------------------------------GtG----КОНЕЦ--21.11.2008
	
	//------------------<Сколько регионов?>-------------------GtG----09.01.2008
	ТЗРег= Новый ТаблицаЗначений;
	ТЗРег.Колонки.Добавить("Рег");
	Для каждого Стр из ВыбРег Цикл
		Если Стр.Пометка=Истина Тогда
			СтрРег=ТЗРег.Добавить();
			СтрРег.Рег=Стр.Значение;
		КонецЕсли;	
	КонецЦикла;	
	//--------------------------------------------------------GtG----КОНЕЦ--09.01.2008
	Если ТЗРег.Количество() = 0 Тогда
		Предупреждение("Для аптеки не задан регион ценообразования");
		Возврат;
	КонецЕсли;
	
	ПараметрыРасценки = Новый Структура;
	
	ПараметрыРасценки.Вставить("Авторасценка",Ложь) ;
	ПараметрыРасценки.Вставить("Склад",СКЛАД);
	ПараметрыРасценки.Вставить("Документ",Документ) ;
	ПараметрыРасценки.Вставить("ТипДокумента",ТипЗнч(Документ)) ;
	ПараметрыРасценки.Вставить("ВидДокумента",Документ.Метаданные().Имя) ;
	ПараметрыРасценки.Вставить("Комментировать",Истина);
	ПараметрыРасценки.Вставить("ВыводитьНеРасцененные",Истина);
	ПараметрыРасценки.Вставить("Регион",ТЗРег.Получить(0).Рег);//;Склад.Регион);	
	ПараметрыРасценки.Вставить("МинимальныйПроцентНаценкиКромеТопов",0);
	ПараметрыРасценки.Вставить("ЗаписыватьЦеныВРегистрЦен",Истина);
	ПараметрыРасценки.Вставить("УстановитьрозничныеЦеныВДокументе",Истина);
	ПараметрыРасценки.Вставить("ИспользоватьЦеныКонкурентов",Истина);
	ПараметрыРасценки.Вставить("ПроверятьЗакупкуИРозницу",Истина);
	ПараметрыРасценки.Вставить("УскореннаяРасценка",УскореннаяРасценка);
	ПараметрыРасценки.Вставить("РазрешитьРозничнуюЦенуНижеЗакупочной",РазрешитьРозничнуюЦенуНижеЗакупочной);
	
	Если ТипЗнч(ЭВФ)=Тип("ДокументОбъект.ПоступлениеТовара") Тогда 
		ПараметрыРасценки.Вставить("СвойПоставщик",Документ.Поставщик.ПринадлежитГруппеКомпаний);
		ПараметрыРасценки.Вставить("ИгнорироватьПревышенияЗакупочнойЦены",Документ.Поставщик.ИгнорироватьПревышенияЗакупочнойЦены);
	КонецЕсли;


	//НачДата = ТекущаяДата();
	Если УскореннаяРасценка Тогда
		СтруктураРезультата = Расценка.Расценить2(ПараметрыРасценки);
	Иначе
		СтруктураРезультата = Расценка.Расценить(ПараметрыРасценки);
	КонецЕсли;
	//Сообщить(ТекущаяДата() - НачДата);
	ЭлементыФормы.ТП.Значение = СтруктураРезультата.ТП;
	ЭлементыФормы.ДеревоОшибок.Значение = СтруктураРезультата.ДеревоОшибок;
	ЭлементыФормы.Таб.Очистить();
	ЭлементыФормы.Таб.Вывести(СтруктураРезультата.ТаблицаКомментариев);
	//СтруктураРезультата.ТаблицаКомментариев.Вывести(ЭлементыФормы.Таб);
	ЭлементыФормы.Таб.Показать();
	КоличествоОшибокРАсценки = СтруктураРезультата.КоличествоОшибокРасценки;
	ТЗКосяков = СтруктураРезультата.ТЗКосяков;
	КонецРасценки=ТекущаяДата();
	
	ВремяВыполнения=КонецРасценки-НачалоРасценки;
	
	ВВМин=Цел(ВремяВыполнения/60);
	ВВСек=ВремяВыполнения%60;
	
	
	
	ЭлементыФормы.ХодРасценкиТОвар.Заголовок="Готово! "+Формат(ВВМин,"ЧЦ=2; ЧН=00; ЧВН=")+":"+Формат(ВВсек,"ЧЦ=2; ЧН=00; ЧВН=");
	
КонецПроцедуры

Процедура ТПГТТОткрытие(Элемент, СтандартнаяОбработка)
КонецПроцедуры

Процедура КоманднаяПанель1СохранитьЦены(Кнопка)
	//СохранитьЦены в партии , серии;
	
	
	//==================<ВАЖНО>===================GtG====28.11.2007
	// в регистре цен хранятся цены на идеальные сферические единицы в вакууме, с коэфициентом=1
	//================================================GtG====КОНЕЦ==28.11.2007
	
	
	Если ЭтаФорма.ВладелецФормы= Неопределено Тогда
		ЭФВО=ДокОбъект;	
	Иначе
		ЭФВО=ЭтаФорма.ВладелецФормы;
	КонецЕсли;
	
	Если ЭФВО=Неопределено Тогда
		ЭФВО=Документ.ПолучитьОбъект();
	КонецЕсли;	
	
	
	Если ЗаписыватьЦеныВРегистрЦен=Истина ТОгда
		
		
		//----------------------------< Очистка регистра цен перед записью новых значений >--------------------------------GtG---
		Попытка
			Движения=ЭФВО.Движения;
		Исключение
			ЭФВО=Документ.ПолучитьОбъект();
			Движения=ЭФВО.Движения;
		КонецПопытки;
		
		
		Для к = 0 По 5 Цикл
			Попытка
				Движения.Цены.Очистить(); 			 
				Движения.Цены.Записать();
				Прервать;
			Исключение
				Предупреждение("Ожидание блокировки записи цен в регистр сведений",2);
			КонецПопытки;
		КонецЦикла;
		//----------------------------<  >--------------------------------GtG---
		
		
		Если АвтоРасценка=Ложь ТОгда
			//ЭлементыФормы.ТОварИндюк.Значение=0;
			//ЭлементыФормы.ТОварИндюк.МаксимальноеЗначение=ТП.Количество();
		КонецЕсли;
	
		//ЭлементыФормы.ТОварИндюк.Видимость=Истина;
		
		
		Для Каждого Стр из ТП Цикл
			
			
			
			Если Стр.ЦенаРозн=0 Тогда
				Если Авторасценка=Ложь ТОгда  // при ручной расценке долбим пока все цены не рассчитаются
					ПРедупреждение("У товара "+Стр.ТОвар+" для региона "+Стр.регион+" не рассчиталась розничная цена!
					|Чтобы цены сохранились - они все должны быть рассчитаны!");
					Возврат;
				Иначе
					Продолжить; // при авторасценке пропускаем строчку нерасцененного товара
				КонецЕсли;	
			КонецЕсли;	
			
			
			ЗапРС=Движения.Цены.Добавить();
			
			ЗапРС.Активность=Истина;
			ЗапРС.АП=Стр.ТОвар;
			
			
			ЗапРС.РЕГИОН=Стр.РЕГИОН;
						
			ЗапРС.Партия=Стр.Партия;
			ЗапРС.Период=ЭФВО.Дата;
			ЗапРС.Регистратор=ЭФВО.Ссылка;
			
			ЗапРС.ЦенаРознГТТ=Стр.ЦенаРозн/Стр.КоэффЕит;
			
			Если АвтоРасценка=Ложь ТОгда
				//ЭлементыФормы.ТОварИндюк.Значение=ЭлементыФормы.ТОварИндюк.Значение+1;
			КонецЕсли;
		
		КонецЦикла; 
		Для к = 0 По 5 Цикл
			Попытка
				Движения.Цены.Записать();
				Прервать;
			Исключение
				Предупреждение("Ожидание блокировки записи цен в регистр сведений",2);
			КонецПопытки;
		КонецЦикла;
				
		СтрИзм=ЭФВО.Изменения.Добавить();
		СтрИзм.Дата=ТекущаяДата();
		СтрИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр;
		Если АвтоРасценка=Ложь ТОгда
			СтрИзм.ТипИзм=Перечисления.ДействияНадДокументами.Расценка;
		Иначе
			СтрИзм.ТипИзм=Перечисления.ДействияНадДокументами.АвтоРасценка;
		КонецЕсли;
		
		
		КоличествоОшибокРАсценки=КоличествоОшибокРАсценки+ТЗКосяков.Количество();
		
		СтрИзм.КомментарийИзменения="Ошибок при расценке "+КоличествоОшибокРАсценки;
		
		Если типзнч(ЭФВО)  = Тип ("ДокументОбъект.ПоступлениеТовара") ТОгда
			ЭФВО.Дата=ТекущаяДАта();
			
			СтрИзм=ЭФВО.Изменения.Добавить();
			СтрИзм.Дата=ТекущаяДата();
			СтрИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр;
			СтрИзм.ТипИзм=Перечисления.ДействияНадДокументами.ИзменениеДаты;
			СтрИзм.КомментарийИзменения="Фактически оприходован "+ЭФВО.Дата;
			
			//ЭФВО.Записать(); Запишем документ один раз в конце процедуры
		КонецЕсли; 
	КонецЕсли;	
	
	ОчиститьСообщения(); 
	ЕСли УстановитьрозничныеЦеныВДокументе=Истина Тогда //пихаем их в документ
		
		Если АвтоРасценка=Ложь ТОгда
			//ЭлементыФормы.ТОварИндюк.Значение=0;
			//ЭлементыФормы.ТОварИндюк.МаксимальноеЗначение=ТП.Количество();
		КонецЕсли;
		
		//ЭлементыФормы.ТОварИндюк.Видимость=Истина;
		
		
		если АвтоРасценка=Ложь 
				и ТипЗнч(Документ)<>Тип("ДокументСсылка.ПеремещениеТовара") 
				и ТипЗнч(Документ)<>Тип("ДокументСсылка.ПереРасценкаТоваров") 
								
			Тогда
			Если  ЭФВО.Проведен=Истина Тогда
				ПРедупреждение("В проведенный документ розничные цены записать не могу!");
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		
		ТОвар=ЭФВО.Товар;
		
		Для каждого СтрТП из ТП Цикл
			
			
			Если СтрТП.ЦенаРозн=0 Тогда
				Если Авторасценка=Ложь ТОгда  // при ручной расценке долбим пока все цены не рассчитаются
					ПРедупреждение("У товара "+СтрТП.ТОвар+" для региона "+СтрТП.регион+" не рассчиталась розничная цена!
					|Чтобы цены сохранились - они все должны быть рассчитаны!");
					Возврат;
				Иначе
					Продолжить; // при авторасценке пропускаем строчку нерасцененного товара
				КонецЕсли;	
			КонецЕсли;	

			
			
			Если ТипЗнч(Документ)<>Тип("ДокументСсылка.ПерерасценкаТоваров") Тогда
				
				
				Если ТипЗнч(Документ)<>Тип("ДокументСсылка.ПеремещениеТовара") Тогда
					Если СтрТП.Регион<>ЭФВО.Склад.Регион Тогда
						Продолжить;
					КонецЕсли;
				Иначе // перемещение товара
					Если СтрТП.Регион<>ЭФВО.СкладПолучатель.Регион Тогда
						Продолжить;
					КонецЕсли;
				КонецЕсли;
				
			Иначе
				// в перерасценке товаров допустимо расценять по другому региону
			КонецЕсли;
			
			
			Если Строка(СтрТП.ЦенаРозн)="" Тогда
				//Сообщить("Строка "+СтрТП.НН+"  Нет розничной цены! Товар: "+СтрТП.ТОвар+"   Партия: "+СтрТП.Партия);
				Продолжить;
			КонецЕсли; 	
			
			СтрП=ТОВар.Найти(СтрТП.Партия,"Партия");
			Если СтрП= Неопределено Тогда
				//Сообщить("Не найдена строка с партией "+СтрТП.Партия+" пропускаем...");
				Продолжить;
			КонецЕсли; 
			
			
			Цена1миншт=СтрТП.ЦенаРозн/СтрТП.КоэффЕит;
			
			
			
			Если ТипЗнч(Документ)<>Тип("ДокументСсылка.ПеремещениеТовара") Тогда
				СтрП.ЦенаРозн=Цена1миншт*СтрП.Коэфф;	
				СтрП.СуммаРозн=СтрП.ЦенаРозн*СтрП.КоличествоФакт;
				
				Если  СтрП.СуммаЗакуп<>0 и СтрП.СуммаРозн<>0 Тогда
					СтрП.ПроцентРознНац=(СтрП.СуммаРозн/СтрП.СуммаЗакуп-1)*100;
				ИначеЕсли СтрП.ЦенаРозн<>0 и СтрП.ЦенаЗакуп<>0 ТОГДА
					СтрП.ПроцентРознНац=(СтрП.ЦенаРозн/СтрП.ЦенаЗакуп-1)*100;
				КонецЕсли;	
				
				
				
				
				//------------------<Не пропускаем товар с отрицательной наценкой ( косяк разбивки?)>-------------------GtG----01.12.2008
				Если СтрП.ПроцентРознНац<0 Тогда
					Косяк=ТЗКосяков.Добавить();
					Косяк.Партия=СтрП.Партия;
					Косяк.ТОвар=СтрП.Товар;
					Косяк.Косяк="Отрицательная наценка! (Разбивочный товар?) "+СтрП.ПроцентРознНац;
					Косяк.ЦенаПоРасценке=СтрП.ЦенаРозн;
				КонецЕсли;
				СтрП.НДСРозн=ОМ3_НДСИзСуммыПоСтавке(СтрП.СуммаРозн,СтрП.СтавкаНДС);
			Иначе
				СтрП.ЦенаРознПол=Цена1миншт*СтрП.Коэфф;	
				СтрП.СуммаРознПол=СтрП.ЦенаРознПол*СтрП.КоличествоФакт;
				
				Если  СтрП.СуммаЗакуп<>0 и СтрП.СуммаРознПол<>0 Тогда
					СтрП.ПроцентРознНац=(СтрП.СуммаРознПол/СтрП.СуммаЗакуп-1)*100;
				ИначеЕсли СтрП.ЦенаРознПол<>0 и СтрП.ЦенаЗакуп<>0 ТОГДА
					СтрП.ПроцентРознНац=(СтрП.ЦенаРознПол/СтрП.ЦенаЗакуп-1)*100;
				КонецЕсли;	
				
				
				
				
				//------------------<Не пропускаем товар с отрицательной наценкой ( косяк разбивки?)>-------------------GtG----01.12.2008
				Если СтрП.ПроцентРознНац<0 Тогда
					Косяк=ТЗКосяков.Добавить();
					Косяк.Партия=СтрП.Партия;
					Косяк.ТОвар=СтрП.Товар;
					Косяк.Косяк="Отрицательная наценка! (Разбивочный товар?) "+СтрП.ПроцентРознНац;
					Косяк.ЦенаПоРасценке=СтрП.ЦенаРознПол;
				КонецЕсли;
				СтрП.НДСРознПол=ОМ3_НДСИзСуммыПоСтавке(СтрП.СуммаРознПол,СтрП.СтавкаНДС);

				
			КонецЕсли;
			
			
			Если АвтоРасценка=Ложь ТОгда
				//ЭлементыФормы.ТОварИндюк.Значение=ЭлементыФормы.ТОварИндюк.Значение+1;
			КонецЕсли;	
			
		КонецЦикла;	
		//ЭФВО.Записать(РежимЗаписиДокумента.Запись); Запишем документ один раз в конце процедуры
		
		//сообщить("Розничные цены записаны в документ");
		
	КонецЕсли;
	
	
	Если (ТипЗнч(Документ)=Тип("ДокументСсылка.ПоступлениеТовара"))  ТОгда
		ОП=ЭФВО.ОшибкиРасценки;
		
		Если Константы.БеспределСЖНВЛС.Получить() = Истина Тогда
			ПустаяПартия = Справочники.Партии.ПустаяСсылка();
			
			СписокУдаляемыхСтрок=новый СписокЗначений;
			ЕстьКосякиЖ2010=ложь;
			Для каждого стр из ОП Цикл
				Если стр.Партия = ПустаяПартия Тогда
					//Это косяк ЖНВЛС апрель 2010. нет цены госреестра либо она там совсем кривая
					
					// Нужно запороть документ - 1) колво=бойбрак=недовоз + комментарий "Проблемы с ценой госрегистрации"
					// 2) сумма розн=0
					
					ТабТовара=ЭФВО.Товар;
					
					СтрокиТовара=ТабТовара.НайтиСтроки(новый Структура("ТОвар",Стр.Товар)); // все строки товара в доке
					
					Для Каждого СтрСтрТовара Из СтрокиТовара Цикл
						СтрСтрТовара.СуммаРозн  =0;
						СтрСтрТовара.КоличествоФакт=0;
						СтрСтрТовара.БойБрак	   =СтрСтрТовара.Количество;
						СтрСтрТовара.Недовоз   =СтрСтрТовара.Количество;
						ЕстьКосякиЖ2010=Истина;
					КонецЦикла;
					продолжить;
				КонецЕсли;
				СписокУдаляемыхСтрок.Добавить(стр);
			КонецЦикла;
			Для Каждого ССУС из СписокУдаляемыхСтрок цикл
				ОП.Удалить(ССУС.Значение);
			КонецЦикла;	
			
			Если ЕстьКосякиЖ2010=Истина тогда
				ЭФВО.Комментарий=ЭФВО.Комментарий+" ### Проблемы с ценой госрегистрации ###" ;
			КонецЕсли;
			
			
		Иначе
			ОП.Очистить();// при каждой расценке перезаполняется. в идеале - пустая.
		КонецЕсли;

		
		ТЗКосяков.Свернуть("Партия,Товар,Косяк,ЦенаПоРасценке","");
		
		
		Для каждого Стр из ТЗКосяков Цикл
			СтрОп=ОП.Добавить();
			СтрОП.Товар 	= Стр.Товар;
			СтрОП.Партия 	= Стр.Партия;
			СтрОП.ОписаниеОшибки= Стр.Косяк;
			СтрОП.ЦенаПоРасценке= Стр.ЦенаПоРасценке;
		КонецЦикла;
		
		
		ЭФВО.Статус=Перечисления.СтатусПрихода.Расценен;
		
		Если ТЗКосяков.Количество()>0 ТОгда
			ЭФВО.Статус=Перечисления.СтатусПрихода.ПроблемыСРасценкой;
		КонецЕсли;
		

	ИначеЕсли (ТипЗнч(Документ)=Тип("ДокументСсылка.ПеремещениеТовара")) ТОгда
		ОП=ЭФВО.ОшибкиРасценки;
		ОП.Очистить();// при каждой расценке перезаполняется. в идеале - пустая.
		
		ТЗКосяков.Свернуть("Партия,Товар,Косяк,ЦенаПоРасценке","");
		
		
		Для каждого Стр из ТЗКосяков Цикл
			СтрОп=ОП.Добавить();
			СтрОП.Товар 	= Стр.Товар;
			СтрОП.Партия 	= Стр.Партия;
			СтрОП.ОписаниеОшибки= Стр.Косяк;
			СтрОП.ЦенаПоРасценке= Стр.ЦенаПоРасценке;
		КонецЦикла;
		
		
		ЭФВО.Статус=Перечисления.СтатусПеремещения.Расценен;
		
		Если ТЗКосяков.Количество()>0 ТОгда
			ЭФВО.Статус=Перечисления.СтатусПеремещения.ПроблемыСРасценкой;
		КонецЕсли;
		
		
	КонецЕсли;
	
	Для н = 0 По 5 Цикл
		Попытка
			ЭФВО.Записать(РежимЗаписиДокумента.Запись);
			Прервать;
		Исключение
			Предупреждение("Ожидание блокировки",1);
		КонецПопытки;
	КонецЦикла;
	
	
	
	
	//предупреждение("Расценка сохранена.",1);
	
    	
КонецПроцедуры

Процедура ДеревоОшибокВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	Если ТипЗнч(ВыбраннаяСтрока.Ошибки)<>Тип("Строка") ТОгда
		ВыбраннаяСтрока.Ошибки.ПолучитьФорму().Открыть();
	КонецЕсли;
КонецПроцедуры

Процедура ПоТОваруНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	
	МассивТоваров=ЭтаФорма.ВладелецФормы.Товар.ВыгрузитьКолонку("Товар");
	Элемент.СписокВыбора.ЗагрузитьЗначения(МАссивТоваров);
КонецПроцедуры

Процедура ТПЦенаРознПриИзменении(Элемент)
	
	//Пересчет процентов наценки при изменении розничной цены вручную
	
	ТСР= ЭлементыФормы.ТП.ТекущаяСтрока;
	
	СтрТП=ЭлементыФормы.ТП.ТекущаяСтрока;
	Если СтрТП.Товар.ЖНВЛС = Истина Тогда
		//СтрТП.ЦенаОптовая=СтрТП.ЦенаРозн;// затычка
		ЦенаЗакупБезНДС = Окр(СтрТП.ЦенаЗакуп/(1+СтрТП.Партия.СтавкаНДС.Ставка/100),2);
		СтрТП.НаценкаОтЗакупки = Окр((СтрТП.ЦенаРозн/(1+СтрТП.Партия.СтавкаНДС.Ставка/100) - ЦенаЗакупБезНДС)*100/СтрТП.ЦенаПрБезНДС,2);
	Иначе
		СтрТП.НаценкаОтЗакупки = ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаЗакуп,СтрТП.ЦенаРозн);
	КонецЕсли;
	СтрТП.НаценкаОтЦГР =ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаГосРег,СтрТП.ЦенаРозн);
	СтрТП.НаценкаОтЗакупБезНДС= ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаЗакуп-ОМ3_НДСИзСуммыПоСтавке(СтрТП.ЦенаЗакуп,СтрТП.Партия.СтавкаНДС,2),СтрТП.ЦенаРозн);
	СтрТП.НаценкаОтЦПРБНДС=ОМ6_НаценкаОтЧегоЛибо (СтрТП.ЦенаПрБезНДС,СтрТП.ЦенаРозн);
	
КонецПроцедуры

Процедура КоманднаяПанель1Закрыть(Кнопка)
	ЭтаФорма.Закрыть();
КонецПроцедуры

Процедура КоманднаяПанель2ВыбратьВсеРЕг(Кнопка)
	ВыбРег.ЗаполнитьПометки(Истина);
КонецПроцедуры

Процедура КоманднаяПанель2неВыбратьВсеРег(Кнопка)
	ВыбРег.ЗаполнитьПометки(Ложь);

КонецПроцедуры

Процедура КоманднаяПанель2ОбратитьРЕГ(Кнопка)
	Для каждого Стр из ВыбРег Цикл
		Стр.Пометка=Не Стр.Пометка;
	КонецЦикла;	 
КонецПроцедуры
 
Процедура ТППриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Остаток > 0 Тогда
		ОформлениеСтроки.Ячейки.Товар.ЦветФона = Новый Цвет(104, 240, 90);	
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1кнПоказатьЦеныКонкурентов(Кнопка)
	
	Если Константы.ИспользоватьЦеныКонкурентовПриРасценке.Получить() = Истина Тогда
		ТекСтрока = ЭлементыФормы.ТП.ТекущаяСтрока;
		Если ТекСтрока = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Если НЕ  ПустаяСтрока(ТекСтрока.Конкурент) Тогда
			Форма = ПолучитьФорму("Обработка.Расценка_v2.Форма.ВсеЦеныКонкурентов");
			Форма.Код = ТекСтрока.Товар.Код;
			Форма.Открыть();
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры

Процедура КоманднаяПанель1УстановитьПредЦенуВРасчетную(Кнопка)
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Текст = "ru = ""Подтвердите ваше желание на коррекцию расчетной цены?"";"
	+ " en = ""Do you want to continue?""";
	Ответ = Вопрос(НСтр(Текст), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	
	Для каждого стр из ТП Цикл
		Если стр.ПредыдущаяРознЦена < стр.ЦенаРозн и стр.ЦенаРозн > 0  Тогда
			стр.ЦенаРозн = стр.ПредыдущаяРознЦена;	
			стр.НаценкаОтЗакупки =  ОМ6_НаценкаОтЧегоЛибо(стр.ЦенаЗакуп,стр.ЦенаРозн);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры


ЭлементыФормы.ХодРасценкиРегион.Видимость=Ложь;
ЭлементыФормы.ХодРасценкиТОвар.Видимость=Ложь;
	
Комментировать=Истина;
ВыводитьНеРасцененные=Истина;

ТХТ="ВЫБРАТЬ
	    |	Регионы.Ссылка как Рег
	    |ИЗ
	    |	Справочник.Регионы КАК Регионы
	    |ГДЕ
	    |	Регионы.ПометкаУдаления = Ложь";
		
Запрос = Новый Запрос;
Запрос.Текст=ТХТ;
	
ВыбРег.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Рег"));

Попытка
	Если ЭтаФорма.ВладелецФормы.Склад.ТипСклада = Перечисления.ТипыМХ.Розн Тогда
		Для каждого Стр из ВыбРег Цикл
			Если Стр.Значение= ЭтаФорма.ВладелецФормы.Склад.Регион ТОгда
				Стр.Пометка=Истина;
			КонецЕсли;
		КонецЦикла;	
	Иначе
		ВыбРег.ЗаполнитьПометки(Истина);
	КонецЕсли;
Исключение
КонецПопытки; 


МинимальныйПроцентНаценкиКромеТопов=0;

ЗаписыватьЦеныВРегистрЦен=Истина;
УстановитьрозничныеЦеныВДокументе=Ложь;
ИспользоватьЦеныКонкурентов = Константы.ИспользоватьЦеныКонкурентовПриРасценке.Получить();
ПроверятьЗакупкуИРозницу = Истина;

