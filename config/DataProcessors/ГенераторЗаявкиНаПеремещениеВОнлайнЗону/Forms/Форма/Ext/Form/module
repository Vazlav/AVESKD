
Процедура КнопкаВыполнитьНажатие(Кнопка)
	Если Аптека.Пустая()=Истина Тогда
		ПРедупреждение("Не выбрана аптека! Не могу отправить заявку на неизвестную аптеку!");
		Возврат;
	КонецЕсли;	
	
	Если ОнлайнЗона.Пустая()=Истина Тогда
		ПРедупреждение("Не выбрана онлайн-зона!");
		Возврат;
	КонецЕсли;	
	
	
	
	МО_ВыгрузитьЗаказ(Заказ);
	
	предупреждение("Выгружена заявка на перемещение товара
	|на аптеку "+Аптека,10);
	ЭтаФорма.Закрыть();
КонецПроцедуры

Процедура ЗаказПриИзменении(Элемент)
	Аптека=Заказ.ФизическаяАптека;
	ОнлайнЗона=Заказ.Склад;
КонецПроцедуры

Процедура ОсновныеДействияФормыОстаткиПоАптекам(Кнопка)
	ЭлементыФормы.ТабОстатков.Очистить();
	
	Построитель = Новый ПостроительОтчета;
	Построитель.ВыводитьОбщиеИтоги=Истина;
	Построитель.ТекстЗаголовка="";
	Построитель.Параметры.Очистить();
	
	Построитель.Параметры.Вставить("Ссылка",  Заказ  );
	Построитель.Параметры.Вставить("СС_Собран",  Перечисления.ИА_СтатусСтрокиЗаказа.Собран);
	Построитель.Параметры.Вставить("СС_НеПробивать",  Перечисления.ИА_СтатусСтрокиЗаказа.НеПробивать);
	Построитель.Параметры.Вставить("АптекаОнлайн",  ОнлайнЗона);
	
	Построитель.ЗаполнениеРасшифровки=ВидЗаполненияРасшифровкиПостроителяОтчета.ЗначенияГруппировок;
	//--------------------------------------- ЗАПРОС ------------------------------------------
	Построитель.Текст="ВЫБРАТЬ
	                  |	ИнтернетЗаказТовар.Товар,
	                  |	ИнтернетЗаказТовар.Количество * ИнтернетЗаказТовар.К КАК КолвоМинЕдЗаказано,
	                  |	ПриоритетВыбораАптекиСДоставкой.Аптека,
	                  |	ПриоритетВыбораАптекиСДоставкой.Приоритет
	                  |ПОМЕСТИТЬ Заказ
	                  |ИЗ
	                  |	Документ.ИнтернетЗаказ.Товар КАК ИнтернетЗаказТовар,
	                  |	РегистрСведений.ПриоритетВыбораАптекиСДоставкой КАК ПриоритетВыбораАптекиСДоставкой
	                  |ГДЕ
	                  |	ИнтернетЗаказТовар.Ссылка = &Ссылка
	                  |	И ИнтернетЗаказТовар.СтатусСтроки <> &СС_Собран
	                  |	И ИнтернетЗаказТовар.СтатусСтроки <> &СС_НеПробивать
	                  |	И ПриоритетВыбораАптекиСДоставкой.Аптека <> &АптекаОнлайн
	                  |;
	                  |
	                  |////////////////////////////////////////////////////////////////////////////////
	                  |ВЫБРАТЬ
	                  |	ПартииЖНВЛСОстатки.Склад,
	                  |	ПартииЖНВЛСОстатки.Товар,
	                  |	ПартииЖНВЛСОстатки.КолвоОстаток
	                  |ПОМЕСТИТЬ ОстаткиПоАптекам
	                  |ИЗ
	                  |	РегистрНакопления.ПартииЖНВЛС.Остатки(
	                  |			,
	                  |			Товар В
	                  |					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	                  |						Заказ.Товар
	                  |					ИЗ
	                  |						Заказ КАК Заказ)
	                  |				И Склад В
	                  |					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	                  |						Заказ.Аптека
	                  |					ИЗ
	                  |						Заказ КАК Заказ)) КАК ПартииЖНВЛСОстатки
	                  |;
	                  |
	                  |////////////////////////////////////////////////////////////////////////////////
	                  |ВЫБРАТЬ
	                  |	Заказ.Аптека КАК Аптека,
	                  |	Заказ.Товар КАК Товар,
	                  |	Заказ.КолвоМинЕдЗаказано КАК Заказано,
	                  |	ЕСТЬNULL(ОстаткиПоАптекам.КолвоОстаток, 0) КАК Остаток
	                  |ИЗ
	                  |	Заказ КАК Заказ
	                  |		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиПоАптекам КАК ОстаткиПоАптекам
	                  |		ПО Заказ.Аптека = ОстаткиПоАптекам.Склад
	                  |			И Заказ.Товар = ОстаткиПоАптекам.Товар
	                  |
	                  |УПОРЯДОЧИТЬ ПО
	                  |	Аптека,
	                  |	Товар
	                  |ИТОГИ
	                  |	СУММА(Заказано),
	                  |	СУММА(Остаток)
	                  |ПО
	                  |	Аптека,
	                  |	Товар";
	//--------------------------------------- ------ ------------------------------------------
	Построитель.Выполнить();
	Построитель.ВыводитьЗаголовокОтчета=Ложь;
	Построитель.МакетОформления=ПолучитьМакетОформления(СтандартноеОформление.ТРАВА);
	Построитель.ЗаполнениеРасшифровки=ВидЗаполненияРасшифровкиПостроителяОтчета.ЗначенияГруппировок;
	Построитель.ОформитьМакет();
	Построитель.Вывести(ЭлементыФормы.ТабОстатков);
	
	
	ЭлементыФормы.ТабОстатков.ТолькоПросмотр=Истина;
	
	
	
	
КонецПроцедуры

Процедура ТабОстатковОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	СтандартнаяОбработка=ЛОжь;
	
	Если ТипЗнч(Расшифровка)<>Тип("СправочникСсылка.МестаХранения") Тогда
		Возврат;
	КонецЕсли;
	
	Аптека=Расшифровка;
	ЭлементыФормы.Аптека.Шрифт=Новый Шрифт(,,Истина);
	
КонецПроцедуры


Процедура ПриОткрытии()
	ОсновныеДействияФормыОстаткиПоАптекам("");
КонецПроцедуры

