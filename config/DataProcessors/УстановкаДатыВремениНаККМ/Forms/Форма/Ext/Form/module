
Перем ECR;

Процедура КнопкаВыполнитьНажатие(Кнопка)
	ECR.DeviceEnabled = 1;
	Если ECR.ResultCode <> 0 тогда
		Предупреждение("Нет связи с фискальным регистратором!");
		Возврат;
	КонецЕсли;
	
	// получаем состояние ККМ
	ГетСтатус=ECR.GetStatus() ;
	Если ГетСтатус <> 0 тогда
		Предупреждение("Неверное состояние ККМ ! Код ошибки "+ГетСтатус);
		Возврат;
	КонецЕсли;
	
	//---------------<дата>---------------------------// GtG // 24.08.2012 14:47:44	
	ТД=ТекущаяДата();
	
	
	//	SetDate()
	//УстановитьДату()
	//Метод устанавливает системную дату в ККМ. Если вводимая дата больше, чем на
	//один день, текущей даты, то ККМ требует подтверждения ввода даты – необхо-
	//димо второй раз вызвать метод.
	//Протокол АТОЛ 1.x : метод вызывается только в режиме отчетов с гашением.
	//Протокол АТОЛ 2.x : метод вызывается в любом режиме при условии, что смена
	//закрыта.
	//Название Тип Дост. Значения
	//Входные свойства
	ECR.Day=День(ТД);
	//День
	//Int RW День:
	//1 … 31
	ECR.Month=Месяц(ТД);
	//Месяц
	//Int RW Месяц:
	//1 … 12
	ECR.Year=Год(ТД);
	//Год
	//Int RW Год:
	//1998 … 2089
	сообщить("Установка даты ... ");
	ECR.SetDate();
	
	Если ECR.ResultCode <> 0 тогда
		
		//Возможные ошибки
		//Код Причина
		Если ECR.ResultCode=-3892 тогда
			//ККМ заблокирована в режиме ввода даты.
			//Для фискализированной ККМ при попытке задать дату меньшую,
			//чем дата последней записи в фискальной памяти (отчета с гашени-
			//ем), ККМ блокируется до задания правильной даты.
			Предупреждение("ККМ заблокирована в режиме ввода даты.
			|Для фискализированной ККМ при попытке задать дату меньшую,
			|чем дата последней записи в фискальной памяти (отчета с гашением), 
			|ККМ блокируется до задания правильной даты.
			|--------------------------------------------------------------------------
			|Бывает если дата на компьютере меньше даты последнего чека на фискальнике.");
		КонецЕсли;
		Если ECR.ResultCode=-3893 тогда
			ECR.Day=День(ТД);
			ECR.Month=Месяц(ТД);
			ECR.Year=Год(ТД);
			сообщить("Подтверждение даты ... ");
			ECR.SetDate();
			//Требуется подтверждение ввода даты (необходимо повторно вы-
			//звать метод SetDate()).
		КонецЕсли;
	КонецЕсли;	
	
	
	//---------------<время>---------------------------// GtG // 24.08.2012 14:47:26
	//SetTime()
	//УстановитьВремя()
	//Метод устанавливает системное время в ККМ.
	//Название Тип Дост. Значения
	//Входные свойства
	ECR.Hour=час(ТД);
	//Час
	//Int RW Час:
	//0 ... 23
	ECR.Minute=минута(тд);
	//Минута
	//Int RW Минута:
	//0 ... 59
	ECR.Second=секунда(ТД);
	//Секунда
	//Int RW Секунда:
	//0 ... 59
	сообщить("Установка времени... ");

	ECR.SetTime();
	
	Если ECR.ResultCode <> 0 тогда
        Предупреждение("Не удалось изменить время!");
		возврат;
	КонецЕсли;	
	
	
	Сообщить("Готово");
	
	
	
	
	
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
		
	Попытка
		ЗагрузитьВнешнююКомпоненту("C:\Program Files (x86)\1cv82\common\DLL\FPRNM1C.dll");
		ECR = Новый("AddIn.FprnM45");
		СостояниеККМ="ККМ:Подключена";
	исключение
		Предупреждение("Ошибка загрузки внешней компоненты C:\Program Files (x86)\1cv82\common\DLL\FPRNM1C.dll, ПЕЧАТЬ ЧЕКОВ НЕВОЗМОЖНА!!!");
		СостояниеККМ="ККМ:НЕ ПОДКЛЮЧЕНА!!!";
		
	конецпопытки;
КонецПроцедуры
