
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	//------------------<Вывод результатов построителя>-------------------GtG----27.11.08
	
	Построитель.Параметры.Вставить("Дата1",НачПериода);	
	Построитель.Параметры.Вставить("Дата2",КонПериода);
	
	Построитель.Выполнить();
	
	ТЗ=Построитель.Результат.Выгрузить();
	
	ТЗ.Колонки.Добавить("Результат");
	
	
	
	ЭлементыФормы.Доки.Значение=ТЗ;
	ЭлементыФормы.Доки.СоздатьКолонки();
	
	//--------------------------------------------------------GtG----КОНЕЦ--27.11.08
	
	ЭтаФорма.Панель.ТекущаяСтраница= ЭтаФорма.Панель.Страницы["Документы"];
КонецПроцедуры


процедура ОчиститьЦеныДокумента(ДокОбъект)
	 	
	
	ДокОбъект.Движения.Цены.Очистить();
	
	ДокОбъект.Движения.Цены.Записать();
	
КонецПроцедуры	


Процедура ОсновныеДействияФормыРасценитьВыбранныеДокументы(Кнопка)
	
	//-------------------------------------------------------------------
	ЭлементыФормы.Инд.Значение=0;
	ЭлементыФормы.Инд.МаксимальноеЗначение=Доки.Количество();
	
	
	
	Для каждого Стр из Доки Цикл
		Попытка
			Документ=Стр.Документ.ПолучитьОбъект();
			
			//РучнойДок=Истина;
			//Если Документ.ЗагруженАвтоматически=Ложь Тогда
			//	Документ.ЗагруженАвтоматически=Истина; // иначе расценка не запустится
			//Иначе
				РучнойДок=Ложь;
			//КонецЕсли;
			
			
			//-------- Если перерасценять ошибочнорасценочные документы  нужно сначала удалить из регистра цен записи по этим докам ----\\
			// в противном случае сработает  ОМ6_ЕстьЦеныПоРасценке(ЭтотОбъект.Ссылка)=Ложь и досвидос.
			
			ОчиститьЦеныДокумента(Документ);
			
			Документ.ОшибкиРасценки.Очистить();
			
			Документ.Записать(РежимЗаписиДокумента.Запись);
			
			
			
			
			
			
			Если Документ.АвтоматическаяРасценка_Успешно()= Истина  Тогда   
				
				//Если РучнойДок=Истина ТОгда
				//	Документ.ЗагруженАвтоматически=Ложь;
				//КонецЕсли;	
					
				
				Документ.Записать(РежимЗаписиДокумента.Проведение);
				Стр.Результат=Перечисления.СтатусПрихода.Расценен;
			Иначе
				Стр.Результат=Перечисления.СтатусПрихода.ПроблемыСРасценкой;
			КонецЕсли; 
		Исключение
			 Стр.Результат=Перечисления.СтатусПрихода.ПроблемыСРасценкой;
			 Сообщить(ОписаниеОшибки());
		 КонецПопытки;
		 
		 ЭлементыФормы.Инд.Значение=ЭлементыФормы.Инд.Значение+1;
	 КонецЦикла;	
	 
	 //==================<Выгрузим расцененные документы в аптеку>===================GtG====03.12.2008
	 ЭлементыФормы.Инд.Значение=0;
	 ЭлементыФормы.Инд.МаксимальноеЗначение=Доки.Количество();
	 Для каждого Стр из Доки Цикл
		 Если Стр.Результат=Перечисления.СтатусПрихода.ПроблемыСРасценкой ТОгда
			 Продолжить;
		 КонецЕсли;
		 
		 Документ=Стр.Документ.ПолучитьОбъект();

		 Если Документ.Склад.ТипСклада= Перечисления.ТипыМХ.Розн ТОгда
			 Если Документ.ВыгрузитьВАптеку()=Истина ТОгда
				 Стр.Результат=Документ.Статус;
				 Стр.Статус=Документ.Статус;

			 КонецЕсли;	  
         КонецЕсли;
		 
		 
		 ЭлементыФормы.Инд.Значение=ЭлементыФормы.Инд.Значение+1;
	 КонецЦикла;	 
	 
	 
	 
	 
	 
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель2Распровести(Кнопка)
	
	Для каждого стр из Доки Цикл
		
		Документ=Стр.Документ.ПолучитьОбъект();
		Документ.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		
	КонецЦикла;
	
КонецПроцедуры


//------------------<Построитель>-------------------GtG----27.11.08

ТХТ="ВЫБРАТЬ
    |	ПоступлениеТовара.ДатапоступленияНаСклад,
    |	ПоступлениеТовара.Ссылка КАК Документ,
    |	ПоступлениеТовара.Поставщик,
    |	ПоступлениеТовара.Склад,
    |	ПоступлениеТовара.СуммаДок,
    |	ПоступлениеТовара.Состояние,
    |	ПоступлениеТовара.Статус,
    |	ПоступлениеТовара.Проведен
    |ИЗ
    |	Документ.ПоступлениеТовара КАК ПоступлениеТовара
    |ГДЕ
    |	ПоступлениеТовара.Проведен = Ложь
    |	И ПоступлениеТовара.ПометкаУдаления = ЛОЖЬ
    |	И ПоступлениеТовара.Дата МЕЖДУ &Дата1 И &Дата2
    |{ГДЕ
    |	ПоступлениеТовара.Поставщик.*,
    |	ПоступлениеТовара.Склад.*,
    |	ПоступлениеТовара.ДатапоступленияНаСклад,
    |	ПоступлениеТовара.Состояние,
    |	ПоступлениеТовара.Статус}";
	
	
	
	
Построитель.Текст=ТХТ;       
Построитель.ОбрабатыватьПрерываниеПользователя=Истина;
Построитель.ОтображатьСостояние=Истина;
//--------------------------------------------------------GtG----КОНЕЦ--27.11.08