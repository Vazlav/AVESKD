Процедура УстановитьВсеРеквизитыВПостроитель()
	
	ТХТ="ВЫБРАТЬ ";
	ТХТРеквизиты = " " ;
	
	
	Для каждого стр из Метаданные.Справочники.МестаХранения.Реквизиты Цикл
		ТХТРеквизиты = ТХТРеквизиты + " " + стр.Имя + ",";
		ЕстьРеквизиты = Истина;
	КонецЦикла;
	
	
	ТХТРеквизиты = ЛЕВ(ТХТРеквизиты,СтрДлина(ТХТРеквизиты)-1);
	
	ТХТ = ТХТ + " " + ТХТРеквизиты + "  
	|ИЗ
	|	Справочник.МестаХранения КАК МХ
	|{ГДЕ
	|	 " + ТХТРеквизиты + " }";
	
	Построитель.Текст=ТХТ;
	
	
КонецПроцедуры

Процедура УстановитьРеквизитыПоОтборуВПостроитель()
	
	НаборЗаписей = РегистрыСведений.ПраваНаОбъекты.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Объект.Установить(Метаданные.Справочники.МестаХранения.Имя);
	НаборЗаписей.Отбор.Пользователь.Установить(ПараметрыСеанса.ТекущийСотр);
	
	НаборЗаписей.Прочитать();
	КоличествоЗаписей = НаборЗаписей.Количество();
	
	Если КоличествоЗаписей = 0 Тогда
		Предупреждение("Недостаточно прав для редактирования реквизитов справочника");
		ЭтаФорма.Закрыть();
		Возврат;			
	КонецЕсли;	
	
	Если НаборЗаписей.Получить(0).ПолныеПрава Тогда
		УстановитьВсеРеквизитыВПостроитель();
		Возврат;
	КонецЕсли;
	
	ТХТ="ВЫБРАТЬ ";
	ТХТРеквизиты = " " ;
	ЕстьРеквизиты = Ложь;
	Для каждого стр из НаборЗаписей Цикл
		Если НЕ Метаданные.Справочники.МестаХранения.Реквизиты.найти(стр.Реквизит) = Неопределено Тогда
			ТХТРеквизиты = ТХТРеквизиты + " " + стр.Реквизит + ",";
			ЕстьРеквизиты = Истина;
		КонецЕсли;
	КонецЦикла;
	
	
	Если ЕстьРеквизиты = Ложь Тогда
		Предупреждение("Недостаточно прав для редактирования реквизитов справочника");
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли;
	
	ТХТРеквизиты = ЛЕВ(ТХТРеквизиты,СтрДлина(ТХТРеквизиты)-1);
	
	ТХТ = ТХТ + " " + ТХТРеквизиты + "  
	|ИЗ
	|	Справочник.МестаХранения КАК МХ
	|{ГДЕ
	|	 " + ТХТРеквизиты + " }";
	
	Построитель.Текст=ТХТ;
	
	
КонецПроцедуры


Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	ЭлементыФормы.Индикатор1.Значение=0;
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение= СписокОтобранныхПозиций.Количество();
	
	Пользователь = ПараметрыСеанса.ТекущийСотр;
	
	Для каждого Стр из СписокОтобранныхПозиций Цикл
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;
		
		МХ=Стр.Значение.ПолучитьОбъект();
		
		Изменения = МХ.Изменения;
		Для каждого Рекв из  Построитель.Отбор Цикл
			ЗначениеДо = МХ[Рекв.ПутьКДанным];
			МХ[Рекв.ПутьКДанным]=Рекв.Значение;
			НС = Изменения.Добавить();
			НС.Дата = ТекущаяДата();
			НС.Реквизит =  Рекв.ПутьКДанным;
			НС.Пользователь  = Пользователь;
			НС.ЗначениеДо = ЗначениеДо;
			НС.ЗначениеПосле = Рекв.Значение;
		КонецЦикла;	
		
		МХ.Записать();
	КонецЦикла;	
	
	

КонецПроцедуры

Процедура КоманднаяПанель3ПодобратьТовар(Кнопка)
	
	СписокОтобранныхПозиций.Очистить();
	
	Обработка = Обработки.ОтборПоФильтру.Создать();
	Обработка.ТекстЗапроса = "ВЫБРАТЬ
	                         |	МестаХранения.Ссылка
	                         |ИЗ
	                         |	Справочник.МестаХранения КАК МестаХранения
	                         |
							 |{ГДЕ
	                         |	МестаХранения.Ссылка.* КАК Аптека}";
	
	ФормаПодбора=Обработка.ПолучитьФорму("Форма");
	
	РезультатСписок = ФормаПодбора.ОткрытьМодально();
	Если РезультатСписок= Неопределено Тогда
		ПРедупреждение("Ничего не выбрано!");
		Возврат;
	КонецЕсли; 	
	
	СписокОтобранныхПозиций=РезультатСписок.Скопировать();
	
КонецПроцедуры

Процедура КоманднаяПанель3кнЗагрузитьИзФайла(Кнопка)
	
	XLS=Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	XLS.ПолноеИмяФайла = "";
	XLS.МножественныйВыбор = Ложь;
	XLS.Заголовок = "Выберите файл формата Excel";
	XLS.Фильтр="*.xls|*.xls";
	Если XLS.Выбрать() Тогда
		ФайлЭксель=XLS.ПолноеИмяФайла;
	Иначе
		Возврат;
	КонецЕсли;	
	
	Если ПустаяСтрока(СокрЛП(ФайлЭксель)) = Истина Тогда
		Предупреждение("Не выбран файл для загрузки аптеки");
		Возврат;
	КонецЕсли;
	
	Excel = Новый COMОбъект("Excel.Application");
	Попытка
		Excel.WorkBooks.Open(СокрЛП(ФайлЭксель), 0);
	Исключение
		Сообщить("Файл: " + ФайлЭксель + " либо уже открыт, либо поврежден! Пропускаем его... ");	
		Возврат;
	КонецПопытки;
	
	
	ТХТ = "ВЫБРАТЬ
	      |	МестаХранения.Код,
	      |	МестаХранения.Ссылка
	      |ИЗ
	      |	Справочник.МестаХранения КАК МестаХранения";
		Запрос = Новый Запрос;
		Запрос.Текст = ТХТ;
		ТЗАптек = Запрос.Выполнить().Выгрузить();
		ТЗАптек.Индексы.Добавить("Код");
	
	
	
	Sell_itr = 2;
	КолСтрок = 0;	
	
	Пока Строка(Excel.ActiveSheet.Cells(Sell_itr,1).Value) <> "" Цикл
		Sell_itr = Sell_itr + 1;
		КолСтрок = КолСтрок + 1;
	КонецЦикла;	
	
	Sell_itr = 2;
	
	
	Пока Строка(Excel.ActiveSheet.Cells(Sell_itr,1).Value) <> "" Цикл

		ОбработкаПрерыванияПользователя();
		Попытка
			Код		= Число(Excel.ActiveSheet.Cells(Sell_itr,1).Value);
		Исключение
			Код = 0;
		КонецПопытки;
	
		НайденнаяСтрока = ТЗАптек.Найти(Код,"Код");
		Если НЕ НайденнаяСтрока = Неопределено  Тогда
			СписокОтобранныхПозиций.Добавить(НайденнаяСтрока.Ссылка);
		КонецЕсли;
		
		Sell_itr = Sell_itr + 1;
					
	КонецЦикла;
	
	Excel.Quit();

	
	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	Если  РольДоступна("супер_Администратор") или  Константы.ИспользоватьОграничениеПравНаСправочники.Получить() = Ложь Тогда	
		УстановитьВсеРеквизитыВПостроитель();	
	Иначе
		УстановитьРеквизитыПоОтборуВПостроитель();
	КонецЕсли;
			
КонецПроцедуры


