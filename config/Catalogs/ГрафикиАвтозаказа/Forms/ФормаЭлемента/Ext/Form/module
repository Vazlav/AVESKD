Перем ТаблицаПримечаний;

Процедура ПосчитатьИтоги()
	
	СоответствиеКолонок = Новый Соответствие;
	Для каждого Колонка из ЭлементыФормы.График.Колонки Цикл
		СоответствиеКолонок.Вставить(Колонка.Имя,0);	
	КонецЦикла; 
	
	Для каждого стр из График Цикл
		
		Если ЭлементыФормы.График.ПроверитьСтроку(стр) = Истина Тогда
			Для каждого текКолонка из ЭлементыФормы.График.Колонки Цикл
				Если стр[текКолонка.Имя] = Истина Тогда
					СоответствиеКолонок[текКолонка.Имя] = СоответствиеКолонок[текКолонка.Имя] + 1;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;	

	Для каждого текКолонка из ЭлементыФормы.График.Колонки Цикл
		ЭлементыФормы.График.Колонки[текКолонка.Имя].ТекстПодвала = СоответствиеКолонок[текКолонка.Имя];	
	КонецЦикла;

	
КонецПроцедуры


Процедура ГрафикПриИзмененииФлажка(Элемент, Колонка)
	
	н=0;
	Для каждого стр из График Цикл
		
		Если ЭлементыФормы.График.ПроверитьСтроку(стр) = Истина Тогда
			Если стр[Колонка.Имя] = Истина Тогда
				н=н+1;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	                                                         
	ЭлементыФормы.График.Колонки[Колонка.Имя].ТекстПодвала = н;
	
КонецПроцедуры

Процедура КоманднаяПанель1кнЗаполнитьАптеки(Кнопка)
	
	Обработка = Обработки.ОтборПоФильтру.Создать();
	Обработка.ТекстЗапроса = "ВЫБРАТЬ
	                            |	МестаХранения.Ссылка
	                            |ИЗ
	                            |	Справочник.МестаХранения КАК МестаХранения
	                            |{ГДЕ
	                            |	МестаХранения.Ссылка.* как Аптека}";
								
	ФормаПодбора=Обработка.ПолучитьФорму("Форма");

	РезультатСписок = ФормаПодбора.ОткрытьМодально();
	Если РезультатСписок= Неопределено Тогда
		ПРедупреждение("Ничего не выбрано!");
		Возврат;
	КонецЕсли; 
	
	Для каждого стр из РезультатСписок Цикл
		НайденнаяСтрока = График.Найти(стр.Значение,"Аптека");	
		Если НайденнаяСтрока = Неопределено Тогда
			НоваяСтрока = График.Добавить();
			НоваяСтрока.Аптека = стр.Значение;
		КонецЕсли;
	КонецЦикла;
	
	
КонецПроцедуры

Процедура ГрафикПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	//ОформлениеСтроки.Ячейки.Пятница.ЦветФона	
	
	Если ДанныеСтроки.Блокировка = Истина Тогда
		ОформлениеСтроки.ЦветФона = Новый Цвет(255,160,122);
	Иначе
		Для каждого стр из ОформлениеСтроки.Ячейки Цикл
			Если ДанныеСтроки[стр.Имя] = Истина Тогда
				Если стр.Имя = "Блокировка" Тогда
					ОформлениеСтроки.Ячейки[стр.Имя].ЦветФона = Новый Цвет(255,160,122);	
				ИНаче
					ОформлениеСтроки.Ячейки[стр.Имя].ЦветФона = Новый Цвет(50,205,50);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	Если НЕ ТаблицаПримечаний = Неопределено Тогда
		Для каждого стр из ОформлениеСтроки.Ячейки Цикл
			Отбор = Новый Структура();
			Отбор.Вставить("КолонкаГрафика",стр.Имя);		
			Отбор.Вставить("Аптека",ДанныеСтроки.Аптека);		
			Строки =  ТаблицаПримечаний.НайтиСтроки(Отбор);
			Если Строки.Количество() > 0 Тогда
				стр.Картинка = БиблиотекаКартинок.ТабличныйДокументОтображатьПримечания;
				стр.ОтображатьКартинку = Истина;
			КонецЕсли;
			
		КонецЦикла;                                    
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	//НеделяГода = НеделяГода(ТекущаяДата());
	//ДеньСтрока = Формат(ТекущаяДата(),"ДФ=дддд");
	//ДеньНедели = ДеньНедели(ТекущаяДата());

	Если НЕ ЭтоНовый() Тогда
		
		ТХТ = "ВЫБРАТЬ
		      |	ПримечанияКГрафикамАвтозаказа.КолонкаГрафика,
		      |	ПримечанияКГрафикамАвтозаказа.Примечание,
		      |	ПримечанияКГрафикамАвтозаказа.Аптека
		      |ИЗ
		      |	РегистрСведений.ПримечанияКГрафикамАвтозаказа КАК ПримечанияКГрафикамАвтозаказа
		      |ГДЕ
		      |	ПримечанияКГрафикамАвтозаказа.График = &График";
		Запрос = Новый Запрос;	  
	    Запрос.Текст = ТХТ;
		Запрос.УстановитьПараметр("График",Ссылка);
		ТаблицаПримечаний = Запрос.Выполнить().Выгрузить();
	Иначе
		ТаблицаПримечаний = Неопределено;
	КонецЕсли;
	
	Если НачалоПериода = Дата(1,1,1) или  КонецПериода = Дата(1,1,1)  Тогда
		Возврат;
	КонецЕсли;
	
	
	НеделяГода = НеделяГода(НачалоПериода);
	ДеньСтрока = Формат(НачалоПериода,"ДФ=дддд");
	ДеньНедели = ДеньНедели(НачалоПериода);
	
	
	Если Цел(НеделяГода/2)=НеделяГода/2  Тогда
		Четность = "Четный";
	ИНаче
		Четность = "";
	КонецЕсли;
	
	ЭлементыФормы.График.Колонки[ДеньСтрока+Четность].ЦветФонаПоля = WebЦвета.СветлоЗеленый;
	//ЭлементыФормы.График.Колонки[ДеньСтрока+Четность].ШрифтТекста.Жирный = Истина;
	
	
	Если ПустаяСтрока(Четность) Тогда
		НачалоНедели = НачалоНедели(НачалоПериода);
	Иначе
		НачалоНедели = НачалоНедели(НачалоНедели(НачалоПериода)-1);
	КонецЕсли;
	
	Для н=0 По 13 Цикл
		ДеньЦикла = НачалоНедели + 60*60*24*н;
		ДеньСтрока = Формат(ДеньЦикла,"ДФ=дддд");
		ДеньСтрокаКратко = Формат(ДеньЦикла,"ДФ=ддд");
		Если н>6 Тогда
			ДеньСтрока = ДеньСтрока+"Четный";
		КонецЕсли;
		
		ДеньДДММ = Формат(ДеньЦикла,"ДФ=dd.MM");
		
		ЭлементыФормы.График.Колонки[ДеньСтрока].ТекстШапки = ДеньСтрокаКратко+" " + ДеньДДММ; 
		
	КонецЦикла;
	
	
	ПосчитатьИтоги();
	//Для каждого Колонка из ЭлементыФормы.График.Колонки Цикл
	//	ГрафикПриИзмененииФлажка("", Колонка);	
	//КонецЦикла;
	
	
КонецПроцедуры

Процедура КоманднаяПанель1ЗаблокироватьАптеку(Кнопка)
	
	ТекСтрока = ЭлементыФормы.График.ТекущаяСтрока;
	Если НЕ ТекСтрока = Неопределено Тогда
		
		Текст = "";
		Подсказка = "Укажите причину блокировки";
		Если ВвестиСтроку(Текст,Подсказка,0,Ложь) Тогда
			ТекСтрока.ПричинаБлокировки = Текст;
		КонецЕсли;
		ТекСтрока.Блокировка = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ГрафикПередУдалением(Элемент, Отказ)
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Текст = "Вы действительно хотите удалить текущую строку?";
	Ответ = Вопрос(Текст, Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУстановитьПримечание(Кнопка)
	
	
	ТекСтрока = ЭлементыФормы.График.ТекущаяСтрока;
	ТекКолонка = ЭлементыФормы.График.ТекущаяКолонка;
	Примечание = "";
	Если ВвестиСтроку(Примечание,"Введите примечание",0,Ложь) Тогда
		
		
		НаборЗаписей = РегистрыСведений.ПримечанияКГрафикамАвтозаказа.СоздатьНаборЗаписей(); 
		
		НаборЗаписей.Отбор.График.Установить(Ссылка); 
		НаборЗаписей.Отбор.КолонкаГрафика.Установить( ТекКолонка.Имя); 
		НаборЗаписей.Отбор.Аптека.Установить( ТекСтрока.Аптека); 
		
		НоваяЗапись = НаборЗаписей.Добавить(); 
		НоваяЗапись.График = Ссылка; 
		НоваяЗапись.КолонкаГрафика = ТекКолонка.Имя; 
		НоваяЗапись.Аптека=ТекСтрока.Аптека; 
		НоваяЗапись.Примечание = Примечание; 
		
		НаборЗаписей.Записать();
		
		НоваяСтрока = ТаблицаПримечаний.Добавить();
		НоваяСтрока.КолонкаГрафика = ТекКолонка.Имя;
		НоваяСтрока.Аптека=ТекСтрока.Аптека; 
		НоваяСтрока.Примечание = Примечание; 

		
		
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУдалитьПримечание(Кнопка)
	
	
	
	ТекСтрока = ЭлементыФормы.График.ТекущаяСтрока;
	ТекКолонка = ЭлементыФормы.График.ТекущаяКолонка;
	
	
	НаборЗаписей = РегистрыСведений.ПримечанияКГрафикамАвтозаказа.СоздатьНаборЗаписей(); 
	
	НаборЗаписей.Отбор.График.Установить(Ссылка); 
	НаборЗаписей.Отбор.КолонкаГрафика.Установить( ТекКолонка.Имя); 
	НаборЗаписей.Отбор.Аптека.Установить( ТекСтрока.Аптека);
	НаборЗаписей.Записать();
	
	
	Отбор = Новый Структура();
	Отбор.Вставить("КолонкаГрафика",ТекКолонка.Имя);		
	Отбор.Вставить("Аптека",ТекСтрока.Аптека);		
	Строки =  ТаблицаПримечаний.НайтиСтроки(Отбор);
	Если Строки.Количество() > 0 Тогда
		ТаблицаПримечаний.Удалить(Строки[0]);
	КонецЕсли;
	
	
	
	
	
	
КонецПроцедуры

Процедура КоманднаяПанель1кнПросмотрПримечания(Кнопка)
	
	текСтрока = ЭлементыФормы.График.ТекущаяСтрока;
	Отбор = Новый Структура();
	Отбор.Вставить("КолонкаГрафика",ЭлементыФормы.График.ТекущаяКолонка.Имя);		
	Отбор.Вставить("Аптека",ТекСтрока.Аптека);		
	Строки =  ТаблицаПримечаний.НайтиСтроки(Отбор);
	Если Строки.Количество()> 0 Тогда
		Предупреждение(""+ Строки[0].Примечание);
	КонецЕсли;
	
	
КонецПроцедуры


Процедура КоманднаяПанель1кнОбновитьИтоги(Кнопка)
	ПосчитатьИтоги();
КонецПроцедуры


Процедура КоманднаяПанель1кнУстановитьФлажки(Кнопка)
	
	  ИмяКолонки = ЭлементыФормы.График.ТекущаяКолонка.Имя;
	  Для каждого стр из График Цикл
			стр[ИмяКолонки]	   = Истина;
	  КонецЦикла;
	  
	
КонецПроцедуры


Процедура КоманднаяПанель1кнСнятьФлажки(Кнопка)
	
	  ИмяКолонки = ЭлементыФормы.График.ТекущаяКолонка.Имя;
	  Для каждого стр из График Цикл
			стр[ИмяКолонки]	   = Ложь;
	  КонецЦикла;
	
	
КонецПроцедуры

