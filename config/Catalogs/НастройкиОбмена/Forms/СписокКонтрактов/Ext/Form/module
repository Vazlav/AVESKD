
Процедура ПриОткрытии()
	
	
	ТХТ = "ВЫБРАТЬ
	      |	Контракты.Ссылка КАК Контракт,
	      |	Контракты.СубъектРФ.Наименование КАК СубъектРФ,
	      |	ВЫБОР
	      |		КОГДА КонтрактыИНастройки.НастройкаОбмена = &НастройкаОбмена
	      |			ТОГДА ИСТИНА
	      |		ИНАЧЕ ЛОЖЬ
	      |	КОНЕЦ КАК Вкл,
	      |	ВЫБОР
	      |		КОГДА КонтрактыИНастройки.НастройкаОбмена <> &НастройкаОбмена
	      |				И НЕ КонтрактыИНастройки.НастройкаОбмена ЕСТЬ NULL 
	      |			ТОГДА КонтрактыИНастройки.НастройкаОбмена
	      |	КОНЕЦ КАК ИмеетПривязку
	      |ИЗ
	      |	Справочник.Контракты КАК Контракты
	      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КонтрактыИНастройки КАК КонтрактыИНастройки
	      |		ПО Контракты.Ссылка = КонтрактыИНастройки.Контракт
	      |ГДЕ
	      |	Контракты.Владелец = &Владелец";
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Владелец",ВладелецФормы.Владелец);
	Запрос.УстановитьПараметр("НастройкаОбмена",ВладелецФормы.Ссылка);
	ТаблицаКонтрактов = Запрос.Выполнить().Выгрузить();
	
	
КонецПроцедуры

Процедура ИзменитьПривязкуПоКонтракту(ЗначениеФлажка,ТекущаяСтрока)
	

	Если ЗначениеФлажка = Истина Тогда
		МЗ = РегистрыСведений.КонтрактыИНастройки.СоздатьМенеджерЗаписи();
		МЗ.Контракт = ТекущаяСтрока.Контракт;
		МЗ.Прочитать();
		Если МЗ.Выбран() Тогда
			Если МЗ.НастройкаОбмена <>  ВладелецФормы.Ссылка Тогда
				Режим = РежимДиалогаВопрос.ДаНет;
				Текст = "Контракт " + ТекущаяСтрока.Контракт + " уже имеет привязку к другой настройке. Заменить на новое значение?";
				Ответ = Вопрос(Текст, Режим, 0);
				Если Ответ = КодВозвратаДиалога.Нет Тогда
					ТекущаяСтрока.Вкл = НЕ ЗначениеФлажка;
					Возврат;
				КонецЕсли; 
				
				МЗ.НастройкаОбмена = ВладелецФормы.Ссылка;
				МЗ.Записать();
			КонецЕсли;
		Иначе
			МЗ.Контракт = ТекущаяСтрока.Контракт;
			МЗ.НастройкаОбмена = ВладелецФормы.Ссылка;
			МЗ.Записать();
		КонецЕсли;
	Иначе //Снимаем привязку с контракта
		МЗ = РегистрыСведений.КонтрактыИНастройки.СоздатьМенеджерЗаписи();
		МЗ.Контракт = ТекущаяСтрока.Контракт;
		МЗ.Прочитать();
		Если МЗ.Выбран() Тогда
			МЗ.Удалить();
		КонецЕсли;
	КонецЕсли;

	
КонецПроцедуры

Процедура ТаблицаКонтрактовПриИзмененииФлажка(Элемент, Колонка)
	

	Если Колонка.Имя = "Пометка" Тогда
		ЗначениеФлажка = Элемент.ТекущаяСтрока.Вкл;
		ИзменитьПривязкуПоКонтракту(ЗначениеФлажка,Элемент.ТекущаяСтрока);
	КонецЕсли;
	
КонецПроцедуры

Процедура ТаблицаКонтрактовПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Вкл = Ложь Тогда
		ОформлениеСтроки.ЦветТекста=Новый Цвет(160,160,160);	
	КонецЕсли;		
	
КонецПроцедуры

Процедура КоманднаяПанель2Действие(Кнопка)
	
	Для каждого стр из ТаблицаКонтрактов Цикл
		Если стр.Вкл = Истина Тогда
			Продолжить;
		КонецЕсли;		
		стр.Вкл = Истина;
		ИзменитьПривязкуПоКонтракту(Истина,стр);	
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанель2Действие1(Кнопка)
	
	Для каждого стр из ТаблицаКонтрактов Цикл
		Если стр.Вкл = Ложь Тогда
			Продолжить;
		КонецЕсли;
		стр.Вкл = Ложь;
		ИзменитьПривязкуПоКонтракту(Ложь,стр);	
	КонецЦикла;	
	
КонецПроцедуры
