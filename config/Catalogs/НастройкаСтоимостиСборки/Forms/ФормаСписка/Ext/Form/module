
Процедура ДействияФормыкнОбновитьДанныеВПредтаблице(Кнопка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	НастройкаСтоимостиСборки.Ссылка,
	               |	НастройкаСтоимостиСборки.НастройкиПостроителя,
	               |	НастройкаСтоимостиСборки.Код  как КодНастройки 
	               |ИЗ
	               |	Справочник.НастройкаСтоимостиСборки КАК НастройкаСтоимостиСборки
	               |ГДЕ
	               |	НастройкаСтоимостиСборки.НеПрошелДопОбработку = ИСТИНА";

	Рез = Запрос.Выполнить();
	Если Рез.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = Рез.Выбрать();
	
	Построитель = Новый ПостроительОтчета;
	Построитель.Текст = "ВЫБРАТЬ
	                    |	МестаХранения.Код КАК Код
	                    |ПОМЕСТИТЬ КодыАптек
	                    |ИЗ
	                    |	Справочник.МестаХранения КАК МестаХранения
	                    |{ГДЕ
	                    |	МестаХранения.Ссылка.* КАК Аптека}
	                    |;
	                    |
	                    |////////////////////////////////////////////////////////////////////////////////
	                    |ВЫБРАТЬ
	                    |	Состав.КатегорияТовара КАК КатегорияТовара,
	                    |	Состав.Холод КАК Холод,
	                    |	Состав.Цена1 КАК Цена1,
	                    |	Состав.Цена2 КАК Цена2,
	                    |	Состав.КатегорияABC КАК КатегорияABC,
	                    |	Состав.Стоимость КАК Стоимость,
	                    |	КодыАптек.Код КАК КодАптеки,
	                    |	Состав.НомерСтроки КАК КодСтроки,
	                    |	Состав.Ссылка.Код КАК КодНастройки
	                    |ИЗ
	                    |	Справочник.НастройкаСтоимостиСборки.Состав КАК Состав,
	                    |	КодыАптек КАК КодыАптек
	                    |ГДЕ
	                    |	Состав.Ссылка = &Ссылка";
	
	
	Пока Выборка.Следующий() Цикл
		НастрПостроителя = ЗначениеИзСтрокиВнутр(Выборка.НастройкиПостроителя);
		Построитель.УстановитьНастройки(НастрПостроителя);
		Построитель.Параметры.Вставить("Ссылка",Выборка.Ссылка);
		Построитель.Выполнить();
		ТЗ = Построитель.Результат.Выгрузить();
		
		НЗ = РегистрыСведений.ПредрасчетСтоимостиСборки.СоздатьНаборЗаписей();
		НЗ.Отбор.КодНастройки.Установить(Выборка.КодНастройки);
		НЗ.Загрузить(ТЗ);
		Попытка
			НЗ.Записать();
			Об = Выборка.Ссылка.ПолучитьОбъект();
			Об.НеПрошелДопОбработку = Ложь;
			Об.Записать();
		Исключение
			Сообщить(ОписаниеОшибки());
		КонецПопытки;

	КонецЦикла;
	
	
КонецПроцедуры
