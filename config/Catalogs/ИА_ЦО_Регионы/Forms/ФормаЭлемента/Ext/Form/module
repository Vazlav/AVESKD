
 

Процедура КоманднаяПанель2Проверка(Кнопка)
	
	Состояние("Запрос на api.metacommerce.ru ...");
	ПолныйАдресРесурса = "https://api.metacommerce.ru/products?apiKey=5e28a741-6732-41ed-becb-4effddd40f90&format=json";
	ХТТПСоединение =  Новый HTTPСоединение("api.metacommerce.ru");
	
	// Добавление к строке пути на сервере отборов по региону 
	ПутьНаСервере  = "/products?apiKey=5e28a741-6732-41ed-becb-4effddd40f90&format=json";
	Если Наименование = "Москва" Тогда
		ПутьНаСервере = ПутьНаСервере + "&onlyMatchedSkus=true&regionIds=moscow"
	ИначеЕсли Наименование = "Санкт-Петербург" Тогда
		ПутьНаСервере = ПутьНаСервере + "&onlyMatchedSkus=true&regionIds=sankt_peterburg"
	КонецЕсли;
	// Получать только нужные поля
	ПутьНаСервере = ПутьНаСервере + "&fields=marketId";
		
	ХТТПЗапрос = Новый HTTPЗапрос(ПутьНаСервере);
	ИФ = ""+КаталогВременныхФайлов()+"JSON_konkurent.json";
	
	Попытка
		ХТТПРезультат =  ХТТПСоединение.Получить(ХТТПЗапрос, ИФ);
	Исключение
		// исключение здесь говорит о том, что запрос не дошел до HTTP-Сервера
		Сообщить("Произошла ошибка при подключении к api.metacommerce.ru!");
		ВызватьИсключение;
	КонецПопытки;
	
	ЧтеДжейсона = Новый ЧтениеJSON ;
	ЧтеДжейсона.ОткрытьФайл(ИФ,"UTF-8");

	ТЗПолученныхКонкурентов = Новый ТаблицаЗначений;
	ТЗПолученныхКонкурентов.Колонки.Добавить("Конкурент", Новый ОписаниеТипов("Строка"));
	
	ТекЗначение = 0; // 1 - regionId,
	Сч = 1;
	
	Пока ЧтеДжейсона.Прочитать() Цикл
		
		Состояние("Чтение файла конкурентов: "+Сч);
		ОбработкаПрерыванияПользователя();
		Попытка
			
			ТипJson = ЧтеДжейсона.ТипТекущегоЗначения;
			Если ТипJson = ТипЗначенияJSON.ИмяСвойства Тогда
				
				Если ЧтеДжейсона.ТекущееЗначение = "marketId" Тогда
					
					ТекЗначение = 1;
					Продолжить
					
				КонецЕсли; 
				
			КонецЕсли;	

			Если ТипJson = ТипЗначенияJSON.Число ИЛИ ТипJson = ТипЗначенияJSON.Строка
				ИЛИ ТипJson = ТипЗначенияJSON.Булево ИЛИ ТипJson = ТипЗначенияJSON.Null Тогда
				
				Если ТекЗначение = 1 Тогда
					
					НоваяСтрокаТЧ = ТЗПолученныхКонкурентов.Добавить();
					НоваяСтрокаТЧ.Конкурент = ЧтеДжейсона.ТекущееЗначение
					
				КонецЕсли; 
				
				ТекЗначение = 0;
				
			КонецЕсли; 
			
		Исключение
			Сообщить("Ошибка при чтении файла JSON: "+ОписаниеОшибки());
			ТекЗначение = 0;
		КонецПопытки;
		
		Сч = Сч +1;
		
	КонецЦикла;
	Состояние("");
	ЧтеДжейсона.Закрыть();
	
	Запрос = Новый Запрос;
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ТЗ.Конкурент
	|ПОМЕСТИТЬ ВТ_Конкурент
	|ИЗ
	|	&ТЗ КАК ТЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Выразить(ВТ_Конкурент.Конкурент КАК строка(100)) КАК Конкурент
	|ИЗ
	|	ВТ_Конкурент КАК ВТ_Конкурент";
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ТЗ",ТЗПолученныхКонкурентов);
	Выборка = Запрос.Выполнить().Выбрать();
	
    Пока Выборка.Следующий() Цикл
	
		НайденнаяСтрока = Конкуренты.Найти(Выборка.Конкурент,"Конкурент");	
		Если НайденнаяСтрока = Неопределено Тогда
		
			Если СокрЛП(Выборка.Конкурент) = "366.ru" Тогда
				продолжить
			КонецЕсли; 
			НоваяСтрокаТЧ = Конкуренты.Добавить();
			НоваяСтрокаТЧ.Конкурент = Выборка.Конкурент;
			Сообщить("Получен конкурент: "+ Выборка.Конкурент + ". В справочнике его нет. Добавлена новая строка с конкурентом.")
			
		Иначе
		
			Сообщить("Получен конкурент: "+ Выборка.Конкурент + ". В справочнике конкурент уже есть.")
		
		КонецЕсли; 
		
	КонецЦикла; 
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	
КонецПроцедуры

Процедура КоманднаяПанель5ДействиеЗагрузитьИзФайла(Кнопка)
	ПолучитьФорму("ФормаЗагрузкиИзФайла").Открыть();
КонецПроцедуры
