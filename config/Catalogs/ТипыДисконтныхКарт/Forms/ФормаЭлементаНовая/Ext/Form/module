
Процедура ПередЗаписью(Отказ)
	
	Если ПрограммаЛояльности и Контрагент.Пустая() Тогда
		Предупреждение("Не выбран контрагент лояльности. Сохранение не может быть продолжено.");	
		Отказ = Истина;
	КонецЕсли;
	
	
КонецПроцедуры

Процедура КоманднаяПанель1ЗаполнитьПоОтбору(Кнопка)
	
	ФормаОтбора = ЭтотОбъект.ПолучитьФорму("ФормаОтбораАптек");
	ПостроительСпискаАптек = ФормаОтбора.ОткрытьМодально();
	
	Если ПостроительСпискаАптек = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Очистить текущий список аптек?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Да Тогда
		СписокАптек.Очистить();
	КонецЕсли;
	
	ПостроительСпискаАптек.Выполнить();
	
	Выборка = ПостроительСпискаАптек.Результат.Выбрать();
	КолВо = Выборка.Количество();
	
	Пока Выборка.Следующий() Цикл 		
		НовСтр = СписокАптек.Добавить();
		НовСтр.Аптека = Выборка.Ссылка; 		
	КонецЦикла;
	
	Сообщить("Записи успешно загружены (" + КолВо + ")");
	
	
КонецПроцедуры

Процедура КоманднаяПанель1УдалитьПоОтбору(Кнопка)
	
	ФормаОтбора = ЭтотОбъект.ПолучитьФорму("ФормаОтбораАптек");
	ПостроительСпискаАптек = ФормаОтбора.ОткрытьМодально();
	
	Если ПостроительСпискаАптек = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПостроительСпискаАптек.Выполнить();
	
	Выборка = ПостроительСпискаАптек.Результат.Выбрать();
	КолВо = 0;
	
	Пока Выборка.Следующий() Цикл 
		
		НайденнаяСтрока = СписокАптек.Найти(Выборка.Ссылка, "Аптека");
		
		Если НайденнаяСтрока <> Неопределено Тогда
			СписокАптек.Удалить(НайденнаяСтрока);
			КолВо = КолВо + 1;
		КонецЕсли;
		
	КонецЦикла;
	
	Сообщить("Записи успешно удалены (" + КолВо + ")");
	
	
КонецПроцедуры

Процедура КоманднаяПанель1УдалитьВсе(Кнопка)
	
	СписокАптек.Очистить();	
	
КонецПроцедуры



//============================================================================================================
//============================================================================================================
//==============   ПРОЦЕДУРЫ РАБОТЫ С УСЛОВИЯМИ ИСКЛЮЧЕНИЙ ===================================================

Процедура УсловияПримененияПострочноПриАктивизацииЯчейки(Элемент)
	
	Если Элемент.ТекущаяКолонка.Имя="ПраваяЧасть" Тогда
		
		ПЧХЗ=Элемент.ТекущаяСтрока.ПраваяЧастьХЗ.Получить();
		ТХТ="";
		Если ТипЗнч(ПЧХЗ)=Тип("Массив") Тогда
			Для Каждого Элем Из ПЧХЗ Цикл
				ТХТ=ТХТ+Элем+Символы.ПС;
			КонецЦикла;
		КонецЕСли;	
		
		
		Элемент.Подсказка=ТХТ;
	КонецЕСли;
	
	
КонецПроцедуры

Процедура ПриИзмененииОператора(Элемент,ТекСтрока)
	
	 Если не (Элемент.Значение=Перечисления.ОператорыУсловийПримененияРА.В или Элемент.Значение=Перечисления.ОператорыУсловийПримененияРА.НеВ) Тогда
		// этот оператор подразумевает сравнение с единственным значением
		Если  ТипЗнч(ТекСтрока.ПраваяЧастьХЗ.Получить())=Тип("Массив") Тогда
			Предупреждение("Оператор сравнения подразумевает 
			                |сравнение с одним единственным значением!
							|В правой части указан список значений!");
			ТекСтрока.ПраваяЧасть="";
			ТекСтрока.ПраваяЧастьХз="";
		КонецЕсли;
	Иначе
		//этот оператор подразумевает сравнение с массивом значений
		// если было единственное создадим из него массив
		Массив=Новый Массив;
		Массив.Добавить(ТекСтрока.ПраваяЧасть);
		ТекСтрока.ПраваяЧастьХЗ=Новый ХранилищеЗначения(Массив);

	КонецЕСли;	

	
КонецПроцедуры	

Процедура УсловияПримененияПострочноОператорПриИзменении(Элемент)
	
	ТекСтрока=Элементыформы.УсловияПримененияПострочно.ТекущаяСтрока;
	ПриИзмененииОператора(Элемент,ТекСтрока);
	
	
КонецПроцедуры

Процедура НачалоВыбораПравойЧасти(ТС,ИмяТаблицыДокумента)
	 ЛеваяЧасть=ТС.ЛеваяЧасть;
	 
	 Если ПустаяСтрока(ТС.Оператор)=Истина Тогда 
		 Предупреждение("Не выбран оператор!");
		 Возврат;
	 КонецЕсли;
	 
	 
	Оператор=ТС.Оператор;
	
	
	Если Оператор=Перечисления.ОператорыУсловийПримененияРА.В или Оператор=Перечисления.ОператорыУсловийПримененияРА.НеВ ТОгда
		ЭтоСписокЗначений=Истина;
	Иначе	
		ЭтоСписокЗначений=ЛОжь;
		
				
	КонецЕсли;	
		
	//---------------<Открываем форму выбора значения>---------------------------// GtG // 17.04.2013 10:45:58
	
	ФормаВЗ=ЭтотОбъект.ПолучитьФорму("ФормаВыбораЗначения",ЭтаФорма,1);
	
	ФормаВЗ.ЭтоСписокЗначений=ЭтоСписокЗначений;
	
	//---------------<В таблице построчно - разные типы, в итоговой - только числа>---------------------------// GtG // 19.04.2013 10:02:02
	Если ИмяТаблицыДокумента="УсловияПримененияИтоги" Тогда
		ЛеваяЧастьТип="Число";
	Иначе
		ЛеваяЧастьТип=ЛеваяЧасть.Тип;
	КонецЕсли;	
	//---------------<>---------------------------// GtG // 19.04.2013 10:03:18
	
	ФормаВЗ.СтрокаТипЗначения=ЛеваяЧастьТип;
	ФормаВЗ.ЗначениеХЗ=ТС.ПраваяЧастьХЗ;
	ФормаВЗ.ИмяТаблицыДокумента=ИмяТаблицыДокумента;
	
	
	ФормаВЗ.ОткрытьМодально();

	
КонецПроцедуры	

Процедура УсловияПримененияПострочноПраваяЧастьНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка=ЛОжь;
	
	ТС=ЭлементыФормы.УсловияПримененияПострочно.ТекущаяСтрока;
	ИмяТаблицыДокумента="УсловияПримененияПострочно";
	НачалоВыбораПравойЧасти(ТС,ИмяТаблицыДокумента);	
	
КонецПроцедуры


Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("Структура") Тогда
		ТекСтрока = ЭлементыФормы[ЗначениеВыбора.ИмяТаблицыДокумента].ТекущаяСтрока; 
		
		Если  ТипЗнч(ЗначениеВыбора.Значение)=Тип("Массив") Тогда // представим это как "Список из хх 
			ТекСтрока.ПраваяЧасть="Список из "+ЗначениеВыбора.Значение.Количество()+" значений";
			ЭтоМассив = Истина;
		Иначе	
			ЭтоМассив = Ложь;
		    ТекСтрока.ПраваяЧасть=ЗначениеВыбора.Значение;
		КонецЕсли;
		
		ТекСтрока.ПраваяЧастьХЗ=Новый ХранилищеЗначения(ЗначениеВыбора.Значение); // универсально, для любого типа. Здесь храним сами значения.
		
		УсловияПримененияПострочноПриАктивизацииЯчейки(ЭлементыФормы[ЗначениеВыбора.ИмяТаблицыДокумента]);
		
		
		
	КонецЕсли;
	
	Если ЗначениеВыбора=Неопределено ТОгда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("СписокЗначений") Тогда
		Если ЗначениеВыбора.Количество()=0 Тогда
			Возврат;
		КонецЕсли;
		
		Если ТипЗнч(ЗначениеВыбора.Получить(0).Значение)=Тип("СправочникСсылка.МестаХранения") Тогда
			Для Каждого Стр Из ЗначениеВыбора Цикл
				СписокАптек.Добавить().Склад=Стр.Значение;
			КонецЦикла;	
			
			СписокАптек.Свернуть("Склад","");
			
		КонецЕсли;
	КонецЕсли;
		
		
	
	
КонецПроцедуры
