Функция УбратьЛишниеСимволы(ИсходнаяСтрока) Экспорт
	
	НовСтрока = "";
	ПравильныеСимволы = "0123456789";
	
	Для Сч = 1 по СтрДлина(ИсходнаяСтрока) Цикл
		ТекСимв = Сред(ИсходнаяСтрока, Сч, 1);
		Если Найти(ПравильныеСимволы, ТекСимв) > 0 Тогда
			НовСтрока = НовСтрока + ТекСимв;
		КонецЕсли;
	КонецЦикла;
	
	Возврат НовСтрока;
	
КонецФункции

Процедура КнопкаВыборФайлаНажатие(Элемент)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	Если Диалог.Выбрать() Тогда
    	ПутьКФайлу = Диалог.ПолноеИмяФайла;
	КонецЕсли;

КонецПроцедуры

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если ПустаяСтрока(ПутьКФайлу) Тогда
    
    	Сообщить("Не указан путь к файлу!");
        Возврат
    
    КонецЕсли; 
    
	Попытка
		
		Excel = Новый COMОбъект("Excel.Application");
		Excel.WorkBooks.Open(ПутьКФайлу);
		Состояние("Обработка файла Microsoft Excel...");
		
	Исключение
		Сообщить("Ошибка при открытии файла с помощью Excel! Загрузка не будет произведена!");
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Попытка
		//Открываем необходимый лист
		Excel.Sheets(1).Select(); // лист 1, по умолчанию
	Исключение
		//Закрываем Excel
		Excel.ActiveWorkbook.Close();
		Excel = 0;
		Сообщить("Файл "+Строка(ПутьКФайлу)+" не соответствует необходимому формату! Первый лист не найден!");
		ОтменитьТранзакцию();
		Возврат;
	КонецПопытки;
	
	//Получим количество строк и колонок.
	//В разных версиях Excel получаются по-разному, поэтому сначала определим версию Excel
	Версия = Лев(Excel.Version,Найти(Excel.Version,".")-1);
	Если Версия = "8" тогда
		ФайлСтрок = Excel.Cells.CurrentRegion.Rows.Count;
		ФайлКолонок = Макс(Excel.Cells.CurrentRegion.Columns.Count, 13);
	Иначе
		ФайлСтрок = Excel.Cells(1,1).SpecialCells(11).Row;
		ФайлКолонок = Excel.Cells(1,1).SpecialCells(11).Column;
    Конецесли;
	
	СпрАпт	= Справочники.МестаХранения;
	СпрАП	= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН;
	
	Для Сч = НачальнаяСтрока  По ФайлСтрок Цикл
    
		Состояние("Обработка: "+ Сч + " строк из " + ФайлСтрок);
		ОбработкаПрерыванияПользователя(); 
		
		КодФайла			= Число(УбратьЛишниеСимволы(Excel.Cells(Сч, НомерСтолбца).Text));
		
		Если ТЧВызова = "Склад" Тогда
		
			СтрокаДляЗаписи = СпрАпт.НайтиПоКоду(КодФайла);
			НовСтрокаАптека = Склад.Добавить();
			НовСтрокаАптека.Код1С = КодФайла;
			НовСтрокаАптека.Аптека = СтрокаДляЗаписи;
		
		Иначе
		
			СтрокаДляЗаписи = СпрАП.НайтиПоКоду(КодФайла);
			НовСтрокаАптека = ТоварныеПозиции.Добавить();
			НовСтрокаАптека.Код1С = КодФайла;
			НовСтрокаАптека.Товар = СтрокаДляЗаписи;
		
		КонецЕсли; 
   
    КонецЦикла; 
	
	//Уберем дубли после загрузки	
	Если ТЧВызова = "Склад" Тогда
		ТЗСв = Склад.Выгрузить();
		ТЗСв.Свернуть("Код1С,Аптека","");
		Склад.Загрузить(ТЗСв);
	Иначе
		ТЗСв = ТоварныеПозиции.Выгрузить();
		ТЗСв.Свернуть("Код1С,Товар","");
		ТоварныеПозиции.Загрузить(ТЗСв);
	КонецЕсли;
		
		
	Excel.DisplayAlerts = 0; 
	Excel.Quit();
	Excel.DisplayAlerts = 1;
	
	Закрыть();
    
КонецПроцедуры

Процедура ПриОткрытии()
	НачальнаяСтрока = 2;
	НомерСтолбца	= 3;
КонецПроцедуры

Процедура ЗакрытьНажатие(Элемент)
	Закрыть()
КонецПроцедуры
