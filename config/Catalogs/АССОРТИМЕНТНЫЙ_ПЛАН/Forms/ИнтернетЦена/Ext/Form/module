
Процедура ФорматированиеКолонкиТЗ (Колонка,Заголовок,Ширина,Подвал,Формат)  
	//----------------------------------
	//Назначение:
	//  Приводт ив божеский вид колонку ТЗ
	//----------------------------------
	
	Колонка.ТекстШапки=Заголовок;
	Колонка.Ширина=Ширина;// (в пикаселях)
	Колонка.ОтображатьВПодвале 	= подвал;
	Колонка.ВыделятьОтрицательные = истина;
	Колонка.Формат=Формат;
	
КонецПроцедуры	//ФорматированиеКолонкиТЗ


Процедура ДействияФормыВесь_АП(Кнопка)
	
	УчВАП=СправочникСписок.Отбор.Найти("УчаствуетВАП");	
	Если УчВАП<>Неопределено ТОгда
		УчВап.Использование=Ложь;
	КонецЕсли;
	
КонецПроцедуры


Процедура ДействияФормырабочийАП(Кнопка)
	
	УчВАП=СправочникСписок.Отбор.Найти("УчаствуетВАП");	
	Если УчВАП<>Неопределено ТОгда
		УчВАП.ВидСравнения=ВидСравнения.Равно;
		УчВАП.Значение=ИСтина;
		УчВап.Использование=Истина;
	КонецЕсли;		
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	Цена=СправочникСписок.Отбор.Найти("МинЦенаMedlux");	
	Если Цена<>Неопределено ТОгда
		Цена.ВидСравнения=ВидСравнения.Больше;
		Цена.Значение=0;
		Цена.Использование=Истина;
	КонецЕсли;
	ДействияФормырабочийАП("");
	
КонецПроцедуры


Процедура КоманднаяПанель1Остатки_по_партиям(Кнопка)
	
	Товар=ЭлементыФормы.СправочникСписок.ТекущаяСтрока;
	ЭлементыФормы.ЧейОстатокВиден.Заголовок=""+Товар.код+ " : "+Товар.Наименование;
	
	Если Склад.Пустая()=Истина Тогда
		ПроСклад="";
	Иначе
		Если Склад.ЭтоГруппа Тогда
			ПроСклад=" И Склад.Родитель=&Склад ";
		Иначе
			ПроСклад=" И Склад=&Склад ";
		КонецЕсли;
	КонецЕсли; 	
	
	
	
	ТХТ="ВЫБРАТЬ РАЗРЕШЕННЫЕ
	    |	ПартииЖНВЛСОстатки.Партия.ДокументПоступления.Дата КАК ДатаПоступления,
	    |	ПартииЖНВЛСОстатки.Партия,
	    |	ПартииЖНВЛСОстатки.Склад,
	    |	ПартииЖНВЛСОстатки.СтавкаНДС,
	    |	ПартииЖНВЛСОстатки.Партия.Серия,
	    |	ПартииЖНВЛСОстатки.Партия.Серия.СрокГодности,
	    |	ПартииЖНВЛСОстатки.КолвоОстаток / ПартииЖНВЛСОстатки.Партия.ЕИТЗакупки.К КАК Остаток,
	    |	ПартииЖНВЛСОстатки.СуммаЗакупСНДСОстаток / ПартииЖНВЛСОстатки.КолвоОстаток * ПартииЖНВЛСОстатки.Партия.ЕИТЗакупки.К КАК ЦенаЗакуп,
	    |	ПартииЖНВЛСОстатки.СуммаЗакупСНДСОстаток,
	    |	ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток / ПартииЖНВЛСОстатки.КолвоОстаток * ПартииЖНВЛСОстатки.Партия.ЕИТЗакупки.К КАК ЦенаРозн,
	    |	ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток,
	    |	ПартииЖНВЛСОстатки.Партия.Поставщик,
	    |	ПартииЖНВЛСОстатки.Партия.ДокументПоступления
	    |ПОМЕСТИТЬ ТЗ
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата, Товар = &товар "+ ПроСклад + ") КАК ПартииЖНВЛСОстатки
	    |ГДЕ
	    |	ПартииЖНВЛСОстатки.КолвоОстаток <> 0
	    |;
	    |
	    |////////////////////////////////////////////////////////////////////////////////
	    |ВЫБРАТЬ РАЗРЕШЕННЫЕ
	    |	ПартииЖНВЛСОбороты.КолвоПриход,
	    |	ПартииЖНВЛСОбороты.Партия,
	    |	ПартииЖНВЛСОбороты.Склад
	    |ПОМЕСТИТЬ ТЗПАРТИЙ
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Обороты(
	    |			,
	    |			,
	    |			, Товар = &товар "+ ПроСклад + "  
	    //|			партия В
	    //|				(ВЫБРАТЬ
	    //|					ТЗ.Партия
	    //|				ИЗ
	    //|					ТЗ)
		|) КАК ПартииЖНВЛСОбороты   
		|inner join ТЗ ПО  ТЗ.Склад = ПартииЖНВЛСОбороты.Склад и ТЗ.Партия =  ПартииЖНВЛСОбороты.Партия
	    |;
	    |
	    |////////////////////////////////////////////////////////////////////////////////
	    |ВЫБРАТЬ РАЗРЕШЕННЫЕ
	    |	ТЗ.ДатаПоступления,
	    |	ТЗ.Партия,
	    |	ТЗ.Склад как Склад,
	    |	ТЗ.СтавкаНДС,
	    |	ТЗ.ПартияСерия.Наименование как Серия,
	    |	ТЗ.ПартияСерияСрокГодности,
		|	ТЗПАРТИЙ.КолвоПриход,
	    |	ТЗ.Остаток,
	    |	ТЗ.ЦенаЗакуп,
	    |	ТЗ.СуммаЗакупСНДСОстаток,
	    |	ТЗ.ЦенаРозн,
	    |	ТЗ.СуммаРознСНДСОстаток,
	    |	ТЗ.ПартияПоставщик.Наименование как Поставщик ,
	    |	ТЗ.ПартияДокументПоступления как Документ
	    |	
	    |ИЗ
	    |	ТЗ КАК ТЗ
	    |		ЛЕВОЕ СОЕДИНЕНИЕ ТЗПАРТИЙ КАК ТЗПАРТИЙ
	    |		ПО (ТЗПАРТИЙ.Партия = ТЗ.Партия)
	    |			И (ТЗПАРТИЙ.Склад = ТЗ.Склад)
		| УПОРЯДОЧИТЬ ПО ТЗ.ДатаПоступления   
	    |;
	    |
	    |////////////////////////////////////////////////////////////////////////////////
	    |УНИЧТОЖИТЬ ТЗ
	    |;
	    |
	    |////////////////////////////////////////////////////////////////////////////////
	    |УНИЧТОЖИТЬ ТЗПАРТИЙ";
		
	Запрос=Новый Запрос;
	Запрос.Текст=ТХТ;
	Запрос.УстановитьПараметр("Дата",КОНЕцдня(ТекущаядатА()));
	Запрос.УстановитьПараметр("Товар",Товар);
	Запрос.УстановитьПараметр("Склад",Склад);
	
	
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	
	ОстаткиПоПартияМ_Тз.Очистить();
	ЭлементыФормы.ОстаткиПоПартияМ_ТЗ.Значение=ТЗ;
	ЭлементыФормы.ОстаткиПоПартияМ_ТЗ.СоздатьКолонки();
	ЭлементыФормы.ОстаткиПоПартияМ_ТЗ.ТолькоПросмотр=Истина;
	
	////------------------<Форматируем колонки>-------------------GtG----07.01.2008
	К=ЭлементыФормы.ОстаткиПоПартияМ_ТЗ.Колонки;
	
	ФорматированиеКолонкиТЗ (К.Получить(0) ,"Дата",10,ложь,"ДФ=dd.MM.yy"); 
	ФорматированиеКолонкиТЗ (К.Получить(1) ,"Партия",17,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(2) ,"Склад",30,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(3) ,"НДС%",7,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(4) ,"Серия",15,ложь,"");	
	ФорматированиеКолонкиТЗ (К.Получить(5) ,"Срок",10,ложь,"");	
	ФорматированиеКолонкиТЗ (К.Получить(6) ,"Приход",10,истина,"ЧДЦ=2");
	ФорматированиеКолонкиТЗ (К.Получить(7) ,"Остаток",10,истина,"ЧДЦ=2");
	ФорматированиеКолонкиТЗ (К.Получить(8) ,"Закуп. цена",10,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(9) ,"Закуп. сумма",15,истина,"ЧДЦ=2");
	ФорматированиеКолонкиТЗ (К.Получить(10) ,"Розн. цена",10,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(11) ,"Розн. сумма",15,истина,"ЧДЦ=2");
	//ФорматированиеКолонкиТЗ (К.Получить(11) ,"Место",7,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(12) ,"Поставщик",15,ложь,"");
	ФорматированиеКолонкиТЗ (К.Получить(13) ,"Документ",30,ложь,"");

КонецПроцедуры


Процедура КоманднаяПанель2Движения_по_Товару(Кнопка)
	
	Товар=ЭлементыФормы.СправочникСписок.ТекущаяСтрока;
	ЭлементыФормы.ЧейОстатокВиден1.Заголовок=""+Товар.код+ " : "+Товар.Наименование;
	ЭлементыФормы.ДвиженияЗаПериод.Очистить();
	

	ТХТ = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	      |	ПартииЖНВЛСОстаткиИОбороты.Период КАК Период,
	      |	СУММА(ПартииЖНВЛСОстаткиИОбороты.КолвоНачальныйОстаток / ПартииЖНВЛСОстаткиИОбороты.Партия.ЕИТЗакупки.К) КАК КолвоНачальныйОстаток,
	      |	СУММА(ПартииЖНВЛСОстаткиИОбороты.КолвоПриход / ПартииЖНВЛСОстаткиИОбороты.Партия.ЕИТЗакупки.К) КАК КолвоПриход,
	      |	СУММА(ПартииЖНВЛСОстаткиИОбороты.КолвоРасход / ПартииЖНВЛСОстаткиИОбороты.Партия.ЕИТЗакупки.К) КАК КолвоРасход,
	      |	СУММА(ПартииЖНВЛСОстаткиИОбороты.КолвоКонечныйОстаток / ПартииЖНВЛСОстаткиИОбороты.Партия.ЕИТЗакупки.К) КАК КолвоКонечныйОстаток
	      |ИЗ
	      |	РегистрНакопления.ПартииЖНВЛС.ОстаткиИОбороты(
	      |			&НачПериода,
	      |			&КонПериода,
	      |			Месяц,
	      |			ДвиженияИГраницыПериода,
	      |			Склад = &Склад
	      |				И Товар = &Товар) КАК ПартииЖНВЛСОстаткиИОбороты
	      |
	      |СГРУППИРОВАТЬ ПО
	      |	ПартииЖНВЛСОстаткиИОбороты.Период
	      |ИТОГИ
	      |	СУММА(КолвоНачальныйОстаток),
	      |	СУММА(КолвоПриход),
	      |	СУММА(КолвоРасход),
	      |	СУММА(КолвоКонечныйОстаток)
	      |ПО
	      |	Период ПЕРИОДАМИ(МЕСЯЦ, &НачПериода, &КонПериода)";
     Запрос = Новый ПостроительОтчета;
	 запрос.Текст = ТХТ;
	 Запрос.Параметры.Очистить();
	 Запрос.Параметры.Вставить("Склад",Склад1);
	 Запрос.Параметры.Вставить("Товар",Товар);
	 Запрос.Параметры.Вставить("НачПериода",НачалоМесяца(НачалоМесяца(ТекущаяДата()) - 60*60*24*50)); //получаем 3 месяца назад
	 Запрос.Параметры.Вставить("КонПериода",КонецДня(ТекущаяДата()));
	 Запрос.Выполнить();
	 
	 Макет = Запрос.Макет;
	 
	 Запрос.Макет = Неопределено;
	 ТекущаяОбласть = Неопределено;
	 Пока Истина Цикл 
		 // Осуществим поиск ячейки, в которой находится параметр - Количество 
		 ТекущаяОбласть = Макет.НайтиТекст("Период", ТекущаяОбласть, Макет.Область(), 
		 Истина, Истина, Истина, Ложь); 
		 Если ТекущаяОбласть <> Неопределено Тогда 
			 Если ТекущаяОбласть.Параметр = "Период" Тогда 
				 // Установим формат значения - два знака после запятой 
				 ТекущаяОбласть.Формат = "ДФ='MMMM yyyy'"; 
			 КонецЕсли; 
		 Иначе 
			 Прервать; 
		 КонецЕсли; 
	 КонецЦикла;	
	 Запрос.Макет = Макет;	
	 Запрос.МакетОформления = ПолучитьМакетОформления(СтандартноеОформление.Трава);
	 Запрос.ОформитьМакет();
	 Запрос.ВыводитьЗаголовокОтчета = Ложь;
	 
	 Запрос.Вывести(ЭлементыФормы.ДвиженияЗаПериод);

КонецПроцедуры
ЭлементыФормы.СправочникСписок.ИзменятьСпособРедактирования = ЛОЖЬ;
