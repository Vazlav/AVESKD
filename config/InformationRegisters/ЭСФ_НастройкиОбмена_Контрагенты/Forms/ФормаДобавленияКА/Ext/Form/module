



Процедура ПолучитьКонтрагентовНажатие(Элемент)
	
	ЗапросКАПоИД=Новый Запрос("ВЫБРАТЬ
	                          |	ЭСФ_НастройкиОбмена_Контрагенты.Контрагент
	                          |ИЗ
	                          |	РегистрСведений.ЭСФ_НастройкиОбмена_Контрагенты КАК ЭСФ_НастройкиОбмена_Контрагенты
	                          |ГДЕ
	                          |	ЭСФ_НастройкиОбмена_Контрагенты.ИД = &ИД
	                          |	И ЭСФ_НастройкиОбмена_Контрагенты.СистемаЭДО = &СистемаЭДО");

	
	
	Если СистемаЭДО=Перечисления.СистемыЭДО.Диадок ТОгда
		
		Диадок=Обработки.ЭСФ_Робот.Создать(); // создается и сам подключается к серверу в модуле объекта
		
		Если Диадок.TestConnection()=Ложь Тогда
			Предупреждение("Не удалось подключиться к серверу Диадока!");
			Отказ=Истина;   // нет связи нет формы
		КонецЕсли;
		
		DiadocInvoiceAPI=Диадок.DiadocInvoiceAPI;
		
		
		//---------------<По всем настройкам обмена всех фирм по выбранной системе это тянем контрагентов>---------------------------// GtG // 06.12.2012 18:02:14
		// настройки должны быть
		
		Запрос=Новый Запрос("ВЫБРАТЬ
		                    |	ЭСФ_НастройкиОбмена_Фирмы.ОтпечатокКлюча,
		                    |	ЭСФ_НастройкиОбмена_Фирмы.ИДФирмы
		                    |ИЗ
		                    |	РегистрСведений.ЭСФ_НастройкиОбмена_Фирмы КАК ЭСФ_НастройкиОбмена_Фирмы
		                    |ГДЕ
		                    |	ЭСФ_НастройкиОбмена_Фирмы.СистемаЭДО = &СистемаЭДО
		                    |	И ЭСФ_НастройкиОбмена_Фирмы.ИДФирмы <> """"
		                    |	И ЭСФ_НастройкиОбмена_Фирмы.ОтпечатокКлюча <> """"");
							
		Запрос.УстановитьПараметр("СистемаЭДО",СистемаЭДО);
		
		Рез=Запрос.Выполнить().Выгрузить();
		
		Для Каждого Стр Из Рез Цикл
			Состояние("Подключаемся к серверу...");
			DiadocConnection = DiadocInvoiceAPI.CreateConnection(Стр.ОтпечатокКлюча);
			
			Состояние("Получаем организацию по ИД "+Стр.ИДФирмы+"...");
			Organization=DiadocConnection.GetOrganizationById(Стр.ИДФирмы); //COM-объект

			МассивКОМКонтрагентов=Organization.GetCounteragentListByStatus(""); // массив COM-Объектов
			//Id	Inn	Kpp	Name	FnsParticipantId	JoinedDiadocTreaty	OrganizationId	Organization	Departments
			Для Каждого КомКА из МассивКОМКонтрагентов Цикл
				
				ЗапросКАПоИД.УстановитьПараметр("ИД",КомКА.ID);				
				ЗапросКАПоИД.УстановитьПараметр("СистемаЭДО",СистемаЭДО);
				Рез=ЗапросКАПоИД.Выполнить().Выгрузить();
				
				Если Рез.Количество()<>0 Тогда
					Продолжить;
				КонецЕсли;	
				
				
				КА=Контрагенты.Добавить();
				
				ЗаполнитьЗначенияСвойств(КА,КомКА);
				
				
			КонецЦикла;	
			
			
		КонецЦикла;	
		
		
	КонецЕСли;	
	
	
	
КонецПроцедуры


Процедура ОсновныеДействияФормыДобавитьНовыхКонтрагентов(Кнопка)
	Для Каждого Стр Из Контрагенты Цикл
		Если Стр.Поставщик.Пустая()=Истина Тогда
			Продолжить;
		КонецЕсли;
		
		ЗаписьКА=РегистрыСведений.ЭСФ_НастройкиОбмена_Контрагенты.СоздатьМенеджерЗаписи();
		ЗаписьКА.Активность=Истина;
		ЗаписьКА.Контрагент=Стр.Поставщик;
		ЗаписьКА.СистемаЭДО=СистемаЭДО;
		
		ЗаписьКА.Прочитать();
		
		ЗаписьКА.Активность=Истина;
		ЗаписьКА.Контрагент=Стр.Поставщик;
		ЗаписьКА.СистемаЭДО=СистемаЭДО;
		ЗаписьКА.ИД=Стр.ID;
		
		ЗаписьКА.Записать();
		
			
		
	КонецЦикла;	
КонецПроцедуры

