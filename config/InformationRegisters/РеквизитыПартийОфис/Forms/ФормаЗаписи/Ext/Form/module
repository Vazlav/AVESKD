Перем мСтруктураПараметров Экспорт;
Перем БаркодДо, СерияДо, СрокГодностиДо;

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	БаркодДо = "";
	СерияДо = "";
	СрокГодностиДо = Дата(1,1,1);
	Если ТипЗнч(мСтруктураПараметров) <> Тип("Структура") Тогда
		Предупреждение("Не заполнена структура параметров.");
		Отказ = Истина;
		Возврат;
	КонецЕсли;		
	Если РегистрСведенийМенеджерЗаписи.Выбран() Тогда 
		КодПартии = РегистрСведенийМенеджерЗаписи.ПартияКод;
		БаркодДо = РегистрСведенийМенеджерЗаписи.Баркод;
		СерияДо = РегистрСведенийМенеджерЗаписи.Серия;
		СрокГодностиДо = РегистрСведенийМенеджерЗаписи.СрокГодности;
	Иначе	
		КодПартии = мСтруктураПараметров.ПартияКод;
	КонецЕсли;
	рез = РегистрыСведений.РеквизитыПартийОфис.ПолучитьТоварПартиюПоКоду(КодПартии);
	Если рез = Неопределено Тогда
		Предупреждение("Не найдена партия по Коду: "+ СокрЛП(КодПартии));
		Отказ = Истина;
		Возврат;
	Иначе
		Товар =  Рез.Товар;
		Партия =  Рез.Партия;
	КонецЕсли;
	ЭлементыФормы.ДанныеТовар.Заголовок = Товар.Наименование;
	ЭлементыФормы.КодТовара.Значение = Товар.Код;
	ПартияКод = Партия.Код;
	
КонецПроцедуры // ПередОткрытием()

Процедура ИзПартииНажатие(Элемент)
	
	Баркод = Партия.БарКод;
	Серия = Партия.Серия;
	СрокГодности = Партия.СрокГодности;
	
КонецПроцедуры

Процедура ЗаписатьИсториюИзмененияРеквизитовПратий(КодАптеки, КодПартии, КодТовара, ИмяРеквизита, ЗначРеквСтарое="", ЗначРеквНовое="")
	МЗ = РегистрыСведений.ИсторияИзмененийРеквизитовПартий.СоздатьМенеджерЗаписи();
	МЗ.Дата = ТекущаяДата();
	МЗ.КодАптеки = КодАптеки;
	МЗ.КодПартии = КодПартии;
	МЗ.КодТовара = КодТовара;
	МЗ.ИмяРеквизита = ИмяРеквизита;
	МЗ.ЗначРеквСтарое = СокрЛП(Строка(ЗначРеквСтарое));
	МЗ.ЗначРеквНовое = СокрЛП(Строка(ЗначРеквНовое));
	МЗ.Записать();
КонецПроцедуры

Процедура ПослеЗаписи()
	
	ЕстьИзменения = Ложь;
	Если СрокГодностиДо <> СрокГодности Тогда
		ЗаписатьИсториюИзмененияРеквизитовПратий(мСтруктураПараметров.СкладКод, мСтруктураПараметров.ПартияКод, Партия.КодТовара, "СрокГодностиОфис",СрокГодностиДо, СрокГодности);
		ЕстьИзменения = Истина;
	КонецЕсли;
	Если БаркодДо <> БарКод Тогда
		ЗаписатьИсториюИзмененияРеквизитовПратий(мСтруктураПараметров.СкладКод, мСтруктураПараметров.ПартияКод, Партия.КодТовара, "БарКодОфис", БаркодДо, БарКод);
		ЕстьИзменения = Истина;
	КонецЕсли;
	Если СерияДо <> Серия Тогда
		ЗаписатьИсториюИзмененияРеквизитовПратий(мСтруктураПараметров.СкладКод, мСтруктураПараметров.ПартияКод, Партия.КодТовара, "СерияОфис", СерияДо, Серия);
		ЕстьИзменения = Истина;
	КонецЕсли;
	мСтруктураПараметров.Вставить("ЕстьИзменения", ЕстьИзменения);
	
КонецПроцедуры



