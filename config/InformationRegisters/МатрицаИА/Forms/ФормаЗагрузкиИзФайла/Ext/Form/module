Процедура КнопкаВыборФайлаНажатие(Элемент)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	Если Диалог.Выбрать() Тогда
    	ПутьКФайлу = Диалог.ПолноеИмяФайла;
	КонецЕсли;

КонецПроцедуры

Процедура ДобавитьЗаписьВРС_МатрицаИА_Лог(КодДДП,ИА,AreaID,Событие,Реквизит = Неопределено,СтароеЗначение = Неопределено,НовоеЗначение = Неопределено)
	
	// Для записи нескольких строк в течении одной секунды
	ОбщегоНазначения.Задержка(1);
	
	МЗ = РегистрыСведений.МатрицаИА_Лог.СоздатьМенеджерЗаписи();
	МЗ.Период			= ТекущаяДата();
	МЗ.КодДДП			= КодДДП;
	МЗ.ИА 				= ИА;
	МЗ.AreaID			= AreaID;
	МЗ.Событие			= Событие;
	МЗ.Реквизит			= Реквизит;
	МЗ.СтароеЗначение	= СтароеЗначение;
	МЗ.НовоеЗначение	= НовоеЗначение;
	МЗ.Пользователь		= ПараметрыСеанса.ТекущийСотр;
	Попытка
		МЗ.Записать(Ложь);
	Исключение
		
	КонецПопытки;
	
КонецПроцедуры	

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если ПустаяСтрока(ПутьКФайлу) Тогда
    
    	Сообщить("Не указан путь к файлу!");
        Возврат
    
    КонецЕсли; 
	
	Если Вопрос("Перед загрузкой регистр сведений ""Матрица ИА"" будет очищен. Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
	
		Возврат	
	
	КонецЕсли;
	
	Попытка
		
		Excel = Новый COMОбъект("Excel.Application");
		Excel.WorkBooks.Open(ПутьКФайлу);
		Состояние("Обработка файла Microsoft Excel...");
		
	Исключение
		Сообщить("Ошибка при открытии файла с помощью Excel! Загрузка не будет произведена!");
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Попытка
		//Открываем необходимый лист
		Excel.Sheets(1).Select(); // лист 1, по умолчанию
	Исключение
		//Закрываем Excel
		Excel.ActiveWorkbook.Close();
		Excel = 0;
		Сообщить("Файл "+Строка(ПутьКФайлу)+" не соответствует необходимому формату! Первый лист не найден!");
		ОтменитьТранзакцию();
		Возврат;
	КонецПопытки;
	
	//Получим количество строк и колонок.
	//В разных версиях Excel получаются по-разному, поэтому сначала определим версию Excel
	Версия = Лев(Excel.Version,Найти(Excel.Version,".")-1);
	Если Версия = "8" тогда
		ФайлСтрок = Excel.Cells.CurrentRegion.Rows.Count;
		ФайлКолонок = Макс(Excel.Cells.CurrentRegion.Columns.Count, 13);
	Иначе
		ФайлСтрок = Excel.Cells(1,1).SpecialCells(11).Row;
		ФайлКолонок = Excel.Cells(1,1).SpecialCells(11).Column;
    Конецесли;
	
	СпрСайты	= Справочники.СайтыИнтернетЗаказов;
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("КодДДП");
	ТЗ.Колонки.Добавить("ИА");
	ТЗ.Колонки.Добавить("AreaID");
	ТЗ.Колонки.Добавить("Изменен");
	ТЗ.Колонки.Добавить("IsAutoorder");
	ТЗ.Колонки.Добавить("Coming");
	ТЗ.Колонки.Добавить("Need");
	ТЗ.Колонки.Добавить("Expire");
	ТЗ.Колонки.Добавить("ParentKod");
	ТЗ.Колонки.Добавить("IsActive");
	ТЗ.Колонки.Добавить("Descr");
	
	Для Сч = НачальнаяСтрока  По ФайлСтрок Цикл
    
		Состояние("Обработка: "+ Сч + " строк из " + ФайлСтрок);
		ОбработкаПрерыванияПользователя(); 
		
		ИА_Наименование	= Строка(Excel.Cells(Сч, 1).Text);
		Если ПустаяСтрока(ИА_Наименование) Тогда
		
			Сообщить("Строка: "+Сч+". Колонка ""PARTNER"" пустая, строка не загружена",СтатусСообщения.Важное);
			Продолжить;
		
		КонецЕсли; 
		НайденнаяСсылка = СпрСайты.НайтиПоНаименованию(ИА_Наименование);
		Если НайденнаяСсылка = СпрСайты.ПустаяСсылка() Тогда
			
			Сообщить("Строка: "+Сч+". Не найден сайт: "+ ИА_Наименование+" в справочнике ""Сайты итернет заказов"", строка не загружена",СтатусСообщения.Важное);
			Продолжить;
		
		КонецЕсли;
		ИА			= НайденнаяСсылка;
		
		AreaID		= Строка(Excel.Cells(Сч, 2).Text);
		Если ПустаяСтрока(AreaID) Тогда
		
			Сообщить("Строка: "+Сч+". Колонка ""REGION"" пустая, строка не загружена",СтатусСообщения.Важное);
			Продолжить;
		
		КонецЕсли; 
		
		IsActive	= Число(Excel.Cells(Сч, 3).Text);
		IsAutoorder	= Число(Excel.Cells(Сч, 4).Text);
		КодДДП		= Число(Excel.Cells(Сч, 5).Text);
		Descr		= Строка(Excel.Cells(Сч, 6).Text);
		Coming		= Строка(Excel.Cells(Сч, 7).Text);
		Need		= Число(Excel.Cells(Сч, 8).Text);
		Expire		= Число(Excel.Cells(Сч, 9).Text);
		ParentKod	= Строка(Excel.Cells(Сч, 10).Text);
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.КодДДП		= КодДДП;
		НоваяСтрока.ИА			= ИА;
		НоваяСтрока.AreaID		= AreaID;
		НоваяСтрока.Изменен		= Истина;
		НоваяСтрока.IsAutoorder	= IsAutoorder;
		НоваяСтрока.Coming		= Coming;
		НоваяСтрока.Need		= Need;
		НоваяСтрока.Expire		= Expire;
		НоваяСтрока.ParentKod	= ParentKod;
		НоваяСтрока.IsActive	= IsActive;
		НоваяСтрока.Descr		= Descr;
		
	КонецЦикла; 
    
	Excel.DisplayAlerts = 0; 
	Excel.Quit();
	Excel.DisplayAlerts = 1;
	
	НаборЗаписей = РегистрыСведений.МатрицаИА.СоздатьНаборЗаписей();
	НаборЗаписей.Загрузить(ТЗ);
	Попытка
		НаборЗаписей.Записать();
	Исключение
	   Сообщить("" + ОписаниеОшибки());
   КонецПопытки;
   
   //Логирование
   НЗ = РегистрыСведений.МатрицаИА_Лог.СоздатьНаборЗаписей();
   
   НЗ.Загрузить(ТЗ);
   МассивЗначений1 = Новый Массив;
   МассивЗначений2 = Новый Массив;
   МассивЗначений3 = Новый Массив;
   Сч = 1; КолвоЗаписей = ТЗ.Количество();
   Для каждого СтрокаТЗ Из ТЗ Цикл
   
	   МассивЗначений1.Добавить("Создание");
	   МассивЗначений2.Добавить(ПараметрыСеанса.ТекущийСотр);
	   МассивЗначений3.Добавить(ТекущаяДата());
	   
	   Состояние("Логирование обработано "+Сч+" из " +КолвоЗаписей+ " записей");  
       Сч = Сч+1;
   
   КонецЦикла; 
   
   НЗ.ЗагрузитьКолонку(МассивЗначений1,"Событие");
   НЗ.ЗагрузитьКолонку(МассивЗначений2,"Пользователь");
   НЗ.ЗагрузитьКолонку(МассивЗначений3,"Период");
  
   Попытка
	   НЗ.Записать()
   Исключение
	   
	   Сообщить("Внимание! Ошибка при записи лога изменений регистра ""Матрица ИА"". Логирование не записано!",СтатусСообщения.Внимание);
	   Сообщить("Техническая информация: "+ ОписаниеОшибки())
	   
   КонецПопытки;
   
   Закрыть();
   
КонецПроцедуры

Процедура ПриОткрытии()
	НачальнаяСтрока = 2;
КонецПроцедуры

Процедура ЗакрытьНажатие(Элемент)
	Закрыть()
КонецПроцедуры
