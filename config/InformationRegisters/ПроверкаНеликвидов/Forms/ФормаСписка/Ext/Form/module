
Процедура ДействияФормыЗагрузитьИзФайла(Кнопка)
	
	Форма = РегистрыСведений.ПроверкаНеликвидов.ПолучитьФорму("ФормаЗагрузкиДанных");
	ФайлИмпорта = Форма.ОткрытьМодально();
	
	Если Не ЗначениеЗаполнено(ФайлИмпорта) Тогда
		Возврат;
	КонецЕсли;
	
	ВыбФайл = Новый Файл(ФайлИмпорта); 	
	Если Не ВыбФайл.Существует() Тогда
		Сообщить("Не найден файл " + ФайлИмпорта);
		Возврат;
	КонецЕсли;
	
	Попытка
		Excel = Новый COMОбъект("Excel.Application");	
	Исключение
		Сообщить ("Не удалось запустить Excel");
		Возврат;
	КонецПопытки;
	
	Книга = Excel.Workbooks.Open(ФайлИмпорта);	
	Лист = Книга.WorkSheets(1);	
	ВсегоСтрок = Лист.Cells(1,1).SpecialCells(11).Row;
	
	Для Строка = 2 По ВсегоСтрок Цикл
		
		ОбработкаПрерыванияПользователя();
		
		КодПозиции = Число(УбратьЛишниеСимволы(СокрЛП(Лист.Cells(Строка,1).Value)));
		Статус = СокрЛП(Лист.Cells(Строка,2).Value);
		
		Если ВРег(Статус) = "СОВПАДАЕТ" Тогда
			СтатусПроверки = Перечисления.СтатусыПроверки.Совпадает;
		ИначеЕсли ВРег(Статус) = "НЕ СОВПАДАЕТ" Тогда
			СтатусПроверки = Перечисления.СтатусыПроверки.НеСовпадает;
		Иначе
			СтатусПроверки = Перечисления.СтатусыПроверки.НеПроверен;
		КонецЕсли;
					           		
		НаборЗаписей = РегистрыСведений.ПроверкаНеликвидов.СоздатьНаборЗаписей(); 		
		НаборЗаписей.Отбор.КодПозиции.Установить(КодПозиции);		
		НаборЗаписей.Прочитать();
		
		Для Каждого Запись Из НаборЗаписей Цикл			
			Запись.ДатаПроверки			= ТекущаяДата();
			Запись.СтатусПроверки		= СтатусПроверки;
		КонецЦикла;
		
		НаборЗаписей.Записать();

	КонецЦикла;
	
	Excel.Application.Quit();
	
	ЗагруженоСтрок = ВсегоСтрок - 1;
	Сообщить("Данные загружены (" + ЗагруженоСтрок + ")");
	
	Обновить();
	
КонецПроцедуры

Процедура ДействияФормыУдалитьСтарыеЗаписи(Кнопка)
	
	ПериодОтбора = НачалоДня(ТекущаяДата());
	Если ВвестиДату(ПериодОтбора, "Введите дату. Более ранние записи будут удалены") Тогда
		
		Выборка = РегистрыСведений.ПроверкаНеликвидов.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Если Выборка.ДатаСозданияЗаписи < ПериодОтбора Тогда
				ТекЗапись = Выборка.ПолучитьМенеджерЗаписи();
				ТекЗапись.Удалить();
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	//Обновить();
	
КонецПроцедуры

Функция УбратьЛишниеСимволы(ИсходнаяСтрока)
	
	НовСтрока = "";
	ПравильныеСимволы = "0123456789";
	
	Для Сч = 1 по СтрДлина(ИсходнаяСтрока) Цикл
		ТекСимв = Сред(ИсходнаяСтрока, Сч, 1);
		Если Найти(ПравильныеСимволы, ТекСимв) > 0 Тогда
			НовСтрока = НовСтрока + ТекСимв;
		КонецЕсли;
	КонецЦикла;
	
	Возврат НовСтрока;
	
КонецФункции 
