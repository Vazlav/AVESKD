Процедура КнопкаВыборФайлаНажатие(Элемент)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	Если Диалог.Выбрать() Тогда
    	ПутьКФайлу = Диалог.ПолноеИмяФайла;
	КонецЕсли;

КонецПроцедуры

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	Если ПустаяСтрока(ПутьКФайлу) Тогда
    
    	Сообщить("Не указан путь к файлу!");
        Возврат
    
    КонецЕсли; 
	
	Если Вопрос("Перед загрузкой регистр сведений будет очищен. Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
	
		Возврат	
	
	КонецЕсли;
	
	СпрРегионыИА = Справочники.ИА_ЦО_Регионы;
	СпрРегионыИА_Москва = СпрРегионыИА.НайтиПоКоду("000000001");
	Если СпрРегионыИА_Москва = Неопределено Тогда
		Сообщить("В справочнике ""Регионы(ЦО ИА)"" не обнаружен элемент ""Москва"" (код 1). Проверьте правильность заполнения справочника и повторите загрузку");
		Возврат
	КонецЕсли; 
	СпрРегионыИА_СПт = СпрРегионыИА.НайтиПоКоду("000000002");
	Если СпрРегионыИА_СПт = Неопределено Тогда
		Сообщить("В справочнике ""Регионы(ЦО ИА)"" не обнаружен элемент ""Санкт-Петербург"" (код 2). Проверьте правильность заполнения справочника и повторите загрузку");
		Возврат
	КонецЕсли; 
	
	Попытка
		
		Excel = Новый COMОбъект("Excel.Application");
		Excel.WorkBooks.Open(ПутьКФайлу);
		Состояние("Обработка файла Microsoft Excel...");
		
	Исключение
		Сообщить("Ошибка при открытии файла с помощью Excel! Загрузка не будет произведена!");
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Попытка
		//Открываем необходимый лист
		Excel.Sheets(1).Select(); // лист 1, по умолчанию
	Исключение
		//Закрываем Excel
		Excel.ActiveWorkbook.Close();
		Excel = 0;
		Сообщить("Файл "+Строка(ПутьКФайлу)+" не соответствует необходимому формату! Первый лист не найден!");
		ОтменитьТранзакцию();
		Возврат;
	КонецПопытки;
	
	//Получим количество строк и колонок.
	//В разных версиях Excel получаются по-разному, поэтому сначала определим версию Excel
	Версия = Лев(Excel.Version,Найти(Excel.Version,".")-1);
	Если Версия = "8" тогда
		ФайлСтрок = Excel.Cells.CurrentRegion.Rows.Count;
		ФайлКолонок = Макс(Excel.Cells.CurrentRegion.Columns.Count, 13);
	Иначе
		ФайлСтрок = Excel.Cells(1,1).SpecialCells(11).Row;
		ФайлКолонок = Excel.Cells(1,1).SpecialCells(11).Column;
    Конецесли;
	
	СпрАП	= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН;
	ТЗ = Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("КодТовар");
	ТЗ.Колонки.Добавить("Регион");
	ТЗ.Колонки.Добавить("ТипСкидки");
	ТЗ.Колонки.Добавить("ТипЗначенияСкидки");
	ТЗ.Колонки.Добавить("ЗначениеСкидки");
	ТЗ.Колонки.Добавить("ДатаНачалаДействияСкидки");
	ТЗ.Колонки.Добавить("ДатаОкончанияДействияСкидки");
	ТЗ.Колонки.Добавить("ДатаЗагрузки");
	ТЗ.Колонки.Добавить("Автор");
	ТЗ.Колонки.Добавить("ПризнакСкидки");
	
	ДатаЗагрузки = ТекущаяДата();
	Автор = ПараметрыСеанса.ТекущийСотр;
	
	Для Сч = НачальнаяСтрока  По ФайлСтрок Цикл
    
		Состояние("Обработка: "+ Сч + " строк из " + ФайлСтрок);
		ОбработкаПрерыванияПользователя(); 
		
		Код1С					= Число(СтрЗаменить(Excel.Cells(Сч, 1).Text," ",""));
		НайденнаяСсылка = СпрАП.НайтиПоКоду(Код1С);
		Если НайденнаяСсылка = СпрАП.ПустаяСсылка() Тогда
			
			Сообщить("Не найден код 1с: "+ Код1С+", строка не загружена");
			Продолжить;
		
		КонецЕсли;
		ТипСкидки				= Число(Excel.Cells(Сч, 2).Text);
		ТипЗначенияСкидки		= Число(Excel.Cells(Сч, 3).Text);
		ЗначениеСкидки			= Число(Excel.Cells(Сч, 4).Text);
		Excel.Cells(Сч , 5).NumberFormat="ДД.ММ.ГГГГ";
		НачалоДействияСкидки		= Excel.Cells(Сч, 5).Value;
		Excel.Cells(Сч , 6).NumberFormat="ДД.ММ.ГГГГ";
		ОкончаниеДействияСкидки	= Excel.Cells(Сч, 6).Value;
		Регион					= Число(Excel.Cells(Сч, 7).Text);
		Если ПустаяСтрока(Excel.Cells(Сч, 8).Text) Тогда
			ПризнакСкидки	= 0;
		Иначе
			ПризнакСкидки	= Число(Excel.Cells(Сч, 8).Text);
		КонецЕсли; 
		
		Если ЗначениеСкидки < 0 Тогда
		
			Сообщить("В строке "+Сч+" введено отрицательное значение в колонке ""Значение скидки"". Строка не записана!");
			Продолжить;
		
		КонецЕсли;
		
		НоваяСтрока = ТЗ.Добавить();
		НоваяСтрока.КодТовар					= Код1С;
		Если Регион = 1 Тогда
			НоваяСтрока.Регион					= СпрРегионыИА_Москва;
		ИначеЕсли Регион = 2 Тогда
			НоваяСтрока.Регион					= СпрРегионыИА_СПт;
		Иначе
			НоваяСтрока.Регион					= СпрРегионыИА.ПустаяСсылка();
		КонецЕсли;
		Если ТипСкидки = 0 Тогда
			НоваяСтрока.ТипСкидки				= Перечисления.ИА_ЦО_ТипСкидки.Фиктивная;
		ИначеЕсли ТипСкидки = 1 Тогда	
			НоваяСтрока.ТипСкидки				= Перечисления.ИА_ЦО_ТипСкидки.Реальная;
		Иначе 
			НоваяСтрока.ТипСкидки				= Перечисления.ИА_ЦО_ТипСкидки.ПустаяСсылка();
		КонецЕсли;
		Если ТипЗначенияСкидки = 0 Тогда
			НоваяСтрока.ТипЗначенияСкидки			= Перечисления.ИА_ЦО_ТипЗначенияСкидки.Относительная;
		ИначеЕсли ТипЗначенияСкидки = 1 Тогда
			НоваяСтрока.ТипЗначенияСкидки			= Перечисления.ИА_ЦО_ТипЗначенияСкидки.Абсолютная;
		Иначе
			НоваяСтрока.ТипЗначенияСкидки			= Перечисления.ИА_ЦО_ТипЗначенияСкидки.ПустаяСсылка();
		КонецЕсли; 
		Если ПризнакСкидки = 1 Тогда
			НоваяСтрока.ПризнакСкидки = Перечисления.ИА_ЦО_ПризнакСкидки.СменаРеальнойНаФиктивную;
		ИначеЕсли ПризнакСкидки = 2 Тогда
			НоваяСтрока.ПризнакСкидки = Перечисления.ИА_ЦО_ПризнакСкидки.СменаФиктивнойНаРеальную;
		КонецЕсли;
		НоваяСтрока.ЗначениеСкидки				= ЗначениеСкидки;
		НоваяСтрока.ДатаНачалаДействияСкидки	= НачалоДействияСкидки;
		НоваяСтрока.ДатаОкончанияДействияСкидки	= ОкончаниеДействияСкидки;
		НоваяСтрока.ДатаЗагрузки				= ДатаЗагрузки;
 		НоваяСтрока.Автор						= Автор;
   
    КонецЦикла; 
    
	Excel.DisplayAlerts = 0; 
	Excel.Quit();
	Excel.DisplayAlerts = 1;
	
	НаборЗаписей = РегистрыСведений.ИА_ЦО_МаркетинговыеЦены.СоздатьНаборЗаписей();
	НаборЗаписей.Загрузить(ТЗ);
	Попытка
		НаборЗаписей.Записать();
	Исключение
	   Сообщить("" + ОписаниеОшибки());
   КонецПопытки;
   
	Закрыть();
    
КонецПроцедуры

Процедура ПриОткрытии()
	НачальнаяСтрока = 2;
КонецПроцедуры

Процедура ЗакрытьНажатие(Элемент)
	Закрыть()
КонецПроцедуры
