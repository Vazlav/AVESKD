Перем КСТ,КСШ;


Процедура ПодборПоАПНажатие(Элемент)
	// Назначение:
	// Запускает процесс подбора по справочнику АП
	// Открывает форму для подбора АП
	// 
	//============================================================================ GtG ===
	Если ЭтаФорма.ТолькоПросмотр Тогда
		Предупреждение("Редактирование документа запрещено!");
		ВОЗВРАТ ;
	КонецЕсли; 
	
	
	
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.ПолучитьФорму("ФормаДляПодбора","",КлючУник);
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ВладелецФормы=ЭтаФорма;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.ОткрытьМодально(0);
КонецПроцедуры

Процедура КоманднаяПанель1Расценить(Кнопка)
	
	ОМ6_КоманднаяПанельКнопкаРасценить(ЭтаФорма,ЭтотОбъект,Товар,Ложь);
	

КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	Если ТипЗнч(ЗначениеВыбора)<>Тип("ТаблицаЗначений") Тогда
		Возврат;
	КонецЕсли; 	
	//ЗначениеВыбора= Новый ТаблицаЗначений; 
	
	ТоварДляПоиска=ЗначениеВыбора.ВыгрузитьКолонку("Товар");
	
	ТХТ="ВЫБРАТЬ
	    |	ПартииЖНВЛСОстатки.Товар КАК Товар,
	    |	ПартииЖНВЛСОстатки.Партия КАК Партия,
	    |	ПартииЖНВЛСОстатки.Партия.ЦенаЗакуп * 100 / (100 + ПартииЖНВЛСОстатки.Партия.СтавкаНДС.Ставка) КАК ЦенаЗакупБезНДС,
	    |	0 КАК ЦенаГосРегистрации,
	    |	ПартииЖНВЛСОстатки.Партия.ЦенаПроизводителяБезНДС КАК ЦенаПроизводителяБезНДС,
	    |	ПартииЖНВЛСОстатки.Партия.ЕИТЗакупки КАК ЕИТ,
	    |	ПартииЖНВЛСОстатки.Партия.ЕИТЗакупки.К КАК К,
	    |	ПартииЖНВЛСОстатки.Партия.ЦенаЗакуп КАК ЦенаЗакупСНДС,
	    |	ПартииЖНВЛСОстатки.Партия.СтавкаНДС КАК СтавкаНДС,
	    |	ПартииЖНВЛСОстатки.КолвоОстаток КАК КоличествоФакт
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Остатки(
	    |		&КонецДняДок,
	    |		Товар В (&ТоварыМассив)
	    |			И Склад = &Склад
	    |			И Фирма = &Фирма) КАК ПартииЖНВЛСОстатки";
		
		Запрос=Новый Запрос;
		Запрос.Текст=ТХТ;
		Запрос.УстановитьПараметр("ТоварыМассив",ТоварДляПоиска);
		Запрос.УстановитьПараметр("КонецДняДок",КонецДня(Дата));
		Запрос.УстановитьПараметр("Склад",Склад);
		Запрос.УстановитьПараметр("Фирма",Склад.Фирма);
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		
		Для каждого Стр из ТЗ Цикл
			СтрДок=ТОвар.Добавить();
			СтрДок.ЕИТ=Стр.ЕИТ;
			СтрДок.КоличествоФакт=Стр.КоличествоФакт;
			СтрДок.Коэфф=Стр.к;
			СтрДок.Партия=Стр.Партия;
			СтрДок.Товар=Стр.Товар;
			СтрДок.ЦенаГосРегистрации=Стр.ЦенаГосРегистрации;
			СтрДок.ЦенаЗакуп=Стр.ЦенаЗакупСНДС;
			СтрДок.ЦенаЗакупБезНДС=Стр.ЦенаЗакупБезНДС;
			СтрДок.ЦенаПроизводителя=Стр.ЦенаПроизводителяБезНДС;
			СтрДок.СтавкаНДС=Стр.СтавкаНдс;
			
		КонецЦикла;	 
		
		
	
КонецПроцедуры

Процедура ПриОткрытии()
	Если ЭтотОбъект.ЭтоНовый() Тогда
		Склад=Константы.ОсновнойСклад.Получить();
		Фирма = Склад.Фирма;
		СИ=Изменения.Добавить();
		СИ.Дата=ТекущаяДата();
		СИ.КомментарийИзменения="Создан новый документ";
		СИ.Сотрудник=ПараметрыСеанса.ТекущийСотр;
		СИ.ТипИзм=Перечисления.ДействияНадДокументами.ВводНового;
		
	КонецЕсли;
	
	КСТ=ОМ4_РасчетКонтрольнойСуммыТабЧастиДокумента(Товар);
	КСШ=ОМ4_РасчетКонтрольнойСуммыШапкиДокумента( ЭтотОбъект );
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	ОМ4_ПередЗаписью(ЭтотОбъект,Товар,КСШ ,КСТ);
КонецПроцедуры


Процедура КоманднаяПанель2НайтиСтрокуВТаблицеТовара(Кнопка)
	
	Если ОшибкиРасценки.Количество()=0 Тогда
		Возврат;
	КонецЕсли;	
	
	ОшПартия=ЭлементыФормы.ОшибкиРасценки.ТекущаяСтрока.Партия;
	Стр=Товар.Найти(ОшПартия,"Партия");
	ЭтаФорма.Панель.ТекущаяСтраница= ЭтаФорма.Панель.Страницы.Найти("СписокТОваров");
	ЭлементыФормы.Товар.ТекущаяСтрока=Стр;
КонецПроцедуры

Процедура ТоварПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	 Если  ОшибкиРасценки.Найти(ДанныеСтроки.Партия,"Партия")<> Неопределено ТОгда
		 //Это строка с ошибками расценки или подозрительная с точки зрения цен или сроков годности
		 ОформлениеСтроки.ЦветФона=Новый Цвет(255,155,240);
	 КонецЕсли;

КонецПроцедуры

Процедура СкладПриИзменении(Элемент)
	Фирма = Склад.Фирма;
КонецПроцедуры

Процедура ФирмаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если (Склад.Фирма <> ВыбранноеЗначение) и (НЕ Склад.Пустая()) Тогда
		Предупреждение("Нельзя выбрать фирму отличную от фирмы по уже выбранной ранее аптеке!"	);
		ВыбранноеЗначение = Фирма;
	КонецЕсли;

КонецПроцедуры

Процедура КомПанТоварОкруглитьДоРублей(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры
