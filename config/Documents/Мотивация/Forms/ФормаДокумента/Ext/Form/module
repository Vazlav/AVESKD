
Процедура ОткрытьПодбор()
	
	ФормаПодбора = ЭтотОбъект.ПолучитьФорму("ПодборТовара",ЭтаФорма,Новый УникальныйИдентификатор());
	ФормаПодбора.ВладелецФормы = ЭтаФорма;
	ФормаПодбора.МножественныйВыбор = Истина;
	ФормаПодбора.ОткрытьМодально();
	
		
	Товар.Загрузить(ФормаПодбора.ТЗТовара);	

	//Для каждого стр из ФормаПодбора.ТЗТовара Цикл
	//	НоваяСтрока = Товар.Добавить();	
	//	ЗаполнитьЗначенияСвойств(НоваяСтрока,стр);
	//КонецЦикла;

	
	
КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	//Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда	
	//	Товар.Загрузить(ФормаПодбора.ТЗТовара);
	//	//Для каждого стр из ЗначениеВыбора Цикл
	//	//	НоваяСтрока = Товар.Добавить();	
	//	//	ЗаполнитьЗначенияСвойств(НоваяСтрока,стр);
	//	//КонецЦикла;
	//КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1кнПодбор(Кнопка)
	
	ОткрытьПодбор();

КонецПроцедуры

Процедура ТоварПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	ОткрытьПодбор();
	
КонецПроцедуры

Процедура ТоварПриИзмененииФлажка(Элемент, Колонка)
	
	Если Колонка.Имя = "Отменена" Тогда
		ТекСтрока = Элемент.ТекущаяСтрока;
		Изменение = Изменения.Добавить();
		Изменение.Дата = ТекущаяДата();
		Изменение.КомментарийИзменения = "Флаг = " + ТекСтрока.Отменена + " № стр. " + ТекСтрока.НомерСтроки;
		Изменение.Сотрудник = ПараметрыСеанса.ТекущийСотр;
		Изменение.ТипИзм = Перечисления.ДействияНадДокументами.Изменение;
	КонецЕсли;
	
КонецПроцедуры

Процедура ТоварПередУдалением(Элемент, Отказ)
	
	Если Проведен и Выгружен Тогда
		Предупреждение("В выгруженном документе удаление строк запрещено. Можно только отменить действие строки.");
		Отказ = Истина;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыкнВыгрузить(Кнопка)
	
	Если РольДоступна("ПолныйДоступКПриорити") Тогда
		Выгрузить();
	Иначе
		Предупреждение("Недостаточно прав на выполнение данной операции!");
	КонецЕсли;
	
КонецПроцедуры

Процедура ТоварПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	

		Если ДанныеСтроки.Товар <> Неопределено Тогда
			ОформлениеСтроки.Ячейки.Активный.УстановитьТекст(ДанныеСтроки.Товар.УчаствуетВАП);
			ОформлениеСтроки.Ячейки.Производитель.УстановитьТекст(ДанныеСтроки.Товар.Производитель);

		Иначе
			ОформлениеСтроки.Ячейки.Активный.УстановитьТекст("");
		КонецЕсли;
	
	
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	ДополнительныеСвойства.Свойство("ОбработкаЗаполненияОтказ", Отказ);
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	Если ЭтоНовый() Тогда
		ДействиеВоВсехАптеках = Истина;
	КонецЕсли;
	
	Если Проведен Тогда
		ЭлементыФормы.НадписьПроведения.Заголовок = "ДОКУМЕНТ ПРОВЕДЕН!";
	КонецЕсли;	
	
КонецПроцедуры

Процедура ЗагрузитьСписокТоваров(Кнопка)
	
	Если Товар.Количество() > 0 Тогда
		Режим = РежимДиалогаВопрос.ДаНетОтмена;
		Ответ = Вопрос("Очистить существующий список товаров?", Режим, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			Товар.Очистить();
		ИначеЕсли Ответ = КодВозвратаДиалога.Отмена Тогда
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	Форма = ЭтотОбъект.ПолучитьФорму("ФормаЗагрузкиТоваров");
	ФайлИмпорта = Форма.ОткрытьМодально();
	
	Если Не ЗначениеЗаполнено(ФайлИмпорта) Тогда
		Возврат;
	КонецЕсли;
	
	ВыбФайл = Новый Файл(ФайлИмпорта); 	
	Если Не ВыбФайл.Существует() Тогда
		Сообщить("Не найден файл " + ФайлИмпорта);
		Возврат;
	КонецЕсли; 
	
	Попытка
		Excel = Новый COMОбъект("Excel.Application");	
	Исключение
		Сообщить ("Не удалось запустить Excel");
		Возврат;
	КонецПопытки;
	
	Книга = Excel.Workbooks.Open(ФайлИмпорта);	
	Лист = Книга.WorkSheets(1);	
	ВсегоСтрок = Лист.Cells(1,1).SpecialCells(11).Row;
	
	Для Строка = 1 По ВсегоСтрок Цикл
		
		ОбработкаПрерыванияПользователя();
		
		КодТовара = ОМ_ТСО.ПолучитьЧислоИзСтроки(Лист.Cells(Строка,1).Value);
		КолвоБаллов = ОМ_ТСО.ПолучитьЧислоИзСтроки(Лист.Cells(Строка,2).Value);
		
		Если Не ЗначениеЗаполнено(КодТовара) Тогда
			Прервать;
		КонецЕсли;
		
		ТекТовар = Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.НайтиПоКоду(КодТовара);
		
		Если Не ЗначениеЗаполнено(ТекТовар) Тогда				
			Сообщить("Не найден товар по коду: " + КодТовара);
			Продолжить;
		КонецЕсли;
		
		НовСтр = Товар.Добавить();
		НовСтр.Товар = ТекТовар;
		НовСтр.КодТовара = КодТовара;
		НовСтр.КоличествоБаллов = КолвоБаллов;
		
	КонецЦикла;
	
	Excel.Application.Quit(); 	
	
КонецПроцедуры

Процедура ПослеЗаписи()
	
	Если Проведен Тогда
		ЭлементыФормы.НадписьПроведения.Заголовок = "ДОКУМЕНТ ПРОВЕДЕН!";
	Иначе
		ПроверитьНаНаличиеТовараВДругихДокументах(Ложь);
	КонецЕсли;
	
	
	
КонецПроцедуры
