
Процедура КоманднаяПанель1кнЗаполнитьНаОсновании(Кнопка)
	
	
	Если Товар.Количество() > 0 Тогда
		
		Режим = РежимДиалогаВопрос.ДаНет;
		Ответ = Вопрос("Таблица товара содержит записи. Очистить?", Режим, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			Товар.Очистить();
		КонецЕсли;
		
	КонецЕсли;
	
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= ПолучитьФорму("ПодборТовара");
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ВладелецФормы=ЭтаФорма;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.Основание = ДокументОснование;
	ФормаПодбора.ДатаДокумента = Дата;
		
	ФормаПодбора.ОткрытьМодально(0);
	
	     
КонецПроцедуры

Процедура ПересчитатьТЧ()
	
	МинимальнаяОптоваяМаржа = Константы.МинимальнаяОптоваяМаржа.Получить();
	МинимальнаяОптоваяМаржаФакторинг = Константы.МинимальнаяОптоваяМаржаФакторинг.Получить();
	
	Для каждого НС из Товар Цикл
			НС.ЦенаСУчетомБонусовБезНДС = Макс(НС.ЦенаЗакупБезНДС - НС.ОптовыйБонус - НС.МаркетинговыйБонус , 0.01);
			НС.ЦенаСУчетомБонусовСНДС = НС.ЦенаСУчетомБонусовБезНДС + Окр(НС.ЦенаЗакупБезНДС*НС.СтавкаЗакупНДС/100,2);
			НС.СуммаСУчетомБонусовБезНДС = НС.ЦенаСУчетомБонусовБезНДС*НС.ПодтвержденнаяПотребность;
			НС.ЦенаОтпускнаяОптБезНДС = Окр(НС.ЦенаОтпускнаяОптСНДС/(1 + НС.СтавкаОптНДС/100),2);
			НС.Маржа = (НС.ЦенаОтпускнаяОптБезНДС - НС.ЦенаСУчетомБонусовБезНДС)*100/НС.ЦенаОтпускнаяОптБезНДС;
			НС.МинЦенаОптБезНДС = Окр(НС.ЦенаСУчетомБонусовБезНДС/(1 - ?(Факторинг,МинимальнаяОптоваяМаржаФакторинг,МинимальнаяОптоваяМаржа)/100),2);
			НС.СуммаОтпускнаяОптСНДС = НС.ЦенаОтпускнаяОптСНДС*НС.ПодтвержденнаяПотребность;
			НС.СуммаОтпускнаяОптБезНДС = НС.СуммаОтпускнаяОптСНДС - Окр(НС.СуммаОтпускнаяОптСНДС*НС.СтавкаОптНДС/100,2);
			НС.СуммаЗакупБезНДС = НС.ЦенаЗакупБезНДС*НС.ПодтвержденнаяПотребность;
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда
		Товар.Очистить();
		Для каждого стр из ЗначениеВыбора Цикл
			Если стр.ПодтвержденнаяПотребность > 0 Тогда
				НС = Товар.Добавить();
				ЗаполнитьЗначенияСвойств(НС,стр);
			КонецЕсли;
		КонецЦикла;
		ПересчитатьТЧ();
	КонецЕсли;	
	
КонецПроцедуры


Процедура ТоварПередНачаломДобавления(Элемент, Отказ, Копирование)
	Если Копирование = Истина Тогда
		Отказ = Истина;
	КонецЕсли;
	КоманднаяПанель1кнЗаполнитьНаОсновании("");
КонецПроцедуры

Процедура ПоказатьИсторию()
	
	ИсторияИзменений.Очистить();
	
	ТЗИстории = ОбщегоНазначения.ПолучитьИсториюИзмененийДокумента(Ссылка);
	Если НЕ ТЗИстории = Неопределено Тогда
		ЭлементыФормы.ИсторияИзменений.Значение = ТЗИстории;
	КонецЕсли;
	
КонецПроцедуры


Процедура Панель1ПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если Элемент.ТекущаяСтраница = Элемент.Страницы.Изменения Тогда
		ПоказатьИсторию();
	КонецЕсли;	
	
КонецПроцедуры


Процедура ДокументОснованиеПриИзменении(Элемент)
	
	Производитель = ДокументОснование.Производитель;
	Клиент = ДокументОснование.Клиент;
	Факторинг = ДокументОснование.Факторинг;
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	Если ЭтоНовый() Тогда
		Дата = ТекущаяДата();
	КонецЕсли;
	
КонецПроцедуры

