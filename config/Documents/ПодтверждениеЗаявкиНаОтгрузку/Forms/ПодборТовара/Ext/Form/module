
Процедура ТЗЗаказаПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.ПодтвержденнаяПотребность > 0 Тогда
		ОформлениеСтроки.ЦветФона=Новый Цвет(152,251,152);
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ЗаполнитьТаблицу()
	
	
	ТЗЗаказа.Очистить();
	
	Запрос = Новый Запрос;
	
	Если СпособОтображенияЗаказа = "ПолнаяЗаявка" Тогда
		ТипСоединения = " ЛЕВОЕ ";
	Иначе
		ТипСоединения = " ВНУТРЕННЕЕ ";
	КонецЕсли;

	Запрос.Текст = "ВЫБРАТЬ
	               |	РегЗаявка.КодТовара КАК КодТовара,
	               |	РегЗаявка.КоличествоОстаток КАК ВПути
	               |ПОМЕСТИТЬ ВтВПути
	               |ИЗ
	               |	РегистрНакопления.ЗаявкаНаОптовуюОтгрузку.Остатки(&ТекДата, Заявка = &Заявка) КАК РегЗаявка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	МК.СуммаУсловногоБонусаЗаУпаковку + ВЫБОР
	               |		КОГДА МК.ОтменаБУБ = ИСТИНА
	               |			ТОГДА 0
	               |		ИНАЧЕ МК.СуммаБезусловногоБонусаЗаУпаковку
	               |	КОНЕЦ КАК МаркетинговыйБонус,
	               |	МК.КодТовара КАК КодТовара
	               |ПОМЕСТИТЬ ВТМК
	               |ИЗ
	               |	Документ.МаркетинговыеКонтракты.Товар КАК МК
	               |ГДЕ
	               |	МК.Ссылка.НачалоПериода <= &ТекДата
	               |	И МК.Ссылка.КонецПериода >= &ТекДата
	               |	И МК.Ссылка.Проведен = ИСТИНА
	               |	И МК.Ссылка.Производитель = &Производитель
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	К.КодТовара КАК КодТовара,
	               |	К.Товар КАК Товар,
	               |	К.СтавкаНДС КАК СтавкаЗакупНДС,
	               |	К.БонусОптовый КАК БонусОптовый,
	               |	ВЫРАЗИТЬ(К.ЦенаЗакупБезНДС * (1 - К.БонусДополнительный / 100) КАК ЧИСЛО(15, 2)) КАК ЦенаЗакупБезНДС,
	               |	К.БонусДополнительный КАК БонусДополнительный,
	               |	ВЫРАЗИТЬ((ВЫРАЗИТЬ(К.ЦенаЗакупБезНДС * (1 - К.БонусДополнительный / 100) КАК ЧИСЛО(15, 2))) * К.БонусОптовый / 100 КАК ЧИСЛО(15, 2)) КАК ОптовыйБонус,
	               |	ЕСТЬNULL(ВТМК.МаркетинговыйБонус, 0) КАК МаркетинговыйБонус
	               |ПОМЕСТИТЬ ДопДанные
	               |ИЗ
	               |	Документ.КонтрактыПроизводителей.Товар КАК К
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ВТМК КАК ВТМК
	               |		ПО (ВТМК.КодТовара = К.КодТовара)
	               |ГДЕ
	               |	К.Ссылка = &Контракт
	               |	И К.ЦенаЗакупБезНДС > 0
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ДокЗаявка.КодТовара КАК КодТовара,
	               |	ДокЗаявка.Товар КАК Товар,
	               |	&Производитель КАК Производитель,
	               |	ДопДанные.СтавкаЗакупНДС КАК СтавкаЗакупНДС,
	               |	ДокЗаявка.СтавкаОптНДС КАК СтавкаОптНДС,
	               |	ДокЗаявка.ПотребностьВКоробах КАК ПотребностьВКоробах,
	               |	0 КАК ПодтвержденнаяПотребность,
				   |	0 КАК ЦенаОтпускнаяОптСНДС,
	               |	ДокЗаявка.ЦенаЗакупБезНДС КАК ЦенаЗакупБезНДСИзЗаявки,
	               |	ДопДанные.ЦенаЗакупБезНДС КАК ЦенаЗакупБезНДС,
	               |	ДопДанные.ОптовыйБонус КАК ОптовыйБонус,
	               |	ДопДанные.БонусДополнительный КАК БонусДополнительный,
	               |	ДопДанные.МаркетинговыйБонус КАК МаркетинговыйБонус,
	               |	ДокЗаявка.ЦенаОтпускнаяОптБезНДС КАК ЦенаОтпускнаяОптБезНДСИзЗаявки,
	               |	ДокЗаявка.ЦенаОтпускнаяОптСНДС КАК ЦенаОтпускнаяОптСНДСИзЗаявки,
	               |	ЕСТЬNULL(ВтВПути.ВПути,0) КАК ВПути
	               |ИЗ
	               |	Документ.ЗаявкаНаОптовуюОтгрузку.Товар КАК ДокЗаявка
	               |		"+ТипСоединения+" СОЕДИНЕНИЕ ВтВПути КАК ВтВПути
	               |		ПО ДокЗаявка.КодТовара = ВтВПути.КодТовара
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ДопДанные КАК ДопДанные
	               |		ПО ДокЗаявка.КодТовара = ДопДанные.КодТовара
	               |ГДЕ
	               |	ДокЗаявка.Ссылка = &Заявка";
	
	Запрос.УстановитьПараметр("ТекДата",ТекущаяДата());
	Запрос.УстановитьПараметр("Контракт",Основание.Контракт);
	Запрос.УстановитьПараметр("Производитель",Основание.Производитель);
	Запрос.УстановитьПараметр("Заявка",Основание);

	ТЗЗаказа = Запрос.Выполнить().Выгрузить();
	
	
	Для каждого стр из ВладелецФормы.ЭлементыФормы.Товар.Значение Цикл
			НайденнаяСтрока = ТЗЗаказа.Найти(стр.КодТовара,"КодТовара");
			Если НЕ НайденнаяСтрока = Неопределено Тогда	
				НайденнаяСтрока.ПодтвержденнаяПотребность = стр.ПодтвержденнаяПотребность;
				НайденнаяСтрока.ЦенаОтпускнаяОптСНДС = стр.ЦенаОтпускнаяОптСНДС;
			КонецЕсли;
	КонецЦикла;
		
	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	Если ЗначениеЗаполнено(Основание) Тогда
		
		ЗаполнитьТаблицу();

		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыкнПеренестиВДокумент(Кнопка)
	
	ОповеститьОВыборе(ТЗЗаказа);
	
КонецПроцедуры


Процедура ОсновныеДействияФормыкнЗаполнитьДаннымиЗаказа(Кнопка)
	
	Для каждого стр из ТЗЗаказа Цикл
		Если стр.ВПути > 0 Тогда
			стр.ПодтвержденнаяПотребность = стр.ВПути;
			стр.ЦенаОтпускнаяОптСНДС = стр.ЦенаОтпускнаяОптСНДСИзЗаявки;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура СпособОтображенияЗаказаПриИзменении(Элемент)
	
	ЗаполнитьТаблицу();
	
КонецПроцедуры

Процедура ТЗЗаказаПотребностьПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры

СпособОтображенияЗаказа = "ПолнаяЗаявка";
