


Процедура КоманднаяПанель1Действие(Кнопка)
	Если ЭтаФорма.ТолькоПросмотр Тогда
		Предупреждение("Редактирование документа запрещено!");
		ВОЗВРАТ ;
	КонецЕсли; 
	
	
	
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.ПолучитьФорму("ДляВыбораВПереоценку","",КлючУник);
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ВладелецФормы=ЭтаФорма;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.ОткрытьМодально(0);

КонецПроцедуры


Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	// Назначение:
	// Обрабатывает событие окончания подбора из формы подбора АП
	// На вход получает ТЗ товара
	// Циклически запускает обработку добавления и расчета строки документа
	//============================================================================ GtG ===
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда
		
		//------------------<Это выбор из справочника АП без серий партий и т.п.>-------------------GtG----25.12.2007
		Если  ЗначениеВыбора.Колонки.количество()=4 ТОгда
			
			Для каждого СтрВ из ЗначениеВыбора Цикл
				
				 Стр=Товар.Добавить();
				 Стр.Товар=СтрВ.Товар;
				 Стр.ЕИТ=СтрВ.Еит;
				 Стр.К=СтрВ.К;
							
				
			КонецЦикла;	
			
			 
			
			
			
			
		КонецЕсли;
		
		
		Для Ы=0 По ЗначениеВыбора.Количество()-1 Цикл
			
			  //СтрТЗ= ЗначениеВыбора.Получить(Ы) ;
			  //
			  //ВыбТовар=СтрТЗ.Товар;
			  //ВыбКолво=СтрТЗ.Колво;
			  
			  //ДобавитьТоварКолво(ВыбТовар,ВыбКолво,Справочники.Серии.ПустаяСсылка());
		
		КонецЦикла;
	КонецЕсли; 
КонецПроцедуры



Процедура ПодборПоАПНажатиеСПартиями(Элемент)
	// Назначение:
	// Запускает процесс подбора по справочнику АП
	// Открывает форму для подбора АП
	//
	
	//  A H T U N G      D A N G E R ! ! ! 
	// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	// Подбор по остаткам партий БЕЗ записи в резерв подбора (чтоб не перекосило все нах!!!!!!)
	// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	
	
	
	////============================================================================ GtG ===
	//Если ЭтаФорма.ТолькоПросмотр Тогда
	//	Предупреждение("Редактирование документа запрещено!");
	//	ВОЗВРАТ ;
	//КонецЕсли; 
	//

	//
	//Если  ЭтотОбъект.ЭтоНовый() ТОгда
	//	 ЭтотОбъект.Записать();
	//КонецЕсли;	 
	//
	//
	//КлючУник=  Новый   УникальныйИдентификатор();
	//ФормаПодбора= ПолучитьОбщуюФорму("ОбщФормаПодборПоОстаткамСклада",ЭтаФорма,КлючУник);	
	//ФормаПодбора.МножественныйВыбор= ИСТИНА;
	//ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	//ФормаПодбора.Открыть();
КонецПроцедуры








Процедура ПриОткрытии()
	ЕСли ЭтотОбъект.ЭтоНовый()=Истина Тогда
		Статус=Перечисления.СтатусПеремещения.ЗагруженСоздан;
		Сотрудник=Параметрысеанса.ТекущийСотр.Ссылка;
	КонецЕсли; 	
	
	ОМ10_ЗаполнитьСписокПечФорм(ЭтотОбъект,СписокПечатныхФорм);
	
	Если Статус= Перечисления.СтатусПеремещения.ВыгруженНаАптеку и ПРоведен=Истина ТОгда
		ПРедупреждение("Этот документ уже выгружен на аптеку!. Не редактируется");
		
		ЭлементыФормы.Товар.ТолькоПросмотр=Истина;
		ЭлементыФормы.ПлюсМинусКРасценке.Доступность=Ложь;
		ЭлементыФормы.УстановитьЦенуПроцОтСтарой.Доступность=Ложь;
		ЭлементыФормы.Склад.Доступность=Ложь;
		ЭлементыФормы.Комментарий.Доступность=Ложь;
		ЭлементыФормы.Сотрудник.Доступность=Ложь;
		ЭлементыФормы.КоманднаяПанель1.Доступность=Ложь;
		ЭлементыФормы.Установить.Доступность=Ложь;
		ЭлементыФормы .ОсновныеДействияФормы.Доступность=Истина;
		ЭлементыФормы.Кнопка2.Доступность=Ложь;
	КонецЕсли; 	
	
КонецПроцедуры

Процедура КоманднаяПанель1ЦеныПоРасценке(Кнопка)
	
	
	
	ТХТ="ВЫБРАТЬ
	    |	ЦеныСрезПоследних.АП КАК Товар,
	    |	ЦеныСрезПоследних.ЦенаРознГТТ КАК Цена
	    |ИЗ
	    |	РегистрСведений.Цены.СрезПоследних КАК ЦеныСрезПоследних
	    |ГДЕ
	    |	ЦеныСрезПоследних.АП В(&СписокТОваров)
	    |	И ЦеныСрезПоследних.РЕГИОН = &Регион";
		
		Запрос=Новый Запрос;
		Запрос.Текст=ТХТ;
		Запрос.УстановитьПараметр("СписокТОваров",ТОвар.ВыгрузитьКолонку("Товар"));
		Запрос.УстановитьПараметр("Регион",Склад.Регион);
		
		ТЗ=Запрос.Выполнить().Выгрузить(); // цены на мимимальную еит товара 
		
		Для каждого Стр из ТОвар Цикл
			
			
			Рез=ТЗ.Найти(Стр.Товар,"ТОвар");
			
			Если Рез= Неопределено ТОгда
				Сообщить("Нет цены на товар "+Стр.Товар+"  ---  НИКОГДА НЕ РАСЦЕНЯЛСЯ?!");
				ПРодолжить;
			КонецЕсли; 	
			
			
			Стр.НоваяЦена=Рез.Цена*Стр.К+(Рез.Цена*Стр.К/100*ПлюсМинусКРасценке);
		КонецЦикла;	
		
	
КонецПроцедуры


Процедура КнопкаПечатьНажатие(Элемент)
		
	ОМ10_КнопкаПечатьНажатие (ЭтотОбъект,ЭтаФорма);
	
		
КонецПроцедуры

Процедура УстановитьНажатие(Элемент)
	Для каждого сТР из тоВАР Цикл
		Стр.НоваяЦена=Окр(Стр.СтараяЦена/100*УстановитьЦенуПроцОтСтарой,2);
	КонецЦикла;	
КонецПроцедуры

Процедура Кнопка2Нажатие(Элемент)
	Для каждого сТР из тОВАР Цикл
		ЦенаЗакупВЕИТДокумента=(Стр.Партия.ЦенаЗакуп/Стр.Партия.ЕИТЗакупки.К)*Стр.К;
		Стр.НоваяЦена=Окр(ЦенаЗакупВЕИТДокумента+ЦенаЗакупВЕИТДокумента/100*ЗакупкаПлюсПроцент,1); // до 1-го знака в большую сторону
		Стр.ПроцентНаценки=ОМ6_НаценкаОтЧегоЛибо(ЦенаЗакупВЕИТДокумента, Стр.НоваяЦена);
	КонецЦикла;	
КонецПроцедуры

Процедура ТоварПроцентНаценкиПриИзменении(Элемент)
	
	
	Стр=ЭлементыФормы.Товар.ТекущаяСтрока;
	ЦенаЗакупВЕИТДокумента=(Стр.Партия.ЦенаЗакуп/Стр.Партия.ЕИТЗакупки.К)*Стр.К;
	
	Стр.НоваяЦена=Окр(ЦенаЗакупВЕИТДокумента+ЦенаЗакупВЕИТДокумента/100*Элемент.Значение,1); // до 1-го знака в большую сторону
	
	Стр.ПроцентНаценки=ОМ6_НаценкаОтЧегоЛибо(ЦенаЗакупВЕИТДокумента, Стр.НоваяЦена);
	
КонецПроцедуры

Процедура ТоварНоваяЦенаПриИзменении(Элемент)
	Стр=ЭлементыФормы.Товар.ТекущаяСтрока;
	ЦенаЗакупВЕИТДокумента=(Стр.Партия.ЦенаЗакуп/Стр.Партия.ЕИТЗакупки.К)*Стр.К;
	Стр.ПроцентНаценки=ОМ6_НаценкаОтЧегоЛибо(ЦенаЗакупВЕИТДокумента, Стр.НоваяЦена);
КонецПроцедуры

Процедура ТоварПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Товар.ЖНВЛС=Истина ТОгда
		ОформлениеСтроки.ЦветФона=Новый Цвет(230, 255, 224);
	КонецЕсли;
	
	
	//Попытка
	//	ДатаПост=ДанныеСтроки.Партия.ДокументПоступления.дата;
	//	ОформлениеСтроки.Ячейки.ДатаПоступления.УстановитьТекст(Формат(ДатаПост,"ДФ=dd.MM.yyyy"));
	//	Если ТекущаяДата()-ДатаПост<60*24*60*60 ТОгда
	//		ОформлениеСтроки.ЦветФона=Новый Цвет(255, 0,0);
	//	КонецЕсли;	
	//Исключение
	//КонецПопытки;
		
	
КонецПроцедуры

Процедура ОкруглитьНовыеЦеныНажатие(Элемент)
	Для Каждого Стр из Товар цикл
		Стр.НоваяЦена=ОМ3_ОтброситьДо10Коп(Стр.НоваяЦена);
		ЦенаЗакупВЕИТДокумента=(Стр.Партия.ЦенаЗакуп/Стр.Партия.ЕИТЗакупки.К)*Стр.К;
	    Стр.ПроцентНаценки=ОМ6_НаценкаОтЧегоЛибо(ЦенаЗакупВЕИТДокумента, Стр.НоваяЦена);
	КонецЦикла;	
КонецПроцедуры

Процедура АвтоматическаяПереоценкаНажатие(Элемент)
	
	Если ЭтоНовый() или ЭтотОбъект.Модифицированность()=Истина ТОгда
		#Если Клиент Тогда
			Предупреждение("Для автоматической переоценки документ должен быть записан!", 2);
		#КонецЕсли	
		Возврат;
	КонецЕсли;

	
	МО_АвтоматическаяПереоценка();
КонецПроцедуры




ЗакупкаПлюсПроцент=1;



