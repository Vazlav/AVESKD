
Функция СоздатьПартию(стр)
	
	
	Поставщик = Фирма.ФирмаКакПоставщик.Код;
	ПоставщикИсходный = Поставщик;
	ПоставщикКомитентКод = 0;
	Если ЗначениеЗаполнено(ПоставщикКомитент) Тогда
		ПоставщикКомитентКод = ПоставщикКомитент.Код;
		ВидПоступления = 1; //Перечисления.ВидыПоступленияТоваров.Индекс(Док.ДоговорПоставкиКомиссия.ВидПоступленияТовара);
		ВидПоступленияИсходный = 0; //Перечисления.ВидыПоступленияТоваров.Индекс(Перечисления.ВидыПоступленияТоваров.Покупка);
	Иначе
		ВидПоступления = 0; //Перечисления.ВидыПоступленияТоваров.Индекс(Шапка.ВидПоступленияТовара);
		ВидПоступленияИсходный = 0; //ВидПоступления;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ФирмаКомитент) Тогда
		ФирмаИсходная = ФирмаКомитент.Код;
	Иначе
		ФирмаИсходная = Фирма.Код;
	КонецЕсли;	
	
	НоваяПартия = Справочники.УЗ_Партии.СоздатьЭлемент();
	НоваяПартия.УстановитьНовыйКод();
	Если НоваяПартия.Код = 0 Тогда // иногда не срабатывает УстановитьНовыйКод() и далее вылетает ошибка.  на 8.2 такой картины никогда не было
		#Если Клиент Тогда
			Сообщить("не сработал метод Партия.УстановитьНовыйКод(). Вызваем его повторно.");
		#КонецЕсли
		НоваяПартия.УстановитьНовыйКод();
	КонецЕсли;
	
	Если НоваяПартия.Код = 0 Тогда
		ВызватьИсключение "Код партии = 0";
	КонецЕсли;
	
	КодБезКС = "24"+Формат(Число(НоваяПартия.Код), "ЧЦ=10; ЧВН=; ЧГ=0");
	
	Если стр.Коэфф = 1 и стр.КоэффициентРазбивки > 1 Тогда
		Коэфф = стр.КоэффициентРазбивки;
	Иначе
		Коэфф = 1;
	КонецЕсли;
	
	
	НоваяПартия.Наименование        = ВычислитьКонтрольнуюСумму(КодБезКС);
	НоваяПартия.Баркод				= стр.Баркод;
	НоваяПартия.ДатаПоступления		= Дата;
	НоваяПартия.ДокументПоступления = Ссылка;
	НоваяПартия.КодТовара			= стр.КодТовара;
	НоваяПартия.К					= стр.КоэффициентРазбивки;
	НоваяПартия.НомерГТД			= стр.НомерГТД;
	НоваяПартия.Серия				= стр.Серия;
	НоваяПартия.СрокГодности		= стр.СрокГодности;
	НоваяПартия.СтавкаНДСЗакуп		= стр.СтавкаНДСЗакуп;
	НоваяПартия.СтавкаНДСРозн		= стр.СтавкаНДСРозн;
	НоваяПартия.ЦенаГосРегистрации	= стр.ЦенаГосРегистрации;
	НоваяПартия.ЦенаЗакуп			= стр.ЦенаЗакуп*Коэфф;
	НоваяПартия.ЦенаЗакупБезНДСРасчет = стр.ЦенаЗакупБезНДСРасчет*Коэфф;
	НоваяПартия.ЦенаПроизводителяБезНДС = стр.ЦенаПроизводителя;
	НоваяПартия.Производитель		= стр.Производитель;
	НоваяПартия.Поставщик			= Поставщик;
	НоваяПартия.ПоставщикИсходный	= ПоставщикИсходный;
	НоваяПартия.ВидПоступления		= ВидПоступления;
	НоваяПартия.ВидПоступленияИсходный = ВидПоступленияИсходный;
	НоваяПартия.ФирмаИсходная		= ФирмаИсходная;
	Если ЗначениеЗаполнено(ПоставщикКомитент) Тогда
		НоваяПартия.ПоставщикКомитентВнутренний		= ПоставщикКомитентКод;	
	КонецЕсли;
	НоваяПартия.Записать();
	
	
	
	Возврат НоваяПартия.Код;
	
	
КонецФункции

Процедура ОбновитьИтоги()
	
	ЭлементыФормы.ИтогиСуммаЗакуп.Заголовок = Формат(Товар.Итог("СуммаЗакуп"),"ЧЦ=10; ЧДЦ=2");
	ЭлементыФормы.ИтогиСуммаРозн.Заголовок = Формат(Товар.Итог("СуммаРозн"),"ЧЦ=10; ЧДЦ=2");
	ЭлементыФормы.ИтогиСуммаЗакупНДС.Заголовок = Формат(Товар.Итог("НДСЗакуп"),"ЧЦ=10; ЧДЦ=2");

	ТЗНДС = Товар.Выгрузить(,"СтавкаНДСЗакуп,НДСЗакуп");
	ТЗНДС.Свернуть("СтавкаНДСЗакуп","НДСЗакуп");
	
	Для каждого стр из ТЗНДС Цикл
		Если стр.СтавкаНДСЗакуп = 10 Тогда
			ЭлементыФормы.ИтогиСуммаЗакупНДС10.Заголовок = Формат(стр.НДСЗАкуп,"ЧЦ=10; ЧДЦ=2");
		ИначеЕсли стр.СтавкаНДСЗакуп = 18 или стр.СтавкаНДСЗакуп = 20 Тогда // НДС20/18
			ЭлементыФормы.ИтогиСуммаЗакупНДС18.Заголовок = Формат(стр.НДСЗАкуп,"ЧЦ=10; ЧДЦ=2");
		КонецЕсли;
	КонецЦикла;
	
	
КонецПроцедуры

Процедура ОбновлениеОтображения()
	
	ОбновитьИтоги();
	
КонецПроцедуры

Процедура ТоварПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	ЖВ = ДанныеСтроки.Товар.ЖНВЛС;
	Если  ЖВ = Ложь и ДанныеСтроки.ЦенаГосРегистрации > 0 ТОгда
		 //Это строка с ошибками расценки или подозрительная с точки зрения цен или сроков годности
		 ОформлениеСтроки.ЦветФона=Новый Цвет(255,0,0);
	 КонецЕсли;
	 
	 
	 Если ЖВ = Истина тогда
		 //ОформлениеСтроки.Шрифт.Жирный = Истина;
		 ОформлениеСтроки.Ячейки.ЖНВЛС.ЗначениеКартинки  =БиблиотекаКартинок.Здоровье;
	 КонецЕсли;	
	
КонецПроцедуры

Процедура ТоварПередУдалением(Элемент, Отказ)
	
////------------------<Контроль изменения серии задним числом>-------------------GtG---- 
//	ТХТ="ВЫБРАТЬ
//	    |	СУММА(ПартииЖНВЛСОбороты.КолвоРасход) КАК КолвоРасход,
//	    |	ПартииЖНВЛСОбороты.Регистратор КАК Регистратор
//	    |ИЗ
//	    |	РегистрНакопления.ПартииЖНВЛС.Обороты(
//	    |			&НачПериода,
//	    |			,
//	    |			Регистратор,
//	    |			Товар = &ВыбТовар
//	    |				И Склад = &ВыбСклад
//	    |				И Партия = &ВыбПартия) КАК ПартииЖНВЛСОбороты
//	    |
//	    |СГРУППИРОВАТЬ ПО
//	    |	ПартииЖНВЛСОбороты.Регистратор";
//	
//	
//	
//	ТСД=ЭлементыФормы.Товар.ТекущаяСтрока;
//	
//	Партия=ТСД.Партия;
//	
//	
//	Если Партия.Пустая()=Ложь тогда
//		
//		Запрос= Новый Запрос;
//		Запрос.Текст=ТХТ;
//		
//		Запрос.УстановитьПараметр("НачПериода",НачалоДня(Дата));
//		Запрос.УстановитьПараметр("ВыбТовар",ТСД.ТОвар);
//		Запрос.УстановитьПараметр("ВыбСклад",Склад);
//		Запрос.УстановитьПараметр("ВыбПартия",ТСД.Партия);
//		
//		ТЗ=Запрос.Выполнить().Выгрузить();
//		
//		Если ТЗ.Количество()>0 Тогда
//			Сообщить(""+ТСД.ТОвар+"   Партия: "+Партия);
//			Сообщить("УЖЕ БЫЛ РАСХОД ЭТОЙ Партии!");
//			Для Каждого Стр из ТЗ Цикл
//				Сообщить(""+Стр.Регистратор+" расход "+Стр.КолвоРасход);
//			КонецЦикла;
//			Отказ=Истина;  // отключает процесс выбора из справочника
//		КонецЕсли;//ТЗ.Количество()>0 
//	КонецЕсли;//Партия.Пустая()=Ложь	
//	Если Отказ = Ложь Тогда
//		Предупреждение("Если удалили случайно, то можно закрыть документ без сохранения!",5);		
//	КонецЕсли;
	
	
КонецПроцедуры

Функция ПроверкаЗаполненияКритическиВажныхЗначенийДляСтроки  (ТекСтрокаТЧ) 
    // Назначение:
	// проверяет заполнены ли поля Цена и ставка ндс
	// Возвращает истина или ложь
    // 
	//--------------------------------------------------------------------------------
	 Если ТекСтрокаТЧ.Количество=0 Тогда
		 Предупреждение("Не указано количество!");
		 Возврат Ложь;
	 Иначе
		 Возврат Истина;
	 КонецЕсли;
	 
КонецФункции

Процедура ПересчетСтрокиДокумента  (ТекСтрД, ИмяКол,БезВопросов= ЛОЖЬ) Экспорт
	 
	Если ИмяКол = "ЦенаЗакуп" или ИмяКол = "Количество" Тогда
		ТекСтрД.СуммаЗакуп				= ТекСтрД.ЦенаЗакуп*ТекСтрД.Количество;
		ТекСтрД.НДСЗакуп				= Окр(ТекСтрД.СуммаЗакуп - ТекСтрД.СуммаЗакуп/(1+ТекСтрД.СтавкаНДСЗакуп/100),2);
		ТекСтрД.СуммаЗакупБезНДС		= ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп;
		ТекСтрД.ЦенаЗакупБезНДС			= ТекСтрД.СуммаЗакупБезНДС/ТекСтрД.Количество;
		ТекСтрД.ЦенаЗакупБезНДСРасчет	= Окр((ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп)/(ТекСтрД.Количество*ТекСтрД.Коэфф),2)* ТекСтрД.Коэфф;
		ТекСтрД.СуммаЗакупБезНДСРасчет	= ТекСтрД.ЦенаЗакупБезНДСРасчет * ТекСтрД.Количество ;
		ТекСтрД.СуммаОстаткаОкругления	= (ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп) - ТекСтрД.СуммаЗакупБезНДСРасчет;
	КонецЕсли;	
	
	Если ИмяКол = "СуммаЗакуп" Тогда
		ТекСтрД.ЦенаЗакуп				= ТекСтрД.СуммаЗакуп/ТекСтрД.Количество;
		ТекСтрД.НДСЗакуп				= Окр(ТекСтрД.СуммаЗакуп - ТекСтрД.СуммаЗакуп/(1+ТекСтрД.СтавкаНДСЗакуп/100),2);
		ТекСтрД.СуммаЗакупБезНДС		= ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп;
		ТекСтрД.ЦенаЗакупБезНДСРасчет	= Окр((ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп)/(ТекСтрД.Количество*ТекСтрД.Коэфф),2)*ТекСтрД.Коэфф;
		ТекСтрД.ЦенаЗакупБезНДС			= ТекСтрД.СуммаЗакупБезНДС/ТекСтрД.Количество;
		ТекСтрД.СуммаЗакупБезНДСРасчет	= ТекСтрД.ЦенаЗакупБезНДСРасчет * ТекСтрД.Количество;
		ТекСтрД.СуммаОстаткаОкругления	= (ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп) - ТекСтрД.СуммаЗакупБезНДСРасчет;
	КонецЕсли;
	
	Если ИмяКол = "СтавкаНДСЗакуп" Тогда
		ТекСтрД.НДСЗакуп				= Окр(ТекСтрД.СуммаЗакуп - ТекСтрД.СуммаЗакуп/(1+ТекСтрД.СтавкаНДСЗакуп/100),2);
		ТекСтрД.СуммаЗакупБезНДС		= ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп;
		ТекСтрД.ЦенаЗакупБезНДСРасчет	= Окр((ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп)/(ТекСтрД.Количество*ТекСтрД.Коэфф),2)*ТекСтрД.Коэфф;
		ТекСтрД.ЦенаЗакупБезНДС			= ТекСтрД.ЦенаЗакупБезНДСРасчет;
		ТекСтрД.СуммаЗакупБезНДСРасчет	= ТекСтрД.ЦенаЗакупБезНДСРасчет * ТекСтрД.Количество;
		ТекСтрД.СуммаОстаткаОкругления	= (ТекСтрД.СуммаЗакуп - ТекСтрД.НДСЗакуп) - ТекСтрД.СуммаЗакупБезНДСРасчет;
	КонецЕсли;	

	Если ИмяКол = "ЦенаРозн" Тогда
		ТекСтрД.СуммаРозн = ТекСтрД.ЦенаРозн*ТекСтрД.Количество;
	КонецЕсли;
	
	Если ИмяКол = "СуммаРозн" Тогда
		ТекСтрД.ЦенаРозн = Окр(ТекСтрД.СуммаРозн/ТекСтрД.Количество,2);
	КонецЕсли;	

  
КонецПроцедуры


Процедура ТоварПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	 ТСД=ЭлементыФормы.Товар.ТекущаяСтрока;
	 ИмяТекКол=Элемент.ТекущаяКолонка.Имя;
	 
	 
	 Если (ИмяТекКол="Количество") Тогда
		 ИмяТекКол="Количество";
		 ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли; 
	 
	 Если ИмяТекКол="ЦенаЗакупБезНДС" Тогда
		 ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли; 
	 Если ИмяТекКол="СтавкаНДСЗакуп" Тогда
		 ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли; 
	 
	 Если ИмяТекКол="ЦенаРозн" Тогда
		 ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли; 
	 
	 Если ИмяТекКол="СуммаРозн" Тогда
		 ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли;
	 
	 Если ИмяТекКол="СуммаЗакуп" Тогда
		  ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли; 
	 Если ИмяТекКол="НДСЗакуп" Тогда
		 ПересчетСтрокиДокумента  (ТСД, ИмяТекКол);
		 ВОЗВРАТ ;
	 КонецЕсли; 
	 
	 //============================< Резервные затычки >================================GtG===

	 Если ИмяТекКол="" Тогда
		 ВОЗВРАТ ;
	 КонецЕсли; 

	
	
	
КонецПроцедуры

Процедура ТоварЕИТОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	ТС=ЭлементыФормы.ТОвар.ТекущаяСтрока;
	ТС.Коэфф= ВыбранноеЗначение.К;	
	
КонецПроцедуры

Процедура КоманднаяПанельТоваракнПодбор(Кнопка)
	
	ОтказПодбора = Ложь;
	Т = "";
	Если ЭтаФорма.ТолькоПросмотр Тогда
		Предупреждение("Редактирование документа запрещено!");
		Возврат;
	КонецЕсли; 
	
	Если Склад.Пустая() Тогда 
		Т = Т + Символы.ПС + "Не заполнен Склад.";
		ОтказПодбора = Истина;
	КонецЕсли;
	
	Если Фирма.Пустая() Тогда 
		Т = Т + Символы.ПС + "Не заполнена Фирма.";
		ОтказПодбора = Истина;
	КонецЕсли;	
	
	Если Склад.РаботаТолькоПоКомиссии Тогда
		Если ФирмаКомитент.Пустая() или ПоставщикКомитент.Пустая()  Тогда	
			Т = Т + Символы.ПС + "Не заполнены реквизиты комиссии ( закладка <Дополнительно> )";	
			ОтказПодбора = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ОтказПодбора = Истина Тогда
		Предупреждение(Т);
		Возврат;
	КонецЕсли;
	
	
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.ПолучитьФорму("ФормаДляПодбора","",КлючУник);
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ВладелецФормы=ЭтаФорма;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.ОткрытьМодально(0);

	
	
	
КонецПроцедуры

Процедура КоманднаяПанельТоваракнРасценить(Кнопка)
	
	ОМ6_КоманднаяПанельКнопкаРасценить(ЭтаФорма,ЭтотОбъект,Товар);	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОсновныеДействияФормыСохранить(Кнопка)
	
	Если Проведен = Истина Тогда
		Предупреждение("Документ НЕ сохранен. В проведенном документе пользуйтесь кнопкой <Провести>!");
		Возврат;
	КонецЕсли;
	
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Вы действительно хотите сохранить документ/изменения?",Режим,0);
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		Записать(РежимЗаписиДокумента.Запись);
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыкнВыгрузить(Кнопка)
	
	Если Проведен = Истина Тогда 
		Если Статус = Перечисления.СтатусПрихода.ВыгруженНаАптеку Тогда
			Режим = РежимДиалогаВопрос.ДаНет;
			Ответ = Вопрос("Документ был ранее выгружен в аптеку. ВЫГРУЗИТЬ еще раз?", Режим, 0);
			Если Ответ = КодВозвратаДиалога.Нет Тогда
				Возврат;
			КонецЕсли;
		Иначе
			Режим = РежимДиалогаВопрос.ДаНет;
			Ответ = Вопрос("Вы действительно хотите выгрузить документ в аптеку?", Режим, 0);
			Если Ответ = КодВозвратаДиалога.Нет Тогда
				Возврат;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ВыгрузитьВАптеку() = Истина Тогда
			Предупреждение("Документ выгружен!",10);
		Иначе
			Предупреждение("Документ не выгружен!",10);
		КонецЕсли;
		ЭтаФорма.Закрыть();
	Иначе
		Предупреждение("Документ не проведен. Выгрузка невозможна",10);
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура КоманднаяПанельТоваракнДвижениеПоПартии(Кнопка)
	
	
	ТСД=ЭлементыФормы.Товар.ТекущаяСтрока;
	
	Карточка=Отчеты.УЗ_ДвижениеТовара.Создать();
	
	Карточка.КодПартии=ТСД.КодПартии;
	Карточка.ВыбСклад=Склад;
	Карточка.ВыбТовар=ТСД.ТОвар;
	Карточка.ВыбФирма=Фирма;
	Карточка.НачПер=НачалоГода(Дата);
	Карточка.КонПер=Дата;
	
	Ф=Карточка.ПолучитьФорму("Форма");
	
	Ф.Открыть();

	
КонецПроцедуры


Процедура ДобавитьТовар(СтрокаДобавления) 
    // Назначение:
	// Добавляет строку товара в документ
	// выполняет расчет числовых полей
    // 
	//--------------------------------------------------------------------------------
	
	ПарамПоиска = Новый  Структура;
	ПарамПоиска.Вставить("Товар",СтрокаДобавления.Товар);
	ПарамПоиска.Вставить("ЦенаЗакупБезНДС",СтрокаДобавления.ЦенаБезНДС);
	ПарамПоиска.Вставить("СтавкаНДСЗакуп",СтрокаДобавления.СтавкаНДС);
	ПарамПоиска.Вставить("Коэфф",СтрокаДобавления.ЕИТ.К);

	
	
	МассивНайденныхСтрок= Товар.НайтиСтроки(ПарамПоиска);
	
	Если МассивНайденныхСтрок.Количество()=0 Тогда
		
		
			//----------------------------< Добавляем только при добавлении КоэффДобавления=1  >--------------------------------GtG---
			НоваяСтрока=Товар.Добавить();
			НоваяСтрока.КодТовара=СтрокаДобавления.Товар.Код;
			НоваяСтрока.Товар=СтрокаДобавления.Товар;
			НоваяСтрока.Количество=СтрокаДобавления.Количество;
			НоваяСтрока.СтавкаНДСЗакуп=СтрокаДобавления.СтавкаНДС;
			НоваяСтрока.СтавкаНДСРозн = СтрокаДобавления.СтавкаНДС;
			НоваяСтрока.ЦенаГосРегистрации=0;
			//-----------------< единица  >----------------GtG---
			НоваяСтрока.Коэфф=СтрокаДобавления.ЕИТ.К;
			НоваяСтрока.КоэффициентРазбивки=СтрокаДобавления.Товар.ЕдиницаПоУмолчанию.К;
	        НоваяСтрока.ЦенаЗакупБезНДС = СтрокаДобавления.ЦенаБезНДС;
			НоваяСтрока.СуммаЗакупБезНДС = СтрокаДобавления.СуммаБезНДС;
			НоваяСтрока.ЦенаЗакуп = НоваяСтрока.ЦенаЗакупБезНДС + Окр(НоваяСтрока.ЦенаЗакупБезНДС/100*СтрокаДобавления.СтавкаНДС,2); 
			НоваяСтрока.СуммаЗакуп = НоваяСтрока.Количество*НоваяСтрока.ЦенаЗакуп;
			
			ОбщСтрокаВТ=НоваяСтрока;
			ПересчетСтрокиДокумента  (ОбщСтрокаВТ, "СуммаЗакуп", ИСТИНА);// пересчитывает ничего не спрашивая		
			//-----------------< создаем партию  >----------------GtG--- 
			НоваяСтрока.КодПартии=СоздатьПартию(НоваяСтрока);
			
	Иначе
		СтрокаВТ=МассивНайденныхСтрок[0];
		СтрокаВТ.Количество=СтрокаВТ.Количество+СтрокаДобавления.Количество;
		ПересчетСтрокиДокумента  (ОбщСтрокаВТ, "СуммаЗакуп", ИСТИНА);// пересчитывает ничего не спрашивая
		ОбщСтрокаВТ=СтрокаВТ;
		
	КонецЕсли; 
	
	
	
	
	РезДобавления=ОбщСтрокаВТ;


	
 КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда
		Для Ы=0 По ЗначениеВыбора.Количество()-1 Цикл
			
		      СтрТЗ= ЗначениеВыбора.Получить(Ы) ;
			  
			  ДобавитьТовар(СтрТЗ);
		
		КонецЦикла;
	ИначеЕсли ТипЗнч(ЗначениеВыбора) = Тип("СправочникСсылка.МестаХранения") Тогда
		Склад = ЗначениеВыбора;
		Фирма = Склад.Фирма;
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура СкладПриИзменении(Элемент)
	
	Если Элемент.Значение.Фирма <> Фирма Тогда
		Фирма = Элемент.Значение.Фирма;
	КонецЕсли;
	
	Если Элемент.Значение.ТипСклада = Перечисления.ТипыМХ.Опт Тогда
		ЭлементыФормы.Товар.Колонки.ЦенаРозн.Видимость=Ложь;
		ЭлементыФормы.Товар.Колонки.СуммаРозн.Видимость=Ложь;

	Иначе
		ЭлементыФормы.Товар.Колонки.ЦенаРозн.Видимость=Истина;
		ЭлементыФормы.Товар.Колонки.СуммаРозн.Видимость=Истина;
	КонецЕсли;		
	
КонецПроцедуры

Процедура ФирмаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если (Склад.Фирма <> ВыбранноеЗначение) и (НЕ Склад.Пустая()) Тогда
		Предупреждение("Нельзя выбрать фирму отличную от фирмы по уже выбранной ранее аптеке!"	);
		ВыбранноеЗначение = Фирма;
	КонецЕсли;	
	
КонецПроцедуры

Процедура КоманднаяПанельОшибкиНайтиСтрокуВТаблицеТовара(Кнопка)
	
	Если ОшибкиРасценки.Количество()=0 Тогда
		Возврат;
	КонецЕсли;	
	ОшПартия=ЭлементыФормы.ОшибкиРасценки.ТекущаяСтрока.Партия;
	Стр=Товар.Найти(ОшПартия,"Партия");
	ЭлементыФормы.ПанельТовара.ТекущаяСтраница = ЭлементыФормы.ПанельТовара.Страницы.СтраницаТовара;
	ЭлементыФормы.Товар.ТекущаяСтрока=Стр;	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	
	Если ЭтоНовый()=Истина Тогда
		Если НеудачныйВводНаОсновании=Истина ТОгда
		 	ЭтаФорма.Закрыть();
		КонецЕсли; 
		ВидВводаОстатков = Перечисления.ВидыВводаОстатков.Обычный;
		ДАта=ТекущаяДата();
		
	Иначе
		ДатаЗапрета = НастройкаПравДоступа.ВернутьДатуЗапретаРедактирования(Склад);
		Если Дата <= ДатаЗапрета Тогда
			ЭтаФорма.ТолькоПросмотр = Истина;
		КонецЕсли;
	КонецЕсли;  
	
	Если Склад.ТипСклада = Перечисления.ТипыМХ.Опт Тогда
		ЭлементыФормы.Товар.Колонки.ЦенаРозн.Видимость=Ложь;
		ЭлементыФормы.Товар.Колонки.СуммаРозн.Видимость=Ложь;
	Иначе
		ЭлементыФормы.Товар.Колонки.ЦенаРозн.Видимость=Истина;
		ЭлементыФормы.Товар.Колонки.СуммаРозн.Видимость=Истина;
	КонецЕсли;
	
	
	ОМ10_ЗаполнитьСписокПечФорм(ЭтотОбъект,СписокПечатныхФорм);
	
	Если Проведен=Истина ТОгда
		
		ЭлементыФормы.НадписьПроведения.Заголовок = "ДОКУМЕНТ ПРОВЕДЕН!!!";

		Если Не РольДоступна("НачПриемногоОтдела") Тогда
			ЭтаФорма.ТолькоПросмотр=Истина;
		КонецЕсли;
		
	КонецЕсли; 
	
	
КонецПроцедуры


Процедура КоманднаяПанель2кнПечать(Кнопка)
	
	ОМ10_КнопкаПечатьНажатие(ЭтотОбъект,ЭтаФорма);	
	
КонецПроцедуры

Процедура ТоварПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	Если ЭтаФорма.ТолькоПросмотр Тогда
		Предупреждение("Редактирование документа запрещено!",5);
		Возврат ;
	КонецЕсли; 
	
	
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.ПолучитьФорму("ФормаДляПодбора","",КлючУник);
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ВладелецФормы=ЭтаФорма;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.ОткрытьМодально(0);	
	
КонецПроцедуры

Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	Если НеудачныйВводНаОсновании = Истина Тогда
		Предупреждение("КОПИРОВАТЬ ВВОД ОСТАТКОВ ТОВАРА НЕЛЬЗЯ!",5);
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если ЭтоНовый() Тогда
		Статус=Перечисления.СтатусПрихода.Черновик;
	КонецЕсли; 
	
КонецПроцедуры

Процедура кнОбновитьИсториюИзмененийНажатие(Элемент)
	
	
	 ТХТ = "ВЫБРАТЬ
	       |	ИзмененияПоступленийВАптеке.Документ,
	       |	ИзмененияПоступленийВАптеке.ИД КАК ИД,
	       |	ИзмененияПоступленийВАптеке.ДатаИзменения,
	       |	ИзмененияПоступленийВАптеке.Действие,
	       |	ИзмененияПоступленийВАптеке.ТабНомер,
	       |	ИзмененияПоступленийВАптеке.ФИО,
	       |	ИзмененияПоступленийВАптеке.НомерДокАптеки
	       |ИЗ
	       |	РегистрСведений.ИзмененияПоступленийВАптеке КАК ИзмененияПоступленийВАптеке
	       |ГДЕ
	       |	ИзмененияПоступленийВАптеке.Документ = &Документ
	       |
	       |УПОРЯДОЧИТЬ ПО
	       |	ИД";
	
		   
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Документ",Ссылка);
	ТЗИзмененийВАптеке = Запрос.Выполнить().Выгрузить();	
	
КонецПроцедуры

Процедура ПослеЗаписи()
	
	Если Проведен Тогда
		ЭлементыФормы.НадписьПроведения.Заголовок = "ДОКУМЕНТ ПРОВЕДЕН!";
	КонецЕсли;

КонецПроцедуры

Процедура ТоварЦенаПроизводителяПриИзменении(Элемент)
	
	ТСД= ЭлементыФормы.Товар.ТекущаяСтрока;
	МО_ПроверкаЦеныПроизводителя(ТСД);

	
КонецПроцедуры

Процедура ПоказатьИсторию()
	
	ИсторияИзменений.Очистить();
	
	ТЗИстории = ОбщегоНазначения.ПолучитьИсториюИзмененийДокумента(Ссылка);
	Если НЕ ТЗИстории = Неопределено Тогда
		ЭлементыФормы.ИсторияИзменений.Значение = ТЗИстории;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПанельШапкиПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если Элемент.ТекущаяСтраница = Элемент.Страницы.СтраницаИстории Тогда
		ПоказатьИсторию();
	КонецЕсли;
	
КонецПроцедуры

