Перем КоличествоСтрокТЧ;
//Перем ИндексТекСтроки;

Процедура ПриИзмененииРеквизитовФормы()
КонецПроцедуры

Процедура ОбновитьДанныеВТабличнойЧасти()
	
	Владелец = ЭтаФорма.ВладелецФормы;
	ТекСтрока = Владелец.Товар[ИндексТекСтроки];

	ТекСтрока.ЦенаРознПол = ЦенаРознПол;
	ТекСтрока.СуммаРознПол = СуммаРознПол;
	ТекСтрока.НДСРознПол = ОМ3_ПолучитьНДСПоСуммеСНДСИСтавке(СуммаРознПол,СтавкаНДС);
	ТекСтрока.ПроцентРознНацПол = НаценкаРознПол;
	
	
КонецПроцедуры

Процедура ЗаполнитьДанныеФормы()
	
	Владелец = ЭтаФорма.ВладелецФормы;
	ТекСтрока = Владелец.Товар[ИндексТекСтроки];
	Владелец.ЭлементыФормы.Товар.ТекущаяСтрока = ТекСтрока;
	КолонкиТабЧасти = Владелец.ЭлементыФормы.Товар.Колонки;	
	КоличествоКолонок = КолонкиТабЧасти.Количество();
	
	Для н= 1 по КоличествоКолонок-1 Цикл
		ИмяКолонки = КолонкиТабЧасти.Получить(н).Имя;
		Элемент = ЭлементыФормы.Найти(ИмяКолонки);
		Если Элемент = Неопределено Тогда
			Продолжить;
		Иначе
			Элемент.Значение = ТекСтрока[ИмяКолонки];
		КонецЕсли;
	КонецЦикла;
	
	
	Если ЦенаЗакуп > 0 Тогда
		НаценкаРознПол = Окр((ЦенаРознПол/ЦенаЗакуп-1)*100,2);
		Если СтавкаНДС.Ставка > 0 Тогда
			ЦенаЗакупБезНДС = Окр(ЦенаЗакуп/(1+СтавкаНДС.Ставка/100),2);
		КонецЕсли;
	КонецЕсли;
	
	КоэффПрихода = Партия.К;
	Если КоэффПрихода > 1 и Коэфф = 1 Тогда
		ЦенаПроизводителя = Партия.ЦенаПроизводителяБезНДС/КоэффПрихода;	
		
		Если ЦенаПроизводителя > 0 Тогда
			ПроцентОпт = Окр((ЦенаЗакупБезНДС/ЦенаПроизводителя-1)*100,2);
		КонецЕсли;
		
	КонецЕсли;
	
	ЭлементыФормы.ТекстЖизненноважный.Заголовок = ?(Товар.ЖНВЛС = Истина,"Жизненноважный","");
	
	ГруппаНаценки = Товар.ГруппаНаценки;

		  
	//ТХТ = "ВЫБРАТЬ ПЕРВЫЕ 1
	//	  |	ПартииЖНВЛС.Период КАК ДатаПоступления,
	//	  |	ПартииЖНВЛС.Партия.Поставщик.Наименование КАК Поставщик,
	//	  |	ПартииЖНВЛС.Партия.ЦенаЗакуп как ЦенаЗакуп,
	//	  |	ПартииЖНВЛС.СтавкаНДС.Ставка КАК СтавкаНДСЧисло,
	//	  |	ПартииЖНВЛС.Партия.ЦенаПроизводителяБезНДС КАК ЦенаПроизводителя,
	//	  |	ПартииЖНВЛС.СуммаРознСНДС / ПартииЖНВЛС.Колво КАК ЦенаРозн,
	//	  | ПартииЖНВЛС.Колво как КоличествоПрихода
	//	  |ИЗ
	//	  |	РегистрНакопления.ПартииЖНВЛС КАК ПартииЖНВЛС
	//	  |ГДЕ
	//	  |	ПартииЖНВЛС.Склад = &Склад
	//	  |	И ПартииЖНВЛС.Товар = &Товар
	//	  |	И ПартииЖНВЛС.ВидОперации В(&СписокОпераций)
	//	  |
	//	  |УПОРЯДОЧИТЬ ПО
	//	  |	ДатаПоступления УБЫВ";		  
	//	  
	//СписокОпераций = Новый СписокЗначений;
	//СписокОпераций.Добавить(Перечисления.ВидыОпераций.ПоступлениеТМЦ);
	//СписокОпераций.Добавить(Перечисления.ВидыОпераций.Переоценка);
	//
	//Запрос = Новый Запрос;
	//Запрос.Текст = ТХТ;
	//Запрос.УстановитьПараметр("Товар",Товар);	
	//Запрос.УстановитьПараметр("Склад",ЭтаФорма.ВладелецФормы.Склад);
	//Запрос.УстановитьПараметр("СписокОпераций",СписокОпераций);
	//Рез = Запрос.Выполнить();
	//Если Рез.Пустой() Тогда
		ЭлементыФормы.ПоследнийПоставщикПоставки.Заголовок = "";
		ПоследняяДатаПоставки = ОМ3_ПустаяДата();
		ПоследняяЦенаЗакуп = 0;
		ПоследняяЦенаЗакупСНДС = 0;
		ПоследняяЦенаРозн = 0;
		ПоследнееКоличествоПрихода = 0;
	//Иначе
	//	Выборка = Рез.Выбрать();
	//	Выборка.Следующий();
	//	ЭлементыФормы.ПоследнийПоставщикПоставки.Заголовок = СокрЛП(Выборка.Поставщик);
	//	ПоследняяДатаПоставки = Выборка.ДатаПоступления;
	//	ПоследняяЦенаЗакуп = Окр(Выборка.ЦенаЗакуп/(1+Выборка.СтавкаНДСЧисло/100),2);
	//	ПоследняяЦенаЗакупСНДС = Окр(Выборка.ЦенаЗакуп,2);
	//	ПоследняяЦенаРозн = Выборка.ЦенаРозн;
	//	ПоследнееКоличествоПрихода = Выборка.КоличествоПрихода;
	//КонецЕсли;
	
	
	//ТХТ = "ВЫБРАТЬ
	//|	СУММА(ПартииЖНВЛСОстатки.КолвоОстаток / ПартииЖНВЛСОстатки.Партия.К) КАК Остаток
	//|ИЗ
	//|	РегистрНакопления.ПартииЖНВЛС.Остатки(
	//|			,
	//|			Товар = &Товар
	//|				И Склад = &Склад) КАК ПартииЖНВЛСОстатки";
	ЭлементыФормы.ПолеОстатков.Очистить();
	
	ТХТ = "ВЫБРАТЬ
	      |	ПартииЖНВЛСОстатки.Партия.ДатаПоступления КАК ДатаПрихода,
	      |	ПартииЖНВЛСОстатки.КолвоОстаток / ПартииЖНВЛСОстатки.Партия.К КАК Остаток,
	      |	ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток / ПартииЖНВЛСОстатки.КолвоОстаток * ПартииЖНВЛСОстатки.Партия.К КАК ЦенаРозн
	      |ИЗ
	      |	РегистрНакопления.ПартииЖНВЛС.Остатки(
	      |			,
	      |			Товар = &Товар
	      |				И Склад = &Склад) КАК ПартииЖНВЛСОстатки
	      |ГДЕ
	      |	ПартииЖНВЛСОстатки.КолвоОстаток > 0
	      |	И ПартииЖНВЛСОстатки.Партия.К > 0
	      |
	      |УПОРЯДОЧИТЬ ПО
	      |	ДатаПрихода УБЫВ";
	
     Запрос = Новый ПостроительОтчета;
	 запрос.Текст = ТХТ;
	 Запрос.Параметры.Очистить();
	 Запрос.Параметры.Вставить("Товар",Товар);
	 Запрос.Параметры.Вставить("Склад",ЭтаФорма.ВладелецФормы.СкладПолучатель);
	 Запрос.Выполнить();
	 
	 //Запрос = Новый Запрос;	  
	 //Запрос.Текст = ТХТ;
	 //Запрос.УстановитьПараметр("Товар",Товар);	
	 //Запрос.УстановитьПараметр("Склад",ЭтаФорма.ВладелецФормы.Склад);
	 //Рез = Запрос.Выполнить();
	 //Если Рез.Пустой() Тогда
	 //	ОстатокВАптеке = 0;		
	 //Иначе
	 //	Выборка = Рез.Выбрать();
	 //	Выборка.Следующий();
	 //	ОстатокВАптеке = Выборка.Остаток;	
	 //КонецЕсли;	
	 Макет = Запрос.Макет;
	 
	 Запрос.Макет = Неопределено;
	 ТекущаяОбласть = Неопределено;
	 
	 // Осуществим поиск ячейки, в которой находится параметр - Количество 
	 ТекущаяОбласть = Неопределено;
	 Пока Истина Цикл
		 ОбработкаПрерыванияПользователя();
	 ТекущаяОбласть = Макет.НайтиТекст("ДатаПрихода", ТекущаяОбласть, Макет.Область(), 
	 Истина, Истина, Истина, Ложь); 
	 Если ТекущаяОбласть <> Неопределено Тогда 
		 Если ТекущаяОбласть.Параметр = "ДатаПрихода" Тогда 
			 // Установим формат значения - два знака после запятой 
			 ТекущаяОбласть.Формат = "ДФ=dd.MM.yyyy"; 
			 ТекущаяОбласть.ШиринаКолонки = 15;
		 КонецЕсли; 
	 Иначе
		 Прервать;
	 КонецЕсли;
	 
	КонецЦикла; 
	 
	 
	 ТекущаяОбласть = Макет.НайтиТекст("Остаток", Неопределено, Макет.Область(), 
	 Истина, Истина, Истина, Ложь); 
	 Если ТекущаяОбласть <> Неопределено Тогда 
		 ТекущаяОбласть.ШиринаКолонки = 10;
	 КонецЕсли; 
	 
	 
	 ТекущаяОбласть = Макет.НайтиТекст("ЦенаРозн", Неопределено, Макет.Область(), 
	 Истина, Истина, Истина, Ложь); 
	 Если ТекущаяОбласть <> Неопределено Тогда 
		 ТекущаяОбласть.ШиринаКолонки = 10;
	 КонецЕсли; 




	Запрос.Макет = Макет;	
			
	
	Запрос.МакетОформления = ПолучитьМакетОформления(СтандартноеОформление.Трава);
	Запрос.ОформитьМакет();
	Запрос.ВыводитьЗаголовокОтчета = Ложь;
	
	Запрос.Вывести(ЭлементыФормы.ПолеОстатков);
	
	Если НЕ Запрос.Результат.Пустой() Тогда
		
		Выборка = Запрос.Результат.Выбрать();
		Выборка.Следующий();
		ПоследняяЦенаРозн = Выборка.ЦенаРозн;
	Иначе
		ПоследняяЦенаРозн = 0 ;
	КонецЕсли;
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	КоличествоСтрокТЧ =	ЭтаФорма.ВладелецФормы.Товар.Количество();
	ЗаполнитьДанныеФормы();
	Если Проведен = Истина Тогда
		ЭтаФорма.ТолькоПросмотр = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура СледующийНажатие(Элемент)
	
	Если Проведен = Ложь Тогда
		ОбновитьДанныеВтабличнойЧасти();
	КонецЕсли;
	
	Если ИндексТекСтроки = КоличествоСтрокТЧ - 1 Тогда
		Предупреждение("Конец таблицы");
		Возврат;
	КонецЕсли;
	ИндексТекСтроки = ИндексТекСтроки + 1;
	ЗаполнитьДанныеФормы();
	
КонецПроцедуры

Процедура ПредыдущийНажатие(Элемент)
	
	Если Проведен = Ложь Тогда
		ОбновитьДанныеВтабличнойЧасти();
	КонецЕсли;

	
	Если ИндексТекСтроки = 0 Тогда
		Возврат;
	КонецЕсли;	
	
	ИндексТекСтроки = ИндексТекСтроки - 1;
	ЗаполнитьДанныеФормы();
	
	
КонецПроцедуры

Процедура ЦенаРознПриИзменении(Элемент)
	
	//Надо вставить расчет предельно допустимой цены, если это ЖНВЛС
	
	СуммаРознПол = КоличествоФакт*ЦенаРознПол;
	НаценкаРознПол = Окр((ЦенаРознПол/ЦенаЗакуп-1)*100,2); 
	
КонецПроцедуры

Процедура ПрименитьПоследнююЦенуНажатие(Элемент)
	
	Если ПоследняяЦенаРозн = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЦенаРозн = ПоследняяЦенаРозн;
	ЦенаРознПриИзменении("");
	
КонецПроцедуры


Процедура НаценкаРознПриИзменении(Элемент)
	
	ЦенаРознПол = ЦенаЗакуп*(1+НаценкаРознПол/100);
	ЦенаРознПол = ОМ3_ОтброситьДо10Коп (ЦенаРознПол);	
	ЦенаРознПриИзменении("");

КонецПроцедуры

Процедура ОКНажатие(Элемент)
	
	Если Проведен = Ложь Тогда
		ОбновитьДанныеВтабличнойЧасти();
	КонецЕсли;

	ЭтаФорма.Закрыть();
	
КонецПроцедуры


Процедура ЦенаРознОкончаниеВводаТекста(Элемент, Текст, Значение, СтандартнаяОбработка)
	
	ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ЦенаРознПол;

КонецПроцедуры

Процедура ПрименитьГруппуНаценкиНажатие(Элемент)
	
	Если ГруппаНаценки.Пустая() = Ложь и ГруппаНаценки.Наценка > 0 Тогда
		НаценкаРознПол = ГруппаНаценки.Наценка;
		НаценкаРознПриИзменении("");
	КонецЕсли;

КонецПроцедуры

КоличествоСтрокТЧ = 0;