
Процедура КоманднаяПанель1кнЗаполнитьНаОсновании(Кнопка)
	
	Если НЕ ЗначениеЗаполнено(РегистрЗакрытияЗаказа) Тогда
		Предупреждение("Не выбран регистр закрытия заказа");
		Возврат;
	КонецЕсли;
	
	Если Товар.Количество() > 0 Тогда
		
		Режим = РежимДиалогаВопрос.ДаНет;
		Ответ = Вопрос("Таблица товара содержит записи. Очистить?", Режим, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
			Товар.Очистить();
		КонецЕсли;
		
	КонецЕсли;
	
	Если РегистрЗакрытияЗаказа = Перечисления.РегистрЗакрытияЗаказа.ЗаказПроизводителяОпт Тогда
		
		КлючУник=  Новый   УникальныйИдентификатор();
		ФормаПодбора= ПолучитьФорму("ПодборТовара");
		ФормаПодбора.МножественныйВыбор= ИСТИНА;
		ФормаПодбора.ВладелецФормы=ЭтаФорма;
		ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
		ФормаПодбора.Основание = ДокументОснование;
		ФормаПодбора.ДатаДокумента = Дата;
		Если Товар.Количество() = 0 Тогда
			ФормаПодбора.ТаблицаОчищена = Истина;
		Иначе
			ФормаПодбора.ТаблицаОчищена = Ложь;
		КонецЕсли;
		
		ФормаПодбора.ОткрытьМодально(0);
		
	КонецЕсли;
	     
КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда
		Товар.Очистить();
		Для каждого стр из ЗначениеВыбора Цикл
			Если стр.КоличествоФакт > 0 Тогда
				НоваяСтрока = Товар.Добавить();
				НоваяСтрока.КодТовара = стр.КодТовара;
				НоваяСтрока.Товар = стр.Товар;
				НоваяСтрока.Количество = стр.КоличествоФакт;
				НоваяСтрока.СуммаЗаказа = НоваяСтрока.Количество*стр.ЦенаЗаказа;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры


Процедура ТоварПередНачаломДобавления(Элемент, Отказ, Копирование)
	Если Копирование = Истина Тогда
		Отказ = Истина;
	КонецЕсли;
	КоманднаяПанель1кнЗаполнитьНаОсновании("");
КонецПроцедуры

Процедура ПоказатьИсторию()
	
	ИсторияИзменений.Очистить();
	
	ТЗИстории = ОбщегоНазначения.ПолучитьИсториюИзмененийДокумента(Ссылка);
	Если НЕ ТЗИстории = Неопределено Тогда
		ЭлементыФормы.ИсторияИзменений.Значение = ТЗИстории;
	КонецЕсли;
	
КонецПроцедуры


Процедура Панель1ПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если Элемент.ТекущаяСтраница = Элемент.Страницы.Изменения Тогда
		ПоказатьИсторию();
	КонецЕсли;	
	
КонецПроцедуры


Процедура ДокументОснованиеПриИзменении(Элемент)
	
	Производитель = ДокументОснование.Производитель;
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	Если ЭтоНовый() Тогда
		Дата = ТекущаяДата();
	КонецЕсли;
	
КонецПроцедуры

