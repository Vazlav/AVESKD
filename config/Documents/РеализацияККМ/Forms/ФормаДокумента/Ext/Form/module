
перем КСШД;
Перем КСТЧ1,КСТЧ2,КСТЧ3,КСТЧ4,КСТЧ5;




Процедура ПроверенПриИзменении(Элемент)
	// Назначение:
	// Отметка проверенности запись документа без проведения и закрытие формы
	// 
	// 
	//============================================================================ GtG ===
	
	Если Затычка=Истина ТОгда
		Предупреждение("ЗАТЫЧКУ НЕЛЬЗЯ ПРОВЕРЯТЬ! Себестоимость не списана, что за товар - неизвестно! Требуется выгрузка данных от аптеки!");
		Проверен=ЛОЖЬ;
		Возврат;
	КонецЕсли;	
	
	 СтрокаИзм=ЭтотОбъект.Изменения.Добавить();
	 СтрокаИзм.Дата=ТекущаяДата();
	 СтрокаИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр.Ссылка;
	 СтрокаИзм.КомментарийИзменения="Проверен - "+Формат(проверен,"БЛ=Нет; БИ=Да");

	
	ЭтотОбъект.Записать(РежимЗаписиДокумента.Запись,);
	
	 
КонецПроцедуры






Процедура ПодборПоАПНажатие(Элемент)

		// Назначение:
	// Запускает процесс подбора по справочнику АП
	// Открывает форму для подбора АП
	// 
	//============================================================================ GtG ===
	Если ЭтаФорма.ТолькоПросмотр Тогда
		Предупреждение("Редактирование документа запрещено!");
		ВОЗВРАТ ;
	КонецЕсли; 
	ЭтотОбъект. Записать(РежимЗаписиДокумента.Запись);
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= ПолучитьОбщуюФорму("ОбщФормаПодборПоОстаткамСклада",ЭтаФорма,КлючУник);	
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.Открыть();

КонецПроцедуры





Процедура ТоварПередНачаломДобавления(Элемент, Отказ, Копирование)
	Если ПараметрыСеанса.ТекущийСотр.Администратор=Ложь Тогда
		Отказ= ИСТИНА;
	КонецЕсли; 
КонецПроцедуры




//============================================================================ GtG ===
Процедура ДобавитьТоварКолво  (СтрТЗ) 
    // Назначение:
	// Добавляет строку товара в документ
	// выполняет расчет числовых полей
    // 
	//--------------------------------------------------------------------------------
	
	ВыбТовар	=СтрТЗ.ТОвар;
	ВыбПартия	=СтрТЗ.Партия;
	ВыбКолво	=СтрТЗ.Колво;
	
	ПарамПоиска = Новый  Структура;
	ПарамПоиска.Вставить("Товар",ВыбТовар);
	ПарамПоиска.Вставить("ЕИТ",СтрТЗ.Ед);
    ПарамПоиска.Вставить("Партия",СтрТЗ.Партия);
	
	
	МассивНайденныхСтрок= Товар.НайтиСтроки(ПарамПоиска);
	
	Если МассивНайденныхСтрок.Количество()=0 Тогда
		
		
					//----------------------------< Добавляем только при добавлении КоэффДобавления=1  >--------------------------------GtG---
			НоваяСтрокаВыбТовара=Товар.Добавить();
			НоваяСтрокаВыбТовара.Товар=ВыбТовар;
			НоваяСтрокаВыбТовара.КоличествоФакт=ВыбКолво;
			НоваяСтрокаВыбТовара.СтавкаНДС=СтрТЗ.СтавкаНДС;
			
			//-----------------< единица  >----------------GtG---
			НоваяСтрокаВыбТовара.ЕИТ=СтрТЗ.Ед;			
			НоваяСтрокаВыбТовара.Коэфф=НоваяСтрокаВыбТовара.ЕИТ.К;
			
			
			//----------------------------< партия >--------------------------------GtG---
			НоваяСтрокаВыбТовара.Партия=ВыбПартия;
			НоваяСтрокаВыбТовара.Серия=ВыбПартия.Серия;
			
			
				//----------------------------< Цены , суммы , НДСы >--------------------------------GtG---
			НоваяСтрокаВыбТовара.НДСРозн 	= СтрТЗ.НДСРозн;
			НоваяСтрокаВыбТовара.СуммаРозн 	= СтрТЗ.СуммаРозн;
			НоваяСтрокаВыбТовара.ЦенаРозн 	= СтрТЗ.СуммаРозн/ВыбКолво;
			НоваяСтрокаВыбТовара.СуммаЗакуп= СтрТЗ.СуммаЗакуп;
			НоваяСтрокаВыбТовара.НДСЗакуп=	СтрТЗ.НДСЗакуп;
			
			
					
	Иначе   // только при совпадении единиц измерения и партии

		СтрокаВТ=МассивНайденныхСтрок[0];
		СтрокаВТ.КоличествоФакт=СтрокаВТ.КоличествоФакт+ВыбКолво;
		
		
		СтрокаВТ.НДСЗакуп	= СтрокаВТ.НДСЗакуп+ СтрТЗ.НДСЗакуп;
		СтрокаВТ.НДСРозн 	= СтрокаВТ.НДСРозн + СтрТЗ.НДСРозн;
		СтрокаВТ.СуммаЗакуп = СтрокаВТ.СуммаЗакуп + СтрТЗ.СуммаЗакуп;
		СтрокаВТ.СуммаРозн 	= СтрокаВТ.СуммаРозн +	СтрТЗ.СуммаРозн;
		СтрокаВТ.ЦенаРозн 	= СтрокаВТ.СуммаРозн /СтрокаВТ.КоличествоФакт;
		
				
	КонецЕсли; 
	
 
 КонецПроцедуры
 //============================================================================ GtG ===
 





Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	// Назначение:
	// Обрабатывает событие окончания подбора из формы подбора АП
	// На вход получает ТЗ товара
	// Циклически запускает обработку добавления и расчета строки документа
	//============================================================================ GtG ===
	Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда
		Для Ы=0 По ЗначениеВыбора.Количество()-1 Цикл
			
		      СтрТЗ= ЗначениеВыбора.Получить(Ы) ;
			  
			  ВыбТовар=СтрТЗ.Товар;
			  ВыбКолво=СтрТЗ.Колво;
			  
			  ДобавитьТоварКолво(СтрТЗ);
		
		КонецЦикла;
	КонецЕсли; 
КонецПроцедуры


Процедура ПриОткрытии()
	
	Если Проверен=Истина ТОгда
		ЭтаФорма.ТолькоПросмотр=Истина;
		ПРедупреждение("Этот документ проверен бухгалтерией и не редактируется!");
	КонецЕсли;	
		
	//ОМ4_ПРиОткрытии(ЭтотОбъект,Товар,КСШД,КСТЧ1);
	//ОМ4_ПРиОткрытии(ЭтотОбъект,Дисконт,КСШД,КСТЧ2);
	
	
	//ОМ4_ПРиОткрытии(ЭтотОбъект,ДисконтБонусы,КСШД,КСТЧ5);
	
	ОМ10_ЗаполнитьСписокПечФорм(ЭтотОбъект,СписокПечатныхФорм);
	
	
	
	Если ПараметрыСеанса.ТекущийСотр.Администратор=Истина ТОгда
		ЭлементыФормы.Товар.ТолькоПросмотр=Ложь;
		ЭлементыФормы.Дисконт.ТолькоПросмотр=Ложь;
		ЭлементыФормы.СводПоТипамОплаты.ТолькоПросмотр=Ложь;
	Иначе
		ЭлементыФормы.Товар.ТолькоПросмотр=Истина;
	КонецЕсли; 
	
	
	
	
	
КонецПроцедуры



Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	ОМ41_ПередОткрытиемДокумента  (ЭтотОбъект,ЭтаФорма,Отказ);
	
		
КонецПроцедуры



Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	ЭтотОбъект.СуммаСоСкидкой=Бухгалтерия.Итог("СуммаСоСкидкой");
	//ЭтотОбъект.ЗаполнитьЗакупку();
	//ЭтотОбъект.ЗаполнитьСводПоТипамОплаты();
	//ОМ4_ПередЗаписью(ЭтотОбъект,Товар,КСШД ,КСТЧ1,"Товар");
	//ОМ4_ПередЗаписью(ЭтотОбъект,Дисконт,КСШД ,КСТЧ2,"ДК%",, ИСТИНА );
	//ОМ4_ПередЗаписью(ЭтотОбъект,ДисконтБонусы,КСШД ,КСТЧ5,"ДК бон.",, ИСТИНА);
	
КонецПроцедуры



Процедура КнопкаПечатьНажатие(Элемент)
		
	ОМ10_КнопкаПечатьНажатие (ЭтотОбъект,ЭтаФорма);
	
		
КонецПроцедуры

Процедура ПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	ТЗ=Бухгалтерия.Выгрузить();
	
	ТЗ.Свернуть("Касса,ЗетОчет,ТипОплаты","СуммаБезСкидки,СуммаСоСкидкой,СуммаСкидки,СуммаНДСБезСкидки,СуммаНДДСоСкидкой,ЗакупочнаяСНДС,НДСЗакуп");
	Для Каждого Стр Из АвансыПоУслугам Цикл
		ДобСтр=ТЗ.Добавить();
		ДобСтр.Касса =Стр.Касса;
		ДобСтр.ЗетОчет  =Стр.ЗетОчет;
		ДобСтр.ТипОплаты =Стр.ТипОплаты;
		ДобСтр.СуммаБезСкидки  =Стр.Сумма;
		ДобСтр.СуммаСоСкидкой =Стр.Сумма;
		ДобСтр.СуммаСкидки   =0;
		ДобСтр.СуммаНДСБезСкидки  =Стр.СуммаНДС;
		ДобСтр.СуммаНДДСоСкидкой =Стр.СуммаНДС;
		ДобСтр.ЗакупочнаяСНДС    =0;
		ДобСтр.НДСЗакуп          =0;
	КонецЦикла;	
	
	ТЗ.Свернуть("Касса,ЗетОчет,ТипОплаты","СуммаБезСкидки,СуммаСоСкидкой,СуммаСкидки,СуммаНДСБезСкидки,СуммаНДДСоСкидкой,ЗакупочнаяСНДС,НДСЗакуп");

	
	
	 ЭлементыФормы .ТЗИтогоПоКассам.Значение=ТЗ;
	 ЭлементыФормы.ТЗИтогоПоКассам.СоздатьКолонки();
	 
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("СуммаБезСкидки").ТекстПодвала=ТЗИтогоПоКассам.Итог("СуммаБезСкидки");
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("СуммаСоСкидкой").ТекстПодвала=ТЗИтогоПоКассам.Итог("СуммаСоСкидкой");
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("СуммаСкидки").ТекстПодвала=ТЗИтогоПоКассам.Итог("СуммаСкидки");
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("СуммаНДСБезСкидки").ТекстПодвала=ТЗИтогоПоКассам.Итог("СуммаНДСБезСкидки");
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("СуммаНДДСоСкидкой").ТекстПодвала=ТЗИтогоПоКассам.Итог("СуммаНДДСоСкидкой");
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("ЗакупочнаяСНДС").ТекстПодвала=ТЗИтогоПоКассам.Итог("ЗакупочнаяСНДС");
	 ЭлементыФормы.ТЗИтогоПоКассам.Колонки.Найти("НДСЗакуп").ТекстПодвала=ТЗИтогоПоКассам.Итог("НДСЗакуп");

	 
	 
	 
	 
	 ТЗ1=ТЗ.Скопировать();
	 ТЗ1.Свернуть("ТипОплаты","СуммаБезСкидки,СуммаСоСкидкой,СуммаСкидки,СуммаНДСБезСкидки,СуммаНДДСоСкидкой,ЗакупочнаяСНДС,НДСЗакуп");
	 
	 ЭлементыФормы.ИВО.Значение=ТЗ1;
	 ЭлементыФормы.ИВО.СоздатьКолонки();
	 
	 ЭлементыФормы.ИВО.Колонки.Найти("СуммаБезСкидки").ТекстПодвала=ИВО.Итог("СуммаБезСкидки");
	 ЭлементыФормы.ИВО.Колонки.Найти("СуммаСоСкидкой").ТекстПодвала=ИВО.Итог("СуммаСоСкидкой");
	 ЭлементыФормы.ИВО.Колонки.Найти("СуммаСкидки").ТекстПодвала=ИВО.Итог("СуммаСкидки");
	 ЭлементыФормы.ИВО.Колонки.Найти("СуммаНДСБезСкидки").ТекстПодвала=ИВО.Итог("СуммаНДСБезСкидки");
	 ЭлементыФормы.ИВО.Колонки.Найти("СуммаНДДСоСкидкой").ТекстПодвала=ИВО.Итог("СуммаНДДСоСкидкой");
	 ЭлементыФормы.ИВО.Колонки.Найти("ЗакупочнаяСНДС").ТекстПодвала=ИВО.Итог("ЗакупочнаяСНДС");
	 ЭлементыФормы.ИВО.Колонки.Найти("НДСЗакуп").ТекстПодвала=ИВО.Итог("НДСЗакуп");

	
	
КонецПроцедуры

Процедура КоличествоЧековПриИзменении(Элемент)
	Если КоличествоЧеков<>0 Тогда
		ССП= Бухгалтерия.Итог("СуммаСоСкидкой")/КоличествоЧеков;	
	КонецЕсли; 
КонецПроцедуры

Процедура СуммыПоЗетОтчетамПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
    
    СуммаАвансов=Авансы.Итог("Сумма");
    
	Дельта=ДанныеСтроки.ИтогоПоЗетОтчету-ДанныеСтроки.ВозвратыПоЗетОтчетуНал-ДанныеСтроки.ВозвратыПоЗетОтчетуБезНал-ДанныеСтроки.СуммаПоБазе;
	
	Если ДанныеСтроки.ВозвратыПоЗетОтчетуНал+ДанныеСтроки.ВозвратыПоЗетОтчетуБезНал<>0 Тогда
		 ОформлениеСтроки.ЦветФона = Новый Цвет(246, 255, 185); // жоптенький
	КонецЕсли; 	
	
    
  
    
	Если Дельта<>0 Тогда
			ОформлениеСтроки.ЦветФона = Новый Цвет(255,100,100);// кирасненький
	КонецЕсли;		
	
КонецПроцедуры

Процедура КоманднаяПанель1КарточкаТовара(Кнопка)
	
	ТСД=ЭлементыФормы.Товар.ТекущаяСтрока;
	
	Карточка=Отчеты.ДвижениеТовара1.Создать();
	
	Карточка.ВыбПартия=ТСД.Партия;
	
	Карточка.ВыбСклад=Склад;
	
	Карточка.ВыбТовар=ТСД.ТОвар;
	Карточка.ВыбФирма=Склад.Фирма;
	Карточка.НачПер=НачалоМесяца(Дата);
	Карточка.КонПер=Дата;
	
	
	Ф=Карточка.ПолучитьФорму("Форма");
	
	Ф.Открыть();
	
КонецПроцедуры

Процедура СкладОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Фирма = ВыбранноеЗначение.Фирма;
КонецПроцедуры

Процедура СкладПриИзменении(Элемент)
	
	Если Элемент.Значение.Фирма <> Фирма Тогда
		Фирма = Элемент.Значение.Фирма;
	КонецЕсли;
	
КонецПроцедуры










