
Процедура УправлениеНадписямиКнопок()
	
	Если Согласован = Ложь Тогда
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.кнСогласования.Текст = "Согласовать";
	Иначе
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.кнСогласования.Текст = "Отмена согласования";
	КонецЕсли;
	
	Если Проведен Тогда
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ОсновныеДействияФормыСохранить.Доступность = Ложь;
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.кнСогласования.Доступность = Ложь;
	Иначе
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.кнСогласования.Доступность = Истина;
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.ОсновныеДействияФормыСохранить.Доступность = Истина;
	КонецЕсли;

КонецПроцедуры

Процедура ОсновныеДействияФормыкнСогласования(Кнопка)
	
	Если СогласованиеДоступно() = Ложь Тогда
		Предупреждение("Недостаточно прав для согласования документа!");	
		Возврат;
	КонецЕсли;

	
	Если НЕ Проведен и Не Согласован Тогда
		Режим = РежимДиалогаВопрос.ДаНет;
		Ответ = Вопрос("Согласовать документ?", Режим, 0);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли; 
		
		Согласован = Истина;
		СогласованКем = ПараметрыСеанса.ТекущийСотр;
		
	ИначеЕсли НЕ Проведен  и Согласован Тогда 		
		Режим = РежимДиалогаВопрос.ДаНет;
		Ответ = Вопрос("Отменить согласование?", Режим, 0);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли; 
		
		Согласован = Ложь;
	Иначе
		Возврат;
	КонецЕсли;
	                               
	Изменение = Изменения.Добавить();
	Изменение.Дата = ТекущаяДата();
	Изменение.КомментарийИзменения = "Согласован = " + Согласован;
	Изменение.Сотрудник = ПараметрыСеанса.ТекущийСотр;
	Изменение.ТипИзм = Перечисления.ДействияНадДокументами.Изменение;
	
	Записать(РежимЗаписиДокумента.Запись);
	
	УправлениеНадписямиКнопок();
	
	
КонецПроцедуры

Процедура ПриОткрытии()	
	
	Если ЭтоНовый() Тогда
		Заявитель = ПараметрыСеанса.ТекущийСотр;
		Дата = ТекущаяДата();
	КонецЕсли;
	УправлениеНадписямиКнопок(); 	
	
КонецПроцедуры


Процедура КоманднаяПанель2Действие(Кнопка)
	
    ДВФ=Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Фильтр = НСтр("ru = 'Текст'; en = 'Text'") + "(*.pdf)|*.pdf";
	ДВФ.Фильтр = Фильтр;
	ДВФ.МножественныйВыбор = Ложь;
	
    ДВФ.Выбрать();
    
    Если ПустаяСтрока(ДВФ.ПолноеИмяФайла)=Ложь Тогда
        
        ДД=Новый ДвоичныеДанные(ДВФ.ПолноеИмяФайла);
        
        
        ХЗ=Новый ХранилищеЗначения (ДД, Новый СжатиеДанных(9));
		
		НоваяСтрока = Приложения.Добавить();
		НоваяСтрока.Наименование = "Приложение " + НоваяСтрока.НомерСтроки;
		НоваяСтрока.Приложение=ХЗ;
        НоваяСтрока.ИмяФайла=СтрЗаменить(ДВФ.ПолноеИмяФайла,ДВФ.Каталог,"");
 
    КонецЕсли;
	
	
КонецПроцедуры

Процедура КоманднаяПанель2ОткрытьПрицеп(Кнопка)
	
	ТС=ЭлементыФормы.Приложения.ТекущаяСтрока;
	Если ТС=Неопределено Тогда
		Предупреждение("Не выбрана строка вложения");
		Возврат;
	КонецЕсли;  
	
	ДД=ТС.Приложение.Получить(); // ДвоичныеДанные
	ИФ=ТС.ИмяФайла;
	
	ДД.Записать(КаталогВременныхФайлов()+"\"+ИФ);
	
	ЗапуститьПриложение(КаталогВременныхФайлов()+"\"+ИФ);
	
	
КонецПроцедуры

Процедура КоманднаяПанель2СохранитьФайлНаДиск(Кнопка)
	
    ТС=ЭлементыФормы.Приложения.ТекущаяСтрока;
    Если ТС=Неопределено Тогда
        Предупреждение("Не выбрана строка вложения");
        Возврат;
    КонецЕсли;  
    
    ДД=ТС.Приложение.Получить(); // ДвоичныеДанные
    ИФ=ТС.ИмяФайла;
    
    
    ДВФ=Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
    ДВФ.Выбрать();
    
    ДД.Записать(ДВФ.Каталог+"\"+ИФ);
    
    Сообщить("Приложение сохранено в "+ДВФ.Каталог+"\"+ИФ);
	
КонецПроцедуры

Функция СогласованиеДоступно()
	
	Если РольДоступна("ПрименениеФиксЦен") Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
	
КонецФункции

Процедура УправлениеДоступностьюКнопок()
	
	
	
КонецПроцедуры

Процедура КоманднаяПанель1кнСфоромировать(Кнопка)
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	АптекиКонкуренты.Владелец.Код КАК Код,
	               |	АптекиКонкуренты.Владелец КАК Аптека,
	               |	АптекиКонкуренты.Владелец.Наименование КАК Наименование
	               |ПОМЕСТИТЬ ВтАптеки
	               |ИЗ
	               |	Справочник.АптекиКонкуренты КАК АптекиКонкуренты
	               |ГДЕ
	               |	АптекиКонкуренты.Владелец.Бренд = &Бренд
	               |	И АптекиКонкуренты.Владелец.ПометкаУдаления = ЛОЖЬ
	               |	И АптекиКонкуренты.Владелец.ЭтоГруппа = ЛОЖЬ
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Код
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Ост.СкладКод КАК КодАптеки,
	               |	Ост.ПартияКод КАК КодПартии,
	               |	Ост.КоличествоОстаток КАК Остаток,
	               |	Партии.ДатаПоступления КАК ДатаПоставки,
	               |	Пост.Наименование КАК Поставщик,
	               |	Партии.ЦенаЗакуп,
	               |	ВЫБОР
	               |		КОГДА ВхЦены.ЦенаЗакупБезНДС ЕСТЬ NULL
	               |			ТОГДА Партии.ЦенаЗакуп
	               |		ИНАЧЕ ВхЦены.ЦенаЗакупБезНДС * (1 + ВхЦены.СтавкаНДС / 100)
	               |	КОНЕЦ КАК ВхЦенаЗакуп,
	               |	ВтАптеки.Аптека КАК Аптека,
	               |	ЕСТЬNULL(РЦП.Цена, ЕСТЬNULL(РЦ.Цена, 0)) КАК ЦенаРозн,
	               |	ВЫБОР
	               |		КОГДА Партии.ЦенаЗакуп > 0
	               |			ТОГДА ВЫРАЗИТЬ((ЕСТЬNULL(РЦП.Цена, ЕСТЬNULL(РЦ.Цена, 0)) / Партии.ЦенаЗакуп - 1) * 100 КАК ЧИСЛО(12, 2))
	               |		ИНАЧЕ 0
	               |	КОНЕЦ КАК НаценкаСтарая,
	               |	0 КАК НаценкаНовая,
	               |	0 КАК Дельта
	               |ИЗ
	               |	РегистрНакопления.УЗ_Партии.Остатки(
	               |			,
	               |			ТоварКод = &ТоварКод
	               |				И СкладКод В
	               |					(ВЫБРАТЬ
	               |						ВтАптеки.Код
	               |					ИЗ
	               |						ВтАптеки)) КАК Ост
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УЗ_Партии КАК Партии
	               |		ПО Ост.ПартияКод = Партии.Код
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВходящиеЦеныПоставщика КАК ВхЦены
	               |		ПО Ост.ПартияКод = ВхЦены.ПартияКод
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтАптеки КАК ВтАптеки
	               |		ПО Ост.СкладКод = ВтАптеки.Код
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РозничныеЦены КАК РЦ
	               |		ПО Ост.ТоварКод = РЦ.ТоварКод
	               |			И Ост.СкладКод = РЦ.АптекаКод
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РозничныеЦеныПоПартиям КАК РЦП
	               |		ПО Ост.СкладКод = РЦП.АптекаКод
	               |			И Ост.ПартияКод = РЦП.ПартияКод
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Поставщики КАК Пост
	               |		ПО (Пост.Код = Партии.Поставщик)
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ДатаПоставки УБЫВ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВТАптеки";
				   
		Запрос.УстановитьПараметр("ТоварКод",Товар.Код);
		Запрос.УстановитьПараметр("Бренд",Справочники.БрендыАптечныхСетей.НайтиПоНаименованию("ГОРЗДРАВ",Истина));
		Анализ = Запрос.Выполнить().Выгрузить();
		
		РассчитатьНовуюНаценку();
	
КонецПроцедуры

Процедура РассчитатьНовуюНаценку()
	
	Если ФиксЦена > 0 Тогда
		Для каждого стр из Анализ Цикл
			Если стр.ЦенаЗакуп > 0 Тогда
				стр.НаценкаНовая = Окр((ФиксЦена/стр.ЦенаЗакуп - 1)*100,2);
			Иначе
				стр.НаценкаНовая = 0;
			КонецЕсли;
			стр.Дельта = (ФиксЦена*стр.Остаток) - (стр.Остаток*стр.Ценарозн);
		КонецЦикла;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ФиксЦенаПриИзменении(Элемент)
	
	РассчитатьНовуюНаценку();
	
КонецПроцедуры

Процедура КоманднаяПанель1кнПрогнозПоПродажам(Кнопка)
	
	  Запрос = Новый Запрос;
	  Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	                 |	АптекиКонкуренты.Владелец.Код КАК Код,
	                 |	АптекиКонкуренты.Владелец КАК Аптека,
	                 |	АптекиКонкуренты.Владелец.Наименование КАК Наименование
	                 |ПОМЕСТИТЬ ВтАптеки
	                 |ИЗ
	                 |	Справочник.АптекиКонкуренты КАК АптекиКонкуренты
	                 |ГДЕ
	                 |	АптекиКонкуренты.Владелец.Бренд = &Бренд
	                 |	И АптекиКонкуренты.Владелец.ПометкаУдаления = ЛОЖЬ
	                 |	И АптекиКонкуренты.Владелец.ЭтоГруппа = ЛОЖЬ
	                 |
	                 |ИНДЕКСИРОВАТЬ ПО
	                 |	Код
	                 |;
	                 |
	                 |////////////////////////////////////////////////////////////////////////////////
	                 |ВЫБРАТЬ
	                 |	СУММА(Выборка.Дельта) КАК Дельта,
	                 |	СУММА(Выборка.ВыручкаНовая) КАК ВыручкаНовая,
	                 |	СУММА(Выборка.ВыручкаСтарая) КАК ВыручкаСтарая
	                 |ИЗ
	                 |	(ВЫБРАТЬ
	                 |		&ЦенаРозн * (УЗ_РеализацииККМ.Количество / УЗ_РеализацииККМ.К) - УЗ_РеализацииККМ.СуммаРозн КАК Дельта,
	                 |		&ЦенаРозн * (УЗ_РеализацииККМ.Количество / УЗ_РеализацииККМ.К) КАК ВыручкаНовая,
	                 |		УЗ_РеализацииККМ.СуммаРозн КАК ВыручкаСтарая,
	                 |		УЗ_РеализацииККМ.СкладКод КАК СкладКод,
	                 |		УЗ_РеализацииККМ.ПартияКод КАК ПартияКод,
	                 |		УЗ_РеализацииККМ.Регистратор КАК Регистратор
	                 |	ИЗ
	                 |		РегистрНакопления.УЗ_РеализацииККМ КАК УЗ_РеализацииККМ
	                 |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтАптеки КАК ВтАптеки
	                 |			ПО УЗ_РеализацииККМ.СкладКод = ВтАптеки.Код
	                 |	ГДЕ
	                 |		УЗ_РеализацииККМ.Период >= &Период
	                 |		И УЗ_РеализацииККМ.ТоварКод = &ТоварКод) КАК Выборка
	                 |;
	                 |
	                 |////////////////////////////////////////////////////////////////////////////////
	                 |УНИЧТОЖИТЬ ВТАптеки";
		Запрос.УстановитьПараметр("ТоварКод",Товар.Код);
		Запрос.УстановитьПараметр("Бренд",Справочники.БрендыАптечныхСетей.НайтиПоНаименованию("ГОРЗДРАВ",Истина));
		Запрос.УстановитьПараметр("Период",ТекущаяДата() - 30*24*60*60);
		Запрос.УстановитьПараметр("ЦенаРозн",ФиксЦена);

		Рез = Запрос.Выполнить();
		Если Рез.Пустой() Тогда
			Предупреждение("За последние 30 дней продажи по данному товару не производились");
		Иначе
			Выборка = Рез.Выбрать();
			Выборка.Следующий();
			Сообщить("Старая выручка :	" +  Выборка.ВыручкаСтарая + Символы.ПС
			+ "Новая выручка :	" +  Выборка.ВыручкаНовая + Символы.ПС
			+ "Дельта :	" +  Выборка.Дельта);
		КонецЕсли;
		

	
КонецПроцедуры

Процедура ТоварПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Товар) Тогда
		КодТовара = Товар.Код;
	Иначе
		КодТовара = 0;
	КонецЕсли;
	
КонецПроцедуры
