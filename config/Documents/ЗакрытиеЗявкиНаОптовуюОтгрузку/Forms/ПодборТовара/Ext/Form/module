
Процедура ТЗЗаказаПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Количество > 0 Тогда
		ОформлениеСтроки.ЦветФона=Новый Цвет(152,251,152);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьТаблицу()
	
		ТЗЗаказа.Очистить();
		
		Запрос = Новый Запрос;
		
		Если СпособОтображенияЗаказа = "ПолнаяЗаявка" Тогда
			ТипСоединения = " ЛЕВОЕ ";
		Иначе
			ТипСоединения = " ВНУТРЕННЕЕ ";
		КонецЕсли;
		
		ТХТ = "ВЫБРАТЬ
		      |	РегЗаявка.КодТовара КАК КодТовара,
		      |	РегЗаявка.КоличествоОстаток КАК КоличествоОстаток,
		      |	РегЗаявка.СуммаЗакупБезНДСОстаток КАК СуммаЗакупБезНДС
		      |ПОМЕСТИТЬ ТоварыЗаказа
		      |ИЗ
		      |	РегистрНакопления.ЗаявкаНаОптовуюОтгрузку.Остатки(
		      |			&Дата,
		      |			КодТовара В (&КодыТовара)
		      |				И Заявка = &Заявка) КАК РегЗаявка
		      |;
		      |
		      |////////////////////////////////////////////////////////////////////////////////
		      |ВЫБРАТЬ
		      |	Заявка.КодТовара КАК КодТовара,
		      |	Заявка.Товар КАК Товар,
		      |	Заявка.ПотребностьВКоробах КАК КоличествоВЗаявке,
		      |	Заявка.ЦенаЗакупБезНДС КАК ЦенаЗакупБезНДС,
		      |	0 КАК СуммаЗакупБезНДС,
		      |	ЕСТЬNULL(ТоварыЗаказа.КоличествоОстаток, 0) КАК ВПути,
		      |	0 КАК Количество
		      |ИЗ
		      |	Документ.ЗаявкаНаОптовуюОтгрузку.Товар КАК Заявка
		      |		"+ТипСоединения+" СОЕДИНЕНИЕ ТоварыЗаказа КАК ТоварыЗаказа
		      |		ПО (ТоварыЗаказа.КодТовара = Заявка.КодТовара)
		      |ГДЕ
		      |	Заявка.Ссылка = &Заявка
		      |;
		      |
		      |////////////////////////////////////////////////////////////////////////////////
		      |УНИЧТОЖИТЬ ТоварыЗаказа";
		
		Запрос.Текст = ТХТ;
		Запрос.УстановитьПараметр("КодыТовара",Основание.Товар.ВыгрузитьКолонку("КодТовара"));
		Запрос.УстановитьПараметр("Дата",ДатаДокумента);
		Запрос.УстановитьПараметр("Заявка",Основание);

		
		ТЗЗаказа = Запрос.Выполнить().Выгрузить();
		
	
КонецПроцедуры


Процедура ЗаполнитьТаблицуИзПодтверждения()
	
		ТЗЗаказа.Очистить();
		
		Запрос = Новый Запрос;
		
		Если СпособОтображенияЗаказа = "ПолныйЗаказ" Тогда
			ТипСоединения = " ЛЕВОЕ ";
		Иначе
			ТипСоединения = " ВНУТРЕННЕЕ ";
		КонецЕсли;
		
		ТХТ = "ВЫБРАТЬ
		      |	ЗаказПроизводителюОстатки.КодТовара,
		      |	ЗаказПроизводителюОстатки.КоличествоОстаток
		      |ПОМЕСТИТЬ ТоварыВПути
		      |ИЗ
		      |	РегистрНакопления.ЗаказПроизводителюОпт.Остатки(
		      |			&Дата,
		      |			КодТовара В (&КодыТовара)
		      |				И Заказ = &Заказ) КАК ЗаказПроизводителюОстатки
		      |;
		      |
		      |////////////////////////////////////////////////////////////////////////////////
		      |ВЫБРАТЬ
		      |	Док.КодТовара,
		      |	Док.Товар,
			  |	Док.Товар.СтавкаНДС.Ставка как СтавкаНДСПроизводителя,
		      |	Док.Количество КАК КоличествоЗаказа,
		      |	Док.Цена КАК ЦенаЗаказа,
		      |	Док.Сумма КАК СуммаЗаказа,
		      |	0 КАК ВПути,
		      |	0 КАК КоличествоФакт,
		      |	Док.Цена КАК ЦенаФакт,
		      |	ДатаВремя(1,1,1) как СрокГодности
		      |ИЗ
		      |	Документ.ЗаказПроизводителю.Товар КАК Док
		      |		" + ТипСоединения + " СОЕДИНЕНИЕ ТоварыВПути КАК ТоварыВПути
		      |			ПО (ТоварыВПути.КодТовара = Док.КодТовара)
		      |ГДЕ
		      |	Док.Ссылка = &Заказ
			  |УПОРЯДОЧИТЬ ПО Док.Товар.Наименование , Док.Количество УБЫВ
		      |;
		      |
		      |////////////////////////////////////////////////////////////////////////////////
		      |ВЫБРАТЬ
		      |	ТоварыВПути.КодТовара,
		      |	ТоварыВПути.КоличествоОстаток как ВПути
		      |ИЗ
		      |	ТоварыВПути КАК ТоварыВПути
		      |;
		      |
		      |////////////////////////////////////////////////////////////////////////////////
		      |УНИЧТОЖИТЬ ТоварыВПути";
		
		Запрос.Текст = ТХТ;
		Запрос.УстановитьПараметр("КодПроизводителя",Основание.Производитель.Код);
		Запрос.УстановитьПараметр("КодыТовара",Основание.Товар.ВыгрузитьКолонку("КодТовара"));
		Запрос.УстановитьПараметр("Дата",ДатаДокумента);
		Запрос.УстановитьПараметр("Заказ",Основание);

		Рез = Запрос.ВыполнитьПакет();
		
		пер_ТЗЗаказа = Рез.Получить(1).Выгрузить();
		ТЗПути = Рез.Получить(2).Выгрузить();
		
		Для каждого стр из ВладелецФормы.ЭлементыФормы.Товар.Значение Цикл
				нс = ТЗЗаказа.Добавить();
			    нс.КодТовара = стр.КодТовара;
				нс.Товар = стр.Товар;
				нс.СтавкаНДСПроизводителя = стр.СтавкаНДСПроизводителя;
				нс.КоличествоЗаказа = 0;
				нс.ВПути = 0;
				нс.ЦенаЗаказа = стр.ЦенаЗаказа;
				нс.СуммаЗаказа = 0;
				нс.КоличествоФакт = стр.Количество;
				нс.ЦенаФакт = стр.ЦенаСоСкидкойСНДС;
				нс.СрокГодности = стр.СрокГодности;
		КонецЦикла;
		
		Для каждого стр из пер_ТЗЗаказа Цикл
			Отбор = Новый Структура;
			Отбор.Вставить("КодТовара",стр.КодТовара);
			Отбор.Вставить("ЦенаЗаказа",стр.ЦенаЗаказа);
			НайденныеСтроки = ТЗЗаказа.НайтиСтроки(Отбор);
			Если НайденныеСтроки.Количество() = 0 Тогда
				нс = ТЗЗаказа.Добавить();
			    нс.КодТовара = стр.КодТовара;
				нс.Товар = стр.Товар;
				нс.СтавкаНДСПроизводителя = стр.СтавкаНДСПроизводителя;
				нс.КоличествоЗаказа = стр.КоличествоЗаказа;
				нс.ВПути = 0;
				нс.ЦенаЗаказа = стр.ЦенаЗаказа;
				нс.СуммаЗаказа = стр.СуммаЗаказа;
				нс.КоличествоФакт = 0;
				нс.ЦенаФакт = нс.ЦенаЗаказа;
				нс.СрокГодности = стр.СрокГодности;				
			Иначе
				ПерваяСтрока = НайденныеСтроки[0];
				ПерваяСтрока.КоличествоЗаказа = стр.КоличествоЗаказа;
				ПерваяСтрока.СуммаЗаказа = ПерваяСтрока.КоличествоЗаказа*ПерваяСтрока.ЦенаЗаказа;
			КонецЕсли;
				
		КонецЦикла;

		Для каждого стр из ТЗПути Цикл
			
			ОстатокВПути = стр.ВПути;
			
			Отбор = Новый Структура;
			Отбор.Вставить("КодТовара",стр.КодТовара);
			
			НайденныеСтроки = ТЗЗаказа.НайтиСтроки(Отбор);
			Для каждого с из НайденныеСтроки Цикл
				
				Если  с.КоличествоЗаказа >= ОстатокВПути Тогда
					с.ВПути = ОстатокВПути;
					Прервать;
				КонецЕсли;
				
				с.ВПути = с.КоличествоЗаказа;	
				ОстатокВПути = ОстатокВПути - с.КоличествоЗаказа;
				
				
			КонецЦикла;
			
			
		КонецЦикла;
		
		ТЗЗаказа.Сортировать("Товар,КоличествоЗаказа Убыв");
		
	
КонецПроцедуры



Процедура ПриОткрытии()
	
	Если НЕ Основание.Пустая() Тогда
		
		ЗаполнитьТаблицу();

		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыкнПеренестиВИнвойс(Кнопка)
	
	ОповеститьОВыборе(ТЗЗаказа);
	
КонецПроцедуры


Процедура ОсновныеДействияФормыкнЗаполнитьДаннымиЗаказа(Кнопка)
	
	Для каждого стр из ТЗЗаказа Цикл
		Если стр.ВПути > 0 Тогда
			стр.Количество = стр.ВПути;
			стр.СуммаЗакупБезНДС = стр.ЦенаЗакупБезНДС*стр.Количество;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура СпособОтображенияЗаказаПриИзменении(Элемент)
	
	ЗаполнитьТаблицу();
			
КонецПроцедуры

Процедура ТЗЗаказаКоличествоПриИзменении(Элемент)
	
	ТС = ЭлементыФормы.ТЗЗаказа.ТекущаяСтрока;
	ТС.СуммаЗакупБезНДС = ТС.Количество*ТС.ЦенаЗакупБезНДС;
	
КонецПроцедуры

СпособОтображенияЗаказа = "ПолнаяЗаявка";
