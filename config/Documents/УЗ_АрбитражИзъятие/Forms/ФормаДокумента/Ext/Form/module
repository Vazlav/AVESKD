Процедура ПоказатьИсторию()
	
	ИсторияИзменений.Очистить();
	
	ТЗИстории = ОбщегоНазначения.ПолучитьИсториюИзмененийДокумента(Ссылка);
	Если НЕ ТЗИстории = Неопределено Тогда
		ЭлементыФормы.ИсторияИзменений.Значение = ТЗИстории;
	КонецЕсли;
	
КонецПроцедуры


Процедура ПанельШапкиПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если Элемент.ТекущаяСтраница = Элемент.Страницы.ИсторияОфиса Тогда
		ПоказатьИсторию();
	КонецЕсли;
	
КонецПроцедуры


Процедура ОсновныеДействияФормыОсновныеДействияФормыСохранить(Кнопка)
	
	Если Проведен = Истина Тогда
		Предупреждение("Документ НЕ сохранен. В проведенном документе пользуйтесь кнопкой <Провести>!");
		Возврат;
	КонецЕсли;
	
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Вы действительно хотите сохранить документ/изменения?",Режим,0);
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		Записать(РежимЗаписиДокумента.Запись);
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	Если Проведен=Истина ТОгда
		
		ЭлементыФормы.Склад.ТолькоПросмотр = Истина; //нельзя изменять получателя
				
		Если Не РольДоступна("супер_Администратор") Тогда
			ТолькоПросмотр = Истина;
		КонецЕсли;
		
	КонецЕсли; 
	
	
КонецПроцедуры

Процедура КоманднаяПанельТоваракнДвижениеПоПартии(Кнопка)
	
	ТСД=ЭлементыФормы.Товар.ТекущаяСтрока;
	
	Карточка=Отчеты.УЗ_ДвижениеТовара.Создать();
	
	Карточка.КодПартии=ТСД.КодПартии;
	Карточка.ВыбСклад=Склад;
	Карточка.ВыбТовар=ТСД.ТОвар;
	Карточка.ВыбФирма=Фирма;
	Карточка.НачПер=НачалоГода(Дата);
	Карточка.КонПер=Дата;
	
	Ф=Карточка.ПолучитьФорму("Форма");
	
	Ф.Открыть();
	
	
КонецПроцедуры

Процедура КоманднаяПанельТоваракнЗаполнитьДляПолнойОчистки(Кнопка)
	
	Если Склад.Пустая() Тогда
		Предупреждение("Не выбран склад. Выполнение не может быть продолжено!");	
		Возврат;
	КонецЕсли;
	
	Если Дата = Дата(1,1,1) Тогда
		Предупреждение("Не установлена дата документа. Выполнение не может быть продолжено!");	
		Возврат;
	КонецЕсли;
		
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Заполнить таблицу остатком арбитража?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли; 
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	АП.Ссылка КАК Товар,
	               |	Выборка.ТоварКод КАК КодТовара,
	               |	Выборка.ПартияКод КАК КодПартии,
	               |	Выборка.КоличествоОстаток КАК Количество,
	               |	Выборка.СуммаЗакупБезНДСОстаток КАК СуммаЗакупБезНДС,
	               |	Выборка.СуммаЗакупБезНДСОстаток / Выборка.КоличествоОстаток КАК ЦенаЗакупБезНДС,
	               |	Выборка.СтавкаНДСЗакуп,
	               |	1 КАК Коэфф,
	               |	Партии.К КАК КоэффициентРазбивки
	               |ИЗ
	               |	РегистрНакопления.УЗ_ПартииАрбитраж.Остатки(&Дата, СкладКод = &СкладКод) КАК Выборка
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.АССОРТИМЕНТНЫЙ_ПЛАН КАК АП
	               |		ПО Выборка.ТоварКод = АП.Код
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.УЗ_Партии КАК Партии
	               |		ПО Выборка.ПартияКод = Партии.Код
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	АП.Наименование";
	
	  Запрос.УстановитьПараметр("СкладКод",Склад.Код);
	  Запрос.УстановитьПараметр("Дата",Дата);
	  Товар.Загрузить(Запрос.Выполнить().Выгрузить());
	  Комментарий = "#Полная очистка арбитража";
	
КонецПроцедуры

Процедура СкладПриИзменении(Элемент)
	
	Фирма = Элемент.Значение.Фирма;
	
КонецПроцедуры
