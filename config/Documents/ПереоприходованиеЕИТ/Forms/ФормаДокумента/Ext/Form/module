Функция ТекущаяСтрокаДокумента  () 
    // Назначение:
	// Дает объект - тек строку документа
	// 
    // 
	//--------------------------------------------------------------------------------
	ТекСтрокаТЧ="";
	ИндексТекСтроки=Товар.Индекс(ЭлементыФормы.Товар.ТекущаяСтрока);
    ТекСтрокаТЧ=ТОвар.Получить( ИндексТекСтроки); // Рез. тип объекта - СтрокаТабличнойЧасти

	Возврат ТекСтрокаТЧ;
	
КонецФункции


Процедура ДобавитьТоварКолво  (СтрТЗ) 
    // Назначение:
	// Добавляет строку товара в документ
	// выполняет расчет числовых полей
    // выдергивает из регистра информации Цены последние цены на товар 
	// в разрезе АП по не жнвлс и по партии для ЖНВЛС
	//--------------------------------------------------------------------------------
	
	ВыбТовар	=СтрТЗ.Товар;
	ВыбПартия	=СтрТЗ.Партия;
	ВыбКолво	=СтрТЗ.Колво;
	
	ПарамПоиска = Новый  Структура;
	ПарамПоиска.Вставить("Товар",ВыбТовар);
	ПарамПоиска.Вставить("ЕИТ",СтрТЗ.Ед);
    ПарамПоиска.Вставить("Партия",СтрТЗ.Партия);
	
	
	МассивНайденныхСтрок= Товар.НайтиСтроки(ПарамПоиска);
	
	Если МассивНайденныхСтрок.Количество()=0 Тогда
		
		
		//----------------------------< Добавляем только при добавлении КоэффДобавления=1  >--------------------------------GtG---
		НоваяСтрокаВыбТовара=Товар.Добавить();
		НоваяСтрокаВыбТовара.ТоварСтарый=ВыбТовар;
		НоваяСтрокаВыбТовара.Товар=ВыбТовар;
		НоваяСтрокаВыбТовара.КоличествоФакт=ВыбКолво;
		НоваяСтрокаВыбТовара.НовоеКоличество=ВыбКолво;
        НоваяСтрокаВыбТовара.СтавкаНДССтарый = ВыбПартия.СтавкаНДС;
		НоваяСтрокаВыбТовара.СтавкаНДС = ВыбПартия.СтавкаНДС;
		НоваяСтрокаВыбТовара.СерияСтарая = ВыбПартия.Серия;
		НоваяСтрокаВыбТовара.Серия		= ВыбПартия.Серия;
		
		//-----------------< единица  >----------------GtG---
		НоваяСтрокаВыбТовара.ЕИТСтарый=СтрТЗ.Ед;			
		НоваяСтрокаВыбТовара.КоэффСтарый=НоваяСтрокаВыбТовара.ЕИТСтарый.К;
		
		
		//----------------------------< партия >--------------------------------GtG---
		НоваяСтрокаВыбТовара.ПартияСтарая=ВыбПартия;

		Если СпособПереоприходования = Перечисления.СпособПереоприходования.ССозданиемНовойПартии Тогда
			ВыбПартия0 = ВыбПартия.Скопировать();
			ВыбПартия0.УстановитьНовыйКод();
			ВыбПартия0.Записать();
			
			НоваяСтрокаВыбТовара.Партия= ВыбПартия0.Ссылка; //ОМ1_СоздатьПартиюТовара(ВыбТовар).Ссылка;
		Иначе
			НоваяСтрокаВыбТовара.Партия= Справочники.Партии.ПустаяСсылка();
		КонецЕсли;
		//----------------------------< Цены , суммы , НДСы >--------------------------------GtG---
		НоваяСтрокаВыбТовара.НДСЗакупСтарый		= СтрТЗ.НДСЗакуп;
		НоваяСтрокаВыбТовара.НДСЗакуп			= СтрТЗ.НДСЗакуп;
		НоваяСтрокаВыбТовара.СуммаЗакупСтарая	= СтрТЗ.СуммаЗакуп;
		НоваяСтрокаВыбТовара.СуммаЗакуп			= СтрТЗ.СуммаЗакуп;
		НоваяСтрокаВыбТовара.ЦенаЗакупСтарая 	= СтрТЗ.СуммаЗакуп/ВыбКолво;
		НоваяСтрокаВыбТовара.ЦенаЗакуп			= СтрТЗ.СуммаЗакуп/ВыбКолво;
		НоваяСтрокаВыбТовара.ЦенаЗакупБезНДС	= Окр(НоваяСтрокаВыбТовара.ЦенаЗакуп/(1+НоваяСтрокаВыбТовара.СтавкаНДС.Ставка/100),2);

		НоваяСтрокаВыбТовара.ЦенаПроизводителяСтарая= СтрТЗ.Партия.ЦенаПроизводителяБезНДС;
		НоваяСтрокаВыбТовара.ЦенаГосРегистрации 	= 0;
		
		
	Иначе   // только при совпадении единиц измерения , серии и партии
		
		СтрокаВТ=МассивНайденныхСтрок[0];
		СтрокаВТ.КоличествоФакт=СтрокаВТ.КоличествоФакт+ВыбКолво;
		
		
		СтрокаВТ.НДСЗакуп	= СтрокаВТ.НДСЗакуп+ СтрТЗ.НДСЗакуп;
		СтрокаВТ.СуммаЗакупСтарая = СтрокаВТ.СуммаЗакупСтарая + СтрТЗ.СуммаЗакуп;
		СтрокаВТ.ЦенаЗакупСтарая 	= СтрокаВТ.СуммаЗакупСтарая/СтрокаВТ.КоличествоФакт;

		
	КонецЕсли; 
 
 
 КонецПроцедуры
 //============================================================================ GtG ===

Процедура ПриОткрытии()
	
	Если ЭтоНовый() = Истина Тогда
		Фирма = Константы.ОсновнаяФирма.Получить();
		Склад = Константы.ОсновнойСклад.Получить();
		Дата  = ТекущаяДата();
		НоваяСтрокаИзм = Изменения.Добавить();
		НоваяСтрокаИзм.Дата=ТекущаяДата();
		НоваяСтрокаИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр;
		НоваяСтрокаИзм.ТипИзм=Перечисления.ДействияНадДокументами.ВводНового;	
	КонецЕсли;
	

	ОМ10_ЗаполнитьСписокПечФорм(ЭтотОбъект,СписокПечатныхФорм);	
	
	Если Товар.Количество() > 0 Тогда
		ПерваяСтрока=ТОвар.Получить(0);
		Если ПерваяСтрока.ПартияСтарая.Пустая()= Ложь Тогда
			//------------------<Уберем из резерва все по этому документу и заново туда пропишем>-------------------GtG----
			Если ЭтотОбъект.ЭтоНовый()=Ложь Тогда
				Если ЭтотОбъект.Проведен=Ложь Тогда
					ОМ15_ОчисткаРезерваДокумента(ЭтотОбъект.Ссылка );// должна быть во всех документах, которые касаются резерва количества товара
					ОМ15_ДобавитьДокументЦеликомВРезервПодбора(ЭтотОбъект.Ссылка,"ПартияСтарая");	 
				КонецЕсли; 
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;	
	
КонецПроцедуры

Процедура КоманднаяПанель1ПодборПоАП(Кнопка)
	
	// Назначение:
	// Запускает процесс подбора по справочнику АП
	// Открывает форму для подбора АП
	// 
	//============================================================================ GtG ===
	Если ЭтаФорма.ТолькоПросмотр Тогда
		Предупреждение("Редактирование документа запрещено!");
		ВОЗВРАТ ;
	КонецЕсли; 
	
	Если СпособПереоприходования = Перечисления.СпособПереоприходования.ПустаяСсылка() Тогда
		Предупреждение("Выберите способ переоприходования!");
		Возврат;
	КонецЕсли;
	
	Если  ЭтотОбъект.ЭтоНовый() ТОгда
		 ЭтотОбъект.Записать();
	КонецЕсли;	 
	
	
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= ПолучитьОбщуюФорму("ОбщФормаПодборПоОстаткамСклада",ЭтаФорма,КлючУник);	
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.Открыть();

КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)
	
	Если ТипЗнч(ЗначениеВыбора)=Тип("ТаблицаЗначений") Тогда
		Для Ы=0 По ЗначениеВыбора.Количество()-1 Цикл
			
		      СтрТЗ= ЗначениеВыбора.Получить(Ы) ;
			  
			  ВыбТовар=СтрТЗ.Товар;
			  ВыбКолво=СтрТЗ.Колво;
			  
			  ДобавитьТоварКолво(СтрТЗ);
		
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	СуммаДокСтарая = Товар.Итог("СуммаЗакупСтарая");
	СуммаДок = Товар.Итог("СуммаЗакуп");
	НоваяСтрокаИзм = Изменения.Добавить();
	НоваяСтрокаИзм.Дата=ТекущаяДата();
	НоваяСтрокаИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр;
	НоваяСтрокаИзм.ТипИзм=Перечисления.ДействияНадДокументами.Изменение;	
	НоваяСтрокаИзм.КомментарийИзменения = "Записан";
	
КонецПроцедуры

Процедура ТоварЕИТНоваяОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	ТСД=ТекущаяСтрокаДокумента();
	Если ВыбранноеЗначение = ТСД.ЕИТСтарый Тогда
		Предупреждение("Необходимо выбрать другую Ед.изм.!");
		СтандартнаяОбработка=Ложь;
	Иначе
		ТСД.Коэфф= ВыбранноеЗначение.К;
	КонецЕсли;
КонецПроцедуры

Процедура ПриЗакрытии()
	
	Если ТОвар.Количество()>0 Тогда
		ПерваяСтрока=ТОвар.Получить(0);
		Если ПерваяСтрока.ПартияСтарая.Пустая()= Ложь Тогда
		//------------------<Чистим резерв подбора >-------------------GtG----15.11.2007
		// только если в документе набирали товар, и он не является свежим заказом (с еще не подобранными партиями)
		
			Если  (ЭтотОбъект.Проведен=Ложь) и (ЭтотОбъект.ЭтоНовый() = Ложь) Тогда
				ОМ15_ОчисткаРезерваДокумента( ЭтотОбъект.Ссылка );
				Если ЭтотОбъект.ПометкаУдаления = Ложь Тогда //Если помечен на удаление, тогда надо только очистить резерв
					ОМ15_ДобавитьДокументЦеликомВРезервПодбора(ЭтотОбъект.Ссылка,"ПартияСтарая");
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли; 
	КонецЕсли;
	
КонецПроцедуры

Процедура ТоварПередУдалением(Элемент, Отказ)
	
	ТекСтр = ЭлементыФормы.Товар.ТекущаяСтрока;
	Если (ЭтотОбъект.Проведен = Ложь) Тогда
		ОМ15_УдалитьСтрокуДокИзРезерваПодбора (ТекСтр.ТоварСтарый,ТекСтр.ПартияСтарая,Склад,ЭтотОбъект.Ссылка);
	КонецЕсли;

КонецПроцедуры

Процедура КоманднаяПанель1Расценить(Кнопка)
	ОМ6_КоманднаяПанельКнопкаРасценить(ЭтаФорма,ЭтотОбъект,Товар);
КонецПроцедуры

Процедура ТоварТоварНовыйПриИзменении(Элемент)
	
	ТекСтр = ТекущаяСтрокаДокумента();
	ПартияОбъект = ТекСтр.Партия.ПолучитьОбъект();
	ПартияОбъект.Владелец = Элемент.Значение;
	ПартияОбъект.Записать();
	
	ТекСтр.Партия = ПартияОбъект.Ссылка;
	ТекСтр.Серия = Справочники.Серии.ПустаяСсылка();
	
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
	
	ОМ10_КнопкаПечатьНажатие (ЭтотОбъект,ЭтаФорма);
	
КонецПроцедуры

Процедура ТоварПартияНоваяОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	ТекСтрока = ТекущаяСтрокаДокумента();
	ТекСтрока.Серия = ВыбранноеЗначение.Серия;
	ТекСтрока.ЦенаЗакуп = ВыбранноеЗначение.ЦенаЗакуп;
	ТекСтрока.ЦенаЗакупБезНДС	= Окр(ТекСтрока.ЦенаЗакуп/(1+ВыбранноеЗначение.СтавкаНДС.Ставка/100),2);
	ТекСтрока.СуммаЗакуп = ТекСтрока.ЦенаЗакуп*Текстрока.НовоеКоличество;
	ТекСтрока.СтавкаНДС = ВыбранноеЗначение.СтавкаНДС;
	ТекСтрока.НДСЗакуп = ОМ3_НДСИзСуммыПоСтавке(ТекСтрока.СуммаЗакуп,ТекСтрока.СтавкаНДС);
КонецПроцедуры

Процедура ТоварПередОкончаниемРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования, Отказ)
	
	
	 ТСД=ТекущаяСтрокаДокумента();
	 ИмяТекКол=Элемент.ТекущаяКолонка.Имя;
	 
	 
	Если (ИмяТекКол="НовоеКоличество") или (ИмяТекКол="ЦенаЗакуп") Тогда
		 ТСД.СуммаЗакуп=ТСД.НовоеКоличество*ТСД.ЦенаЗакуп;
		 ТСД.НДСЗакуп = ОМ3_НДСИзСуммыПоСтавке(ТСД.СуммаЗакуп,ТСД.СтавкаНДС);
		 ТСД.ЦенаЗакупБезНДС	= Окр(ТСД.ЦенаЗакуп/(1+ТСД.СтавкаНДС.Ставка/100),2);
	 ИначеЕсли ИмяТекКол = "СтавкаНДС" Тогда
		 ТСД.НДСЗакуп = ОМ3_НДСИзСуммыПоСтавке(ТСД.СуммаЗакуп,ТСД.СтавкаНДС);
		 ТСД.ЦенаЗакупБезНДС	= Окр(ТСД.ЦенаЗакуп/(1+ТСД.СтавкаНДС.Ставка/100),2);
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ТоварПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	КодАПСт=ОформлениеСтроки.Ячейки.КодАПСт;
	ОформлениеСтроки.Ячейки.КодАПСт.УстановитьТекст(Формат(ДанныеСтроки.ТоварСтарый.Код,"ЧЦ=10; ЧДЦ=0; ЧГ=0"));
	КодАП=ОформлениеСтроки.Ячейки.КодАП;
	ОформлениеСтроки.Ячейки.КодАП.УстановитьТекст(Формат(ДанныеСтроки.Товар.Код,"ЧЦ=10; ЧДЦ=0; ЧГ=0"));
	

КонецПроцедуры


