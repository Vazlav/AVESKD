Перем КоличествоСтрокТЧ;
//Перем ИндексТекСтроки;

Процедура ПриИзмененииРеквизитовФормы()
КонецПроцедуры

Процедура ОбновитьДанныеВТабличнойЧасти()
	
	Владелец = ЭтаФорма.ВладелецФормы;
	ТекСтрока = Владелец.Товар[ИндексТекСтроки];
	//ТекСтрока.БойБрак = БойБрак;
	//ТекСтрока.Недовоз = Недовоз;
	//ТекСтрока.КоличествоФакт = КоличествоФакт;
	ТекСтрока.ЦенаПроизводителя = ЦенаПроизводителя;
	ТекСтрока.ЦенаЗакупБезНДС = ЦенаЗакупБезНДС;
	ТекСтрока.ЦенаЗакуп = ЦенаЗакуп;
	ТекСтрока.НДСЗакуп = НДСЗакуп;
	ТекСтрока.ЦенаРозн = ЦенаРозн;
	ТекСтрока.СуммаРозн = СуммаРозн;
	ТекСтрока.ПроцентРознНац = НаценкаРозн;
	
	
КонецПроцедуры

Процедура ЗаполнитьДанныеФормы()
	
	Владелец = ЭтаФорма.ВладелецФормы;
	ТекСтрока = Владелец.Товар[ИндексТекСтроки];
	Владелец.ЭлементыФормы.Товар.ТекущаяСтрока = ТекСтрока;
	КолонкиТабЧасти = Владелец.ЭлементыФормы.Товар.Колонки;	
	КоличествоКолонок = КолонкиТабЧасти.Количество();
	
	Для н= 1 по КоличествоКолонок-1 Цикл
		ИмяКолонки = КолонкиТабЧасти.Получить(н).Имя;
		Элемент = ЭлементыФормы.Найти(ИмяКолонки);
		Если Элемент = Неопределено Тогда
			Продолжить;
		Иначе
			Элемент.Значение = ТекСтрока[ИмяКолонки];
		КонецЕсли;
	КонецЦикла;
	
	Если ЦенаПроизводителя > 0 Тогда
		ПроцентОпт = Окр((ЦенаЗакупБезНДС/ЦенаПроизводителя-1)*100,2);
	КонецЕсли;
	
	Если ЦенаЗакуп > 0 Тогда
		НаценкаРозн = Окр((ЦенаРозн/ЦенаЗакуп-1)*100,2);
	КонецЕсли;
	
	ЭлементыФормы.ТекстЖизненноважный.Заголовок = ?(Товар.ЖНВЛС = Истина,"Жизненноважный","");
	
	ГруппаНаценки = Товар.ГруппаНаценки;

		  
	//ТХТ = "ВЫБРАТЬ ПЕРВЫЕ 1
	//	  |	ПартииЖНВЛС.Период КАК ДатаПоступления,
	//	  |	ПартииЖНВЛС.Партия.Поставщик.Наименование КАК Поставщик,
	//	  |	ПартииЖНВЛС.Партия.ЦенаЗакуп как ЦенаЗакуп,
	//	  |	ПартииЖНВЛС.СтавкаНДС.Ставка КАК СтавкаНДСЧисло,
	//	  |	ПартииЖНВЛС.Партия.ЦенаПроизводителяБезНДС КАК ЦенаПроизводителя,
	//	  |	ПартииЖНВЛС.СуммаРознСНДС / ПартииЖНВЛС.Колво КАК ЦенаРозн,
	//	  | ПартииЖНВЛС.Колво как КоличествоПрихода
	//	  |ИЗ
	//	  |	РегистрНакопления.ПартииЖНВЛС КАК ПартииЖНВЛС
	//	  |ГДЕ
	//	  |	ПартииЖНВЛС.Склад = &Склад
	//	  |	И ПартииЖНВЛС.Товар = &Товар
	//	  |	И ПартииЖНВЛС.ВидОперации В(&СписокОпераций)
	//	  |
	//	  |УПОРЯДОЧИТЬ ПО
	//	  |	ДатаПоступления УБЫВ";		  
	//	  
	//СписокОпераций = Новый СписокЗначений;
	//СписокОпераций.Добавить(Перечисления.ВидыОпераций.ПоступлениеТМЦ);
	//СписокОпераций.Добавить(Перечисления.ВидыОпераций.Переоценка);
	//
	//Запрос = Новый Запрос;
	//Запрос.Текст = ТХТ;
	//Запрос.УстановитьПараметр("Товар",Товар);	
	//Запрос.УстановитьПараметр("Склад",ЭтаФорма.ВладелецФормы.Склад);
	//Запрос.УстановитьПараметр("СписокОпераций",СписокОпераций);
	//Рез = Запрос.Выполнить();
	//Если Рез.Пустой() Тогда
		ЭлементыФормы.ПоследнийПоставщикПоставки.Заголовок = "";
		ПоследняяДатаПоставки = ОМ3_ПустаяДата();
		ПоследняяЦенаЗакуп = 0;
		ПоследняяЦенаЗакупСНДС = 0;
		ПоследняяЦенаРозн = 0;
		ПоследнееКоличествоПрихода = 0;
	//Иначе
	//	Выборка = Рез.Выбрать();
	//	Выборка.Следующий();
	//	ЭлементыФормы.ПоследнийПоставщикПоставки.Заголовок = СокрЛП(Выборка.Поставщик);
	//	ПоследняяДатаПоставки = Выборка.ДатаПоступления;
	//	ПоследняяЦенаЗакуп = Окр(Выборка.ЦенаЗакуп/(1+Выборка.СтавкаНДСЧисло/100),2);
	//	ПоследняяЦенаЗакупСНДС = Окр(Выборка.ЦенаЗакуп,2);
	//	ПоследняяЦенаРозн = Выборка.ЦенаРозн;
	//	ПоследнееКоличествоПрихода = Выборка.КоличествоПрихода;
	//КонецЕсли;
	
	
	//ТХТ = "ВЫБРАТЬ
	//|	СУММА(ПартииЖНВЛСОстатки.КолвоОстаток / ПартииЖНВЛСОстатки.Партия.К) КАК Остаток
	//|ИЗ
	//|	РегистрНакопления.ПартииЖНВЛС.Остатки(
	//|			,
	//|			Товар = &Товар
	//|				И Склад = &Склад) КАК ПартииЖНВЛСОстатки";
	ЭлементыФормы.ПолеОстатков.Очистить();
	
	ТХТ = "ВЫБРАТЬ
	      |	ПартииЖНВЛСОстатки.Партия.ДатаПоступления КАК ДатаПрихода,
	      |	ПартииЖНВЛСОстатки.КолвоОстаток / ПартииЖНВЛСОстатки.Партия.К КАК Остаток,
	      |	ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток / ПартииЖНВЛСОстатки.КолвоОстаток * ПартииЖНВЛСОстатки.Партия.К КАК ЦенаРозн
	      |ИЗ
	      |	РегистрНакопления.ПартииЖНВЛС.Остатки(
	      |			,
	      |			Товар = &Товар
	      |				И Склад = &Склад) КАК ПартииЖНВЛСОстатки
	      |ГДЕ
	      |	ПартииЖНВЛСОстатки.КолвоОстаток > 0
	      |	И ПартииЖНВЛСОстатки.Партия.К > 0
	      |
	      |УПОРЯДОЧИТЬ ПО
	      |	ДатаПрихода УБЫВ";
	
     Запрос = Новый ПостроительОтчета;
	 запрос.Текст = ТХТ;
	 Запрос.Параметры.Очистить();
	 Запрос.Параметры.Вставить("Товар",Товар);
	 Запрос.Параметры.Вставить("Склад",ЭтаФорма.ВладелецФормы.Склад);
	 Запрос.Выполнить();
	 
	 //Запрос = Новый Запрос;	  
	 //Запрос.Текст = ТХТ;
	 //Запрос.УстановитьПараметр("Товар",Товар);	
	 //Запрос.УстановитьПараметр("Склад",ЭтаФорма.ВладелецФормы.Склад);
	 //Рез = Запрос.Выполнить();
	 //Если Рез.Пустой() Тогда
	 //	ОстатокВАптеке = 0;		
	 //Иначе
	 //	Выборка = Рез.Выбрать();
	 //	Выборка.Следующий();
	 //	ОстатокВАптеке = Выборка.Остаток;	
	 //КонецЕсли;	
	 Макет = Запрос.Макет;
	 
	 Запрос.Макет = Неопределено;
	 ТекущаяОбласть = Неопределено;
	 
	 // Осуществим поиск ячейки, в которой находится параметр - Количество 
	 ТекущаяОбласть = Неопределено;
	 Пока Истина Цикл
		 ОбработкаПрерыванияПользователя();
	 ТекущаяОбласть = Макет.НайтиТекст("ДатаПрихода", ТекущаяОбласть, Макет.Область(), 
	 Истина, Истина, Истина, Ложь); 
	 Если ТекущаяОбласть <> Неопределено Тогда 
		 Если ТекущаяОбласть.Параметр = "ДатаПрихода" Тогда 
			 // Установим формат значения - два знака после запятой 
			 ТекущаяОбласть.Формат = "ДФ=dd.MM.yyyy"; 
			 ТекущаяОбласть.ШиринаКолонки = 15;
		 КонецЕсли; 
	 Иначе
		 Прервать;
	 КонецЕсли;
	 
	КонецЦикла; 
	 
	 
	 ТекущаяОбласть = Макет.НайтиТекст("Остаток", Неопределено, Макет.Область(), 
	 Истина, Истина, Истина, Ложь); 
	 Если ТекущаяОбласть <> Неопределено Тогда 
		 ТекущаяОбласть.ШиринаКолонки = 10;
	 КонецЕсли; 
	 
	 
	 ТекущаяОбласть = Макет.НайтиТекст("ЦенаРозн", Неопределено, Макет.Область(), 
	 Истина, Истина, Истина, Ложь); 
	 Если ТекущаяОбласть <> Неопределено Тогда 
		 ТекущаяОбласть.ШиринаКолонки = 10;
	 КонецЕсли; 




	Запрос.Макет = Макет;	
			
	
	Запрос.МакетОформления = ПолучитьМакетОформления(СтандартноеОформление.Трава);
	Запрос.ОформитьМакет();
	Запрос.ВыводитьЗаголовокОтчета = Ложь;
	
	Запрос.Вывести(ЭлементыФормы.ПолеОстатков);
	
	Если НЕ Запрос.Результат.Пустой() Тогда
		
		Выборка = Запрос.Результат.Выбрать();
		Выборка.Следующий();
		ПоследняяЦенаРозн = Выборка.ЦенаРозн;
	Иначе
		ПоследняяЦенаРозн = 0 ;
	КонецЕсли;
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	КоличествоСтрокТЧ =	ЭтаФорма.ВладелецФормы.Товар.Количество();
	ЗаполнитьДанныеФормы();
	Если Проведен = Истина Тогда
		ЭтаФорма.ТолькоПросмотр = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура СледующийНажатие(Элемент)
	
	Если Проведен = Ложь Тогда
		ОбновитьДанныеВтабличнойЧасти();
	КонецЕсли;
	
	Если ИндексТекСтроки = КоличествоСтрокТЧ - 1 Тогда
		Предупреждение("Конец таблицы");
		Возврат;
	КонецЕсли;
	ИндексТекСтроки = ИндексТекСтроки + 1;
	ЗаполнитьДанныеФормы();
	
КонецПроцедуры

Процедура ПредыдущийНажатие(Элемент)
	
	Если Проведен = Ложь Тогда
		ОбновитьДанныеВтабличнойЧасти();
	КонецЕсли;

	
	Если ИндексТекСтроки = 0 Тогда
		Возврат;
	КонецЕсли;	
	
	ИндексТекСтроки = ИндексТекСтроки - 1;
	ЗаполнитьДанныеФормы();
	
	
КонецПроцедуры

Процедура ЦенаРознПриИзменении(Элемент)
	
	//Сначала рассчитаем предельно допустимую цену, если это ЖНВЛС
	СтавкаНДС = Товар.СтавкаНДС;
	Если Товар.ЖНВЛС = Истина Тогда
		Если Регион.Код = 1 Тогда//москва
			Если ЦенаПроизводителя <= 50 Тогда	
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*32)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			ИначеЕсли ЦенаПроизводителя > 50 и ЦенаПроизводителя <= 500 Тогда	
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*28)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			Иначе
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*15)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			КонецЕсли;
		ИначеЕсли Регион.Код = 2 Тогда //московская область
			Если ЦенаПроизводителя <= 50 Тогда	
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*34)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			ИначеЕсли ЦенаПроизводителя > 50 и ЦенаПроизводителя <= 500 Тогда	
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*27)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			Иначе
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*14)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			КонецЕсли;
		ИначеЕсли Регион.Код = 4 Тогда //Ярославль
			Если ЦенаПроизводителя <= 50 Тогда	
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*30)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			ИначеЕсли ЦенаПроизводителя > 50 и ЦенаПроизводителя <= 500 Тогда	
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*25)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			Иначе
				ПредельнаяЦена = (ЦенаЗакупБезНДС+ ЦенаПроизводителя/100*17)*(1+ПереопределениеЗначенияСтавки20_18(СтавкаНДС,ВладелецФормы.Дата)/100);
			КонецЕсли;
		КонецЕсли; 
		// Отбрасываем копейки и сравниваем цену на превышение предельной
		ПредельнаяЦена = ОМ3_ОтброситьДо10Коп (ПредельнаяЦена);		
		Если ЦенаРозн > ПредельнаяЦена Тогда
			ЦенаРозн = ПредельнаяЦена;
		КонецЕсли;
	КонецЕсли;
	
	СуммаРозн = КоличествоФакт*ЦенаРозн;
	НаценкаРозн = Окр((ЦенаРозн/ЦенаЗакуп-1)*100,2); 
	
КонецПроцедуры

Процедура ПрименитьПоследнююЦенуНажатие(Элемент)
	
	Если ПоследняяЦенаРозн = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ЦенаРозн = ПоследняяЦенаРозн;
	ЦенаРознПриИзменении("");
	
КонецПроцедуры

Процедура НедостачаПриИзменении(Элемент)
	
	КоличествоФакт = Количество - Недовоз;
	
КонецПроцедуры

Процедура КоличествоПриИзменении(Элемент)
	
	  НедостачаПриИзменении("");
	  СуммаЗакуп = ЦенаЗакуп*КоличествоФакт;
	  НДСЗакуп = ОМ3_ПолучитьНДСПоСуммеСНДСИСтавке(СуммаЗакуп,СтавкаНДСЗакуп,,ВладелецФормы.Дата);
	  СуммаРозн = КоличествоФакт*ЦенаРозн;
	
КонецПроцедуры

Процедура КоличествоФактПриИзменении(Элемент)
	Недовоз = Количество - КоличествоФакт - БойБрак;
КонецПроцедуры

Процедура НаценкаРознПриИзменении(Элемент)
	
	ЦенаРозн = ЦенаЗакуп*(1+НаценкаРозн/100);
	ЦенаРозн = ОМ3_ОтброситьДо10Коп (ЦенаРозн);	
	ЦенаРознПриИзменении("");

КонецПроцедуры

Процедура ОКНажатие(Элемент)
	
	Если Проведен = Ложь Тогда
		ОбновитьДанныеВтабличнойЧасти();
	КонецЕсли;

	ЭтаФорма.Закрыть();
	
КонецПроцедуры

Процедура ЦенаЗакупПриИзменении(Элемент)
	
	СуммаЗакуп = КоличествоФакт*ЦенаЗакуп;
	НаценкаРозн = Окр((ЦенаРозн/ЦенаЗакуп-1)*100,2); 
	НДСЗакуп = ОМ3_ПолучитьНДСПоСуммеСНДСИСтавке(СуммаЗакуп,СтавкаНДСЗакуп,,ВладелецФормы.Дата);
	ЦенаЗакупБезНДС = Окр(ЦенаЗакуп/(1+СтавкаНДСЗакуп/100),2);
	//Проверим не превысит ли наценка по ЖНВСЛ
	ЦенаРознПриИзменении("");	
	
КонецПроцедуры

Процедура СуммаЗакупПриИзменении(Элемент)
	
	ЦенаЗакуп = Окр(СуммаЗакуп/КоличествоФакт,2);
	ЦенаЗакупБезНДС = Окр(ЦенаЗакуп/(1+СтавкаНДСЗакуп/100),2);
	НДСЗакуп = ОМ3_ПолучитьНДСПоСуммеСНДСИСтавке(СуммаЗакуп,СтавкаНДСЗакуп,,ВладелецФормы.Дата);
	НаценкаРозн = Окр((ЦенаРозн/ЦенаЗакуп-1)*100,2); 
	//Проверим не превысит ли наценка по ЖНВСЛ
	ЦенаРознПриИзменении("");
	ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ЦенаРозн;
	
КонецПроцедуры


Процедура КоличествоФактОкончаниеВводаТекста(Элемент, Текст, Значение, СтандартнаяОбработка)
	
	ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ЦенаРозн;
	
КонецПроцедуры

Процедура ЦенаРознОкончаниеВводаТекста(Элемент, Текст, Значение, СтандартнаяОбработка)
	
	ЭтаФорма.ТекущийЭлемент = ЭлементыФормы.ЦенаРозн;

КонецПроцедуры

Процедура ПрименитьГруппуНаценкиНажатие(Элемент)
	
	Если ГруппаНаценки.Пустая() = Ложь и ГруппаНаценки.Наценка > 0 Тогда
		НаценкаРозн = ГруппаНаценки.Наценка;
		НаценкаРознПриИзменении("");
	КонецЕсли;

КонецПроцедуры

КоличествоСтрокТЧ = 0;