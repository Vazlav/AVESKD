Функция ЗадатьВопрос(ТекстВопроса)
	
		Режим = РежимДиалогаВопрос.ДаНет;
		Ответ = Вопрос(ТекстВопроса, Режим, 0);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат Истина;
		Иначе
			Возврат Ложь;	
		КонецЕсли;
	
	
КонецФункции
	
Процедура КоманднаяПанель2кнОтобратьТовары(Кнопка)
	
	
	Построитель.Параметры.Вставить("СкладКод",Склад.Код);
	Построитель.Параметры.Вставить("Склад",Склад);
	Построитель.Параметры.Вставить("СубъектРФ",Склад.СубъектРФ);
	Построитель.Параметры.Вставить("ТекДата",ТекущаяДата());
	Построитель.Параметры.Вставить("ВидФиксЦены",Склад.ВидФиксЦены.Код);

	Построитель.Выполнить();
	Товар.Загрузить(Построитель.Результат.Выгрузить());
	
	ЭлементыФормы.ПанельТЧ.ТекущаяСтраница = ЭлементыФормы.ПанельТЧ.Страницы.Товар;
	
КонецПроцедуры

Процедура ТоварПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Уценка Тогда
		ОформлениеСтроки.ЦветФона=Новый Цвет(255,179,179);	
	КонецЕсли;
	
	Если ДанныеСтроки.ЖНВЛС = Истина тогда
		 ОформлениеСтроки.Ячейки.ЖНВЛСКартинка.ЗначениеКартинки  =БиблиотекаКартинок.Здоровье;
	КонецЕсли;	
	
КонецПроцедуры

Процедура УправлениеДоступностьюФормы()
	
	Если Проведен Тогда
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.кнПримененияЦен.Доступность = Ложь;	
		ЭлементыФормы.ОсновныеДействияФормы.Кнопки.кнОтложитьЦены.Доступность = Ложь;	
		ЭтаФорма.ТолькоПросмотр = истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	УправлениеДоступностьюФормы();
	
КонецПроцедуры

Процедура ПослеЗаписи()
	
	УправлениеДоступностьюФормы();
	
КонецПроцедуры

Процедура КоманднаяПанель1кнРасценить(Кнопка)
	
	ОМ6_КоманднаяПанельКнопкаРасценить(ЭтаФорма,ЭтотОбъект,Товар);	
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУдалитьНеизмененныеЦены(Кнопка)
	
	СУС=Новый Массив;
	
	ДЛя Каждого Стр Из Товар цикл
		Если Стр.ЦенаОбщаяНовая = Стр.ЦенаОбщая  и стр.ЦенаОбщая > 0 и стр.ЦенаОбщаяНовая > 0 Тогда
			СУС.Добавить(Стр);
		ИначеЕсли Стр.ЦенаИндивидуальнаяНовая = Стр.ЦенаИндивидуальная  и стр.ЦенаИндивидуальнаяНовая > 0 и стр.ЦенаИндивидуальная > 0 Тогда
			СУС.Добавить(Стр);
		КонецЕсли;	
	КонецЦикла;	
	
	Для Каждого Стр Из Сус Цикл
		Товар.Удалить(Стр);
	КонецЦикла;		
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУдалитьСтараяМеньшеНовой(Кнопка)
	
	
	СУС=Новый Массив;
	
	ДЛя Каждого Стр Из Товар цикл
		Если Стр.ЦенаОбщаяНовая > Стр.ЦенаОбщая  и стр.ЦенаОбщая > 0 и стр.ЦенаОбщаяНовая > 0 Тогда
			СУС.Добавить(Стр);
		ИначеЕсли Стр.ЦенаИндивидуальнаяНовая > Стр.ЦенаИндивидуальная  и стр.ЦенаИндивидуальнаяНовая > 0 и стр.ЦенаИндивидуальная > 0 Тогда
			СУС.Добавить(Стр);
		КонецЕсли;	
	КонецЦикла;	
	
	Для Каждого Стр Из Сус Цикл
		Товар.Удалить(Стр);
	КонецЦикла;		
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУдалитьСтараяБольшеНовой(Кнопка)
	
	СУС=Новый Массив;
	
	ДЛя Каждого Стр Из Товар цикл
		Если Стр.ЦенаОбщаяНовая < Стр.ЦенаОбщая  и стр.ЦенаОбщая > 0 и стр.ЦенаОбщаяНовая > 0 Тогда
			СУС.Добавить(Стр);
		ИначеЕсли Стр.ЦенаИндивидуальнаяНовая < Стр.ЦенаИндивидуальная  и стр.ЦенаИндивидуальнаяНовая > 0 и стр.ЦенаИндивидуальная > 0 Тогда
			СУС.Добавить(Стр);
		КонецЕсли;	
	КонецЦикла;	
	
	Для Каждого Стр Из Сус Цикл
		Товар.Удалить(Стр);
	КонецЦикла;		
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУдалитьЦенаНоваяРавнаНулю(Кнопка)
	
	СУС=Новый Массив;
	
	ДЛя Каждого Стр Из Товар цикл
		Если Стр.ЦенаОбщаяНовая = 0 и  Стр.ЦенаИндивидуальнаяНовая = 0 Тогда
			СУС.Добавить(Стр);
		КонецЕсли;	
	КонецЦикла;	
	
	Для Каждого Стр Из Сус Цикл
		Товар.Удалить(Стр);
	КонецЦикла;		
	
КонецПроцедуры

Процедура КоманднаяПанель1ПоказатьПрогноз(Кнопка)
	
	СуммаСтарая = 0;
	СуммаНовая = 0;
	СуммаЗакуп = 0;
	Дельта = 0;
	Для Каждого Стр Из Товар Цикл
		  СуммаСтарая= СуммаСтарая + ?(Стр.ЦенаИндивидуальная>0,Стр.ЦенаИндивидуальная,Стр.ЦенаОбщая)*Стр.Количество/стр.КоэффициентРазбивки*стр.Коэфф;
		  СуммаНовая= СуммаНовая + ?(Стр.ЦенаИндивидуальнаяНовая>0,Стр.ЦенаИндивидуальнаяНовая,Стр.ЦенаОбщаяНовая)*Стр.Количество/стр.КоэффициентРазбивки*стр.Коэфф;

          СуммаЗакуп = СуммаЗакуп + (стр.ЦенаЗакуп*Стр.Количество/стр.КоэффициентРазбивки*стр.Коэфф);
	КонецЦикла;	
	
	Дельта = СуммаНовая - СуммаСтарая;
	
	  
	Сообщить("ИТОГО Суммарный результат переоценки: "+ Окр(Дельта,2));
	Сообщить("Сумма новая : " + СуммаНовая);
	Сообщить("Сумма старая: " + СуммаСтарая);
	Сообщить("Сумма закуп : " + СуммаЗакуп);
	
	
КонецПроцедуры

Процедура ПанельШапкиПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если Элемент.ТекущаяСтраница = Элемент.Страницы.История Тогда
		
		ИсторияИзменений.Очистить();
		
		ТЗИстории = ОбщегоНазначения.ПолучитьИсториюИзмененийДокумента(Ссылка);
		Если НЕ ТЗИстории = Неопределено Тогда
			ЭлементыФормы.ИсторияИзменений.Значение = ТЗИстории;
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры

Процедура КоманднаяПанель1кнУдалитьСтараяБольшеНовыхВсехЦен(Кнопка)
	
	СУС=Новый Массив;
	
	ДЛя Каждого Стр Из Товар цикл
		Если (Стр.ЦенаИндивидуальнаяНовая < Стр.ЦенаИндивидуальная или Стр.ЦенаИндивидуальнаяНовая < Стр.ЦенаОбщая)  и стр.ЦенаИндивидуальнаяНовая > 0  Тогда
			СУС.Добавить(Стр);
		КонецЕсли;	
	КонецЦикла;	
	
	Для Каждого Стр Из Сус Цикл
		Товар.Удалить(Стр);
	КонецЦикла;	
	
КонецПроцедуры

Функция ПроверкаНаСнижениеЦены()
	
	ЕстьСнижениеЦены = Ложь;
	ДЛя Каждого Стр Из Товар цикл
		Если Стр.ЦенаОбщаяНовая < Стр.ЦенаОбщая  и стр.ЦенаОбщая > 0 и стр.ЦенаОбщаяНовая > 0 Тогда
			ЕстьСнижениеЦены = Истина;
			Прервать;
		ИначеЕсли Стр.ЦенаИндивидуальнаяНовая < Стр.ЦенаИндивидуальная  и стр.ЦенаИндивидуальнаяНовая > 0 и стр.ЦенаИндивидуальная > 0 Тогда
			ЕстьСнижениеЦены = Истина;
			Прервать;
		КонецЕсли;	
	КонецЦикла;	
	
	Возврат ЕстьСнижениеЦены;
	
КонецФункции

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		перОтказ = ПроверкаНаСнижениеЦены();
		Если перОтказ = Истина Тогда
			Отказ = ЗадатьВопрос("В таблице присутствуют строки , где Цена старая > Цена новая. Продолжить выполнение?");
			Если Отказ Тогда
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыкнОтложитьЦены(Кнопка)
	
	ОтложенныеЦены = Истина;
	Записать(РежимЗаписиДокумента.Проведение);
	УправлениеДоступностьюФормы();
	
КонецПроцедуры

Процедура ОсновныеДействияФормыкнПримененияЦен(Кнопка)
	
	ОтложенныеЦены = Ложь;
	Записать(РежимЗаписиДокумента.Проведение);
	УправлениеДоступностьюФормы();

КонецПроцедуры


Построитель.Текст = "ВЫБРАТЬ
                    |	АП.Код КАК Код,
                    |	АП.Ссылка КАК Товар,
                    |	АП.Наименование КАК Наименование,
                    |	АП.ЖНВЛС КАК ЖНВЛС,
                    |	ЕСТЬNULL(ФЦ.Цена, 0) КАК ФиксЦена,
                    |	МАКСИМУМ(ЕСТЬNULL(СЦ.Ссылка.СпециальнаяЦена, 0)) КАК СпецЦена
                    |ПОМЕСТИТЬ ВтТовары
                    |ИЗ
                    |	Справочник.АССОРТИМЕНТНЫЙ_ПЛАН КАК АП
                    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФиксЦены.СрезПоследних(, ВидФиксЦены = &ВидФиксЦены) КАК ФЦ
                    |		ПО (ФЦ.КодТовара = АП.Код)
                    |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпециальныеЦены.Аптеки КАК СЦ
                    |		ПО (СЦ.Аптека = &Склад)
                    |			И АП.Ссылка = СЦ.Ссылка.Товар
                    |			И (&ТекДата МЕЖДУ СЦ.Ссылка.НачПериода И СЦ.Ссылка.КонПериода)
                    |{ГДЕ
                    |	АП.Ссылка.* КАК Товар,
                    |	(ЕСТЬNULL(ФЦ.Цена, 0)) КАК ФиксЦена,
                    |	(ЕСТЬNULL(СЦ.Ссылка.СпециальнаяЦена, 0)) КАК СпецЦена}
                    |
                    |СГРУППИРОВАТЬ ПО
                    |	АП.Ссылка,
                    |	ЕСТЬNULL(ФЦ.Цена, 0),
                    |	АП.Код,
                    |	АП.Наименование,
                    |	АП.ЖНВЛС
                    |
                    |ИНДЕКСИРОВАТЬ ПО
                    |	АП.Код
                    |;
                    |
                    |////////////////////////////////////////////////////////////////////////////////
                    |ВЫБРАТЬ
                    |	Остатки.ТоварКод КАК КодТовара,
                    |	Остатки.ПартияКод КАК КодПартии,
                    |	Остатки.КоличествоОстаток КАК КоличествоОстаток,
                    |	Остатки.СуммаЗакупБезНДСОстаток КАК СуммаЗакупБезНДСОстаток,
                    |	ЕСТЬNULL(РЦ.Цена, 0) КАК ЦенаОбщая,
                    |	ЕСТЬNULL(РЦП.Цена, 0) КАК ЦенаИндивидуальная,
                    |	ЕСТЬNULL(РЦП.Уценка, ЛОЖЬ) КАК Уценка,
                    |	ЕСТЬNULL(РЦП.ДатаУстановки, ЕСТЬNULL(РЦ.ДатаУстановки, ДАТАВРЕМЯ(1, 1, 1))) КАК ПредыдущаяДатаУстановкиЦены,
                    |	ЕСТЬNULL(РЦП.Документ, РЦ.Документ) КАК Документ,
                    |	ВтТовары.Наименование КАК Наименование,
                    |	ВтТовары.Товар КАК Товар,
                    |	Партии.СрокГодности КАК СрокГодности,
                    |	ВЫБОР
                    |		КОГДА Партии.К > 1
                    |			ТОГДА ВЫБОР
                    |					КОГДА (ВЫРАЗИТЬ(Остатки.КоличествоОстаток / Партии.К КАК ЧИСЛО(15, 0))) <> Остатки.КоличествоОстаток / Партии.К
                    |						ТОГДА Остатки.КоличествоОстаток
                    |					ИНАЧЕ Остатки.КоличествоОстаток / Партии.К
                    |				КОНЕЦ
                    |		ИНАЧЕ Остатки.КоличествоОстаток
                    |	КОНЕЦ КАК Количество,
                    |	Партии.ЦенаЗакупБезНДСРасчет КАК ЦенаЗакупБезНДС,
                    |	ВЫБОР
                    |		КОГДА Партии.К > 1
                    |			ТОГДА ВЫБОР
                    |					КОГДА (ВЫРАЗИТЬ(Остатки.КоличествоОстаток / Партии.К КАК ЧИСЛО(15, 0))) <> Остатки.КоличествоОстаток / Партии.К
                    |						ТОГДА 1
                    |					ИНАЧЕ Партии.К
                    |				КОНЕЦ
                    |		ИНАЧЕ Партии.К
                    |	КОНЕЦ КАК Коэфф,
                    |	Партии.К КАК КоэффициентРазбивки,
                    |	ВтТовары.ЖНВЛС КАК ЖНВЛС,
                    |	Партии.СтавкаНДСРозн КАК СтавкаНДС,
                    |	Партии.ЦенаЗакуп КАК ЦенаЗакуп,
                    |	ВтТовары.СпецЦена КАК СпецЦена,
                    |	ВЫБОР
                    |		КОГДА Партии.ЦенаЗакуп > 0
                    |			ТОГДА (ЕСТЬNULL(РЦП.Цена, ЕСТЬNULL(РЦ.Цена, 0)) / Партии.ЦенаЗакуп - 1) * 100
                    |		ИНАЧЕ 0
                    |	КОНЕЦ КАК ПроцентНаценкиСтарый
                    |ИЗ
                    |	РегистрНакопления.УЗ_Партии.Остатки(, СкладКод = &СкладКод) КАК Остатки
                    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.УЗ_Партии КАК Партии
                    |		ПО Остатки.ПартияКод = Партии.Код
                    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТовары КАК ВтТовары
                    |		ПО Остатки.ТоварКод = ВтТовары.Код
                    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РозничныеЦены КАК РЦ
                    |		ПО Остатки.ТоварКод = РЦ.ТоварКод
                    |			И (РЦ.АптекаКод = &СкладКод)
                    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РозничныеЦеныПоПартиям КАК РЦП
                    |		ПО Остатки.ПартияКод = РЦП.ПартияКод
                    |			И (РЦП.АптекаКод = &СкладКод)
                    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВходящиеЦеныПоставщика КАК ВходящиеЦеныПоставщика
                    |		ПО Остатки.ПартияКод = ВходящиеЦеныПоставщика.ПартияКод
                    |ГДЕ
                    |	Остатки.КоличествоОстаток > 0
                    |	И НЕ Партии.ТипПартии = ""I""
                    |{ГДЕ
                    |	(ЕСТЬNULL(РЦП.Цена, ЕСТЬNULL(РЦ.Цена, 0))) КАК ЦенаРозн,
                    |	Партии.СрокГодности,
                    |	Партии.ПартияРодительКод,
                    |	Партии.ДатаПоступления,
                    |	(ЕСТЬNULL(РЦП.ДатаУстановки, ЕСТЬNULL(РЦ.ДатаУстановки, ДАТАВРЕМЯ(1, 1, 1)))) КАК ПоследняяДатаУстановкиЦены,
                    |	Партии.ПоставщикИсходный,
                    |	(ВЫБОР
                    |			КОГДА ВтТовары.ЖНВЛС = ИСТИНА
                    |					И Партии.ЦенаПроизводителяБезНДС = 0
                    |				ТОГДА ЛОЖЬ
                    |			ИНАЧЕ ИСТИНА
                    |		КОНЕЦ) КАК ИсключитьЖВБезЦенПроизводителя,
                    |	(ВЫБОР
                    |			КОГДА ВтТовары.ЖНВЛС = ИСТИНА
                    |					И Партии.ЦенаГосРегистрации = 0
                    |				ТОГДА ЛОЖЬ
                    |			ИНАЧЕ ИСТИНА
                    |		КОНЕЦ) КАК ИсключитьЖВБезЦенГосРеестра,
                    |	(ВЫБОР
                    |			КОГДА Партии.ЦенаЗакуп > 0
                    |				ТОГДА (ЕСТЬNULL(РЦП.Цена, ЕСТЬNULL(РЦ.Цена, 0)) / Партии.ЦенаЗакуп - 1) * 100
                    |			ИНАЧЕ 0
                    |		КОНЕЦ) КАК ПроцентНаценкиСтарый,
					|	ЕСТЬNULL(ВходящиеЦеныПоставщика.КачествоТовара,"""") КАК КачествоТовара}
                    |
                    |УПОРЯДОЧИТЬ ПО
                    |	Наименование";