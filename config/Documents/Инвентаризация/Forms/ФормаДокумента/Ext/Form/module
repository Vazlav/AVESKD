Перем ТЗЕИТ;

Функция ТекущаяСтрокаДокумента  () 
    // Назначение:
	// Дает объект - тек строку документа
	// 
    // 
	//--------------------------------------------------------------------------------
	ТекСтрокаТЧ="";
	ИндексТекСтроки=Товар.Индекс(ЭлементыФормы.Товар.ТекущаяСтрока);
    ТекСтрокаТЧ=ТОвар.Получить( ИндексТекСтроки); // Рез. тип объекта - СтрокаТабличнойЧасти

	Возврат ТекСтрокаТЧ;
	
КонецФункции


Процедура КоманднаяПанель1ЗаполнитьОстатками(Кнопка)
	
	Если Склад.Ссылка = Справочники.МестаХранения.ПустаяСсылка() Тогда
		Предупреждение("Выберите подразделение, по которому надо сформировать остатки");
		Возврат;
	КонецЕсли;
	
	ТХТ="ВЫБРАТЬ
	    |	ПартииЖНВЛСОстатки.Товар КАК Товар,
	    |	ПартииЖНВЛСОстатки.Партия КАК Партия,
	    |	ПартииЖНВЛСОстатки.КолвоОстаток КАК КоличествоУчет,
	    |	ПартииЖНВЛСОстатки.СуммаЗакупСНДСОстаток КАК СуммаЗакупУчет,
	    |	ПартииЖНВЛСОстатки.СуммаНДСЗакупОстаток КАК СуммаНДСЗакупУчет,
	    |	ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток КАК СуммаРознУчет,
	    |	ПартииЖНВЛСОстатки.СуммаРознНДСОстаток КАК СуммаНДСРознУчет,
	    |	ПартииЖНВЛСОстатки.СтавкаНДС КАК СтавкаНДС,
	    |	1 КАК Коэфф,
	    |	-ПартииЖНВЛСОстатки.КолвоОстаток КАК КоличествоРазница,
	    |	-ПартииЖНВЛСОстатки.СуммаЗакупСНДСОстаток КАК СуммаЗакупРазница,
	    |	-ПартииЖНВЛСОстатки.СуммаНДСЗакупОстаток КАК СуммаНДСЗакупРазница,
	    |	-ПартииЖНВЛСОстатки.СуммаРознСНДСОстаток КАК СуммаРознРазница,
	    |	-ПартииЖНВЛСОстатки.СуммаРознНДСОстаток КАК СуммаНДСРознРазница
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата, Склад = &Склад) КАК ПартииЖНВЛСОстатки
	    |
	    |УПОРЯДОЧИТЬ ПО
	    |	ПартииЖНВЛСОстатки.Товар.Наименование";
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТХТ;
	Запрос.УстановитьПараметр("Дата",Дата);
	Запрос.УстановитьПараметр("Склад",Склад);
	
	ТЗ = Запрос.Выполнить().Выгрузить();
	Товар.Загрузить(ТЗ);
	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	Если ЭтотОбъект.ЭтоНовый() Тогда
		Дата = ТекущаяДата();
		Фирма = Константы.ОсновнаяФирма.Получить();
	КонецЕсли;
	
	ОМ10_ЗаполнитьСписокПечФорм(ЭтотОбъект,СписокПечатныхФорм);
	
КонецПроцедуры

Процедура ФайлНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка=Ложь;
	
	Режим = РежимДиалогаВыбораФайла.Открытие;
	ДОФ = Новый ДиалогВыбораФайла(Режим);
	ДОФ.Расширение="*.dbf";
	Доф.Фильтр="Файл заказа *.dbf|*.dbf";
	
	
	Если ДОФ.Выбрать() Тогда
		Файл=ДОФ.ПолноеИмяФайла;
	КонецЕсли;	

КонецПроцедуры


Процедура ЗагрузитьОстаткиАптекиИЗФайла()
	
	Если Товар.Количество()  = 0 Тогда
		Предупреждение("Сначала надо загрузить остатки учетные");
		Возврат;
	КонецЕсли;
	
	//ТекстДок = Новый ТекстовыйДокумент;
	
	
	ТЗОст = Новый ТаблицаЗначений;
	ТЗОст.Колонки.Добавить("Код");
	ТЗОст.Колонки.Добавить("Количество");
	ТЗОст.Колонки.Добавить("Цена");
	ТЗОст.Колонки.Добавить("Партия");
	ТЗОст.Колонки.Добавить("Сумма");
	
	ДБФ=Новый Xbase;
	
	Ф=Новый Файл(Файл);
	Если Ф.Существует()=Ложь ТОгда
		ПРедупреждение("Нет такого файла ! <"+Файл+">");
		Возврат;
	КонецЕсли;
	
	
	ДБФ.ОткрытьФайл(Файл);
	
	КЗ = ДБФ.КоличествоЗаписей();
	//СотаяЧасть = КЗ/100;
	//ЭлементыФормы.Инд.МаксимальноеЗначение = КЗ;
	//ЭлементыФормы.Инд.Значение = 0;
	Состояние("Обрабатываем таблицу остатков аптеки ......");
	Для Ы=1 По КЗ Цикл
		ДБФ.Перейти(Ы);
		
		Если Ы%100 = 0 Тогда
			Состояние("Подготовлено "+Ы+ " из " + КЗ);
		КонецЕсли;
		
		Если ДБФ.QNT = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		ТекСтр = ТЗОст.Добавить();
		ТекСтр.Код = ДБФ.IDGOOD;
		ТекСтр.Количество = ДБФ.QNT;
		ТекСтр.Цена = ДБФ.COST_R;
		ТекСтр.Сумма = ТекСтр.Количество*ТекСтр.Цена;
		ТекСтр.Партия = ДБФ.PART;
		
	КонецЦикла;
	
	ДБФ.ЗакрытьФайл();
	
	ТЗОст.Свернуть("Код,Партия","Количество,Сумма");
	
	СовместитьУчетИФакт(ТЗОст);
	//ТЗСсылокНаПартии = ПолучитьТаблицуСсылокНаПартии(ТЗОст.ВыгрузитьКолонку("Партия"));
	//СформируемТЗЕИТ();
	//
	////ТЗОст.ВыбратьСтроку();
	//КоличествоСтрокОстатков = ТЗОст.Количество();


	//Состояние("Накатываем таблицу остатков аптеки на остатки учетные в 1С .......");
	//н=0;
	//Для каждого стр из ТЗОст Цикл
	//	н=н+1;
	//	Если н%100 = 0 Тогда
	//		Состояние("Загружено "+н+ " из " + КоличествоСтрокОстатков);
	//	КонецЕсли;
	//	
	//	ЕИТСтрока = ТЗЕИТ.Найти(стр.Код,"Код");
	//	
	//	Если ЕИТСтрока = Неопределено Тогда
	//		Сообщить("Не нашли ЕИТ по коду: " + стр.Код);
	//		Возврат;
	//	КонецЕсли;		
	//	
	//	ПартияСтрока = ТЗСсылокНаПартии.Найти(СокрЛП(стр.Партия),"ПартияНаименование");
	//	Если ПартияСтрока = Неопределено Тогда
	//		Сообщить("Не найдена партия "+стр.Партия+" файл не обрабатываем");
	//		Возврат;				
	//	КонецЕсли;
	//	
	//	
	//	ТоварСсылка = ЕИТСтрока.Товар;
	//	ПартияСсылка = ПартияСтрока.ПартияСсылка;
	//	
	//	НайденнаяСтрока = Товар.Найти(ПартияСсылка,"Партия");
	//	Если НайденнаяСтрока = Неопределено Тогда //Если нет на остатке, то добавляем строку
	//		НоваяСтрока = Товар.Добавить();
	//		НоваяСтрока.Товар = ТоварСсылка;
	//		НоваяСтрока.Коэфф = ЕИТСтрока.К;
	//		НоваяСтрока.КоличествоУчет = 0;
	//		НоваяСтрока.КоличествоФакт = стр.Количество;
	//		НоваяСтрока.КоличествоРазница = стр.Количество;
	//		НоваяСтрока.Партия = ПартияСсылка;
	//		НоваяСтрока.СтавкаНДС = ПартияСтрока.СтавкаНДС;
	//		НоваяСтрока.СуммаЗакупФакт = (стр.Количество*ПартияСтрока.ЦенаЗакуп)/НоваяСтрока.Партия.ЕИТЗакупки.К*ЕИТСтрока.К;
	//		НоваяСтрока.СуммаЗакупРазница = НоваяСтрока.СуммаЗакупФакт;
	//		НоваяСтрока.СуммаРознФакт = стр.Сумма;
	//		НоваяСтрока.СуммаРознРазница = стр.Сумма;
	//		НоваяСтрока.СуммаНДСЗакупРазница = Окр(ОМ3_НДСИзСуммыПоСтавке(НоваяСтрока.СуммаЗакупФакт,НоваяСтрока.СтавкаНДС),2); 
	//		НоваяСтрока.СуммаНДСРознРазница = Окр(ОМ3_НДСИзСуммыПоСтавке(НоваяСтрока.СуммаРознФакт,НоваяСтрока.СтавкаНДС),2); 
	//		
	//	Иначе //Есть на остатке, редактируем
	//		НайденнаяСтрока.КоличествоФакт = НайденнаяСтрока.КоличествоФакт + стр.Количество*ЕИТСтрока.К;
	//		НайденнаяСтрока.КоличествоРазница = НайденнаяСтрока.КоличествоФакт -НайденнаяСтрока.КоличествоУчет;
	//		Если НайденнаяСтрока.КоличествоУчет = 0 Тогда
	//			НайденнаяСтрока.СуммаЗакупФакт = НайденнаяСтрока.КоличествоФакт*ПартияСтрока.ЦенаЗакуп/НайденнаяСтрока.Партия.ЕИТЗакупки.К; // (стр.Количество*ПартияСтрока.ЦенаЗакуп)/НайденнаяСтрока.Партия.ЕИТЗакупки.К*ЕИТСтрока.К;
	//			//Сообщить("партия: "+ НайденнаяСтрока.Партия + " проверить эту строчку");
	//		Иначе
	//			НайденнаяСтрока.СуммаЗакупФакт = НайденнаяСтрока.КоличествоФакт*(НайденнаяСтрока.СуммаЗакупУчет/НайденнаяСтрока.КоличествоУчет); //стр.Количество*(НайденнаяСтрока.СуммаЗакупУчет/НайденнаяСтрока.КоличествоУчет);
	//		КонецЕсли;
	//		НайденнаяСтрока.СуммаЗакупРазница = НайденнаяСтрока.СуммаЗакупФакт - НайденнаяСтрока.СуммаЗакупУчет;
	//		НайденнаяСтрока.СуммаРознФакт = НайденнаяСтрока.СуммаРознФакт + стр.Сумма;
	//		НайденнаяСтрока.СуммаРознРазница = НайденнаяСтрока.СуммаРознФакт - НайденнаяСтрока.СуммаРознУчет; // стр.Сумма - НайденнаяСтрока.СуммаРознУчет;
	//		НайденнаяСтрока.СуммаНДСЗакупРазница = (Окр(ОМ3_НДСИзСуммыПоСтавке(НайденнаяСтрока.СуммаЗакупФакт,НайденнаяСтрока.СтавкаНДС),2) - НайденнаяСтрока.СуммаНДСЗакупУчет); 
	//		НайденнаяСтрока.СуммаНДСРознРазница = (Окр(ОМ3_НДСИзСуммыПоСтавке(НайденнаяСтрока.СуммаРознФакт,НайденнаяСтрока.СтавкаНДС),2) - НайденнаяСтрока.СуммаНДСРознУчет); 
	//		
	//		Если НайденнаяСтрока.СуммаРознФакт < НайденнаяСтрока.СуммаЗакупФакт Тогда
	//			ТекстДок.ДобавитьСтроку("партия: " + ПартияСсылка + " розн = " + НайденнаяСтрока.СуммаРознФакт + " < закуп = " + НайденнаяСтрока.СуммаЗакупФакт);
	//		КонецЕсли;
	//		
	//		
	//		//Если количества и суммы равны , то разницы ндс по любому должны нулю равны быть
	//		Если (НайденнаяСтрока.КоличествоУчет = НайденнаяСтрока.КоличествоФакт)
	//			И (НайденнаяСтрока.СуммаРознУчет = НайденнаяСтрока.СуммаРознФакт)
	//			И (НайденнаяСтрока.СуммаЗакупУчет = НайденнаяСтрока.СуммаЗакупФакт) Тогда
	//			НайденнаяСтрока.СуммаНДСЗакупРазница = 0; 
	//			НайденнаяСтрока.СуммаНДСРознРазница = 0;
	//		КонецЕсли;
	//		
	//	КонецЕсли;
	//	
	//	
	//КонецЦикла;
	//
	//ТекстДок.Показать();
	
КонецПроцедуры

Процедура ЗагрузитьПоОптовомуСкладу()
	Если Товар.Количество()  = 0 Тогда
		Предупреждение("Сначала надо загрузить остатки учетные");
		Возврат;
	КонецЕсли;
	
	ТекстДок = Новый ТекстовыйДокумент;
	СпрПартий = Справочники.Партии;
	
	ТЗОст = Новый ТаблицаЗначений;
	ТЗОст.Колонки.Добавить("Код");
	ТЗОст.Колонки.Добавить("Количество");
	ТЗОст.Колонки.Добавить("Цена");
	ТЗОст.Колонки.Добавить("Партия");
	ТЗОст.Колонки.Добавить("Сумма");
	
	ДБФ=Новый Xbase;
	
	Ф=Новый Файл(Файл);
	Если Ф.Существует()=Ложь ТОгда
		ПРедупреждение("Нет такого файла ! <"+Файл+">");
		Возврат;
	КонецЕсли;
	
	
	ДБФ.ОткрытьФайл(Файл);
	
	КЗ = ДБФ.КоличествоЗаписей();
	
	ЭлементыФормы.Инд.МаксимальноеЗначение = КЗ;
	ЭлементыФормы.Инд.Значение = 0;
	Состояние("Обрабатываем таблицу остатков аптеки ......");
	Для Ы=1 По КЗ Цикл
		ДБФ.Перейти(Ы);
		
		ЭлементыФормы.Инд.Значение = ЭлементыФормы.Инд.Значение + 1;
		
		Если ДБФ.QNT = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		КодПартии = Формат(ДБФ.ID,"ЧГ=0");		
		Партия = СпрПартий.НайтиПоКоду(КодПартии);
		Если Партия = СпрПартий.ПустаяСсылка() Тогда
			Сообщить("Не нашли партию по коду: " + КодПартии);
			Продолжить;
		КонецЕсли;		
		
		
		ТекСтр = ТЗОст.Добавить();
		ТекСтр.Код = ДБФ.ID;
		ТекСтр.Количество = ДБФ.QNT;
		//ТекСтр.Цена = ДБФ.COST_R;
		//ТекСтр.Сумма = ТекСтр.Количество*ТекСтр.Цена;
		ТекСтр.Партия = Партия;
		
	КонецЦикла;
	
	ДБФ.ЗакрытьФайл();
	
	ТЗОст.Свернуть("Партия","Количество,Сумма");
	
	//ТЗОст.ВыбратьСтроку();
	
	ЭлементыФормы.Инд.МаксимальноеЗначение = ТЗОст.Количество();
	ЭлементыФормы.Инд.Значение = 0;
	Состояние("Накатываем таблицу остатков склада на остатки учетные в 1С .......");
	Для каждого стр из ТЗОст Цикл
		
		ЭлементыФормы.Инд.Значение = ЭлементыФормы.Инд.Значение + 1;
		
		НайденнаяСтрока = Товар.Найти(стр.Партия,"Партия");
		Если НайденнаяСтрока = Неопределено Тогда //Если нет на остатке, то добавляем строку
			НоваяСтрока = Товар.Добавить();
			НоваяСтрока.Товар = стр.Партия.Владелец;
			НоваяСтрока.Коэфф = 1;
			НоваяСтрока.КоличествоУчет = 0;
			НоваяСтрока.КоличествоФакт = стр.Количество;
			НоваяСтрока.КоличествоРазница = стр.Количество;
			НоваяСтрока.Партия = стр.Партия;
			НоваяСтрока.СтавкаНДС = НоваяСтрока.Партия.СтавкаНДС;
			НоваяСтрока.СуммаЗакупФакт = (стр.Количество*НоваяСтрока.Партия.ЦенаЗакуп)/НоваяСтрока.Партия.ЕИТЗакупки.К;
			НоваяСтрока.СуммаЗакупРазница = НоваяСтрока.СуммаЗакупФакт;
			НоваяСтрока.СуммаРознФакт = НоваяСтрока.СуммаЗакупФакт;
			НоваяСтрока.СуммаРознРазница = НоваяСтрока.СуммаЗакупФакт;
			НоваяСтрока.СуммаНДСЗакупРазница = Окр(ОМ3_НДСИзСуммыПоСтавке(НоваяСтрока.СуммаЗакупФакт,НоваяСтрока.СтавкаНДС),2); 
			НоваяСтрока.СуммаНДСРознРазница = Окр(ОМ3_НДСИзСуммыПоСтавке(НоваяСтрока.СуммаЗакупФакт,НоваяСтрока.СтавкаНДС),2); 
			
		Иначе //Есть на остатке, редактируем
			НайденнаяСтрока.КоличествоФакт = стр.Количество;
			НайденнаяСтрока.КоличествоРазница = стр.Количество-НайденнаяСтрока.КоличествоУчет;
			Если НайденнаяСтрока.КоличествоУчет = 0 Тогда
				НайденнаяСтрока.СуммаЗакупФакт = (стр.Количество*НайденнаяСтрока.Партия.ЦенаЗакуп)/НайденнаяСтрока.Партия.ЕИТЗакупки.К;
				//Сообщить("партия: "+ НайденнаяСтрока.Партия + " проверить эту строчку");
			Иначе
				НайденнаяСтрока.СуммаЗакупФакт = стр.Количество*(НайденнаяСтрока.СуммаЗакупУчет/НайденнаяСтрока.КоличествоУчет);
			КонецЕсли;
			НайденнаяСтрока.СуммаЗакупРазница = НайденнаяСтрока.СуммаЗакупФакт - НайденнаяСтрока.СуммаЗакупУчет;
			НайденнаяСтрока.СуммаРознФакт = НайденнаяСтрока.СуммаЗакупФакт;
			НайденнаяСтрока.СуммаРознРазница = НайденнаяСтрока.СуммаЗакупФакт - НайденнаяСтрока.СуммаРознУчет;
			НайденнаяСтрока.СуммаНДСЗакупРазница = (Окр(ОМ3_НДСИзСуммыПоСтавке(НайденнаяСтрока.СуммаЗакупФакт,НайденнаяСтрока.СтавкаНДС),2) - НайденнаяСтрока.СуммаНДСЗакупУчет); 
			НайденнаяСтрока.СуммаНДСРознРазница = (Окр(ОМ3_НДСИзСуммыПоСтавке(НайденнаяСтрока.СуммаЗакупФакт,НайденнаяСтрока.СтавкаНДС),2) - НайденнаяСтрока.СуммаНДСРознУчет); 
			
			Если НайденнаяСтрока.СуммаРознФакт < НайденнаяСтрока.СуммаЗакупФакт Тогда
				ТекстДок.ДобавитьСтроку("партия: " + стр.Партия + " розн = " + НайденнаяСтрока.СуммаРознФакт + " < закуп = " + НайденнаяСтрока.СуммаЗакупФакт);
			КонецЕсли;
			
			
			//Если количества и суммы равны , то разницы ндс по любому должны нулю равны быть
			Если (НайденнаяСтрока.КоличествоУчет = НайденнаяСтрока.КоличествоФакт)
				И (НайденнаяСтрока.СуммаРознУчет = НайденнаяСтрока.СуммаРознФакт)
				И (НайденнаяСтрока.СуммаЗакупУчет = НайденнаяСтрока.СуммаЗакупФакт) Тогда
				НайденнаяСтрока.СуммаНДСЗакупРазница = 0; 
				НайденнаяСтрока.СуммаНДСРознРазница = 0;
			КонецЕсли;
			
		КонецЕсли;
		
		
	КонецЦикла;
	
	ТекстДок.Показать();
	
КонецПроцедуры

Процедура ЗагрузитьОстаткиИзФайла()
	
	Если Склад.ТипСклада = Перечисления.ТипыМХ.Розн Тогда
		ЗагрузитьОстаткиАптекиИЗФайла();
	Иначе
		ЗагрузитьПоОптовомуСкладу();
	КонецЕсли;
	
КонецПроцедуры


Процедура ОсновныеДействияФормы1КарточкаТовара(Кнопка)
	
	ТСД=ТекущаяСтрокаДокумента  ();
	
	Карточка=Отчеты.ДвижениеТовара1.Создать();
	
	Карточка.ВыбПартия=ТСД.Партия;
	
	Карточка.ВыбСклад=Склад;
	
	Карточка.ВыбТовар=ТСД.ТОвар;
	Карточка.ВыбФирма=Фирма;
	Карточка.НачПер=Дата-60*60*24*15;// по умолчанию за последние 15 дней
	Карточка.КонПер=Дата;
	
	
	Ф=Карточка.ПолучитьФорму("Форма");
	
	Ф.Открыть();
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	СуммаЗакупУчет = Товар.Итог("СуммаЗакупУчет");
	СуммаРознУчет = Товар.Итог("СуммаРознУчет");
	СуммаЗакупФакт = Товар.Итог("СуммаЗакупФакт");
	СуммаРознФакт = Товар.Итог("СуммаРознФакт");
	СуммаРазница = Товар.Итог("СуммаРознРазница");

	
КонецПроцедуры

Процедура Кнопка1Нажатие(Элемент)
	ОМ10_КнопкаПечатьНажатие (ЭтотОбъект,ЭтаФорма);
КонецПроцедуры

Процедура СкладОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	Фирма = ВыбранноеЗначение.Фирма;
КонецПроцедуры

Процедура СкладПриИзменении(Элемент)
	
	Если Элемент.Значение.Фирма <> Фирма Тогда
		Фирма = Элемент.Значение.Фирма;
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель3кнПрочитатьДанныеАптеки(Кнопка)
	
	ДанныеХранилища = ДанныеАптеки.Получить();
	Если НЕ ДанныеХранилища = Неопределено Тогда
		
		ЭлементыФормы.ТабДанныеАптеки.УстановитьТекст(ДанныеХранилища.ПолучитьТекст());
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ФирмаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	Если (Склад.Фирма <> ВыбранноеЗначение) и (НЕ Склад.Пустая()) Тогда
		Предупреждение("Нельзя выбрать фирму отличную от фирмы по уже выбранной ранее аптеке!"	);
		ВыбранноеЗначение = Фирма;
	КонецЕсли;	
	
КонецПроцедуры

Процедура ЗагрузитьДанныеАптекиИЗPG(Кнопка)
	
	МДЗагрузитьДанныеАптекиИЗPG();
	
КонецПроцедуры




