
Процедура КнопкаВыполнитьНажатие(Кнопка)
	ЭлементыФормы.Инд.Видимость=Истина;
	//-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --Запрос шаблон--GtG-->
	ТХТ="ВЫБРАТЬ
	    |	ПартииЖНВЛС.Товар КАК ТОвар,
	    |	ПартииЖНВЛС.Партия.Поставщик КАК Поставщик,
	    |	ПартииЖНВЛС.Товар.ЖНВЛС КАК ЖНВЛС,
	    |	СУММА(ПартииЖНВЛС.КолвоОстаток) КАК КолвоОстаток,
	    |	СУММА(ПартииЖНВЛС.СуммаЗакупСНДСОстаток) КАК СуммаЗакупСНДСОстаток,
	    |	СУММА(ПартииЖНВЛС.СуммаРознСНДСОстаток) КАК СуммаРознСНДСОстаток,
	    |	СУММА(ВЫБОР
	    |			КОГДА ПартииЖНВЛС.Партия.Поставщик.ДаетФинскидку
	    |					И ПартииЖНВЛС.Товар.ЖНВЛС = ИСТИНА
	    |				ТОГДА ПартииЖНВЛС.СуммаЗакупСНДСОстаток - ПартииЖНВЛС.СуммаЗакупСНДСОстаток / 100 * &ПроцентФинскидки
	    |			ИНАЧЕ ПартииЖНВЛС.СуммаЗакупСНДСОстаток
	    |		КОНЕЦ) КАК ЗакупкаЗаВычетомФинскидки,
	    |	СУММА(ВЫБОР
	    |			КОГДА ПартииЖНВЛС.Партия.Поставщик.ДаетФинскидку И ПартииЖНВЛС.Товар.ЖНВЛС = ИСТИНА
	    |				ТОГДА ПартииЖНВЛС.СуммаЗакупСНДСОстаток / 100 * &ПроцентФинскидки
	    |			ИНАЧЕ 0
	    |		КОНЕЦ) КАК Финскидка
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Остатки(&Дата, Склад = &Аптека) КАК ПартииЖНВЛС
	    |ГДЕ
	    |	ПартииЖНВЛС.КолвоОстаток > 0
	    |
	    |СГРУППИРОВАТЬ ПО
	    |	ПартииЖНВЛС.Товар,
	    |	ПартииЖНВЛС.Партия.Поставщик,
	    |	ПартииЖНВЛС.Товар.ЖНВЛС
	    |
	    |УПОРЯДОЧИТЬ ПО
	    |	ПартииЖНВЛС.Товар.Наименование";
	
	Запрос=Новый Запрос;
	Запрос.Текст=ТХТ;
	Запрос.УстановитьПараметр("Аптека",Аптека);
	Запрос.УстановитьПараметр("Дата",КонецДня(ДатаОстатка));
	Запрос.УстановитьПараметр("ПроцентФинскидки",ПроцентФинскидки);
	
	ТЗ=Запрос.Выполнить().Выгрузить();
	//-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --GtG--<
	
	Таб=Новый ТабличныйДокумент;                                                                 
	МАк=ЭтотОбъект.ПолучитьМакет("Макет");
	
	
	//------------------ Индикатор --------------------------------------------------------------------------GtG---
	ЭлементыФормы.Инд.Значение=0;
	ЭлементыФормы.Инд.МаксимальноеЗначение=ТЗ.Количество();
	//------------------ Индикатор КОНЕЦ---------------------------------------------------------------------GtG---
	
	Секция=МАк.ПолучитьОбласть("АптДата");
	
	Секция.Параметры.Аптека=Аптека;											
	Секция.Параметры.ДатаОстатка=Формат(ДАтаОстатка,"ДФ=dd.MM.yyyy");
	Таб.Вывести(Секция);
	
	Если БезТовара=Ложь ТОгда
		Секция=Мак.ПолучитьОбласть("ШСТОваром");
        Таб.Вывести(Секция);
		
		

		
		Секция=Мак.ПолучитьОбласть("ЗагТаб");
        Таб.Вывести(Секция);

		НН=0;
		Для каждого Стр из ТЗ Цикл
			ЭлементыФормы.Инд.Значение=ЭлементыФормы.Инд.Значение+1;
			
			НН=НН+1;
			
			Секция=МАк.ПолучитьОбласть("Строка");
			
			Секция.Параметры.НН=НН;
			Секция.Параметры.Товар=Стр.ТОвар;
			Секция.Параметры.Жнвлс=?(Стр.ЖНВЛС=Истина,"V","");
			Секция.Параметры.Колво=Стр.КолвоОстаток;	
			Секция.Параметры.Закуп=Стр.СуммаЗакупСНДСОстаток;	
			Секция.Параметры.ФС	  =Стр.Финскидка;
			Секция.Параметры.ЗакупБФС=Стр.ЗакупкаЗаВычетомФинскидки;	
			Секция.Параметры.Розн=Стр.СуммаРознСНДСОстаток;	
			Секция.Параметры.Пост = Стр.Поставщик;
			Таб.Вывести(Секция);
		КонецЦикла;	

		Итоги=ТЗ.Скопировать();
		Итоги.Свернуть("","СуммаЗакупСНДСОстаток,Финскидка,ЗакупкаЗаВычетомФинскидки,СуммаРознСНДСОстаток");
	    СтрИтогов=Итоги.Получить(0);
		
		Секция=Мак.ПолучитьОбласть("ОбщийИтог");
		
		Секция.Параметры.Закуп=	СтрИтогов.СуммаЗакупСНДСОстаток;
		Секция.Параметры.ФС	  = СтрИтогов.Финскидка;
		Секция.Параметры.ЗакупБФС	= СтрИтогов.ЗакупкаЗаВычетомФинскидки;
		Секция.Параметры.Розн       = СтрИтогов.СуммаРознСНДСОстаток;
		
        Таб.Вывести(Секция);
	КонецЕсли;
	
	
	Секция=Мак.ПолучитьОбласть("ЗагФСП");
	Таб.Вывести(Секция);
	
	ИтПост=ТЗ.Скопировать();
	ИтПост.Свернуть("Поставщик","СуммаЗакупСНДСОстаток,Финскидка,ЗакупкаЗаВычетомФинскидки,СуммаРознСНДСОстаток");
	
	Для каждого Стр из ИтПост Цикл
		Секция=МАк.ПолучитьОбласть("СтрП");
		Секция.Параметры.Закуп=Стр.СуммаЗакупСНДСОстаток;	
		Секция.Параметры.ФС	  =Стр.Финскидка;
		Секция.Параметры.ЗакупБФС=Стр.ЗакупкаЗаВычетомФинскидки;	
		Секция.Параметры.Розн=Стр.СуммаРознСНДСОстаток;	
		Секция.Параметры.Пост = Стр.Поставщик;
		Таб.Вывести(Секция);
	КонецЦикла;	
	
	
	Секция=МАк.ПолучитьОбласть("ИтогПост");
	Секция.Параметры.Закуп=ИтПост.Итог("СуммаЗакупСНДСОстаток");	
	Секция.Параметры.ФС	  =ИтПост.Итог("Финскидка");
	Секция.Параметры.ЗакупБФС=ИтПост.Итог("ЗакупкаЗаВычетомФинскидки");	
	Секция.Параметры.Розн=ИтПост.Итог("СуммаРознСНДСОстаток");	
	Таб.Вывести(Секция);

	
	
	
	
	Таб.ОтображатьСетку=Ложь;
	Таб.ОтображатьЗаголовки=Ложь;
	Таб.ОтображатьГруппировки=Ложь;
	ТАб.ТолькоПросмотр=Истина;
	Таб.ОриентацияСтраницы=ОриентацияСтраницы.Ландшафт;
	Таб.АвтоМасштаб=Истина;
	Таб.Показать("Отчет Остатки и финскидки");
	
	
	
	
	
	
	
	
	
	
	
ЭлементыФормы.Инд.Видимость=Ложь;	
КонецПроцедуры



ЭлементыФормы.Инд.Видимость=Ложь;
ПроцентФинскидки=10;