Перем МегаТХТ;

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	
	ТХТ=МегаТХТ;
	
	
	
	Если БезДежурныхКарт=Ложь ТОгда
		ТХТ=СтрЗаменить(ТХТ,"И НЕ РеализацияККМДисконт.Карта В(ВЫБРАТЬ ДежурныеДК.Наименование ИЗ Справочник.ДежурныеДК КАК ДежурныеДК  ГДЕ ДежурныеДК.ПометкаУдаления = ЛОЖЬ)","");
	КонецЕсли;
	
	
	Построитель.Текст=тхт;	
	
	
		
	КолвоДней=(КонецДня(КонПериода)-КонецДня(НачПериода))/24/60/60  ;
	
	
	ПустаяТЗДат= Новый ТаблицаЗначений; // понадобится при выводе детализированных строк
	
	ПустаяТЗДат.Колонки.Добавить("Дата");
	ПустаяТЗДат.Колонки.Добавить("Скидка");
	ПустаяТЗДат.Колонки.Добавить("СуммаСоСкидкой");
	ПустаяТЗДат.Колонки.Добавить("СуммаБезСкидки");
	
	ПустаяТЗДат.ЗаполнитьЗначения(0,"Скидка,СуммаСоСкидкой,СуммаБезСкидки");
	
	Для Ы=0 По КолвоДней Цикл 
		Стр=ПустаяТЗДат.Добавить();
		Стр.Дата=НачалоДня(НачПериода+ы*24*60*60);
	КонецЦикла;
	
	Построитель.Параметры.Вставить("Дата1",НачалоДня(НачПериода));
	Построитель.Параметры.Вставить("Дата2",КонецДня(КонПериода));
	
	
	
	//СГРУППИРОВАТЬ ПО
    //    	РеализацияККМДисконт.Ссылка.Склад,
    //    	РеализацияККМДисконт.Карта,
    //    	РеализацияККМДисконт.Ссылка.Дата

	Если ИспользованиеКартВАптеках=Истина тогда
		Построитель.Текст=СтрЗаменить(Построитель.Текст,"СГРУППИРОВАТЬ ПО
		|РеализацияККМДисконт.Ссылка.Склад,
		|РеализацияККМДисконт.Карта,
		|РеализацияККМДисконт.Ссылка.Дата",
		"СГРУППИРОВАТЬ ПО
		|РеализацияККМДисконт.Карта,
		|РеализацияККМДисконт.Ссылка.Склад,
		|РеализацияККМДисконт.Ссылка.Дата");
	КонецЕсли;
		
			
			
	
	Построитель.Выполнить();
	
	
	Рез=Построитель.Результат;
	
	
	РезСуммаСкидки =0;
	РезСуммаРозн   =0;
	РезПолнаяСумма =0;
	
	
	Таб=Новый ТабличныйДокумент;                                                                 
	МАк=ЭтотОбъект.ПолучитьМакет("ОтчетПоДК");
	Секция=Мак.ПолучитьОбласть("Шапка");
	
	Секция.Параметры.НачПериода=Формат(НачПериода,"ДФ=dd.MM.yy");
	Секция.Параметры.КонПериода=Формат(КонПериода,"ДФ=dd.MM.yy");
	
	Таб.Вывести(Секция); 
	
	
	Секция=Мак.ПолучитьОбласть("ШапкаСокр");
	Таб.Вывести(Секция);

	
	
		
	
	
	Если РазвернутыйОтчет=ИСтина ТОгда
				
		// шапка с квадратиками по датам
		Секция=Мак.ПолучитьОбласть("ШапкаСДатами|ДК");
		Таб.Вывести(Секция);
		
		Если ДетальноПоДатам=Истина ТОгда
			// генерим даты
			Для Ы=0 По КолвоДней Цикл 
				Секция=Мак.ПолучитьОбласть("ШапкаСДатами|Дата");
				Секция.Параметры.Дата=НачПериода+ы*24*60*60;
				Таб.Присоединить(Секция);
			КонецЦикла;
		КонецЕсли;
		// итоговая колонка
		Секция=Мак.ПолучитьОбласть("ШапкаСДатами|ИтогВерт");
		Таб.Присоединить(Секция);
		Секция=Мак.ПолучитьОбласть("ШапкаСДатами|ДнейИсп");
		Таб.Присоединить(Секция);
		
	КонецЕсли;
	
	
	
	
	
	
	
	ВыборкаПоСкладам=Рез.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,?(ИспользованиеКартВАптеках=Ложь,"Склад","НомерДК"));
	
	//-------------------------------------------------------------------
	ЭлементыФормы.Инд.Значение=0;
	ЭлементыФормы.Инд.МаксимальноеЗначение=  ВыборкаПоСкладам.Количество();
	
	Пока ВыборкаПоСкладам.Следующий() Цикл
		
		
		Если ВыборкаПоСкладам.ДнейИспользования<Карта_использована тогда
			Продолжить;
		КонецЕсли;

		
		
		
		
		ОбработкаПрерыванияПользователя();
		
		ЭлементыФормы.ТекАптека.Заголовок=?(ИспользованиеКартВАптеках=Ложь,ВыборкаПоСкладам.Склад,ВыборкаПоСкладам.НомерДК);
		
		ЭлементыФормы.Инд.Значение=ЭлементыФормы.Инд.Значение+1;
		//Сообщить("Склад :"+ВыборкаПоСкладам.Склад);
		Секция=Мак.ПолучитьОбласть("Аптека");
		Секция.Параметры.Аптека=?(ИспользованиеКартВАптеках=Ложь,ВыборкаПоСкладам.Склад,ВыборкаПоСкладам.НомерДК);
		Секция.Параметры.ИтогАптека=ВыборкаПоСкладам.СуммаСкидки;
		Секция.Параметры.СуммаСоСкидкоЙ=ВыборкаПоСкладам.СуммаСоСкидкой;
		Секция.Параметры.СуммаВсего    =ВыборкаПоСкладам.ПолнаяСумма;
		Таб.Вывести(Секция); 
		
		
		//------------------<Для общих итогов>-------------------GtG----03.07.2008
		РезСуммаСкидки =РезСуммаСкидки+ВыборкаПоСкладам.СуммаСкидки;
		РезСуммаРозн   =РезСуммаРозн+ВыборкаПоСкладам.СуммаСоСкидкой;
		РезПолнаяСумма =РезПолнаяСумма+ВыборкаПоСкладам.ПолнаяСумма;
		
		
		
		
		
		Если РазвернутыйОтчет=Истина Тогда
			
			
			
			
			
			
			ВыборкаПоКартам=ВыборкаПоСкладам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,?(ИспользованиеКартВАптеках=Ложь,"НомерДК","Склад"));
			
			//-------------------------------------------------------------------
			ЭлементыФормы.Инд1.Значение=0;
			ЭлементыФормы.Инд1.МаксимальноеЗначение=ВыборкаПоКартам.Количество();
			
			
			Пока  ВыборкаПоКартам.Следующий()=Истина Цикл
				
				
				Если ВыборкаПоКартам.ДнейИспользования<Карта_использована тогда
					Продолжить;
				КонецЕсли;
				
				
				
				Секция=Мак.ПолучитьОбласть("Карта|ДК");
				Секция.Параметры.Карта=?(ИспользованиеКартВАптеках=Ложь,ВыборкаПоКартам.НомерДК,ВыборкаПоКартам.Склад);
				Секция.Параметры.РасшифровкаКарты=?(ИспользованиеКартВАптеках=Ложь,ВыборкаПоКартам.НомерДК,ВыборкаПоКартам.Склад);
				Таб.Вывести(Секция); 
				
				ЭлементыФормы.Инд1.Значение=ЭлементыФормы.Инд1.Значение+1;
				
				
				
				
				
				Если ДетальноПоДатам=Истина Тогда
					ТЗДАптеки=ПустаяТЗДат.Скопировать();
					
					
					ВыборкаПоДатам=ВыборкаПоКартам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"Дата");
					Пока ВыборкаПоДатам.Следующий() Цикл
						ТекДата= НачалоДня(ВыборкаПоДатам.Дата);
						Стр=ТЗДАптеки.Найти(ТекДата,"Дата"); // найдем нужную строку
						Стр. Скидка =  ВыборкаПоДатам.СуммаСкидки;
						Стр.СуммаСоСкидкой= ВыборкаПоДатам.СуммаСоСкидкой;
						Стр.СуммаБезСкидки=ВыборкаПоДатам.ПолнаяСумма;
					КонецЦикла;
					
					
					Для каждого Стр из ТЗДАптеки Цикл
						Секция=Мак.ПолучитьОбласть("Карта|Дата");
						Секция.Параметры.Скидка=Стр.Скидка;
						Таб.Присоединить(Секция); 
						
					КонецЦикла;	
					
				КонецЕсли;
				
				
				
				Секция=Мак.ПолучитьОбласть("Карта|ИтогВерт");
				Секция.Параметры.ИтогКарта=ВыборкаПоКартам.СуммаСкидки;
				Таб.Присоединить(Секция); 
				
				
				Секция=Мак.ПолучитьОбласть("Карта|ДнейИсп");
				Секция.Параметры.ДнейИсп=ВыборкаПоКартам.ДнейИспользования;
				Таб.Присоединить(Секция); 
				
				
			КонецЦикла;
		КонецЕсли; 
	КонецЦикла;
	
	
	
	
	Если РазвернутыйОтчет=Ложь ТОгда
		Секция=Мак.ПолучитьОбласть("ИтогСокр");
		
		Секция.Параметры.ИтогАптека	=  РезСуммаСкидки;
		Секция.Параметры.СуммаСоСкидкой=  РезСуммаРозн;	
		Секция.Параметры.СуммаВсего    =  РезПолнаяСумма;
		
		Таб.Вывести(Секция);
	КонецЕсли;
	
	
	
	
	Таб.ОтображатьСетку=Ложь;
	Таб.ОтображатьЗаголовки=Ложь;
	Таб.ОтображатьГруппировки=Ложь;
	ТАб.ТолькоПросмотр=Истина;
	Таб.Показать("Отчет по ДК");
	
	ЭлементыФормы.ТекАптека.Заголовок="Готово.";
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ОсновныеДействияФормыАптекиБезДежурныхКарт(Кнопка)
	
	Постр=Новый ПостроительОтчета;
	Постр.Текст="ВЫБРАТЬ
	            |	МестаХранения.Код,
	            |	МестаХранения.Ссылка КАК Аптека
	            |ИЗ
	            |	Справочник.МестаХранения КАК МестаХранения
	            |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДежурныеДК КАК ДежурныеДК
	            |		ПО (ДежурныеДК.Владелец = МестаХранения.Ссылка)
	            |ГДЕ
	            |	МестаХранения.ТипСклада = ЗНАЧЕНИЕ(Перечисление.ТипыМХ.Розн)
	            |	И МестаХранения.ДатаЗакрытия <= МестаХранения.ДатаПерехода
	            |	И МестаХранения.ПометкаУдаления = ЛОЖЬ
	            |	И ДежурныеДК.Наименование ЕСТЬ NULL 
	            |
	            |УПОРЯДОЧИТЬ ПО
	            |	МестаХранения.Наименование";
				
	Постр.Выполнить();
	Постр.Вывести();
	
	
	
КонецПроцедуры

МегаТХТ="ВЫБРАТЬ
        |	РеализацияККМДисконт.Ссылка.Склад КАК Склад,
        |	СУММА(РеализацияККМДисконт.СуммаСоСкидкой) КАК СуммаСоСкидкой,
        |	СУММА(РеализацияККМДисконт.СуммаСкидки) КАК СуммаСкидки,
        |	РеализацияККМДисконт.Карта КАК НомерДК,
        |	СУММА(РеализацияККМДисконт.СуммаСоСкидкой + РеализацияККМДисконт.СуммаСкидки) КАК ПолнаяСумма,
        |	РеализацияККМДисконт.Ссылка.Дата КАК Дата,
        |	1 КАК ДнейИспользования
        |ИЗ
        |	Документ.РеализацияККМ.Дисконт КАК РеализацияККМДисконт
        |ГДЕ
        |	РеализацияККМДисконт.Ссылка.Проведен = ИСТИНА
        |	И РеализацияККМДисконт.Ссылка.Дата МЕЖДУ &Дата1 И &Дата2
        |	И (НЕ РеализацияККМДисконт.Карта В
        |				(ВЫБРАТЬ
        |					ДежурныеДК.Наименование
        |				ИЗ
        |					Справочник.ДежурныеДК КАК ДежурныеДК
        |				ГДЕ
        |					ДежурныеДК.ПометкаУдаления = ЛОЖЬ))
        |{ГДЕ
        |	РеализацияККМДисконт.Ссылка.Склад.*,
        |	РеализацияККМДисконт.Карта}
        |
        |СГРУППИРОВАТЬ ПО
        |	РеализацияККМДисконт.Ссылка.Склад,
        |	РеализацияККМДисконт.Карта,
        |	РеализацияККМДисконт.Ссылка.Дата
        |{УПОРЯДОЧИТЬ ПО
        |	Склад.*,
        |	НомерДК,
        |	Дата}
        |ИТОГИ
        |	СУММА(СуммаСоСкидкой),
        |	СУММА(СуммаСкидки),
        |	СУММА(ПолнаяСумма),
        |	СУММА(ДнейИспользования)
        |ПО
        |	Склад,
        |	НомерДК,
        |	Дата";	


НеИсподьзоватьДДК=Истина;


Если НеИсподьзоватьДДК=Истина ТОгда
	МегаТХТ=СтрЗаменить(МегаТХТ,"И НЕ РеализацияККМДисконт.Карта В(ВЫБРАТЬ ДежурныеДК.Наименование ИЗ Справочник.ДежурныеДК КАК ДежурныеДК  ГДЕ ДежурныеДК.ПометкаУдаления = ЛОЖЬ)","");
КонецЕсли;	


Построитель.Текст=МегаТХТ;	

Построитель.Порядок.Очистить();
Построитель.Порядок.Добавить("Склад");
Построитель.Порядок.Добавить("НомерДК");
Построитель.Порядок.Добавить("Дата");





		