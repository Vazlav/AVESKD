
Процедура КнопкаСформироватьНажатие(Кнопка)
	
	   Построитель.Параметры.Очистить();
	   Построитель.Параметры.Вставить("Дата1",НачалоДня(НачПериода));
	   Построитель.Параметры.Вставить("Дата2",КонецДня(КонПериода));
	
	   Построитель.Выполнить();
	   
	   
	   Таб=ЭлементыФормы.Таб;
	   
	   Таб.Очистить();
	   
	   Мак= ЭтотОбъект.ПолучитьМакет("Макет");
	   
	   Область=Мак.ПолучитьОбласть("Шапка");
	   
	   Область.Параметры.НачПериода=Формат(НачПериода,"ДФ=dd.MM.yyyy");
	   Область.Параметры.КонПериода=Формат(КонПериода,"ДФ=dd.MM.yyyy");
	   
	   Таб.Вывести(Область);
	   
	   ИтогоСуммаРозничная=0;
	   ИтогоОткат=0;
	   
	   
	   Аптека=Построитель.Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	   
	   Пока Аптека.Следующий()=Истина Цикл
		   
		   Область=Мак.ПолучитьОбласть("Аптека");
		   
		   Область.Параметры.Аптека	    = Аптека.Аптека;
		   Область.Параметры.СуммаПродаж= Аптека.СуммаРозничнаяПолная;
		   Область.Параметры.СуммаПремии= Аптека.Откат;
		   
		   
		   Таб.Вывести(Область);
		   
		   
		   
		   
		   
		   ИтогоСуммаРозничная=ИтогоСуммаРозничная+Аптека.СуммаРозничнаяПолная;
		   ИтогоОткат=ИтогоОткат+Аптека.Откат;

		   
		   
		   
		   Врачи=Аптека.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		   
		   
		   Пока Врачи.Следующий()=истина Цикл
			   РецептурныеКнижки=Врачи.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			   
			   Область=Мак.ПолучитьОбласть("Врач");
			   
			   Область.Параметры.Врач	    = Врачи.Врач;
			   Область.Параметры.ВрачСсылка	    = Врачи.ВрачСсылка;

			   Область.Параметры.СуммаПродаж= Врачи.СуммаРозничнаяПолная;
			   Область.Параметры.СуммаПремии= Врачи.Откат;
			   
			   			   
			   Таб.Вывести(Область);
			   
			   Если Детально=Истина Тогда
				   Пока РецептурныеКнижки.Следующий() = истина Цикл
					   
					   Область=Мак.ПолучитьОбласть("Книжка");
					   
					   Область.Параметры.РецептурнаяКнижка	    = РецептурныеКнижки.РецептурнаяКнижка;
					   Область.Параметры.СуммаПродаж= РецептурныеКнижки.СуммаРозничнаяПолная;
					   Область.Параметры.СуммаПремии= РецептурныеКнижки.Откат;
					   
					   Таб.Вывести(Область);
					   
					   
				   КонецЦикла;
			   КонецЕсли; 
		   КонецЦикла;
	   КонецЦикла; 
	   
	   
	   Область=Мак.ПолучитьОбласть("ИТОГО");
	   
	  	   
	  	   
	   Область.Параметры.СуммаПродаж= ИтогоСуммаРозничная;
	   Область.Параметры.СуммаПремии= ИтогоОткат;
	   
	   Таб.Вывести(Область);
	   
	   
	   	   
	   
	   Таб.ТолькоПросмотр=Истина;
	   Таб.АвтоМасштаб=Истина;
	   Таб.ОриентацияСтраницы=ОриентацияСтраницы.Портрет;
	   Таб.ОтображатьЗаголовки=Ложь;
	   Таб.ОтображатьСетку=Ложь;
	   Таб.Показать("Отчет по врачам","Врачи с "+Формат(НачПериода,"ДФ=dd.MM.yyyy")+" по "+Формат(КонПериода,"ДФ=dd.MM.yyyy")+".XLS");
	   
	   
	   
	   ЭтаФорма.Панель.ТекущаяСтраница=ЭтаФорма.Панель.Страницы["Отчет"];
	
	
	
	
	
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры


Процедура ОтчетПоПродажамПоРецептамВыбранногоВрача(Расшифровка)
	
	  //-------------------- Запрос by GtG -----------------------
	  // Назначение: Ищем продажи по рецептам врачишки
	  //----------------------------------------------------------
	  ТХТ="ВЫБРАТЬ
	      |	ДисконтныеКартыОбороты.Период КАК Дата,
	      |	ДисконтныеКартыОбороты.Товар КАК Товар,
	      |	СУММА(ДисконтныеКартыОбороты.СуммаРознСоСкОборот) КАК СуммаРознСоСк,
	      |	СУММА(ВЫРАЗИТЬ(ДисконтныеКартыОбороты.СуммаРознСоСкОборот / 100 * 5 КАК ЧИСЛО(15, 2))) КАК СуммаСкидки,
	      |	СУММА(ДисконтныеКартыОбороты.КолвоОборот) КАК Колво
	      |ИЗ
	      |	РегистрНакопления.ДисконтныеКарты.Обороты(
	      |			&Дата1,
	      |			&Дата2,
	      |			День,
	      |			НомерДК В
	      |				(ВЫБРАТЬ
	      |					ВрачиРецептурныеКнижки.Штрихкод
	      |				ИЗ
	      |					Справочник.Врачи.РецептурныеКнижки КАК ВрачиРецептурныеКнижки
	      |				ГДЕ
	      |					ВрачиРецептурныеКнижки.Ссылка = &Врач)) КАК ДисконтныеКартыОбороты
	      |
	      |СГРУППИРОВАТЬ ПО
	      |	ДисконтныеКартыОбороты.Период,
	      |	ДисконтныеКартыОбороты.Товар
	      |
	      |УПОРЯДОЧИТЬ ПО
	      |	Дата,
	      |	Товар
	      |ИТОГИ
	      |	СУММА(СуммаРознСоСк),
	      |	СУММА(СуммаСкидки),
	      |	СУММА(Колво)
	      |ПО
	      |	Дата";
		  
		  
			  
	  Запрос=Новый Запрос;
	  Запрос.Текст=ТХТ;
	  
	  Запрос.УстановитьПараметр("Врач",Расшифровка);
	  Запрос.УстановитьПараметр("Дата1",НачалоДня(НачПериода));
	  Запрос.УстановитьПараметр("Дата2",КонецДня(КонПериода));
	  
	  
	  Таб=Новый ТабличныйДокумент;
	  
	  Мак=ЭтотОбъект.ПолучитьМакет("продажиПоРецептамВрача");
	  
	  Область=Мак.ПолучитьОбласть("Шапка");
	  
	  Область.Параметры.Врач=Расшифровка;
	  Область.Параметры.НачПериода=Формат(НачПериода,"ДФ=dd.MM.yyyy");
	  Область.Параметры.КонПериода=Формат(КонПериода,"ДФ=dd.MM.yyyy");

	  Таб.Вывести(Область);
	  
	  
	  ИтСумма=0;
	  ИтСкидка=0;
	  
	  
	  Рез=Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	  
	  Пока Рез.Следующий() Цикл
		  ИтСумма=ИтСумма+Рез.СуммаРознСоСк;
		  ИтСкидка=ИтСкидка+Рез.СуммаСкидки;
		  
		  Область=Мак.ПолучитьОбласть("Дата");
		  
		  Область.Параметры.Дата=Рез.Дата;
		  Область.Параметры.СуммаСоСкидкой=Рез.СуммаРознСоСк;
		  Область.Параметры.СуммаСкидки=Рез.СуммаСкидки;
		  
		  Таб.Вывести(Область);
		  
		  
		  
		  Тов=Рез.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		  
		  Пока Тов.Следующий() Цикл
			  
			  
			  
			  Область=Мак.ПолучитьОбласть("Товар");
			  
			  Область.Параметры.Товар=Тов.ТОвар;
			  Область.Параметры.СуммаСоСкидкой=Тов.СуммаРознСоСк;
			  Область.Параметры.СуммаСкидки=Тов.СуммаСкидки;
			  
			  Таб.Вывести(Область);
			  
			  
		  КонецЦикла;
		  
		  
	  	
	  
	  КонецЦикла; 
	  
	  Область=Мак.ПолучитьОбласть("ИТОГО");
	  
	  Область.Параметры.СуммаСоСкидкой=ИтСумма;
	  Область.Параметры.СуммаСкидки=ИтСкидка;
	  
	  Таб.Вывести(Область);
	  
	  Таб.АвтоМасштаб=Истина;
	  Таб.ОриентацияСтраницы=ОриентацияСтраницы.Портрет;
	  Таб.ОтображатьСетку=Ложь;
	  Таб.ТолькоПросмотр=Истина;
	  Таб.ОтображатьЗаголовки=Ложь;
	  Таб.Показать();
	  
	  
	  //----------------------------------------------------------
	
	
КонецПроцедуры



Процедура ПолеТабличногоДокумента1ОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	  СтандартнаяОбработка=ложь;
	  
	  Если ТипЗнч(Расшифровка)=Тип("СправочникСсылка.Врачи") ТОгда
		  ОтчетПоПродажамПоРецептамВыбранногоВрача(Расшифровка);
	  КонецЕсли;
	  
КонецПроцедуры

Построитель.Текст="ВЫБРАТЬ
                  |	ЕСТЬNULL(ПОДСТРОКА(ВрачиРецептурныеКнижки.Ссылка.Наименование, 1, 150), ""--Неизвестно--"") КАК Врач,
                  |	ВрачиРецептурныеКнижки.Ссылка.Специализация,
                  |	ДисконтныеКартыОбороты.НомерДК КАК РецептурнаяКнижка,
                  |	СУММА(ДисконтныеКартыОбороты.СуммаРознСоСкОборот) КАК СуммаРозничнаяПолная,
                  |	СУММА(ВЫРАЗИТЬ(ДисконтныеКартыОбороты.СуммаРознСоСкОборот / 100 * 5 КАК ЧИСЛО(15, 2))) КАК Откат,
                  |	ВрачиРецептурныеКнижки.Ссылка.Аптека КАК Аптека,
                  |	ВрачиРецептурныеКнижки.Ссылка КАК ВрачСсылка
                  |{ВЫБРАТЬ
                  |	Врач,
                  |	Специализация,
                  |	РецептурнаяКнижка,
                  |	СуммаРозничнаяПолная,
                  |	Откат}
                  |ИЗ
                  |	РегистрНакопления.ДисконтныеКарты.Обороты(&Дата1, &Дата2, Период, ) КАК ДисконтныеКартыОбороты
                  |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Врачи.РецептурныеКнижки КАК ВрачиРецептурныеКнижки
                  |		ПО ДисконтныеКартыОбороты.НомерДК = ВрачиРецептурныеКнижки.Штрихкод
                  |{ГДЕ
                  |	ВрачиРецептурныеКнижки.Ссылка.* КАК Врач,
                  |	ВрачиРецептурныеКнижки.Ссылка.Аптека.*}
                  |
                  |СГРУППИРОВАТЬ ПО
                  |	ДисконтныеКартыОбороты.НомерДК,
                  |	ВрачиРецептурныеКнижки.Ссылка.Специализация,
                  |	ЕСТЬNULL(ПОДСТРОКА(ВрачиРецептурныеКнижки.Ссылка.Наименование, 1, 150), ""--Неизвестно--""),
                  |	ВрачиРецептурныеКнижки.Ссылка.Аптека,
                  |	ВрачиРецептурныеКнижки.Ссылка
                  |
                  |УПОРЯДОЧИТЬ ПО
                  |	Аптека,
                  |	Врач,
                  |	РецептурнаяКнижка
                  |ИТОГИ
                  |	СУММА(СуммаРозничнаяПолная),
                  |	СУММА(Откат)
                  |ПО
                  |	Аптека,
                  |	ВрачСсылка КАК Врачи,
                  |	РецептурнаяКнижка";