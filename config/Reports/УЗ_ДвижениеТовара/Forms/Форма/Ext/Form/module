//============================< ДОДЕЛАТЬ: >================================GtG===
//ПРИ ВЫБОРЕ ПАРТИИ ИЗ ТЯЦЕКИ тз ЗАПУСКАТЬ ОТЧЕТ - ДВИЖЕНИЯ ОСТАТКИ ТОВАРА ПО ПАРТИЯМ  
//С ПАРАМЕТРАМИ КАК У ТЕКУЩЕГО ОТЧЕТА ПО РЕГИСТРУ ОСТАТКОВ ПАРТИЙ ТОВАРОВ жнвлс

Процедура КнопкаСформироватьНажатие(Кнопка)
	
	
	СписокУсловий = Новый  СписокЗначений;
	
	//Если ВыбФирма <> Справочники.Фирмы.ПустаяСсылка() Тогда
	//	СписокУсловий.Добавить("Фирма = &ВыбФирма");
	//КонецЕсли; 
	
	Если ВыбТовар.Пустая() и КодПартии = 0 Тогда
		Предупреждение("Выберите либо товар, либо партию.");
		Возврат;
	КонецЕсли;
	
	Если КодПартии > 0 Тогда
		СписокУсловий.Добавить("ПартияКод = &КодПартии");
	КонецЕсли;
	
	Если НЕ ВыбТовар.Пустая() Тогда
		СписокУсловий.Добавить("ТоварКод = &КодТовара");
	КонецЕсли; 

	
	Если НЕ ВыбСклад.Пустая() Тогда
		СписокУсловий.Добавить("СкладКод = &КодСклада");
	КонецЕсли; 
	
	
	Масс = "";
	
	СписокУсловийСтрока = "";
	Если СписокУсловий.Количество() > 0 Тогда
		Для каждого стр из СписокУсловий Цикл
			СписокУсловийСтрока = СписокУсловийСтрока + "и "	 + стр.Значение + " ";
		КонецЦикла;
		СписокУсловийСтрока = Сред(СписокУсловийСтрока,2,СтрДлина(СписокУсловийСтрока));
	КонецЕсли;
	
	Если ВыбТовар.Разбивается = Ложь Тогда
		ТХТ="ВЫБРАТЬ 
		|	ОстаткиИОбороты.Регистратор.Дата КАК ДатаДок,
		|	ОстаткиИОбороты.Регистратор.Номер КАК НомерДок,
		|	ОстаткиИОбороты.Регистратор КАК Документ,
		|	АП.Наименование КАК Товар,
		|	МХ.Наименование КАК Склад,
		|	ОстаткиИОбороты.СтавкаНДСЗакуп КАК СтавкаНДС,
		|	Партии.Серия,
		|	Партии.СрокГодности,
		|	ОстаткиИОбороты.КоличествоПриход КАК КолвоПриход,
		|	ОстаткиИОбороты.КоличествоРасход КАК КолвоРасход,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСПриход КАК СуммаЗакупБезНДСПриход,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСРасход КАК СуммаЗакупБезНДСРасход,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСНачальныйОстаток,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСКонечныйОстаток,
		|	ОстаткиИОбороты.КоличествоНачальныйОстаток КАК КолвоНачальныйОстаток,
		|	ОстаткиИОбороты.КоличествоКонечныйОстаток КАК КолвоКонечныйОстаток,
		|	Партии.Код КАК Партия
		|ИЗ
		|	РегистрНакопления."+ВидРегистра+".ОстаткиИОбороты(&НачПер, &КонПер, Регистратор, ДвиженияИГраницыПериода, " + СписокУсловийСтрока + "  ) КАК ОстаткиИОбороты
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УЗ_Партии как Партии ПО Партии.Код = ОстаткиИОбороты.ПартияКод
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Ассортиментный_План как АП ПО АП.Код = ОстаткиИОбороты.ТоварКод
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаХранения как МХ ПО МХ.Код = ОстаткиИОбороты.СкладКод
		|
		|УПОРЯДОЧИТЬ ПО
		|	Партии.Код,
		|	ДатаДок
		|ИТОГИ
		|	СУММА(СуммаЗакупБезНДСНачальныйОстаток),
		|	СУММА(СуммаЗакупБезНДСКонечныйОстаток),
		|	СУММА(КоличествоНачальныйОстаток),
		|	СУММА(КоличествоКонечныйОстаток)
		|ПО
		|	Партия";
	Иначе
		
		ТХТ="ВЫБРАТЬ 
		|	ОстаткиИОбороты.Регистратор.Дата КАК ДатаДок,
		|	ОстаткиИОбороты.Регистратор.Номер КАК НомерДок,
		|	ОстаткиИОбороты.Регистратор КАК Документ,
		|	АП.Наименование КАК Товар,
		|	МХ.Наименование КАК Склад,
		|	ОстаткиИОбороты.СтавкаНДСЗакуп КАК СтавкаНДС,
		|	Партии.Серия,
		|	Партии.СрокГодности,
		|	ОстаткиИОбороты.КоличествоПриход/Партии.К КАК КолвоПриход,
		|	ОстаткиИОбороты.КоличествоРасход/Партии.К КАК КолвоРасход,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСПриход КАК СуммаЗакупБезНДСПриход,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСРасход КАК СуммаЗакупБезНДСРасход,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСНачальныйОстаток,
		|	ОстаткиИОбороты.СуммаЗакупБезНДСКонечныйОстаток,
		|	ОстаткиИОбороты.КоличествоНачальныйОстаток/Партии.К КАК КолвоНачальныйОстаток,
		|	ОстаткиИОбороты.КоличествоКонечныйОстаток/Партии.К КАК КолвоКонечныйОстаток,
		|	Партии.Код КАК Партия
		|ИЗ
		|	РегистрНакопления."+ВидРегистра+".ОстаткиИОбороты(&НачПер, &КонПер, Регистратор, ДвиженияИГраницыПериода, " + СписокУсловийСтрока + "  ) КАК ОстаткиИОбороты
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УЗ_Партии как Партии ПО Партии.Код = ОстаткиИОбороты.ПартияКод
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Ассортиментный_План как АП ПО АП.Код = ОстаткиИОбороты.ТоварКод
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаХранения как МХ ПО МХ.Код = ОстаткиИОбороты.СкладКод
		|
		|УПОРЯДОЧИТЬ ПО
		|	Партии.Код,
		|	ДатаДок
		|ИТОГИ
		|	СУММА(СуммаЗакупБезНДСНачальныйОстаток),
		|	СУММА(СуммаЗакупБезНДСКонечныйОстаток),
		|	СУММА(КолвоНачальныйОстаток),
		|	СУММА(КолвоКонечныйОстаток)
		|ПО
		|	Партия";

		
	КонецЕсли;
	
	Запрос=Новый Запрос(ТХТ);
	//Сообщить(ТХТ);
	//Возврат;
	
	Запрос.УстановитьПараметр("НачПер",НачалоДня(НачПер));//ВАЖНО! начало и конец дня
	Запрос.УстановитьПараметр("КонПер",КонецДня(КонПер)); //ВАЖНО
	Запрос.УстановитьПараметр("КодФирмы",ВыбФирма.Код);
	Запрос.УстановитьПараметр("КодСклада",ВыбСклад.Код);
	Запрос.УстановитьПараметр("КодТовара",ВыбТовар.Код);
	Запрос.УстановитьПараметр("КодПартии",КодПартии);
	
	ДерДвиж=ЗАпрос.Выполнить();//ОМ8_ВыполнитьЗапросНаСервере (Тхт,ЗначениеВСтрокуВнутр(СПЗ),2);
	
	Если ДерДвиж=Неопределено ТОгда
		Предупреждение("Ошибка при выполнении запроса! КОД:000001");
		ВОЗВРАТ ;
	КонецЕсли;
	
	
	//============================< Шаблон печати таблицы начало >================================GtG===
	
	Таб = Новый  ТабличныйДокумент;
	Таб.ОтображатьСетку= ЛОЖЬ;
	Таб.АвтоМасштаб= ИСТИНА;
	Таб.ОтображатьЗаголовки = Ложь;
	
	Мак = ЭтотОбъект.ПолучитьМакет("ОтчетОДвиженияхТоваров");
	
	КолвоСтрокШапки=0;
	
	//============================< Шапка таблицы >================================GtG===
	
	Секц  = Мак.ПолучитьОбласть("Сформирован");
	Струк = Новый Структура;
	Струк.Вставить("Сост",РабочаяДата);
	
	Секц.Параметры.Заполнить(Струк);
	
	Таб.Вывести(Секц);
	
	Секц  = Мак.ПолучитьОбласть("Заголовок");
	Струк = Новый  Структура;
	Струк.Вставить("НачПерДата",Формат(НачПер,"ДФ=dd.MM.yy"));
	Струк.Вставить("КонПерДата",Формат(КонПер,"ДФ=dd.MM.yy"));
	Секц.Параметры.Заполнить(Струк);
	
	Таб.Вывести(Секц);
	
	Если НЕ ВыбФирма.Пустая() Тогда
		Секц=Мак.ПолучитьОбласть("УсловиеФирма");
		Струк= Новый  Структура;
		Струк.Вставить("ВыбФирма",ВыбФирма);
		Секц.Параметры.Заполнить(Струк);
		Таб.Вывести(Секц);
	КонецЕсли; 
	
	Если НЕ ВыбСклад.Пустая() Тогда
		Секц=Мак.ПолучитьОбласть("УсловиеСклад");  
		Струк= Новый  Структура;
		Струк.Вставить("ВыбСклад",ВыбСклад);
		Секц.Параметры.Заполнить(Струк);
		Таб.Вывести(Секц);
	КонецЕсли; 
	
	
	Если НЕ ВыбТовар.Пустая() Тогда
		Секц=Мак.ПолучитьОбласть("УсловиеТовар");  
		Струк= Новый  Структура;
		Струк.Вставить("Выбтовар",Выбтовар);
		Струк.Вставить("КодАП",Выбтовар.Код);

		Секц.Параметры.Заполнить(Струк);
		Таб.Вывести(Секц);
	КонецЕсли; 
	
	Секц=Мак.ПолучитьОбласть("ШапкаТД");  
	Таб.Вывести(Секц);	
	
	КолвоСтрокШапки = Таб.ВысотаТаблицы;// колво строк уже выведенных в таб	
	//Инициализация переменных
	

	
	
	ВыборкаТ=ДерДвиж.Выбрать(ОбходРезультатаЗапроса.Прямой);
	
	ТекПартия="";
	Заголовок=Истина;  Первая=Истина;
	СекцКонОст = Мак.ПолучитьОбласть("КонОст"); 
	Пока ВыборкаТ.Следующий() Цикл
		
		Если ТекПартия<>ВыборкаТ.Партия  Тогда
			Если Заголовок=Истина ТОгда
				
				Заголовок=Ложь;//выведен
			Иначе
				//------------------<Выводим итоги и заголовок след.>-------------------GtG----
				Если Первая=Ложь тогда
					Таб.ЗакончитьГруппуСтрок();
					Таб.Вывести(СекцКонОст);// конец предыдущей
				КонецЕсли;
				Заголовок=Истина;
			КонецЕсли;
			//------------------<Выводим заголовок серии>-------------------GtG----
			
				СекцОст = Мак.ПолучитьОбласть("НачОст"); 
				СекцОст.Параметры.Колво = ВыборкаТ.КолвоНачальныйОстаток;
				СекцОст.Параметры.СуммаЗакуп=ВыборкаТ.СуммаЗакупБезНДСНачальныйОстаток;			
				//Серия = ВыборкаТ.Партия.Серия;
				СтрокаПартии = "" + ВыборкаТ.Партия + " Серия: " +ВыборкаТ.Серия + " Срок: " + Формат(ВыборкаТ.СрокГодности,"ДФ=dd.MM.yyyy");
				СекцОст.Параметры.Партия=СтрокаПартии;
				Таб.Вывести(СекцОст);
				Таб.НачатьГруппуСтрок();
				Первая=Ложь;
				
				//------------------<Держим в уме секцию кон остатка>-------------------GtG---- 
				// на случай если след строка от другой серии
				СекцКонОст = Мак.ПолучитьОбласть("КонОст"); 
				СекцКонОст.Параметры.Колво = ВыборкаТ.КолвоКонечныйОстаток;
				СекцКонОст.Параметры.СуммаЗакуп=ВыборкаТ.СуммаЗакупБезНДСКонечныйОстаток;			
				СекцКонОст.Параметры.Партия=СтрокаПартии;

				
			ТекПартия=ВыборкаТ.Партия;
			продолжить;
		КонецЕсли; 
		
		Если ВыборкаТ.Документ = Неопределено Тогда
			продолжить;
		КонецЕсли;
		
		////------------------<Держим в уме секцию кон остатка>-------------------GtG---- 
		//// на случай если след строка от другой серии
		//СекцКонОст = Мак.ПолучитьОбласть("КонОст"); 
		//СекцКонОст.Параметры.Колво = ВыборкаТ.КолвоКонечныйОстаток;
		//СекцКонОст.Параметры.СуммаЗакуп=ВыборкаТ.СуммаЗакупСНДСКонечныйОстаток;			
		//СекцКонОст.Параметры.СуммаРозн	=ВыборкаТ.СуммаРознСНДСКонечныйОстаток;		
		//СекцКонОст.Параметры.Серия=ВыборкаТ.Серия;

		//--------------------------------------------------------GtG----КОНЕЦ
		ВидДокумента = ВыборкаТ.Документ.Метаданные().Имя;
		//------------------<Выводим строку серии>-------------------GtG----
		СекСтр= Мак.ПолучитьОбласть("Движение");
		
		СекСтр.Параметры.ДатаДок	=  ВыборкаТ.ДатаДок;
		СекСтр.Параметры.НомерДок	=  ВыборкаТ.НомерДок;
		СекСтр.Параметры.ВидДок	    =  ВыборкаТ.Документ.Метаданные().Представление();
		//------------------<Выводим статус документа , если он есть>-------------------Virus----17.01.2008
		Если ВыборкаТ.Документ.Метаданные().Реквизиты.Найти("Статус") <> Неопределено Тогда
			Статус = ВыборкаТ.Документ.Статус;
		Иначе
			Статус = "";
		КонецЕсли;
		СекСтр.Параметры.Статус = Статус;
		//--------------------------------------------------------Virus----КОНЕЦ--17.01.2008
		//Если ВыборкаТ.СкладПолучательНаименование<>NULL Тогда
		//	СекСтр.Параметры.Склад	    =  ВыборкаТ.СкладПолучательНаименование;
		//Иначе
			СекСтр.Параметры.Склад	    =  ВыборкаТ.Склад;
		//КонецЕсли; 	
		
		ЕСли  ВидДокумента="УЗ_ПоступлениеТовара" Тогда
			СекСтр.Параметры.СкладОтпр	    =  ВыборкаТ.Документ.Поставщик;
			СекСтр.Параметры.Склад	    =  ВыборкаТ.Документ.Склад;
		КонецЕсли; 	

		ЕСли  ВидДокумента="УЗ_Перемещение" Тогда
			СекСтр.Параметры.СкладОтпр	    =  ВыборкаТ.Документ.СкладОтправитель;
			СекСтр.Параметры.Склад	    =  ВыборкаТ.Документ.СкладПолучатель;
		КонецЕсли;
		
		ЕСли  ВидДокумента="ПереоприходованиеЕИТ" Тогда
			СекСтр.Параметры.СкладОтпр	    =  ВыборкаТ.Документ.Склад;
			СекСтр.Параметры.Склад	    =  ВыборкаТ.Документ.Склад;
		КонецЕсли;
		
		
		
		
		СекСтр.Параметры.СтавкаНДС	=  ВыборкаТ.СтавкаНДС;
		//СекСтр.Параметры.Серия	    =  ВыборкаТ.Серия;
		//СекСтр.Параметры.СрокГодн	=  ВыборкаТ.СерияСГ;
		СекСтр.Параметры.КолвоПрих	=  ВыборкаТ.КолвоПриход;
		СекСтр.Параметры.КолвоРасх	=  ВыборкаТ.КолвоРасход;
		Попытка
			СекСтр.Параметры.ЦенаЗакуп	=  ?(ВыборкаТ.КолвоПриход<>0,Окр(ВыборкаТ.СуммаЗакупБезНДСПриход/ВыборкаТ.КолвоПриход,2),Окр(ВыборкаТ.СуммаЗакупБезНДСРасход/ВыборкаТ.КолвоРасход,2));
		ИСключение
			Сообщить("Деление на ноль (нет ни прихода ни расхода) "+ ВыборкаТ.Товар+"  Серия: "+ВыборкаТ.Серия);
		КонецПопытки; 
		СекСтр.Параметры.СуммаЗакупПрих	=  ВыборкаТ.СуммаЗакупБезНДСПриход;
		СекСтр.Параметры.СуммаЗакупРасх =  ВыборкаТ.СуммаЗакупБезНДСРасход;		
		СекСтр.Параметры.Партия         =  ВыборкаТ.Партия;
		СекСтр.Параметры.Док=ВыборкаТ.Документ;
		
		Таб.Вывести(СекСтр);
	КонецЦикла;
	Попытка
		Таб.ЗакончитьГруппуСтрок();
	Исключение
	КонецПопытки;
	Таб.Вывести(СекцКонОст);// конец предыдущей
	
	Попытка
		Таб.ПовторятьПриПечатиСтроки = Таб.Область("УсловиеТовар");
	Исключение
	Конецпопытки;	
	
	Таб.ТолькоПросмотр=Истина;
	Таб.ФиксацияСверху=КолвоСтрокШапки;
	Таб.АвтоМасштаб=Истина;
	Таб.ОриентацияСтраницы=ОриентацияСтраницы.Ландшафт;
	Таб.Показать(); // вывод на экран
	//============================< Шаблон печати таблицы конец >================================GtG===  
	
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПер, ?(КонПер='0001-01-01', КонПер, КонецДня(КонПер)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПер = НастройкаПериода.ПолучитьДатуНачала();
		КонПер = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанель2ОчиститьСписок(Кнопка)
	// Вставить содержимое обработчика.
	
КонецПроцедуры

Процедура КоманднаяПанель2ПодборТовараПоАП(Кнопка)
	КлючУник=  Новый   УникальныйИдентификатор();
	ФормаПодбора= Справочники.АССОРТИМЕНТНЫЙ_ПЛАН.ПолучитьФорму("ФормаДляПодбора","",КлючУник);
	ФормаПодбора.МножественныйВыбор= ИСТИНА;
	ФормаПодбора.ВладелецФормы=ЭтаФорма;
	ФормаПодбора.ЗакрыватьПриЗакрытииВладельца=Истина;
	ФормаПодбора.ОткрытьМодально(0);
КонецПроцедуры

Процедура ОбработкаВыбора(ЗначениеВыбора, Источник)

КонецПроцедуры

Процедура ВыбСкладПриИзменении(Элемент)
	
	Если Элемент.Значение <> ВыбФирма Тогда
		ВыбФирма = Элемент.Значение.Фирма;
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыбФирмаПриИзменении(Элемент)
	
	Если Элемент.Значение <> ВыбСклад.Фирма Тогда
		ВыбСклад = Справочники.МестаХранения.ПустаяСсылка();
	КонецЕсли;
	
КонецПроцедуры

ВидРегистра = "УЗ_Партии";





