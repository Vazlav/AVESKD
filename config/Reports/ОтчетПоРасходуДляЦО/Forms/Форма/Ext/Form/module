


Процедура КнопкаСформироватьНажатие(Кнопка)
	
	ЭлементыФормы.Индикатор1.Значение=0;
	
	
	Состояние("Запрос к базе данных...");
	
	ЕстьВыбранныеРегионы=Ложь;
	
	Для каждого Стр из Регионы Цикл
		Если Стр.Пометка=Истина ТОгда
			ЕстьВыбранныеРегионы=Истина;
		КонецЕсли; 	
	КонецЦикла;	
	
	
	ТХТ="ВЫБРАТЬ
	|   ЗПР.ДатаДок как ДатаДок,
	|	ЗПР.Пост как Поставщик,
	|	ЗПР.Док как Док,
	|	ЗПР.ДокСС как ДокСС,
	|	ЗПР.НаклПост как НаклПост,
	|	СУММА(ЗПР.Закуп) КАК ЗакупДок
	|,
	|	СУММА(ЗПР.Розн) КАК РознДок,
	|	СУММА(ЗПР.ЗакупНДС) КАК ЗакупНДСДок,
	|	СУММА(ЗПР.РознНДС) КАК РознНДСДок
	|";
	
	Если ЕстьВыбранныеРегионы=Истина ТОгда
		Х=0;
		Для каждого Стр из Регионы Цикл
			Х=Х+1;
			Если Стр.Пометка=Ложь ТОгда
				Продолжить;
			КонецЕсли; 
			ТХТ=ТХТ+"
			| ,
			|   СУММА(ЗПР.СуммаРозн"+Х+") КАК РегСуммаРозн"+Х+"
			|";
		КонецЦикла;	
	КонецЕсли;
	
	ТХТ=ТХТ+"
	|ИЗ
	|	(ВЫБРАТЬ 
	|       ПартииЖНВЛСОбороты.Регистратор.Дата КАК ДатаДок,
	|		ПартииЖНВЛСОбороты.Регистратор.Поставщик КАК Пост,
	|		ПартииЖНВЛСОбороты.Регистратор КАК Док,
	|		ПартииЖНВЛСОбороты.Регистратор КАК ДокСС,

	|		ПартииЖНВЛСОбороты.Регистратор.ВхНомерНакл КАК НаклПост,
	|		ПартииЖНВЛСОбороты.Партия.Ссылка КАК Партия,
	|		ПартииЖНВЛСОбороты.СуммаЗакупСНДСРасход КАК Закуп,
	|		ПартииЖНВЛСОбороты.СуммаРознСНДСРасход КАК Розн,
	|		ПартииЖНВЛСОбороты.СуммаНДСЗакупРасход КАК ЗакупНДС,
	|		ПартииЖНВЛСОбороты.СуммаРознНДСРасход КАК РознНДС,
	|		ПартииЖНВЛСОбороты.КолвоРасход КАК Колво
	|";
	
	
	Если ЕстьВыбранныеРегионы=Истина ТОгда
		Х=0;
		Для каждого Стр из Регионы Цикл
			Х=Х+1;
			Если Стр.Пометка=Ложь ТОгда
				Продолжить;
			КонецЕсли; 
			ТХТ=ТХТ+"
			| ,
			|   ЦеныСрезПоследних"+Х+".ЦенаРознГТТ * ПартииЖНВЛСОбороты.КолвоРасход КАК СуммаРозн"+Х+"
			|";
		КонецЦикла;	
	КонецЕсли;
	
	
	
	
	ТХТ=ТХТ+"
	|	ИЗ
	|		РегистрНакопления.ПартииЖНВЛС.Обороты(
	|			&ДАта1,
	|			&Дата2,
	|			Регистратор,
	|			Фирма = &Фирма
	|			    И Склад = &Склад) КАК ПартииЖНВЛСОбороты
	|";
	
	
	Если ЕстьВыбранныеРегионы=Истина ТОгда
		Х=0;
		Для каждого Стр из Регионы Цикл
			Х=Х+1;
			Если Стр.Пометка=Ложь ТОгда
				Продолжить;
			КонецЕсли; 
			ТХТ=ТХТ+"
			| 
			|   		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних(, РЕГИОН = &ВыбРег"+Х+") КАК ЦеныСрезПоследних"+Х+"
			|			ПО ЦеныСрезПоследних"+Х+".Партия = ПартииЖНВЛСОбороты.Партия
			|";
		КонецЦикла;	
	КонецЕсли;
	
	ТХТ=ТХТ+"
	| Где ПартииЖНВЛСОбороты.Регистратор Ссылка Документ.ПеремещениеТовара  
	|	И
	|   ПартииЖНВЛСОбороты.Регистратор.Статус<>&СтатусИзменениеКМХ
	|) КАК ЗПР
	|{ГДЕ
	|	ЗПР.Пост как Поставщик,
	|	ЗПР.Партия.Владелец.* как Товар}
	|
	|СГРУППИРОВАТЬ ПО
	|   ЗПР.ДатаДок,
	|	ЗПР.Пост,
	|	ЗПР.Док,
	|	ЗПР.ДокСС,

	|	ЗПР.НаклПост
	|Order by ЗПР.ДатаДок,ЗПР.Пост";
	
	
	Построитель.Текст=ТХТ;
	
	
	
	
	
	
	Построитель.Параметры.Вставить("ДАта1",нАЧАЛОдНЯ(НачПериода));
	Построитель.Параметры.Вставить("ДАта2",КонецДня(КонПериода));
	Построитель.Параметры.Вставить("Фирма",Константы.ОсновнаяФирма.Получить());
	Построитель.Параметры.Вставить("Склад",Склад);
	Построитель.Параметры.Вставить("СтатусИзменениеКМХ",Перечисления.СтатусПеремещения.ИзменениеМестаХранения);
	
	Если ЕстьВыбранныеРегионы=Истина ТОгда
		Х=0;
		Для каждого Стр из Регионы Цикл
			Х=Х+1;
			Если Стр.Пометка=Ложь ТОгда
				Продолжить;
			КонецЕсли; 
			Построитель.Параметры.Вставить("ВыбРег"+Х,Стр.Значение);
		КонецЦикла;	
	КонецЕсли;
	
	Состояние("Запрос к базе данных...");
	
	//Построитель.Выполнить();
	Построитель.Выполнить();
	
		
	ТЗ=Построитель.Результат.Выгрузить();
	
	Состояние("Выводим отчет на экран...");
	
	
	Таб=Новый ТабличныйДокумент;                                                                 
	МАк=ЭтотОбъект.ПолучитьМакет("Макет");
	Секция=Мак.ПолучитьОбласть("Шапка|Осн");
	
	Секция.Параметры.ТекДата=ТекущаяДата();
	Секция.Параметры.НачДата=Формат(НачПериода,"ДФ=dd.MM.yyyy");
	Секция.Параметры.КонДата=Формат(КонПериода,"ДФ=dd.MM.yyyy");
	
	Таб.Вывести(Секция);
	
	ТЗИтогРег= Новый ТаблицаЗначений; 
	СтрИтогРег=ТЗИтогРег.Добавить();
	
	
	Секция=Мак.ПолучитьОбласть("ЗагТаб|Осн");
	Таб.Вывести(Секция);
	
	
	Если ЕстьВыбранныеРегионы=Истина ТОгда
		Х=0;
		Для каждого Стр из Регионы Цикл
			Х=Х+1;
			Если Стр.Пометка=Ложь ТОгда
				Продолжить;
			КонецЕсли; 
			
			ТЗИтогРег.Колонки.Добавить("Итого"+Х);
			СтрИтогРег["Итого"+Х]=0;
			
			
			Секция=Мак.ПолучитьОбласть("ЗагТаб|Регион");
			Секция.Параметры.Регион=Стр.Значение;
			Таб.Присоединить(Секция);
		КонецЦикла;	
	КонецЕсли;
	
	
	
	
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение=ТЗ.Количество();
	
	Для каждого Стр из ТЗ Цикл
		
		Состояние("Выводим отчет в таблицу...");
		
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;	
		
		Секция=Мак.ПолучитьОбласть("Строка|Осн");
		
		Секция.Параметры.Дата	= Формат(Стр.Док.Дата,"ДФ=dd.MM.yyyy");;
		Секция.Параметры.Документ	= Стр.Док.Метаданные().Представление();
		Секция.Параметры.ДокументСС	= Стр.ДокСС;
		
		Секция.Параметры.Номер	= Стр.Док.Номер;
		Секция.Параметры.НакладнаяПоставщика	= Стр.НаклПост;
		Секция.Параметры.Поставщик	            = Стр.Поставщик;
		Секция.Параметры.СуммаЗакуп	            = Стр.ЗакупДок;
		Секция.Параметры.СуммаРозн	            = Стр.РознДок;
		
		Таб.Вывести(Секция);
		
		
		
		//==================<по регионам>===================GtG====22.01.2008
		
		Если ЕстьВыбранныеРегионы=Истина ТОгда
			Х=0;
			Для каждого СтрР из Регионы Цикл
				Х=Х+1;
				Если СтрР.Пометка=Ложь ТОгда
					Продолжить;
				КонецЕсли; 
				
				
				
				Секция=Мак.ПолучитьОбласть("Строка|Регион");
				Секция.Параметры.СуммаРознРег=Стр["РегСуммаРозн"+Х];
				Таб.Присоединить(Секция);
			КонецЦикла;	
		КонецЕсли;
		
		
	КонецЦикла;	
	
	Секция=Мак.ПолучитьОбласть("Итого|Осн");
	
	Секция.Параметры.СуммаЗакуп	= ТЗ.Итог("ЗакупДок");
	Секция.Параметры.СуммаРозн	= ТЗ.Итог("РознДок");
	Таб.Вывести(Секция);
	
	Если ЕстьВыбранныеРегионы=Истина ТОгда
		Х=0;
		Для каждого Стр из Регионы Цикл
			Х=Х+1;
			Если Стр.Пометка=Ложь ТОгда
				Продолжить;
			КонецЕсли; 
			
			
			
			Секция=Мак.ПолучитьОбласть("Итого|Регион");
			Секция.Параметры.СуммаРознРег=ТЗ.Итог("РегСуммаРозн"+Х);
			Таб.Присоединить(Секция);
		КонецЦикла;	
	КонецЕсли;
	
	Таб.ОтображатьСетку=Ложь;
	Таб.ОтображатьЗаголовки=Ложь;
	Таб.ОтображатьГруппировки=Ложь;
	ТАб.ТолькоПросмотр=Истина;
	Таб.Показать("Отчет по Расходу для ЦО");
	
	Состояние("ГОТОВО!");
	
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры


ТХТ="ВЫБРАТЬ
|	Регионы.Ссылка как Регион
|ИЗ
|	Справочник.Регионы КАК Регионы
|ГДЕ
|	Регионы.ПометкаУдаления = Ложь";
Запрос=Новый Запрос;
Запрос.Текст=ТХТ;

Регионы.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Регион"));


ТХТ="ВЫБРАТЬ
    |	ЗПР.Пост,
    |	ЗПР.Док,
    |	ЗПР.ДокСС,
    |	СУММА(ЗПР.Закуп) КАК ЗакупДок,
    |	СУММА(ЗПР.Розн) КАК РознДок,
    |	СУММА(ЗПР.ЗакупНДС) КАК ЗакупНДСДок,
    |	СУММА(ЗПР.РознНДС) КАК РознНДСДок,
    |	СУММА(ЗПР.СуммаРозн1) КАК РегСуммаРозн1,
    |	СУММА(ЗПР.СуммаРозн2) КАК РегСуммаРозн2,
    |	ЗПР.Док.ВхНомерНакл,
    |	ЗПР.Док.ВхНомерСФ
    |ИЗ
    |	(ВЫБРАТЬ
    |		ПартииЖНВЛСОбороты.Регистратор.Поставщик КАК Пост,
    |		ПартииЖНВЛСОбороты.Регистратор КАК Док,
    |		ПартииЖНВЛСОбороты.Регистратор КАК ДокСС,
    |		ПартииЖНВЛСОбороты.Партия КАК Партия,
    |		ПартииЖНВЛСОбороты.СуммаЗакупСНДСРасход КАК Закуп,
    |		ПартииЖНВЛСОбороты.СуммаРознСНДСРасход КАК Розн,
    |		ПартииЖНВЛСОбороты.СуммаНДСЗакупРасход КАК ЗакупНДС,
    |		ПартииЖНВЛСОбороты.СуммаРознНДСРасход КАК РознНДС,
    |		ПартииЖНВЛСОбороты.КолвоРасход КАК Колво,
    |		ЦеныСрезПоследних1.ЦенаРознГТТ * ПартииЖНВЛСОбороты.КолвоРасход КАК СуммаРозн1,
    |		ЦеныСрезПоследних2.ЦенаРознГТТ * ПартииЖНВЛСОбороты.КолвоРасход КАК СуммаРозн2
    |	ИЗ
    |		РегистрНакопления.ПартииЖНВЛС.Обороты(
    |			&ДАта1,
    |			&Дата2,
    |			Регистратор,
    |			Фирма = &Фирма
    |				И Склад = &Склад) КАК ПартииЖНВЛСОбороты
    |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних(, РЕГИОН = &ВыбРег1) КАК ЦеныСрезПоследних1
    |			ПО ЦеныСрезПоследних1.Партия.Ссылка = ПартииЖНВЛСОбороты.Партия.Ссылка
    |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних(, РЕГИОН = &ВыбРег2) КАК ЦеныСрезПоследних2
    |			ПО ЦеныСрезПоследних2.Партия.Ссылка = ПартииЖНВЛСОбороты.Партия.Ссылка) КАК ЗПР
    |{ГДЕ
    |	ЗПР.Пост КАК Поставщик,
    |	ЗПР.Партия.Владелец.* КАК ТОвар}
    |
    |СГРУППИРОВАТЬ ПО
    |	ЗПР.Пост,
    |	ЗПР.ДокСС,
    |	ЗПР.Док,
    |	ЗПР.Док.ВхНомерНакл,
    |	ЗПР.Док.ВхНомерСФ";

Построитель.Текст=ТХТ; // предварительно чтоб до запуска отчета настроить условия в построителе

Склад=Константы.ОсновнойСклад.Получить();




	