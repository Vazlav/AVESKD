
Процедура КнопкаСформироватьНажатие(Кнопка)
	
	Если ЭлементыФормы.Панель1.ТекущаяСтраница<>ЭлементыФормы.Панель1.Страницы.Техподдержка ТОгда
		ЭлементыФормы.Таб.Очистить();
		ЭлементыФормы.Таб.Вывести(МО_ОтчетПоВыручке());
		
		Если Кратко Тогда
			ЭлементыФормы.Таб.ФиксацияСверху=5;
		Иначе	
			ЭлементыФормы.Таб.ФиксацияСверху=8;
		КонецЕсли; 
		
		
		ЭлементыФормы.Таб.ФиксацияСлева=3;
		ЭлементыФормы.Таб.ТолькоПросмотр=Истина;
		
		ЭлементыФормы.Панель1.ТекущаяСтраница=ЭлементыФормы.Панель1.Страницы.Отчет;
	Иначе
		
		
		
	КонецЕсли;
	
	
	
КонецПроцедуры


Процедура МесяцПриИзменении(Элемент)
	Месяц=Началомесяца(Месяц);
КонецПроцедуры


Процедура ВвестиДанныеОВыручкеВручную(Расшифровка)
	
	СуммаВыручки=0;
	
	ВвестиЧисло(СуммаВыручки,"Сумма выручки",15,2);
	
	Если СуммаВыручки=0 Тогда
		Возврат;
	КонецЕсли; 	
	
	
	КоличествоЧеков=0;
	ВвестиЧисло(КоличествоЧеков,"Количество чеков",10,0);
	
	Если КоличествоЧеков=0 Тогда
		Возврат;
	КонецЕсли; 
	
	Если Вопрос("Сумма выручки = "+СуммаВыручки+Символы.ПС+"Количество чеков = "+КоличествоЧеков+Символы.ПС+" Правильно?"  
		, РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да Тогда
		
		
		
		
		
		Смена=Документы.УЗ_СменаККМ.СоздатьДокумент();
		Смена.GuidСмены=Лев("РУЧНОЙ_ВВОД@"+СтрЗаменить(Новый УникальныйИдентификатор(),"-",""),36);
		Смена.Дата=Расшифровка.Дата;
		Смена.СкладКод=Расшифровка.СкладКодДляРучногоВводаВыручки;
		
		Запрос=Новый Запрос();
		Запрос.Текст="ВЫБРАТЬ
		|	МестаХранения.Фирма.Код как ФирмаКод
		
		|ИЗ
		|	Справочник.МестаХранения КАК МестаХранения
		|ГДЕ
		|	МестаХранения.Код = &Код";
		Запрос.УстановитьПараметр("Код",Расшифровка.СкладКодДляРучногоВводаВыручки);
		
		Рез=Запрос.Выполнить().Выгрузить();
		
		
		Смена.ФирмаКод=Рез.Получить(0).ФирмаКод;
		
		Смена.Комментарий="Введено вручную "+ТекущаяДата()+" "+ПараметрыСеанса.ТекущийСотр;
		
		Стр=Смена.ПродажиТовара.Добавить();
		
		Стр.СуммаРозн=СуммаВыручки;
		
		Смена.СуммаВыручки=СуммаВыручки;
		
		Смена.НомерСмены="-=вручную=-";
		
		Смена.Мотивация_Итоги.Добавить().КоличествоЧеков=КоличествоЧеков;
		
		Смена.Записать(РежимЗаписиДокумента.Проведение);
		
	КонецЕсли; 
	
Конецпроцедуры	



Процедура ТабОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	СтандартнаяОбработка=ЛОжь;
	
	Если ТипЗнч(Расшифровка)=Тип("Структура") ТОгда
		
		
		Если Расшифровка.Свойство("УдалениеСмены")=Истина Тогда
			
			Если Вопрос("Удалить смену ?"+Символы.ПС+Расшифровка.Смена,РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да ТОгда
				Расшифровка.Смена.ПолучитьОбъект().Удалить();
			КонецЕсли; 	
			
			
			
		ИначеЕсли Расшифровка.Свойство("СкладКодДляРучногоВводаВыручки")=Истина Тогда
			
			Если Вопрос("Ввести данные о выручке вручную?",РежимДиалогаВопрос.ДаНет)=КодВозвратаДиалога.Да ТОгда
				ВвестиДанныеОВыручкеВручную(Расшифровка);	
			КонецЕсли; 	
	
			
			
		Иначе // обычная расшифровка обычного отчета	
			
			ТабРасш=МО_ПолучитьРасшифровкуАптекоДня(Расшифровка);
			
			Если ТабРасш<>Неопределено ТОгда
				
				ТабРасш.ТолькоПросмотр=Истина;
				ТабРасш.ОтображатьЗаголовки=Ложь;
				ТабРасш.ОтображатьСетку=Ложь;
				ТабРасш.Показать();
				
			КонецЕсли; 
		КонецЕсли;

	ИначеЕсли ТипЗнч(Расшифровка)=тип("СправочникСсылка.МестаХранения") Тогда
		СтандартнаяОбработка=Истина;
	Конецесли;	
	
	
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	Если (РольДоступна("Техподдержка")или РольДоступна("супер_АДМИНИСТРАТОР")) Тогда
		ЭлементыФормы.Панель1.Страницы.Техподдержка.Видимость=Истина;
	Иначе
		ЭлементыФормы.Панель1.Страницы.Техподдержка.Видимость=Ложь;
	КонецЕсли;	
	
		
КонецПроцедуры


Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры


Процедура СписокНезакрытыхВыручекНажатие(Элемент)
	
	
	
	День2=День(КонПериода);
	День1=День(НачПериода);
	
	Ы=День2-День1;
	
	ТЗ=Новый ТаблицаЗначений;
	ТЗ.Колонки.Добавить("Дата",Новый ОписаниеТипов("Дата",Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	Для ЫЫ=0 по Ы Цикл
		ТЗ.Добавить().Дата=Дата(Год(НачПериода),Месяц(НачПериода),День1+ЫЫ);
	КонецЦикла;	
	
	
	 Запрос= ПостроительТехподдержки.ПолучитьЗапрос();
	 
	 
	 Запрос.Текст=СтрЗаменить(Запрос.Текст,"ПОМЕСТИТЬ ТЗ__","ПОМЕСТИТЬ Затычка");
	 Запрос.Текст=СтрЗаменить(Запрос.Текст,"ТЗ__","&ТЗ");
	 
	 //Сообщить(Запрос.Текст);
	 
	 
	 Запрос.УстановитьПараметр("Дата1",НачалоДня(НачПериода));
	 Запрос.УстановитьПараметр("Дата2",КонецДня(КонПериода));
	 Запрос.УстановитьПараметр("ТЗ",ТЗ);
	 Запрос.УстановитьПараметр("ТипыМХ_Розн",Перечисления.ТипыМХ.Розн);
	 
	 Рез=Запрос.Выполнить();
	 
	 Если Рез.Пустой() ТОгда
		 Предупреждение("Нет данных за этот период!");
		 Возврат;
	 КонецЕсли; 
	 
	 ЭлементыФормы.ТабТП.Очистить();
	 
	 Мак=ЭтотОбъект.ПолучитьМакет("Техподдержка_СписокНезакрытых");
	 
	 Выб=Рез.Выбрать();
	 
	 Обл=Мак.ПолучитьОбласть("Шапка");
	 Обл.Параметры.Дата1=Формат(НачПериода,"ДФ=dd.MM.yyyy");
	 Обл.Параметры.Дата2=Формат(КонПериода,"ДФ=dd.MM.yyyy");
	 Обл.Параметры.НезакрытоСмен=Выб.Количество();
	 
	 ЭлементыФормы.ТабТП.Вывести(Обл);
	 
	 
	 Пока Выб.Следующий() Цикл
		 
		 Обл=Мак.ПолучитьОбласть("Строка"+?(Выб.Смена="Х","Х",""));
		 Обл.Параметры.Заполнить(Выб);
		 Если Выб.Смена<>"Х" Тогда
		 	Обл.Параметры.РасшТехподд=Новый Структура("УдалениеСмены,Смена",Истина,Выб.Смена);
		Иначе // чтоб проставился выходной
			Обл.Параметры.РасшТехподд=Новый Структура("СкладКод,Дата",Выб.СкладКод,Выб.Дата);
			Обл.Параметры.РасшДляВводаВручную=Новый Структура("СкладКодДляРучногоВводаВыручки,Дата",Выб.СкладКод,Выб.Дата);
			
		 КонецЕсли; 
		 ЭлементыФормы.ТабТП.Вывести(Обл);
	 КонецЦикла;	 
	 
	 ЭлементыФормы.ТабТП.ТолькоПросмотр=Истина;
	 
	 ЭлементыФормы.Панель1.ТекущаяСтраница=ЭлементыФормы.Панель1.Страницы.ОтчетТП;
	 
	 ЭлементыФормы.ТабТП.ФиксацияСверху=6;
	 ЭлементыФормы.ТабТП.ОтображатьЗаголовки=Истина;
	 ЭлементыФормы.ТабТП.ОтображатьГруппировки=Истина;
	 
     Обл=ЭлементыФормы.ТабТП.Область("C7:C9");
	 
	 Обл.Сгруппировать("Комментарии",РасположениеЗаголовкаГруппировкиТабличногоДокумента.Начало);;
	 
	 
	 
	
КонецПроцедуры

Процедура ОсновныеДействияФормыФорма_2(Кнопка)
	
	//==========================================================GtG====

	//----------------------------------
	//Назначение:
	//  Вывод формы для ВВ
	//  
	//  
	//  
	//----------------------------------
	
	ЭлементыФормы.Ф2.Очистить();
	ЭлементыФормы.Ф2.Вывести(МО_Форма_2());
	ЭлементыФормы.Ф2.АвтоМасштаб=Истина;
	
	ЭлементыФормы.Ф2.ФиксацияСверху=0;
	
	ЭлементыФормы.Панель1.ТекущаяСтраница=ЭлементыФормы.Панель1.Страницы.Форма2;
	
	
	
КонецПроцедуры

Процедура ВыбПериодНажатие1(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачПериода1, ?(КонПериода1='0001-01-01', КонПериода1, КонецДня(КонПериода1)));
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода1 = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода1 = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

ПостроительТехподдержки.Текст=   "ВЫБРАТЬ
                                 |	ДАТАВРЕМЯ(1666, 1, 1) КАК Дата
                                 |ПОМЕСТИТЬ ТЗ__
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |ВЫБРАТЬ
                                 |	ТАБЛИЦА_ЗНАЧЕНИЙ.Дата КАК Дата
                                 |ПОМЕСТИТЬ ТаблицаДат1
                                 |ИЗ
                                 |	ТЗ__ КАК ТАБЛИЦА_ЗНАЧЕНИЙ
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |ВЫБРАТЬ
                                 |	УЗ_РеализацияККМ.СкладКод КАК СкладКод,
                                 |	НАЧАЛОПЕРИОДА(УЗ_РеализацияККМ.Дата, ДЕНЬ) КАК Дата
                                 |ПОМЕСТИТЬ ВыходныеДни
                                 |ИЗ
                                 |	Документ.УЗ_РеализацияККМ КАК УЗ_РеализацияККМ
                                 |ГДЕ
                                 |	УЗ_РеализацияККМ.Дата МЕЖДУ &Дата1 И &ДАТА2
                                 |	И УЗ_РеализацияККМ.Проведен = ИСТИНА
                                 |	И УЗ_РеализацияККМ.ВыходнойДень = ИСТИНА
                                 |
                                 |ИНДЕКСИРОВАТЬ ПО
                                 |	СкладКод,
                                 |	Дата
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |ВЫБРАТЬ
                                 |	МестаХранения.Код КАК Код,
                                 |	ТаблицаДат1.Дата КАК Дата
                                 |ПОМЕСТИТЬ ТаблицаАптекодат0
                                 |ИЗ
                                 |	ТаблицаДат1 КАК ТаблицаДат1,
                                 |	Справочник.МестаХранения КАК МестаХранения
                                 |ГДЕ
                                 |	(МестаХранения.ДатаЗакрытия = ДАТАВРЕМЯ(1, 1, 1)
                                 |			ИЛИ МестаХранения.ДатаЗакрытия > &Дата1)
                                 |	И НЕ(МестаХранения.ДатаПерехода = ДАТАВРЕМЯ(1, 1, 1)
                                 |				ИЛИ МестаХранения.ДатаПерехода > &ДАТА2)
                                 |	И МестаХранения.ПометкаУдаления = ЛОЖЬ
                                 |	И ЕСТЬNULL(МестаХранения.СторонаДоговораКомиссии.Порядок, 0) <> 1
                                 |	И МестаХранения.ТипСклада = &ТипыМХ_Розн
                                 |	И НЕ МестаХранения.Наименование ПОДОБНО ""РЦ ГИПЕР%""
                                 |	И НЕ МестаХранения.Наименование ПОДОБНО ""%Склад%""
                                 |
                                 |ИНДЕКСИРОВАТЬ ПО
                                 |	Код
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |ВЫБРАТЬ
                                 |	ТаблицаАптекодат.Код,
                                 |	ТаблицаАптекодат.Дата
                                 |ПОМЕСТИТЬ ТаблицаАптекоДат
                                 |ИЗ
                                 |	ТаблицаАптекодат0 КАК ТаблицаАптекодат
                                 |		ЛЕВОЕ СОЕДИНЕНИЕ ВыходныеДни КАК ВыходныеДни
                                 |		ПО ТаблицаАптекодат.Код = ВыходныеДни.СкладКод
                                 |			И ТаблицаАптекодат.Дата = ВыходныеДни.Дата
                                 |ГДЕ
                                 |	ВыходныеДни.Дата ЕСТЬ NULL 
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |ВЫБРАТЬ
                                 |	ТаблицаАптекодат.Код КАК СкладКод,
                                 |	МестаХранения.Наименование КАК Адрес,
                                 |	ТаблицаАптекодат.Дата КАК Дата,
                                 |	УЗ_СменаККМ.Проведен,
                                 |	УЗ_СменаККМ.ВАрхив,
                                 |	УЗ_СменаККМ.Корректная,
                                 |	УЗ_СменаККМ.СуммаВыручки КАК СуммаВыручки,
                                 |	УЗ_СменаККМ.СуммаНаличными КАК СуммаНаличными,
                                 |	УЗ_СменаККМ.СуммаПоКартам КАК СуммаПоКартам,
                                 |	УЗ_СменаККМ.Авансы_Получено КАК Авансы_Получено,
                                 |	УЗ_СменаККМ.GuidСмены,
                                 |	ЕСТЬNULL(УЗ_СменаККМ.Ссылка, ""Х"") КАК Смена
                                 |ИЗ
                                 |	ТаблицаАптекоДат КАК ТаблицаАптекодат
                                 |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.УЗ_СменаККМ КАК УЗ_СменаККМ
                                 |		ПО (НАЧАЛОПЕРИОДА(ТаблицаАптекодат.Дата, ДЕНЬ) = НАЧАЛОПЕРИОДА(УЗ_СменаККМ.Дата, ДЕНЬ))
                                 |			И ТаблицаАптекодат.Код = УЗ_СменаККМ.СкладКод
                                 |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.МестаХранения КАК МестаХранения
                                 |		ПО ТаблицаАптекодат.Код = МестаХранения.Код
                                 |ГДЕ
                                 |	(УЗ_СменаККМ.Проведен ЕСТЬ NULL 
                                 |			ИЛИ УЗ_СменаККМ.Проведен = ИСТИНА)
                                 |{ГДЕ
                                 |	ТаблицаАптекодат.Код КАК КодАптеки,
                                 |	ТаблицаАптекодат.Дата,
                                 |	МестаХранения.Ссылка.* КАК Аптека}
                                 |
                                 |УПОРЯДОЧИТЬ ПО
                                 |	СкладКод,
                                 |	Дата
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |УНИЧТОЖИТЬ ТаблицаДат1
                                 |;
                                 |
                                 |////////////////////////////////////////////////////////////////////////////////
                                 |УНИЧТОЖИТЬ ТаблицаАптекодат"; // Сгенерировано в GtG's Консоль запросов. 07.01.2016 18:05:11






