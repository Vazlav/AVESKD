


Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура КоманднаяПанель1ОбновитьМатрицу(Кнопка)
	
	Если Аптека.Пустая()=Истина ТОгда
		ПРедупреждение("Не выбрана аптека!");
		Возврат;
	КонецЕсли; 
	ПостроительТекМатрицы.Выполнить();
	ЭлементыФормы.ТекущаяМатрица.Значение=ПостроительТекМатрицы.Результат.Выгрузить();
	ЭлементыФормы.ТекущаяМатрица.СоздатьКолонки();
КонецПроцедуры

Процедура КоманднаяПанель2ОтобратьТовар(Кнопка)
	
	  Если Аптека.Пустая()=Истина ТОгда
		ПРедупреждение("Не выбрана аптека!");
		Возврат;
	КонецЕсли; 

	ОтобранныйТОвар.Очистить();
	
	Построитель.Параметры.Очистить();
	Построитель.Параметры.Вставить("Аптека",Аптека);
	
	Построитель.Выполнить();
	
	РезОтбора=Построитель.Результат.Выгрузить();
	
	
	
	
	Для Ы=1 По РезОтбора.Количество() Цикл
		ОтобранныйТОвар.Добавить();
	КонецЦикла;	
		
	
	
	
	Для Ы=0 По РезОтбора.Колонки.Количество()-1 Цикл
		ДанныеКолонки=РезОтбора.ВыгрузитьКолонку(Ы);
		ОтобранныйТОвар.ЗагрузитьКолонку(ДанныеКолонки,Ы);
	КонецЦикла;	
	
	
	
	
	
	
КонецПроцедуры

Процедура КоманднаяПанель3СохранитьМатрицу(Кнопка)
	
	//-------------------------------------------------------------------
	ЭлементыФормы.Индикатор1.Значение=0;
	ЭлементыФормы.Индикатор1.МаксимальноеЗначение=ОтобранныйТОвар.Количество();
	
	
	Для каждого Стр из ОтобранныйТОВар Цикл
		
		Если Стр.Присутствует=Истина ТОгда
			ОМ16_ДобавитьТоварВМатрицуАптеки (Стр.Товар,Аптека);
		Иначе
			ОМ16_УдалитьТоварИзМатрицыАптеки (Стр.Товар, Аптека);
		КонецЕсли;
		
		ЭлементыФормы.Индикатор1.Значение=ЭлементыФормы.Индикатор1.Значение+1;
		
	КонецЦикла;		
	
	
КонецПроцедуры

Процедура КоманднаяПанель1Настройка(Кнопка)
	// Открывает окошко настройки вывода матрицы аптеки
	НастройкаПостроителяТекМатрицы=ЭтотОбъект.ПолучитьФорму("НастройкаОтбораТовара", ЭтаФорма, Новый УникальныйИдентификатор);
	РезНастройки=НастройкаПостроителяТекМатрицы.ОткрытьМодально();
	
	Если РезНастройки=Истина ТОгда
		
		Если Аптека.Пустая()=Истина ТОгда
			ПРедупреждение("Не выбрана аптека!");
			Возврат;
		КонецЕсли; 
		
		ПостроительТекМатрицы.Выполнить();
		
		ЭлементыФормы.ТекущаяМатрица.Значение=ПостроительТекМатрицы.Результат.Выгрузить();
		ЭлементыФормы.ТекущаяМатрица.СоздатьКолонки();
		
	КонецЕсли; 	
	
КонецПроцедуры

Процедура АптекаПриИзменении(Элемент)
	
	ПостроительТекМатрицы.Параметры.Очистить();
	ПостроительТекМатрицы.Параметры.Вставить("Аптека",Аптека);
	
КонецПроцедуры

Процедура КоманднаяПанель3ОтметитьВсе(Кнопка)
	Для каждого Стр из ОтобранныйТОвар Цикл
		Стр.ПРисутствует=Истина;
	КонецЦикла;	
КонецПроцедуры

Процедура КоманднаяПанель3РазотметитьВсе(Кнопка)
	Для каждого Стр из ОтобранныйТОвар Цикл
		Стр.ПРисутствует=Ложь;
	КонецЦикла;	
КонецПроцедуры

Процедура ПриОткрытии()
	Если ПравоДоступа("Use", Метаданные.Отчеты.УправлениеМатрицей2)=Ложь Тогда
		ПРедупреждение("Доступ запрещен!");
		ЭтаФорма.Закрыть();
	КонецЕсли;	

КонецПроцедуры

Процедура КоманднаяПанель2ОстаткиТовараВМатрицу(Кнопка)
	
	ОтобранныйТОвар.Очистить();
	
	  //-------------- ЗАПРОС GTG --------------------------НАЧАЛО
	  //Назначение: Остатки товара
	  //
	  ТХТ="ВЫБРАТЬ
	  |	ПартииЖНВЛСОстатки.Товар.Код как код,
	  |	ПартииЖНВЛСОстатки.Товар как Товар,
	  |	ВЫБОР
	  |		КОГДА Матрица.Товар ЕСТЬ NULL 
	  |			ТОГДА ЛОЖЬ
	  |		ИНАЧЕ ИСТИНА
	  |	КОНЕЦ КАК Присутствует
	  |ИЗ
	  |	РегистрНакопления.ПартииЖНВЛС.Остатки(&ТекДата, Склад = &Аптека) КАК ПартииЖНВЛСОстатки
	  | ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	  |			Матрица.Владелец.Товар КАК Товар
	  |		ИЗ
	  |			Справочник.Матрица КАК Матрица
	  |		ГДЕ
	  |			Матрица.Аптека = &Аптека) КАК Матрица
	  |		ПО ПартииЖНВЛСОстатки.Товар = Матрица.Товар
	  |ГДЕ
	  |	ПартииЖНВЛСОстатки.КолвоОстаток > 0";
	  Запрос=Новый Запрос;
	  Запрос.Текст=ТХТ;
	  Запрос.УстановитьПараметр("ТекДата",КонецДня(ТекущаяДата()));
	  Запрос.УстановитьПараметр("Аптека",Аптека);
	  
	  ТЗ=Запрос.Выполнить().Выгрузить();
	  
	  Для каждого Стр из ТЗ Цикл
		  
		  СтрОТ=ОтобранныйТОвар.Добавить();
		  
		  СтрОт.Код=Стр.Код;
		  СтрОТ.Товар=Стр.Товар;
		  СтрОТ.Присутствует=Стр.Присутствует;
	  КонецЦикла;	
	  
	  
	  
	  
	  //-------------- ЗАПРОС GTG --------------------------КОНЕЦ
	
КонецПроцедуры

Процедура КоманднаяПанель4ТоварИзЗаказовВМатрицу(Кнопка)
	   ОтобранныйТОвар.Очистить();
	
	  //-------------- ЗАПРОС GTG --------------------------НАЧАЛО
	  //Назначение: Остатки товара
	  //
	  ТХТ="ВЫБРАТЬ РАЗЛИЧНЫЕ
	      |	ЗаявкаНаТоварТовар.Товар.Код КАК код,
	      |	ЗаявкаНаТоварТовар.Товар КАК Товар,
	      |	ВЫБОР
	      |		КОГДА Матрица.Товар ЕСТЬ NULL 
	      |			ТОГДА ЛОЖЬ
	      |		ИНАЧЕ ИСТИНА
	      |	КОНЕЦ КАК Присутствует
	      |ИЗ
	      |	Документ.ЗаявкаНаТовар.Товар КАК ЗаявкаНаТоварТовар
	      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	      |			Матрица.Владелец.Товар КАК Товар
	      |		ИЗ
	      |			Справочник.Матрица КАК Матрица
	      |		ГДЕ
	      |			Матрица.Аптека = &Аптека) КАК Матрица
	      |		ПО ЗаявкаНаТоварТовар.Товар = Матрица.Товар
	      |ГДЕ
	      |	ЗаявкаНаТоварТовар.Ссылка.Склад = &Аптека
	      |	И ЗаявкаНаТоварТовар.Ссылка.Проведен = ИСТИНА";
	  Запрос=Новый Запрос;
	  Запрос.Текст=ТХТ;
	  
	  Запрос.УстановитьПараметр("Аптека",Аптека);
	  
	  ТЗ=Запрос.Выполнить().Выгрузить();
	  
	  Для каждого Стр из ТЗ Цикл
		  
		  СтрОТ=ОтобранныйТОвар.Добавить();
		  
		  СтрОт.Код=Стр.Код;
		  СтрОТ.Товар=Стр.Товар;
		  СтрОТ.Присутствует=Стр.Присутствует;
	  КонецЦикла;	
КонецПроцедуры






//------------------<Построитель>-------------------GtG----15.09.08

ТХТ="ВЫБРАТЬ
    |	АССОРТИМЕНТНЫЙ_ПЛАН.Код,
    |	АССОРТИМЕНТНЫЙ_ПЛАН.Ссылка КАК Товар,
    |	ВЫБОР
    |		КОГДА Матрица.Товар ЕСТЬ NULL 
    |			ТОГДА ЛОЖЬ
    |		ИНАЧЕ ИСТИНА
    |	КОНЕЦ КАК Присутствует
    |ИЗ
    |	Справочник.АССОРТИМЕНТНЫЙ_ПЛАН КАК АССОРТИМЕНТНЫЙ_ПЛАН
    |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
    |			Матрица.Владелец.Товар КАК Товар
    |		ИЗ
    |			Справочник.Матрица КАК Матрица
    |		ГДЕ
    |			Матрица.Аптека = &Аптека) КАК Матрица
    |		ПО АССОРТИМЕНТНЫЙ_ПЛАН.Ссылка = Матрица.Товар
    |{ГДЕ
    |	АССОРТИМЕНТНЫЙ_ПЛАН.Ссылка.* КАК Товар,
    |	ВЫБОР
    |			КОГДА Матрица.Товар ЕСТЬ NULL 
    |				ТОГДА ЛОЖЬ
    |			ИНАЧЕ ИСТИНА
    |		КОНЕЦ КАК Присутствует_в_матрице_аптеки}";
	
	
Построитель.Текст=ТХТ;       
//--------------------------------------------------------GtG----КОНЕЦ--15.09.08



//------------------<Построитель>-------------------GtG----15.09.08

ТХТПостроительТекМатрицы="ВЫБРАТЬ
                         |	Матрица.Владелец.Товар.Код КАК Код,
                         |	Матрица.Владелец.Товар КАК Товар,
                         |	Матрица.КуМин,
                         |	Матрица.КуМакс,
                         |	Матрица.КтоВнесВМатрицу,
                         |	Матрица.ДатаВнесенияВМатрицу
                         |{ВЫБРАТЬ
                         |	Код,
                         |	Товар.*,
                         |	КуМин,
                         |	КуМакс,
                         |	КтоВнесВМатрицу.*,
                         |	ДатаВнесенияВМатрицу}
                         |ИЗ
                         |	Справочник.Матрица КАК Матрица
                         |ГДЕ
                         |	Матрица.Аптека = &Аптека
                         |{ГДЕ
                         |	Матрица.Владелец.Товар.* КАК Товар,
                         |	Матрица.КуМин,
                         |	Матрица.КуМакс,
                         |	Матрица.КтоВнесВМатрицу.*,
                         |	Матрица.ДатаВнесенияВМатрицу}
                         |{УПОРЯДОЧИТЬ ПО
                         |	Товар.*}";
	
	
ПостроительТекМатрицы.Текст=ТХТПостроительТекМатрицы;       
//--------------------------------------------------------GtG----КОНЕЦ--15.09.08
