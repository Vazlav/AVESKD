
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	ПроТОвар="";
	
	Для каждого ПолеОтбора из Построитель.Отбор Цикл
		Если ПолеОтбора.Использование=Истина Тогда 
			ПроТовар="Товар.Ссылка В (&СписокТоваров)";
		КонецЕсли;	
	КонецЦикла;	
	
	Если Поставщик.Пустая()=Ложь ТОгда
		Если проТовар="" ТОгда
			ПроТовар="Партия.Поставщик = &Поставщик";
		Иначе	
			ПроТовар=ПроТовар+" И Партия.Поставщик = &Поставщик";
		КонецЕсли;
	КонецЕсли;	
	
	
	Если ПоАптекам=Истина ТОгда
		ПроАптеки=",ПартииЖНВЛСОбороты.Склад";
		ПроАптекиГр="ПартииЖНВЛСОбороты.Склад,";
		ПроАптекиУ="Склад,";
	Иначе
		
		ПроАптеки="";
		ПроАптекиГр="";
		ПроАптекиУ="";
	КонецЕсли; 	

	
	
	
	ТХТ="ВЫБРАТЬ
	    |	ПартииЖНВЛСОбороты.Товар КАК Товар,
	    |	СУММА(ПартииЖНВЛСОбороты.СуммаЗакупСНДСРасход) КАК СуммаЗакупСНДСРасход,
	    |	СУММА(ПартииЖНВЛСОбороты.СуммаРознСНДСРасход) КАК СуммаРознСНДСРасход,
	    |	СУММА(ПартииЖНВЛСОбороты.КолвоРасход) КАК КолвоРасход,
		|	ПартииЖНВЛСОбороты.Товар.Производитель КАК ПроизводительИзАП,
		|	ПартииЖНВЛСОбороты.Партия.Серия.Производитель КАК ПроизводительИзПартии,
	    |	ПартииЖНВЛСОбороты.Партия.Поставщик КАК ПартияПоставщик "+ПроАптеки+"
	    |ИЗ
	    |	РегистрНакопления.ПартииЖНВЛС.Обороты(&Дата1, &ДАта2, Запись,"+ПроТовар+" ) КАК ПартииЖНВЛСОбороты
	    |ГДЕ
	    |	ПартииЖНВЛСОбороты.Регистратор ССЫЛКА Документ.РеализацияККМ
	    |
	    |СГРУППИРОВАТЬ ПО
		|   "+ПроАптекиГр+"
	    |	ПартииЖНВЛСОбороты.Товар,
		|	ПартииЖНВЛСОбороты.Партия.Серия.Производитель,
        |	ПартииЖНВЛСОбороты.Товар.Производитель,
	    |	ПартииЖНВЛСОбороты.Партия.Поставщик 
	    |
	    |УПОРЯДОЧИТЬ ПО
		|  "+ПроАптекиУ+"
	    |	Товар,
	    |	ПартияПоставщик";
		
		
		Построитель.Выполнить();
		ТЗ=Построитель.Результат.Выгрузить();
		МассивТоваров=ТЗ.ВыгрузитьКолонку("Ссылка");
		
		
				
				
		
		
	    Запрос=Новый Запрос;
		Запрос.Текст=ТХТ;
		Запрос.УстановитьПараметр("Дата1",НАчалоДня(НачПериода));
		Запрос.УстановитьПараметр("Дата2",КонецДня(КонПериода));
		Запрос.УстановитьПараметр("СписокТоваров",МассивТоваров);
		Запрос.УстановитьПараметр("Поставщик",Поставщик);
		
		
		ТЗ=Запрос.Выполнить().Выгрузить();
		
		
		
		Таб=Новый ТабличныйДокумент;                                                                 
		МАк=ЭтотОбъект.ПолучитьМакет("Продажи");
		Секция=Мак.ПолучитьОбласть("Шапка");
		
		Секция.Параметры.НачПериода=Формат(НачПериода,"ДФ=dd.MM.yyyy");
		Секция.Параметры.КонПериода=Формат(КонПериода,"ДФ=dd.MM.yyyy");
		
		Таб.Вывести(Секция);
		
		
		НН=0;
		
		ИтКол	=0;
		ИтСуммаЗ=0;	
		ИтСуммаР=0;	
		ИтНац   =0;
		
		//------------------ Индикатор --------------------------------------------------------------------------GtG---
		ЭлементыФормы.Инд.Значение=0;
		ЭлементыФормы.Инд.МаксимальноеЗначение=ТЗ.Количество();
		//------------------ Индикатор КОНЕЦ---------------------------------------------------------------------GtG---
		
		
		Для каждого Стр из ТЗ Цикл
			
			ЭлементыФормы.Инд.Значение=ЭлементыФормы.Инд.Значение+1;
			
			
			НН=НН+1;
			Секция=Мак.ПолучитьОбласть("Строка");
			
			Секция.Параметры.НН= НН  ;
			Секция.Параметры.Товар=Стр. Товар;
			Секция.Параметры.Количество	=Стр.КолвоРасход;
			Секция.Параметры.Поставщик	=Стр.ПартияПоставщик;
			
			Если ПоАптекам=Истина Тогда
				Секция.Параметры.Апт	=Стр.Склад;
			КонецЕсли; 
			
			Секция.Параметры.ПрАП	= Стр.ПроизводительИзАП;
			Секция.Параметры.ПрПарт = Стр.ПроизводительИзПартии;

			
			ИтКол=ИтКол+Стр.КолвоРасход;
			
			Секция.Параметры.СуммаЗ	    = Стр.СуммаЗакупСНДСРасход;
			
			ИтСуммаЗ=ИтСуммаЗ+Стр.СуммаЗакупСНДСРасход;
			
			Секция.Параметры.СуммаР	    = Стр.СуммаРознСНДСРасход;
			
			ИтСуммаР=ИтСуммаР+ Стр.СуммаРознСНДСРасход;
			
			Попытка
				Секция.Параметры.Нац        = Окр((Стр.СуммаРознСНДСРасход/Стр.СуммаЗакупСНДСРасход-1)*100,2);
			Исключение
				Секция.Параметры.Нац        = 0;
				Сообщить("!!! ДЕЛЕНИЕ НА НОЛЬ : "+Стр. Товар+" Расход  "+Стр.КолвоРасход+" поставщик "+Стр.ПартияПоставщик);
			КонецПопытки;
			
			Таб.Вывести(Секция);
		КонецЦикла;	
		
		
		Секция=Мак.ПолучитьОбласть("Итого");
			
			Секция.Параметры.ИтКол	=ИтКол	;
			Секция.Параметры.ИтСуммаЗ	    = ИтСуммаЗ;
			Секция.Параметры.ИтСуммаР	    = ИтСуммаР;
			Попытка
			Секция.Параметры.ИтНац        = Окр((ИтСуммаР/ИтСуммаЗ-1)*100,2);
		Исключение
			КонецПопытки;
			
			Таб.Вывести(Секция);

		
		
		
		
		
		Таб.ОтображатьСетку=Ложь;
		Таб.ОтображатьЗаголовки=Ложь;
		Таб.ОтображатьГруппировки=Ложь;
		ТАб.ТолькоПросмотр=Истина;
		Таб.Показать("Продажи");
		
	ОтметкаАудита(ЭтотОбъект,ЭтаФорма,"Сформировать");

КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.УстановитьПериод(НачПериода, ?(КонПериода='0001-01-01', КонПериода, КонецДня(КонПериода)));
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	Если НастройкаПериода.Редактировать() Тогда
		НачПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры



ТХТ="ВЫБРАТЬ
    |	АССОРТИМЕНТНЫЙ_ПЛАН.Ссылка
    |{ВЫБРАТЬ
    |	Ссылка.* КАК Товар}
    |ИЗ
    |	Справочник.АССОРТИМЕНТНЫЙ_ПЛАН КАК АССОРТИМЕНТНЫЙ_ПЛАН
    |{ГДЕ
    |	АССОРТИМЕНТНЫЙ_ПЛАН.Ссылка.* КАК ТОВАР}";
	
	
	Построитель.Текст=ТХТ;
	
	
	