Процедура ПриОткрытии()
	// Подставляем регион из склада или из константы
	// регион используется для расчета предельной наценки по ЖНВЛС / СВЛС
	// Запуск расценки Только из формы прихода товара(пока что)
	//------------------------------------------------------------------------
	
	СКД=ЭтаФорма.ВладелецФормы.Склад;
	ФинСкидка=ЭтаФорма.ВладелецФормы.ФинСкидка;
	
КонецПроцедуры




Процедура ОсновныеДействияФормыРасценить(Кнопка) Экспорт
	
	ТП.Очистить();
	ЭлементыФормы.ОшибкиРасценки.Очистить();
		
	ЭВФ=ЭтаФорма.ВладелецФормы;
	
	ВыбГТТ=Справочники.ГруппыТТ.Выбрать();
	кОЛВОгтт=0;
	Пока ВыбГТТ.Следующий() Цикл
		кОЛВОгтт=кОЛВОгтт+1;
	КонецЦикла;	
	
	КСТовара=ЭВФ.Товар.Количество();
	
	ИТОГОСтрокРез=КСТовара*кОЛВОгтт;
	
	ЭлементыФормы.Индикатор.МаксимальноеЗначение=ИТОГОСтрокРез;
	ЭлементыФормы.Индикатор.Значение=0;
	
	
	//----------------------------< Цикл по всем Группам ТТ >--------------------------------GtG--- 
	
	
	
	ВыбГТТ=Справочники.ГруппыТТ.Выбрать();
	
	Курс=ПолучитьКурсВалюты(ЭВФ.Валюта, ЭВФ.Дата);
	
	СписокСтрокДокумента=ЭтаФорма.ВладелецФормы.Товар.ВыгрузитьКолонку("ТОвар");
	
	//----------------------------< Готовим Дерево Ошибок (ДО) >--------------------------------GtG---
	ДО = Новый ДеревоЗначений;
	КДО=ДО.Колонки.Добавить("Ошибки");
	
	ДО.Строки.Очистить();
	
	
	//----------------------------<  >--------------------------------GtG---	
	
	ЕстьОшибки=Ложь;
	
	ТЧ = ЭВФ.Товар.Выгрузить();
	
	ТЧ.Свернуть("Товар,Партия,НадбавкаПостОтЦГР,ЦенаПроизводителя,ЦенаЗакуп,ЦенаЗакупБезНДС,ЦенаГосРегистрации,СтавкаНДС,НомерГТД","");
	
	Пока ВыбГТТ.Следующий() Цикл
		//=================== ГТТ помеченные на удаление в ценообразовании не участвуют! ========================
		Если ВыбГТТ.ПометкаУдаления = Истина Тогда
			Продолжить;
		КонецЕсли;
		
		//============= Расценка по ГТТ ======================
		
		СпрГТТСсылка = ВыбГТТ.ПолучитьОбъект().Ссылка;
		
		ТекСтрГТТДО=ДО.Строки.Добавить();
		ТекСтрГТТДО.Ошибки=СпрГТТСсылка;		
		
		Если СпрГТТСсылка.МинНаценкаЛС=0 Тогда
			СтрОш="
			|Группа: "+СпрГТТСсылка+"
			|    	Описание:   У ГТТ НЕ ЗАДАН ПРОЦЕНТ МИН. НАЦЕНКИ НА ЛЕКСРЕДСТВА !!!
			|    НЕОБХОДИМО УКАЗАТЬ ПРОЦЕНТ МИН. НАЦЕНКИ НА ЛС ДЛЯ ЭТОЙ ГРУППЫ!";
			ЕстьОшибки=Истина;
			
			Описание=ТекСтрГТТДО.Строки.Добавить();
			Описание.Ошибки="У ГТТ НЕ ЗАДАН ПРОЦЕНТ МИН. НАЦЕНКИ НА ЛЕКСРЕДСТВА !!!";
			
			Рекомендация=Описание.Строки.Добавить();
			Рекомендация.Ошибки="НЕОБХОДИМО УКАЗАТЬ ПРОЦЕНТ МИН. НАЦЕНКИ НА ЛС ДЛЯ ЭТОЙ ГРУППЫ!";			
    	ИначеЕсли СпрГТТСсылка.МинНаценкаПФ=0 Тогда
			СтрОш="
			|Группа: "+СпрГТТСсылка+"
			|    	Описание:   У ГТТ НЕ ЗАДАН ПРОЦЕНТ МИН. НАЦЕНКИ НА ПАРАФАРМАЦИЮ !!!
			|    НЕОБХОДИМО УКАЗАТЬ ПРОЦЕНТ МИН. НАЦЕНКИ НА ПФ ДЛЯ ЭТОЙ ГРУППЫ!";
			ЕстьОшибки=Истина;
			Описание=ТекСтрГТТДО.Строки.Добавить();
			Описание.Ошибки="У ГТТ НЕ ЗАДАН ПРОЦЕНТ МИН. НАЦЕНКИ НА ПАРАФАРМАЦИЮ !!!";
			
			Рекомендация=Описание.Строки.Добавить();
			Рекомендация.Ошибки="НЕОБХОДИМО УКАЗАТЬ ПРОЦЕНТ МИН. НАЦЕНКИ НА ПФ ДЛЯ ЭТОЙ ГРУППЫ!";	
		КонецЕсли; 	
			
		//Сообщить("------------------Расценка под "+СпрГТТСсылка +" ---------------------------------------");
		
		ТХТ="ВЫБРАТЬ
		|	АП_ГТТ.Ссылка КАК ЭлемАПГТТ,
		|	АП_ГТТ.Товар КАК ТОВАР,
		|   АП_ГТТ.НеИспользовать as НеИспользовать
		|ИЗ
		|	Справочник.АП_ГТТ КАК АП_ГТТ
		|ГДЕ
		|	АП_ГТТ.Товар В(&СписокСтрокДокумента)
		|	И АП_ГТТ.Владелец = &СсылкаГТТ
		|
		|СГРУППИРОВАТЬ ПО
		|	АП_ГТТ.Ссылка,
		|	АП_ГТТ.Товар";
		
		Структ= Новый  Структура;
		Структ.Вставить("СписокСтрокДокумента",СписокСтрокДокумента);
		Структ.Вставить("СсылкаГТТ",СпрГТТСсылка);
		//Структ.Вставить("НеИспользовать",Ложь);
		
		
		СПЗВнутрСтр=ЗначениеВСтрокуВнутр(Структ);
		
		ИщемПоГТТ=ОМ8_ВыполнитьЗапросНаСервере  (Тхт,СПЗВнутрСтр,1);
		
		
		
		
		//----------------------------< Построчная обработка >--------------------------------GtG---
		
			
		Для Каждого Стр из ТЧ Цикл
			
			СтрОшТовар=ТекСтрГТТДО.Строки.Добавить();
			СтрОшТовар.Ошибки=Стр.Товар;
			
	
			ЭлементыФормы.Индикатор.Значение=ЭлементыФормы.Индикатор.Значение+1;
			
			СтрТЗ_АП_ГТТ=ИщемПоГТТ.Найти(Стр.Товар,"Товар");
			
			
			
			//Сообщить(Стр.ТОвар);
			СтрТ=ТП.Добавить();
			СтрТ.Товар=Стр.Товар;
			СтрТ.ГТТ=СпрГТТСсылка;
			//СтрТ.Серия=Стр.Серия;
			СтрТ.Партия=Стр.Партия;
			
			
			СтрТ.НадбавкаПостОтЦГР=СТР.НадбавкаПостОтЦГР;
			СтрТ.ЦенаПроизв=Стр.ЦенаПроизводителя; // Рублевая, из документа
			СтрТ.ЦенаЗакуп=Стр.ЦенаЗакуп; // Рублевая, с НДС, из документа						
			СтрТ.ЦенаГосРег=Стр.ЦенаГосРегистрации+Стр.ЦенаГосРегистрации/100*Стр.СтавкаНДС.Ставка;//С НДС!
               		
			СтрТЗЗапросаПоГТТ=ИщемПоГТТ.Найти(Стр.Товар,"Товар");
			
			//----------------------------< Не расценаяем для группы если нет цены в АПГТТ, пишем лог >--------------------------------GtG---
			
			Если СтрТЗЗапросаПоГТТ= Неопределено Тогда
				
				СтрОш="
				|Группа: "+СпрГТТСсылка+"
				|    ТОвар: "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
				|    	Описание:   Нет товара в АП ГТТ !!
				|    НЕ РАСЦЕНЕН ДЛЯ ЭТОЙ ГРУППЫ!";
				ЕстьОшибки=Истина;
				ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш);
				
				ОШТовара=СтрОшТовар.Строки.Добавить();
				ОШТовара.Ошибки="Нет товара в АП ГТТ !!";
				
				ОшРек=ОШТовара.Строки.Добавить();
				ОшРек.Ошибки="1) Добавить товар в ГТТ";
				ОшРек=ОШТовара.Строки.Добавить();
				ОшРек.Ошибки="2) Заново расценить документ или заблокировать товар в ГТТ если его там быть не должно";
				Продолжить;
			КонецЕсли;
			//----------------------------<Отбросим те, у которых стоит блокировка в ап  >--------------------------------GtG---
			
			Если СтрТЗЗапросаПоГТТ.НеИспользовать= ИСТИНА Тогда
				
				СтрОш="
				|Группа: "+СпрГТТСсылка+"
				|    ТОвар:   "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
				|    	Описание:   стоит галочка Неиспользовать в АП ГТТ !!
				|    НЕ РАСЦЕНЕН ДЛЯ ЭТОЙ ГРУППЫ!";
				ЕстьОшибки=Истина;
				ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш);
				
				ОШТовара=СтрОшТовар.Строки.Добавить();
				ОШТовара.Ошибки="стоит галочка Неиспользовать в АП ГТТ ";
				
				ОшРек=ОШТовара.Строки.Добавить();
				ОшРек.Ошибки="НЕ РАСЦЕНЕН ДЛЯ ЭТОЙ ГРУППЫ!";
				Продолжить;
			КонецЕсли;
			//----------------------------<  >--------------------------------GtG---
			
			
			
			СтрТ.АПГТТ=СтрТЗЗапросаПоГТТ.ЭлемАПГТТ.ссылка;
			СтрТ.ЦенаАПГТТ=СтрТЗЗапросаПоГТТ.ЭлемАПГТТ.РозничнаяЦенаГТТ;   // из ГТТ 
			СтрТ.ЦенаОптАПГТТ=СтрТЗЗапросаПоГТТ.ЭлемАПГТТ.ОптоваяЦенаГТТ;   // из ГТТ 
			
			//----------------------------< Сообщим что нет цены >--------------------------------GtG---
			ЕСли СтрТ.ЦенаАПГТТ=0 Тогда
				СтрОш="
				|Группа: "+СпрГТТСсылка+"
				|    ТОвар:   "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
				|    	Описание:   Не указана розничная цена товара в АП ГТТ
				|    НЕ РАСЦЕНЕН ДЛЯ ЭТОЙ ГРУППЫ!";
				ЕстьОшибки=Истина;
				ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш);
				
				
				
				ОШТовара=СтрОшТовар.Строки.Добавить();
				ОШТовара.Ошибки="Не указана розничная цена товара в АП ГТТ";
				
				ОшРек=ОШТовара.Строки.Добавить();
				ОшРек.Ошибки="НЕ РАСЦЕНЕН ДЛЯ ЭТОЙ ГРУППЫ!";
				
				
				Продолжить;
			КонецЕсли;	
			//----------------------------<  >--------------------------------GtG---
			
			
			Если (СтрТ.Товар.ЖНВЛС=Ложь) Тогда
				//============================< Расчет НЕ Жнвлс >================================GtG===
				// для товаров НеЖНВЛС и ЖНВЛС товаров у которых не указана цена госрегистрации
				
				ЦенаРознАПГТТ = СтрТ.ЦенаАПГТТ; // берем из АПГТТ
				//----------------------------< в тех.задании. >--------------------------------GtG---
				//Если (Цр - Цзр)*100/Цзр  < Zmin (%), то розничная цена принимает значение 
				//	Цр = Цзр*(1+Zmin/100), где 
				//	Zmin (%) - минимально-допустимая надбавка
				//	(либо индивидуальное значение в справочнике номенклатуры
				//	(количественная характеристика); либо = 20% для ЛП, 30% для ПФ). 
				//		Для ШРЕЯ -  Zmin = 5%
				
				//----------------------------< Реально >--------------------------------GtG---
				// Поскольку всегда знаем руб. цену и система все хранит в рублях
				// то расчет по курсу отпадает.				
				ПРоверкаНаценки=(ЦенаРознАПГТТ-СтрТ.ЦенаЗакуп)*100/СтрТ.ЦенаЗакуп;
				
				// границы наценки по ап основному !!!
				
				// затычки
				ZminАП=10000;
				ZminАПГТТ=10000;
				ZminПост=10000;
				
				ZminКонст=Константы.МинимальноДопустимаяНаценка.Получить();
				
				
				Если СтрТ.Товар.МинНаценка>0 Тогда
					ZminАП=СтрТ.Товар.МинНаценка;
				Иначе
					СтрОш="
					|ТОВАР:   "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
					|    	Описание: у товара в справочнике АП НЕ УКАЗАНА Минимальная наценка! 
					|        Не могу определить минимальный процент наценки по АП!
					|        При расценке будет использован процент из ГТТ, константы или поставщика!
					|    ТРЕБУЕТСЯ УСТАНОВИТЬ минимальный процент наценки в АП!";
					еСТЬоШИБКИ=Истина;
					ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш);
					ZminАП=10000;
					
					ОШТовара=СтрОшТовар.Строки.Добавить();
					ОШТовара.Ошибки="У товара в справочнике АП НЕ УКАЗАНА Мин.наценка! Не могу определить мин.% наценки по АП! При расценке будет использован процент из ГТТ, константы или поставщика!";
					
					ОшРек=ОШТовара.Строки.Добавить();
					ОшРек.Ошибки="ТРЕБУЕТСЯ УСТАНОВИТЬ мин.% наценки в АП!";
				КонецЕсли; 	
				
				Если СтрТ.Товар.ТипДляЦО=Перечисления.ТипыДляЦО.Лексредства ТОгда
					ZminАПГТТ=СпрГТТСсылка.МинНаценкаЛС;
				ИначеЕсли СтрТ.Товар.ТипДляЦО=Перечисления.ТипыДляЦО.Парафармация ТОгда
					ZminАПГТТ=СпрГТТСсылка.МинНаценкаПФ;
				Иначе
					// затычка на 10000
					СтрОш="
					|ТОВАР:  "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
					|    	Описание: у товара в справочнике АП НЕ УКАЗАН ТИП ДЛЯ ЦО (лексредство или парафармация)! 
					|        Не могу определить минимальный процент наценки ГТТ!
					|        При расценке будет использован процент из АП, константы или поставщика!
					|    ТРЕБУЕТСЯ УСТАНОВИТЬ Тип для ЦО в АП!";
					еСТЬоШИБКИ=Истина;
					ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш);
					
					ОШТовара=СтрОшТовар.Строки.Добавить();
					ОШТовара.Ошибки="У товара в справочнике АП НЕ УКАЗАН ТИП ДЛЯ ЦО (лексредство или парафармация)! Не могу определить мин.% наценки ГТТ! При расценке будет использован процент из АП, константы или поставщика!";
					
					ОшРек=ОШТовара.Строки.Добавить();
					ОшРек.Ошибки="ТРЕБУЕТСЯ УСТАНОВИТЬ Тип для ЦО в АП!";						
					
				КонецЕсли;	
				
				Если ZminАПГТТ=0 Тогда // по апгтт и типу для цо процент определить не удалось	  
					// значит бесполезно использовать ZMinАПГТТ
					//	 в случае если  у гтт стоят 0 в процентах наценок,
					// 	 не указан тип для цо у товара
					ZminАПГТТ=10000;
				КонецЕсли;	  
					
				Если ЭВФ.Поставщик.МинимальнаяНаценкаНаТовар>0 Тогда
					ZminПост=ЭВФ.Поставщик.МинимальнаяНаценкаНаТовар;
				КонецЕсли; 
				
				ZMin=Мин(ZminАП,ZminАПГТТ,ZminПост);
				
				//----------------------------< Безумная мин. наценка - признак плохой настройки >--------------------------------GtG---
				Если ZMin=10000 Тогда // нет ни одной из ZminАП,ZminАПГТТ,ZminПост
					СтрОш="
					|Группа: "+СпрГТТСсылка+"
					|    ТОвар:   "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
					|    	Описание: на товар НИГДЕ НЕ УКАЗАНА наценка (АП, АПГТТ, Поставщик)!!! 
					|        ЦЕНА ВЗЯТА ИЗ АПГТТ,  НО ПРОВЕРКА ПРАВИЛЬНОСТИ НАЦЕНКИ НЕВОЗМОЖНА!
					|    ТРЕБУЕТСЯ УКАЗАТЬ ПРОЦЕНТЫ НАЦЕНКИ (хотябы в АП)!"; ЕСТЬОШИБКИ=Истина;
					ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш);
					
					
					ОШТовара=СтрОшТовар.Строки.Добавить();
					ОШТовара.Ошибки="На товар НИГДЕ НЕ УКАЗАНА наценка (АП, АПГТТ, Поставщик)!!! ЦЕНА ВЗЯТА ИЗ АПГТТ,  НО ПРОВЕРКА ПРАВИЛЬНОСТИ НАЦЕНКИ НЕВОЗМОЖНА!";
					
					ОшРек=ОШТовара.Строки.Добавить();
					ОшРек.Ошибки="ТРЕБУЕТСЯ УКАЗАТЬ ПРОЦЕНТЫ НАЦЕНКИ (хотябы в АП)!";
					
					
					
					Продолжить;
				КонецЕсли; 
				
				Если ПРоверкаНаценки<ZMin ТОгда
					
					Если ZMin=0 тогда
						ZMin=ZminКонст;
					КонецЕсли; 	
					
					КриваяЦенаРознАПГТТ=ЦенаРознАПГТТ;
					
					ЦенаРознАПГТТ = СтрТ.ЦенаЗакуп+СтрТ.ЦенаЗакуп/100*ZMin;
					СтрОш="
					|Группа: "+СпрГТТСсылка+"
					|    ТОвар:  "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
					|        Розн.цена АП= "+КриваяЦенаРознАПГТТ+"  Закупка="+СтрТ.ЦенаЗакуп+" наценка="+ПРоверкаНаценки+"%
					|    	Описание:   наценка меньше "+Zmin+" % !!! Расценен с наценкой "+ ZMin+"%
					|    РЕКОМЕНДУЕТСЯ ИЗМЕНИТЬ ЦЕНУ В АП ГТТ!";
					ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш); ЕСТЬОШИБКИ=Истина;
					
					ОШТовара=СтрОшТовар.Строки.Добавить();
					ОШТовара.Ошибки="Розн.цена АП = "+КриваяЦенаРознАПГТТ+"  Закупка="+СтрТ.ЦенаЗакуп+" наценка="+Окр(ПРоверкаНаценки,3)+"% Наценка меньше "+Zmin+" % !!! Расценен с наценкой "+ ZMin+"%";
					
					
					ОшРек=ОШТовара.Строки.Добавить();
					ОшРек.Ошибки="РЕКОМЕНДУЕТСЯ ИЗМЕНИТЬ ЦЕНУ В АП ГТТ!";
				КонецЕсли;	
				
				// На всякий случай проверим на максимальную наценку (хотя в ТЗ об этом ни слова)
				// если превысит выведем как ошибку, хотя , больше не меньше.
				ЕСли ПРоверкаНаценки>Стр.Товар.МаксНаценка Тогда
					СтрОш="
					|Группа: "+СпрГТТСсылка+"
					|    ТОвар: "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
					|        Розн.цена АП= "+ЦенаРознАПГТТ+"  Закупка="+СтрТ.ЦенаЗакуп+" наценка="+ПРоверкаНаценки+"%
					|    	Описание:   наценка больше максимальной в АП "+Стр.Товар.МаксНаценка+" % 
					|    РЕКОМЕНДУЕТСЯ ПРОВЕРИТЬ ЦЕНУ В АП ГТТ!";
					ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш); ЕСТЬОШИБКИ=Истина;
					
					ОШТовара=СтрОшТовар.Строки.Добавить();
					ОШТовара.Ошибки="Розн.цена АП = "+ЦенаРознАПГТТ+"  Закупка="+СтрТ.ЦенаЗакуп+" наценка="+Окр(ПРоверкаНаценки,3)+"% Наценка больше "+Стр.Товар.МаксНаценка+" % ";
					
					
					ОшРек=ОШТовара.Строки.Добавить();
					ОшРек.Ошибки="РЕКОМЕНДУЕТСЯ ПРОВЕРИТЬ ЦЕНУ В АП ГТТ!";
				КонецЕсли; 
						
    			СтрТ.ЦенаРозн=ЦенаРознАПГТТ;
				СтрТ.ЦенаОптовая=СтрТ.ЦенаРозн;
				
				Если СтрТ.ЦенаЗакуп>0 тогда
					СтрТ.НаценкаОтЗакупки=(СтрТ.ЦенаРозн-СтрТ.ЦенаЗакуп)/СтрТ.ЦенаЗакуп*100;//%
				Иначе
					СтрТ.НаценкаОтЗакупки=0;
				КонецЕсли; 
				
				Если СтрТ.ЦенаГосРег>0 Тогда
					СтрТ.НаценкаОтЦГР=(СтрТ.ЦенаРозн-СтрТ.ЦенаГосРег)/СтрТ.ЦенаГосРег*100;//%
				Иначе
					СтрТ.НаценкаОтЦГР=0;
				КонецЕсли; 				
								
			Иначе
				//============================< Расчет ЖНВЛС >================================GtG===
			    // мутно и не ясно, считаем выше по простому
   		        //или (СтрТ.Товар.ЖНВЛС=Истина и СтрТ.ЦенаГосРег=0) 
				//или (СтрТ.Товар.ЖНВЛС=Истина) //ЭТО ЗАТЫЧКА. ВЕСЬ ТОВАР РАСЧИТАЕТСЯ КАК НЕЖНВЛС								
				//----------------------------< в тех.задании. >--------------------------------GtG---
				//Если (Цр - Цзр)*100/Цзр  < Zmin (%), то розничная цена принимает значение 
				//	Цр = Цзр*(1+Zmin/100), где 
				//	Zmin (%) - минимально-допустимая надбавка
				//	(либо индивидуальное значение в справочнике номенклатуры
				//	(количественная характеристика); либо = 20% для ЛП, 30% для ПФ). 
				//		Для ШРЕЯ -  Zmin = 5%
				
				//----------------------------< Реально >--------------------------------GtG---
				// Поскольку всегда знаем руб. цену и система все хранит в рублях
				// то расчет по курсу отпадает.				
				//============================< зАТЫЧКА НА жнвлс >================================GtG===
				// !!! цена госрег должна быть !!!
					// зарубим наценку до максимально допустимой
			
				//ЦенаРозМаксБезНДС   = ЦенаЗакбезНДС + МаксНадбОтЗакЦены;
				//МаксНадбОтЗакЦены = ПроцентРозНадб*ЦенаРозбезНДС/100;				      
				//Модуль проверки наценки на товар оптовиком
				//Если ПоставщикИмпортер Тогда
				//	ПроцентОптНадб = Константы.НаценкаИмпортера.Получить();
				//Иначе	
				//	ПроцентОптНадб = Константы.НаценкаНеИмпортера.Получить();
				//КонецЕсли;					
				ZMax =  СпрГТТСсылка.МинНаценкаЛС;		
				
			    ЦенаРозАПбезНДС   = СтрТ.ЦенаАПГТТ/(1+Стр.СтавкаНДС.Ставка/100); // Цена АП  с ндс
				ЦенаЗакбезНДС     = СтрТ.ЦенаЗакуп/(1+Стр.СтавкаНДС.Ставка/100); //Закупочная без НДС
				ЦенаПроизвбезНДС  = СтрТ.ЦенаПроизв;///(1+Стр.СтавкаНДС.Ставка/100); //Цена производителя без НДС
				ЦенаРозМаксбезНДС = Макс(ЦенаРозАПбезНДС, ЦенаЗакбезНДС*(1+ ZMax/100)); // Максимально розничная цена
				
				ЦенаРозМакс = ЦенаРозМаксБезНДС*(1 + Стр.СтавкаНДС.Ставка/100);
				
				Если ЭВФ.Поставщик.ТипПоставщика = "Производитель" Тогда
				  ПроцентРозНадб = Константы.НаценкаПроизводителя.Получить();
			    Иначе
				  ПроцентРозНадб = Константы.НаценкаОптовика.Получить();
			    КонецЕсли;
			  
			    Если СтрТ.Товар.СВЛС=Истина ТОгда
				  ZMin=СпрГТТСсылка.Регион.МаксПроцРознНацСВЛС; //минимально допустимая наценка из АП.
			    Иначе
			      ZMin=СпрГТТСсылка.Регион.МаксПроцРознНацЖНВЛС; //минимально допустимая наценка из АП.
			    КонецЕсли;				  
			  
			    
				
			    ЦенаРоз = ЦенаЗакбезНДС * (1+ZMin/100)*(1 + Стр.СтавкаНДС.Ставка/100);
																	
		        ЦенаРоз = Мин(ЦенаРозМакс,ЦенаРоз);
				
				
				Если ЦенаРоз > ЦенаРозМакс Тогда
				  СтрТ.ЦенаРозн   = Окр(ЦенаРозМакс,2,0);
				Иначе
    			  СтрТ.ЦенаРозн   = Окр(ЦенаРоз,2,0);
			    КонецЕсли;
			  
				СтрТ.МаксРознЦена = Окр(ЦенаРозМакс,2,0);		
				
				Если СтрТ.ЦенаЗакуп>0 тогда
					СтрТ.НаценкаОтЗакупки=(СтрТ.ЦенаРозн-СтрТ.ЦенаЗакуп)/СтрТ.ЦенаЗакуп*100;//%
				Иначе
					СтрТ.НаценкаОтЗакупки=0;
				КонецЕсли; 
				
					
					//	СтрОш="
					//|Группа: "+СпрГТТСсылка+"
					//|    ТОвар:   "+Стр.Товар.Код+"  "+Стр.Товар.Наименование+"
					//|        Розн.цена АП= "+криваяЦенаРознАПГТТ+"  Цена гос.рег.="+СтрТ.ЦенаГосРег+" наценка="+ПРоверкаНаценкиЦГР+"%
					//|    	Описание:   наценка больше максимально допустимой по региону на "+?(СтрТ.Товар.СВЛС=истина,"СВЛС","ЖНВЛС")+" "+РубитьДо+" % 
					//|       Расценен по максимально допустимому проценту наценки "+РубитьДо +"% Розн.цена="+ЦенаРознАПГТТ+"
					//|    РЕКОМЕНДУЕТСЯ ПРОВЕРИТЬ ЦЕНУ В АП ГТТ!";
					//ЭлементыФормы.ОшибкиРасценки.ДобавитьСтроку(СтрОш); ЕСТЬОШИБКИ=Истина;
					//
					//ОШТовара=СтрОшТовар.Строки.Добавить();
					//ОШТовара.Ошибки="Розн.цена АП = "+криваяЦенаРознАПГТТ+"  Цена госрегистрации="+СтрТ.ЦенаГосРег+" наценка="+ПРоверкаНаценкиЦГР+"% Наценка больше "+РубитьДо+" % ";				

					//ОшРек=ОШТовара.Строки.Добавить();
					//ОшРек.Ошибки="Расценен по макс.доп.% наценки на "+?(СтрТ.Товар.СВЛС=истина,"СВЛС","ЖНВЛС")+" "+РубитьДо+"% РознЦена="+ЦенаРознАПГТТ;
					//ОшРек1=ОшРек.Строки.Добавить();
					//ОшРек1.Ошибки="ПРОВЕРИТЬ ЦЕНУ В АП ГТТ!";
				
          	КонецЕсли;
			
			Если  СтрОшТовар.Строки.Количество()=0 Тогда
				ТекСтрГТТДО.Строки.Удалить(СтрОшТовар); // по этому товару ошибок не возникло
			КонецЕсли; 	
	
			
			
		КонецЦикла; // по товару
		
		Если  ТекСтрГТТДО.Строки.Количество()=0 Тогда
				ДО.Строки.Удалить(ТекСтрГТТДО); // по этой ГТТ ошибок не возникло
		КонецЕсли; 
		
	КонецЦикла; // по ГТТ	
	
	
	ЭлементыФормы .ДеревоОшибок.Значение=ДО;
	ЭлементыФормы.ДеревоОшибок.СоздатьКолонки();
КонецПроцедуры

Процедура ТПГТТОткрытие(Элемент, СтандартнаяОбработка)
	//СтандартнаяОбработка=Ложь;
	//// Вставить содержимое обработчика.
	//ТС= ЭлементыФормы.ТП.ТекущаяСтрока;
	//ФЭ=Элемент.Значение.ПолучитьФорму("ФормаЭлемента",ЭтаФорма,Новый  УникальныйИдентификатор);
	//ФЭ.Открыть();
	//фэ= ЭтаФорма;
	//ФЭ.сТекущаяСтраница=1;
	//
	//
	//
	//сообщить(Элемент.Значение);
КонецПроцедуры

Процедура КоманднаяПанель1СохранитьЦены(Кнопка)
	//СохранитьЦены в партии , серии;
	
	ЭФВО=ЭтаФорма.ВладелецФормы;
	
	//----------------------------< Очистка регистра цен перед записью новых значений >--------------------------------GtG---
	Движения=ЭФВО.Движения;
	Движения.Цены.Очистить(); 			 
	Движения.Цены.Записать();
	//----------------------------<  >--------------------------------GtG---
	
	
	Для Каждого Стр из ТП Цикл
		
		Если Стр.ЦенаРозн=0 Тогда
			ПРедупреждение("У товара "+Стр.ТОвар+" для ГТТ "+Стр.ГТТ+" не рассчиталась розничная цена!
			|Чтобы цены сохранились - они все должны быть рассчитаны!");
			Возврат;
		КонецЕсли;	
		
		
		ЗапРС=Движения.Цены.Добавить();
		
		ЗапРС.Активность=Истина;
		ЗапРС.АП=Стр.ТОвар;
		ЗапРС.ГТТ=Стр.ГТТ;
		//		ЗапРС.Документ=ЭтаФорма.ВладелецФормы.Ссылка;
		
		Если Стр.Партия.Пустая() Тогда
			ПартияРЦ=Справочники.Партии.ПустаяСсылка();
		Иначе	
			ПартияРЦ=Стр.Партия.Ссылка;
		КонецЕсли;	
		
		ЗапРС.Партия=ПартияРЦ;
		ЗапРС.Период=ЭтаФорма.ВладелецФормы.Дата;
		ЗапРС.Регистратор=ЭтаФорма.ВладелецФормы.Ссылка;
		//ЗапРС.Серия=Стр.Серия;
		ЗапРС.ЦенаОптГТТ=Стр.ЦенаОптовая;
		ЗапРС.ЦенаРознГТТ=Стр.ЦенаРозн;
	КонецЦикла; 
	
	Движения.Цены.Записать();
	
	предупреждение("ГОТОВО!",5);
	
	СтрИзм=ЭФВО.Изменения.Добавить();
	СтрИзм.Дата=ТекущаяДата();
	СтрИзм.Сотрудник=ПараметрыСеанса.ТекущийСотр;
	СтрИзм.ТипИзм=Перечисления.ДействияНадДокументами.Расценка;
КонецПроцедуры
